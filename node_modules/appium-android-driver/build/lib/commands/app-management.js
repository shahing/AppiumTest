"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

const APP_EXTENSION = '.apk';
const APP_STATE_NOT_INSTALLED = 0;
const APP_STATE_NOT_RUNNING = 1;
const APP_STATE_RUNNING_IN_BACKGROUND = 3;
const APP_STATE_RUNNING_IN_FOREGROUND = 4;
let commands = {};
exports.commands = commands;

commands.isAppInstalled = async function (appId) {
  return await this.adb.isAppInstalled(appId);
};

commands.queryAppState = async function (appId) {
  _logger.default.info(`Querying the state of '${appId}'`);

  if (!(await this.adb.isAppInstalled(appId))) {
    return APP_STATE_NOT_INSTALLED;
  }

  if (!(await this.adb.processExists(appId))) {
    return APP_STATE_NOT_RUNNING;
  }

  const output = await this.adb.shell(['dumpsys', 'window', 'windows']);

  for (const line of output.split('\n')) {
    if (line.includes(appId) && (line.includes('mCurrentFocus') || line.includes('mFocusedApp'))) {
      return APP_STATE_RUNNING_IN_FOREGROUND;
    }
  }

  return APP_STATE_RUNNING_IN_BACKGROUND;
};

commands.activateApp = async function (appId) {
  const cmd = ['monkey', '-p', appId, '-c', 'android.intent.category.LAUNCHER', '1'];
  let output = '';

  try {
    _logger.default.debug(`Activating '${appId}' with 'adb shell ${cmd.join(' ')}' command`);

    output = await this.adb.shell(cmd);

    _logger.default.debug(`Command stdout: ${output}`);
  } catch (e) {
    _logger.default.errorAndThrow(`Cannot activate '${appId}'. Original error: ${e.message}`);
  }

  if (output.includes('monkey aborted')) {
    _logger.default.errorAndThrow(`Cannot activate '${appId}'. Are you sure it is installed?`);
  }
};

commands.removeApp = async function (appId, options = {}) {
  return await this.adb.uninstallApk(appId, options);
};

commands.terminateApp = async function (appId, options = {}) {
  _logger.default.info(`Terminating '${appId}'`);

  if (!(await this.adb.processExists(appId))) {
    _logger.default.info(`The app '${appId}' is not running`);

    return false;
  }

  await this.adb.forceStop(appId);
  const timeout = _appiumSupport.util.hasValue(options.timeout) && !isNaN(options.timeout) ? parseInt(options.timeout, 10) : 500;

  try {
    await (0, _asyncbox.waitForCondition)(async () => (await this.queryAppState(appId)) <= APP_STATE_NOT_RUNNING, {
      waitMs: timeout,
      intervalMs: 100
    });
  } catch (e) {
    _logger.default.errorAndThrow(`'${appId}' is still running after ${timeout}ms timeout`);
  }

  _logger.default.info(`'${appId}' has been successfully terminated`);

  return true;
};

commands.installApp = async function (appPath, options = {}) {
  const localPath = await this.helpers.configureApp(appPath, APP_EXTENSION);

  try {
    await this.adb.install(localPath, options);
  } finally {
    if (localPath !== appPath) {
      await _appiumSupport.fs.rimraf(localPath);
    }
  }
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJBUFBfRVhURU5TSU9OIiwiQVBQX1NUQVRFX05PVF9JTlNUQUxMRUQiLCJBUFBfU1RBVEVfTk9UX1JVTk5JTkciLCJBUFBfU1RBVEVfUlVOTklOR19JTl9CQUNLR1JPVU5EIiwiQVBQX1NUQVRFX1JVTk5JTkdfSU5fRk9SRUdST1VORCIsImNvbW1hbmRzIiwiaXNBcHBJbnN0YWxsZWQiLCJhcHBJZCIsImFkYiIsInF1ZXJ5QXBwU3RhdGUiLCJsb2ciLCJpbmZvIiwicHJvY2Vzc0V4aXN0cyIsIm91dHB1dCIsInNoZWxsIiwibGluZSIsInNwbGl0IiwiaW5jbHVkZXMiLCJhY3RpdmF0ZUFwcCIsImNtZCIsImRlYnVnIiwiam9pbiIsImUiLCJlcnJvckFuZFRocm93IiwibWVzc2FnZSIsInJlbW92ZUFwcCIsIm9wdGlvbnMiLCJ1bmluc3RhbGxBcGsiLCJ0ZXJtaW5hdGVBcHAiLCJmb3JjZVN0b3AiLCJ0aW1lb3V0IiwidXRpbCIsImhhc1ZhbHVlIiwiaXNOYU4iLCJwYXJzZUludCIsIndhaXRNcyIsImludGVydmFsTXMiLCJpbnN0YWxsQXBwIiwiYXBwUGF0aCIsImxvY2FsUGF0aCIsImhlbHBlcnMiLCJjb25maWd1cmVBcHAiLCJpbnN0YWxsIiwiZnMiLCJyaW1yYWYiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsYUFBYSxHQUFHLE1BQXRCO0FBR0EsTUFBTUMsdUJBQXVCLEdBQUcsQ0FBaEM7QUFDQSxNQUFNQyxxQkFBcUIsR0FBRyxDQUE5QjtBQUNBLE1BQU1DLCtCQUErQixHQUFHLENBQXhDO0FBQ0EsTUFBTUMsK0JBQStCLEdBQUcsQ0FBeEM7QUFFQSxJQUFJQyxRQUFRLEdBQUcsRUFBZjs7O0FBUUFBLFFBQVEsQ0FBQ0MsY0FBVCxHQUEwQixnQkFBZ0JDLEtBQWhCLEVBQXVCO0FBQy9DLFNBQU8sTUFBTSxLQUFLQyxHQUFM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QUFDSSxPQUFULENBQXhDLEdBQTRESSxRQUFRLENBQUNSLE9BQU8sQ0FBQ0ksT0FBVCxFQUFrQixFQUFsQixDQUFwRSxHQUE0RixHQUE1Rzs7QUFDQSxNQUFJO0FBQ0YsVUFBTSxnQ0FBaUIsWUFBWSxPQUFNLEtBQUtyQixhQUFMLENBQW1CRixLQUFuQixDQUFOLEtBQW1DTCxxQkFBaEUsRUFDaUI7QUFBQ2lDLE1BQUFBLE1BQU0sRUFBRUwsT0FBVDtBQUFrQk0sTUFBQUEsVUFBVSxFQUFFO0FBQTlCLEtBRGpCLENBQU47QUFFRCxHQUhELENBR0UsT0FBT2QsQ0FBUCxFQUFVO0FBQ1ZaLG9CQUFJYSxhQUFKLENBQW1CLElBQUdoQixLQUFNLDRCQUEyQnVCLE9BQVEsWUFBL0Q7QUFDRDs7QUFDRHBCLGtCQUFJQyxJQUFKLENBQVUsSUFBR0osS0FBTSxvQ0FBbkI7O0FBQ0EsU0FBTyxJQUFQO0FBQ0QsQ0FoQkQ7O0FBMENBRixRQUFRLENBQUNnQyxVQUFULEdBQXNCLGdCQUFnQkMsT0FBaEIsRUFBeUJaLE9BQU8sR0FBRyxFQUFuQyxFQUF1QztBQUMzRCxRQUFNYSxTQUFTLEdBQUcsTUFBTSxLQUFLQyxPQUFMLENBQWFDLFlBQWIsQ0FBMEJILE9BQTFCLEVBQW1DdEMsYUFBbkMsQ0FBeEI7O0FBQ0EsTUFBSTtBQUNGLFVBQU0sS0FBS1EsR0FBTCxDQUFTa0MsT0FBVCxDQUFpQkgsU0FBakIsRUFBNEJiLE9BQTVCLENBQU47QUFDRCxHQUZELFNBRVU7QUFDUixRQUFJYSxTQUFTLEtBQUtELE9BQWxCLEVBQTJCO0FBQ3pCLFlBQU1LLGtCQUFHQyxNQUFILENBQVVMLFNBQVYsQ0FBTjtBQUNEO0FBQ0Y7QUFDRixDQVREOztlQWFlbEMsUSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IHdhaXRGb3JDb25kaXRpb24gfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgeyBmcywgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuY29uc3QgQVBQX0VYVEVOU0lPTiA9ICcuYXBrJztcbi8vIFRoZXNlIGNvbnN0YW50cyBhcmUgaW4gc3luYyB3aXRoXG4vLyBodHRwczovL2RldmVsb3Blci5hcHBsZS5jb20vZG9jdW1lbnRhdGlvbi94Y3Rlc3QveGN1aWFwcGxpY2F0aW9uc3RhdGUveGN1aWFwcGxpY2F0aW9uc3RhdGVydW5uaW5nYmFja2dyb3VuZD9sYW5ndWFnZT1vYmpjXG5jb25zdCBBUFBfU1RBVEVfTk9UX0lOU1RBTExFRCA9IDA7XG5jb25zdCBBUFBfU1RBVEVfTk9UX1JVTk5JTkcgPSAxO1xuY29uc3QgQVBQX1NUQVRFX1JVTk5JTkdfSU5fQkFDS0dST1VORCA9IDM7XG5jb25zdCBBUFBfU1RBVEVfUlVOTklOR19JTl9GT1JFR1JPVU5EID0gNDtcblxubGV0IGNvbW1hbmRzID0ge307XG5cbi8qKlxuICogVmVyaWZ5IHdoZXRoZXIgYW4gYXBwbGljYXRpb24gaXMgaW5zdGFsbGVkIG9yIG5vdFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBJZCAtIEFwcGxpY2F0aW9uIHBhY2thZ2UgaWRlbnRpZmllclxuICogQHJldHVybnMge2Jvb2xlYW59IHRydWUgaWYgdGhlIGFwcCBpcyBpbnN0YWxsZWRcbiAqL1xuY29tbWFuZHMuaXNBcHBJbnN0YWxsZWQgPSBhc3luYyBmdW5jdGlvbiAoYXBwSWQpIHtcbiAgcmV0dXJuIGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKGFwcElkKTtcbn07XG5cbi8qKlxuICogUXVlcmllcyB0aGUgY3VycmVudCBzdGF0ZSBvZiB0aGUgYXBwLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBJZCAtIEFwcGxpY2F0aW9uIHBhY2thZ2UgaWRlbnRpZmllclxuICogQHJldHVybnMge251bWJlcn0gVGhlIGNvcnJlc3BvbmRpbmcgY29uc3RhbnQsIHdoaWNoIGRlc2NyaWJlc1xuICogICAgICAgICAgICAgICAgICAgdGhlIGN1cnJlbnQgYXBwbGljYXRpb24gc3RhdGU6XG4gKiAwIC0gaXMgdGhlIGFwcCBpcyBub3QgaW5zdGFsbGVkXG4gKiAxIC0gaWYgdGhlIGFwcCBpcyBpbnN0YWxsZWQsIGJ1dCBpcyBub3QgcnVubmluZ1xuICogMyAtIGlmIHRoZSBhcHAgaXMgcnVubmluZyBpbiB0aGUgYmFja2dyb3VuZFxuICogNCAtIGlmIHRoZSBhcHAgaXMgcnVubmluZyBpbiB0aGUgZm9yZWdyb3VuZFxuICovXG5jb21tYW5kcy5xdWVyeUFwcFN0YXRlID0gYXN5bmMgZnVuY3Rpb24gKGFwcElkKSB7XG4gIGxvZy5pbmZvKGBRdWVyeWluZyB0aGUgc3RhdGUgb2YgJyR7YXBwSWR9J2ApO1xuICBpZiAoIWF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKGFwcElkKSkge1xuICAgIHJldHVybiBBUFBfU1RBVEVfTk9UX0lOU1RBTExFRDtcbiAgfVxuICBpZiAoIWF3YWl0IHRoaXMuYWRiLnByb2Nlc3NFeGlzdHMoYXBwSWQpKSB7XG4gICAgcmV0dXJuIEFQUF9TVEFURV9OT1RfUlVOTklORztcbiAgfVxuICBjb25zdCBvdXRwdXQgPSBhd2FpdCB0aGlzLmFkYi5zaGVsbChbJ2R1bXBzeXMnLCAnd2luZG93JywgJ3dpbmRvd3MnXSk7XG4gIGZvciAoY29uc3QgbGluZSBvZiBvdXRwdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgaWYgKGxpbmUuaW5jbHVkZXMoYXBwSWQpICYmIChsaW5lLmluY2x1ZGVzKCdtQ3VycmVudEZvY3VzJykgfHwgbGluZS5pbmNsdWRlcygnbUZvY3VzZWRBcHAnKSkpIHtcbiAgICAgIHJldHVybiBBUFBfU1RBVEVfUlVOTklOR19JTl9GT1JFR1JPVU5EO1xuICAgIH1cbiAgfVxuICByZXR1cm4gQVBQX1NUQVRFX1JVTk5JTkdfSU5fQkFDS0dST1VORDtcbn07XG5cbi8qKlxuICogQWN0aXZhdGVzIHRoZSBnaXZlbiBhcHBsaWNhdGlvbiBvciBsYXVuY2hlcyBpdCBpZiBuZWNlc3NhcnkuXG4gKiBUaGUgYWN0aW9uIGlzIGRvbmUgd2l0aCBtb25rZXkgdG9vbCBhbmQgbGl0ZXJhbGx5IHNpbXVsYXRlc1xuICogY2xpY2tpbmcgdGhlIGNvcnJlc3BvbmRpbmcgYXBwbGljYXRpb24gaWNvbiBvbiB0aGUgZGFzaGJvYXJkLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBJZCAtIEFwcGxpY2F0aW9uIHBhY2thZ2UgaWRlbnRpZmllclxuICovXG5jb21tYW5kcy5hY3RpdmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBJZCkge1xuICBjb25zdCBjbWQgPSBbJ21vbmtleScsXG4gICAgJy1wJywgYXBwSWQsXG4gICAgJy1jJywgJ2FuZHJvaWQuaW50ZW50LmNhdGVnb3J5LkxBVU5DSEVSJyxcbiAgICAnMSddO1xuICBsZXQgb3V0cHV0ID0gJyc7XG4gIHRyeSB7XG4gICAgbG9nLmRlYnVnKGBBY3RpdmF0aW5nICcke2FwcElkfScgd2l0aCAnYWRiIHNoZWxsICR7Y21kLmpvaW4oJyAnKX0nIGNvbW1hbmRgKTtcbiAgICBvdXRwdXQgPSBhd2FpdCB0aGlzLmFkYi5zaGVsbChjbWQpO1xuICAgIGxvZy5kZWJ1ZyhgQ29tbWFuZCBzdGRvdXQ6ICR7b3V0cHV0fWApO1xuICB9IGNhdGNoIChlKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYENhbm5vdCBhY3RpdmF0ZSAnJHthcHBJZH0nLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YCk7XG4gIH1cbiAgaWYgKG91dHB1dC5pbmNsdWRlcygnbW9ua2V5IGFib3J0ZWQnKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgYWN0aXZhdGUgJyR7YXBwSWR9Jy4gQXJlIHlvdSBzdXJlIGl0IGlzIGluc3RhbGxlZD9gKTtcbiAgfVxufTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBVbmluc3RhbGxPcHRpb25zXG4gKiBAcHJvcGVydHkge251bWJlcn0gdGltZW91dCBbMjAwMDBdIC0gVGhlIGNvdW50IG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFwcCBpcyB1bmluc3RhbGxlZC5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0ga2VlcERhdGEgW2ZhbHNlXSAtIFNldCB0byB0cnVlIGluIG9yZGVyIHRvIGtlZXAgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBkYXRhIGFuZCBjYWNoZSBmb2xkZXJzIGFmdGVyIHVuaW5zdGFsbC5cbiAqL1xuXG4vKipcbiAqIFJlbW92ZSB0aGUgY29ycmVzcG9uZGluZyBhcHBsaWNhdGlvbiBpZiBpcyBpbnN0YWxsZWQuXG4gKiBUaGUgY2FsbCBpcyBpZ25vcmVkIGlmIHRoZSBhcHAgaXMgbm90IGluc3RhbGxlZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwSWQgLSBBcHBsaWNhdGlvbiBwYWNrYWdlIGlkZW50aWZpZXJcbiAqIEBwYXJhbSB7P1VuaW5zdGFsbE9wdGlvbnN9IG9wdGlvbnMgLSBUaGUgc2V0IG9mIHJlbW92YWwgb3B0aW9uc1xuICogQHJldHVybnMge2Jvb2xlYW59IFRydWUgaWYgdGhlIHBhY2thZ2Ugd2FzIGZvdW5kIG9uIHRoZSBkZXZpY2UgYW5kXG4gKiAgICAgICAgICAgICAgICAgICAgc3VjY2Vzc2Z1bGx5IHVuaW5zdGFsbGVkLlxuICovXG5jb21tYW5kcy5yZW1vdmVBcHAgPSBhc3luYyBmdW5jdGlvbiAoYXBwSWQsIG9wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gYXdhaXQgdGhpcy5hZGIudW5pbnN0YWxsQXBrKGFwcElkLCBvcHRpb25zKTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gVGVybWluYXRlT3B0aW9uc1xuICogQHByb3BlcnR5IHtudW1iZXJ8c3RyaW5nfSB0aW1lb3V0IFs1MDBdIC0gVGhlIGNvdW50IG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwIGlzIHRlcm1pbmF0ZWQuXG4gKi9cblxuLyoqXG4gKiBUZXJtaW5hdGVzIHRoZSBhcHAgaWYgaXQgaXMgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYXBwSWQgLSBBcHBsaWNhdGlvbiBwYWNrYWdlIGlkZW50aWZpZXJcbiAqIEBwYXJhbSB7P1Rlcm1pbmF0ZU9wdGlvbnN9IG9wdGlvbnMgLSBUaGUgc2V0IG9mIGFwcGxpY2F0aW9uIHRlcm1pbmF0aW9uIG9wdGlvbnNcbiAqIEByZXR1cm5zIHtib29sZWFufSBUcnVlIGlmIHRoZSBhcHAgaGFzIGJlZW4gc3VjY2Vzc2Z1bGx5IHRlcm1pbmF0ZWQuXG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlIGFwcCBoYXMgbm90IGJlZW4gdGVybWluYXRlZCB3aXRoaW4gdGhlIGdpdmVuIHRpbWVvdXQuXG4gKi9cbmNvbW1hbmRzLnRlcm1pbmF0ZUFwcCA9IGFzeW5jIGZ1bmN0aW9uIChhcHBJZCwgb3B0aW9ucyA9IHt9KSB7XG4gIGxvZy5pbmZvKGBUZXJtaW5hdGluZyAnJHthcHBJZH0nYCk7XG4gIGlmICghKGF3YWl0IHRoaXMuYWRiLnByb2Nlc3NFeGlzdHMoYXBwSWQpKSkge1xuICAgIGxvZy5pbmZvKGBUaGUgYXBwICcke2FwcElkfScgaXMgbm90IHJ1bm5pbmdgKTtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgYXdhaXQgdGhpcy5hZGIuZm9yY2VTdG9wKGFwcElkKTtcbiAgY29uc3QgdGltZW91dCA9IHV0aWwuaGFzVmFsdWUob3B0aW9ucy50aW1lb3V0KSAmJiAhaXNOYU4ob3B0aW9ucy50aW1lb3V0KSA/IHBhcnNlSW50KG9wdGlvbnMudGltZW91dCwgMTApIDogNTAwO1xuICB0cnkge1xuICAgIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oYXN5bmMgKCkgPT4gYXdhaXQgdGhpcy5xdWVyeUFwcFN0YXRlKGFwcElkKSA8PSBBUFBfU1RBVEVfTk9UX1JVTk5JTkcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICB7d2FpdE1zOiB0aW1lb3V0LCBpbnRlcnZhbE1zOiAxMDB9KTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAnJHthcHBJZH0nIGlzIHN0aWxsIHJ1bm5pbmcgYWZ0ZXIgJHt0aW1lb3V0fW1zIHRpbWVvdXRgKTtcbiAgfVxuICBsb2cuaW5mbyhgJyR7YXBwSWR9JyBoYXMgYmVlbiBzdWNjZXNzZnVsbHkgdGVybWluYXRlZGApO1xuICByZXR1cm4gdHJ1ZTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gSW5zdGFsbE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSB0aW1lb3V0IFs2MDAwMF0gLSBUaGUgY291bnQgb2YgbWlsbGlzZWNvbmRzIHRvIHdhaXQgdW50aWwgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwIGlzIGluc3RhbGxlZC5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gYWxsb3dUZXN0UGFja2FnZXMgW2ZhbHNlXSAtIFNldCB0byB0cnVlIGluIG9yZGVyIHRvIGFsbG93IHRlc3RcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhY2thZ2VzIGluc3RhbGxhdGlvbi5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gdXNlU2RjYXJkIFtmYWxzZV0gLSBTZXQgdG8gdHJ1ZSB0byBpbnN0YWxsIHRoZSBhcHAgb24gc2RjYXJkXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zdGVhZCBvZiB0aGUgZGV2aWNlIG1lbW9yeS5cbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gZ3JhbnRQZXJtaXNzaW9ucyBbZmFsc2VdIC0gU2V0IHRvIHRydWUgaW4gb3JkZXIgdG8gZ3JhbnQgYWxsIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwZXJtaXNzaW9ucyByZXF1ZXN0ZWQgaW4gdGhlIGFwcGxpY2F0aW9uJ3MgbWFuaWZlc3RcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXV0b21hdGljYWxseSBhZnRlciB0aGUgaW5zdGFsbGF0aW9uIGlzIGNvbXBsZXRlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmRlciBBbmRyb2lkIDYrLlxuICogQHByb3BlcnR5IHtib29sZWFufSByZXBsYWNlIFt0cnVlXSAtIFNldCBpdCB0byBmYWxzZSBpZiB5b3UgZG9uJ3Qgd2FudFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoZSBhcHBsaWNhdGlvbiB0byBiZSB1cGdyYWRlZC9yZWluc3RhbGxlZFxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGl0IGlzIGFscmVhZHkgcHJlc2VudCBvbiB0aGUgZGV2aWNlLlxuICovXG5cbi8qKlxuICogSW5zdGFsbHMgdGhlIGdpdmVuIGFwcGxpY2F0aW9uIHRvIHRoZSBkZXZpY2UgdW5kZXIgdGVzdFxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBhcHBQYXRoIC0gVGhlIGxvY2FsIGFwayBwYXRoIG9yIGEgcmVtb3RlIHVybFxuICogQHBhcmFtIHs/SW5zdGFsbE9wdGlvbnN9IG9wdGlvbnMgLSBUaGUgc2V0IG9mIGluc3RhbGxhdGlvbiBvcHRpb25zXG4gKiBAdGhyb3dzIHtFcnJvcn0gaWYgdGhlIGdpdmVuIGFwayBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgcmVhY2hhYmxlXG4gKi9cbmNvbW1hbmRzLmluc3RhbGxBcHAgPSBhc3luYyBmdW5jdGlvbiAoYXBwUGF0aCwgb3B0aW9ucyA9IHt9KSB7XG4gIGNvbnN0IGxvY2FsUGF0aCA9IGF3YWl0IHRoaXMuaGVscGVycy5jb25maWd1cmVBcHAoYXBwUGF0aCwgQVBQX0VYVEVOU0lPTik7XG4gIHRyeSB7XG4gICAgYXdhaXQgdGhpcy5hZGIuaW5zdGFsbChsb2NhbFBhdGgsIG9wdGlvbnMpO1xuICB9IGZpbmFsbHkge1xuICAgIGlmIChsb2NhbFBhdGggIT09IGFwcFBhdGgpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihsb2NhbFBhdGgpO1xuICAgIH1cbiAgfVxufTtcblxuXG5leHBvcnQgeyBjb21tYW5kcyB9O1xuZXhwb3J0IGRlZmF1bHQgY29tbWFuZHM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9hcHAtbWFuYWdlbWVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
