"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.setupNewChromedriver = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("../logger"));

var _appiumChromedriver = _interopRequireDefault(require("appium-chromedriver"));

var _portfinder = _interopRequireDefault(require("portfinder"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _webviewHelpers = _interopRequireWildcard(require("../webview-helpers"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getCurrentContext = async function () {
  return this.curContext || this.defaultContextName();
};

commands.getContexts = async function () {
  let webviews;

  if (this.isChromeSession) {
    webviews = [_webviewHelpers.CHROMIUM_WIN];
  } else {
    webviews = await _webviewHelpers.default.getWebviews(this.adb, this.opts.androidDeviceSocket);
  }

  this.contexts = _lodash.default.union([_webviewHelpers.NATIVE_WIN], webviews);

  _logger.default.debug(`Available contexts: ${JSON.stringify(this.contexts)}`);

  return this.contexts;
};

commands.setContext = async function (name) {
  if (name === null) {
    name = this.defaultContextName();
  } else if (name === _webviewHelpers.WEBVIEW_WIN) {
    name = this.defaultWebviewName();
  }

  let contexts = await this.getContexts();

  if (!_lodash.default.includes(contexts, name)) {
    throw new _appiumBaseDriver.errors.NoSuchContextError();
  }

  if (name === this.curContext) {
    return;
  }

  await this.switchContext(name);
  this.curContext = name;
};

helpers.switchContext = async function (name) {
  if (this.isChromedriverContext(name)) {
    await this.startChromedriverProxy(name);
  } else if (this.isChromedriverContext(this.curContext)) {
    if (this.opts.recreateChromeDriverSessions) {
      _logger.default.debug("recreateChromeDriverSessions set to true; killing existing chromedrivers");

      await this.stopChromedriverProxies();
    } else {
      await this.suspendChromedriverProxy();
    }
  } else {
    throw new Error(`Didn't know how to handle switching to context '${name}'`);
  }
};

helpers.defaultContextName = function () {
  return _webviewHelpers.NATIVE_WIN;
};

helpers.defaultWebviewName = function () {
  return _webviewHelpers.WEBVIEW_BASE + this.opts.appPackage;
};

helpers.isWebContext = function () {
  return this.curContext !== null && this.curContext !== _webviewHelpers.NATIVE_WIN;
};

helpers.startChromedriverProxy = async function (context) {
  _logger.default.debug(`Connecting to chrome-backed webview context '${context}'`);

  let cd;

  if (this.sessionChromedrivers[context]) {
    _logger.default.debug(`Found existing Chromedriver for context '${context}'. Using it.`);

    cd = this.sessionChromedrivers[context];
    await setupExistingChromedriver(cd);
  } else {
    let opts = _lodash.default.cloneDeep(this.opts);

    opts.chromeUseRunningApp = true;

    if (opts.extractChromeAndroidPackageFromContextName) {
      let androidPackage = context.match(`${_webviewHelpers.WEBVIEW_BASE}(.+)`);

      if (androidPackage && androidPackage.length > 0) {
        opts.chromeAndroidPackage = androidPackage[1];
      }
    }

    cd = await this.setupNewChromedriver(opts, this.adb.curDeviceId, this.adb);
    cd.on(_appiumChromedriver.default.EVENT_CHANGED, msg => {
      if (msg.state === _appiumChromedriver.default.STATE_STOPPED) {
        this.onChromedriverStop(context);
      }
    });
    this.sessionChromedrivers[context] = cd;
  }

  this.chromedriver = cd;
  this.proxyReqRes = this.chromedriver.proxyReq.bind(this.chromedriver);
  this.jwpProxyActive = true;
};

helpers.suspendChromedriverProxy = function () {
  this.chromedriver = null;
  this.proxyReqRes = null;
  this.jwpProxyActive = false;
};

helpers.onChromedriverStop = async function (context) {
  _logger.default.warn(`Chromedriver for context ${context} stopped unexpectedly`);

  if (context === this.curContext) {
    let err = new Error("Chromedriver quit unexpectedly during session");
    await this.startUnexpectedShutdown(err);
  } else {
    _logger.default.warn("Chromedriver quit unexpectedly, but it wasn't the active " + "context, ignoring");

    delete this.sessionChromedrivers[context];
  }
};

helpers.stopChromedriverProxies = async function () {
  this.suspendChromedriverProxy();

  for (let context of _lodash.default.keys(this.sessionChromedrivers)) {
    let cd = this.sessionChromedrivers[context];

    _logger.default.debug(`Stopping chromedriver for context ${context}`);

    cd.removeAllListeners(_appiumChromedriver.default.EVENT_CHANGED);

    try {
      await cd.stop();
    } catch (err) {
      _logger.default.warn(`Error stopping Chromedriver: ${err.message}`);
    }

    delete this.sessionChromedrivers[context];
  }
};

helpers.isChromedriverContext = function (viewName) {
  return _lodash.default.includes(viewName, _webviewHelpers.WEBVIEW_WIN) || viewName === _webviewHelpers.CHROMIUM_WIN;
};

helpers.shouldDismissChromeWelcome = function shouldDismissChromeWelcome() {
  return !!this.opts.chromeOptions && _lodash.default.isArray(this.opts.chromeOptions.args) && this.opts.chromeOptions.args.includes('--no-first-run');
};

helpers.dismissChromeWelcome = async function dismissChromeWelcome() {
  _logger.default.info("Trying to dismiss Chrome welcome");

  let activity = await this.getCurrentActivity();

  if (activity !== "org.chromium.chrome.browser.firstrun.FirstRunActivity") {
    _logger.default.info("Chrome welcome dialog never showed up! Continuing");

    return;
  }

  let el = await this.findElOrEls('id', 'com.android.chrome:id/terms_accept', false);
  await this.click(el.ELEMENT);

  try {
    let el = await this.findElOrEls('id', 'com.android.chrome:id/negative_button', false);
    await this.click(el.ELEMENT);
  } catch (e) {
    _logger.default.warn(`This device did not show Chrome SignIn dialog, ${e.message}`);
  }
};

helpers.startChromeSession = async function startChromeSession() {
  _logger.default.info("Starting a chrome-based browser session");

  let opts = _lodash.default.cloneDeep(this.opts);

  opts.chromeUseRunningApp = false;
  const knownPackages = ['org.chromium.chrome.shell', 'com.android.chrome', 'com.chrome.beta', 'org.chromium.chrome', 'org.chromium.webview_shell'];

  if (_lodash.default.includes(knownPackages, this.opts.appPackage)) {
    opts.chromeBundleId = this.opts.appPackage;
  } else {
    opts.chromeAndroidActivity = this.opts.appActivity;
  }

  this.chromedriver = await this.setupNewChromedriver(opts, this.adb.curDeviceId, this.adb);
  this.chromedriver.on(_appiumChromedriver.default.EVENT_CHANGED, msg => {
    if (msg.state === _appiumChromedriver.default.STATE_STOPPED) {
      this.onChromedriverStop(_webviewHelpers.CHROMIUM_WIN);
    }
  });
  this.curContext = _webviewHelpers.CHROMIUM_WIN;
  this.sessionChromedrivers[_webviewHelpers.CHROMIUM_WIN] = this.chromedriver;
  this.proxyReqRes = this.chromedriver.proxyReq.bind(this.chromedriver);
  this.jwpProxyActive = true;

  if (this.shouldDismissChromeWelcome()) {
    await this.dismissChromeWelcome();
  }
};

async function setupExistingChromedriver(chromedriver) {
  if (!(await chromedriver.hasWorkingWebview())) {
    _logger.default.debug("ChromeDriver is not associated with a window. " + "Re-initializing the session.");

    await chromedriver.restart();
  }

  return chromedriver;
}

helpers.setupNewChromedriver = async function setupNewChromedriver(opts, curDeviceId, adb) {
  if (!opts.chromeDriverPort) {
    const getPort = _bluebird.default.promisify(_portfinder.default.getPort, {
      context: _portfinder.default
    });

    opts.chromeDriverPort = await getPort();

    _logger.default.debug(`A port was not given, using random port: ${opts.chromeDriverPort}`);
  }

  const chromedriver = new _appiumChromedriver.default({
    port: opts.chromeDriverPort,
    executable: opts.chromedriverExecutable,
    adb,
    verbose: !!opts.showChromedriverLog,
    executableDir: opts.chromedriverExecutableDir,
    mappingPath: opts.chromedriverChromeMappingFile,
    bundleId: opts.chromeBundleId,
    useSystemExecutable: opts.chromedriverUseSystemExecutable,
    disableBuildCheck: opts.chromedriverDisableBuildCheck
  });
  opts.chromeOptions = opts.chromeOptions || {};

  for (const opt of _lodash.default.keys(opts)) {
    if (opt.endsWith(':chromeOptions')) {
      _logger.default.warn(`Merging '${opt}' into 'chromeOptions'. This may cause unexpected behavior`);

      _lodash.default.merge(opts.chromeOptions, opts[opt]);
    }
  }

  let caps = {
    chromeOptions: {
      androidPackage: opts.chromeOptions.androidPackage || opts.appPackage
    }
  };

  if (opts.chromeUseRunningApp) {
    caps.chromeOptions.androidUseRunningApp = opts.chromeUseRunningApp;
  }

  if (opts.chromeAndroidPackage) {
    caps.chromeOptions.androidPackage = opts.chromeAndroidPackage;
  }

  if (opts.chromeAndroidActivity) {
    caps.chromeOptions.androidActivity = opts.chromeAndroidActivity;
  }

  if (opts.chromeAndroidProcess) {
    caps.chromeOptions.androidProcess = opts.chromeAndroidProcess;
  }

  if (opts.loggingPrefs) {
    caps.loggingPrefs = opts.loggingPrefs;
  }

  if (opts.enablePerformanceLogging) {
    _logger.default.warn(`The 'enablePerformanceLogging' cap is deprecated; simply use ` + `the 'loggingPrefs' cap instead, with a 'performance' key set to 'ALL'`);

    const newPref = {
      performance: 'ALL'
    };
    caps.loggingPrefs = caps.loggingPrefs ? Object.assign({}, caps.loggingPrefs, newPref) : newPref;
  }

  if (opts.browserName === 'chromium-webview') {
    caps.chromeOptions.androidActivity = opts.appActivity;
  }

  if (opts.pageLoadStrategy) {
    caps.pageLoadStrategy = opts.pageLoadStrategy;
  }

  caps = _webviewHelpers.default.decorateChromeOptions(caps, opts, curDeviceId);
  await chromedriver.start(caps);
  return chromedriver;
};

const setupNewChromedriver = helpers.setupNewChromedriver;
exports.setupNewChromedriver = setupNewChromedriver;
Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbImNvbW1hbmRzIiwiaGVscGVycyIsImV4dGVuc2lvbnMiLCJnZXRDdXJyZW50Q29udGV4dCIsImN1ckNvbnRleHQiLCJkZWZhdWx0Q29udGV4dE5hbWUiLCJnZXRDb250ZXh0cyIsIndlYnZpZXdzIiwiaXNDaHJvbWVTZXNzaW9uIiwiQ0hST01JVU1fV0lOIiwid2Vidmlld0hlbHBlcnMiLCJnZXRXZWJ2aWV3cyIsImFkYiIsIm9wdHMiLCJhbmRyb2lkRGV2aWNlU29ja2V0IiwiY29udGV4dHMiLCJfIiwidW5pb24iLCJOQVRJVkVfV0lOIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5Iiwic2V0Q29udGV4dCIsIm5hbWUiLCJXRUJWSUVXX1dJTiIsImRlZmF1bHRXZWJ2aWV3TmFtZSIsImluY2x1ZGVzIiwiZXJyb3JzIiwiTm9TdWNoQ29udGV4dEVycm9yIiwic3dpdGNoQ29udGV4dCIsImlzQ2hyb21lZHJpdmVyQ29udGV4dCIsInN0YXJ0Q2hyb21lZHJpdmVyUHJveHkiLCJyZWNyZWF0ZUNocm9tZURyaXZlclNlc3Npb25zIiwic3RvcENocm9tZWRyaXZlclByb3hpZXMiLCJzdXNwZW5kQ2hyb21lZHJpdmVyUHJveHkiLCJFcnJvciIsIldFQlZJRVdfQkFTRSIsImFwcFBhY2thZ2UiLCJpc1dlYkNvbnRleHQiLCJjb250ZXh0IiwiY2QiLCJzZXNzaW9uQ2hyb21lZHJpdmVycyIsInNldHVwRXhpc3RpbmdDaHJvbWVkcml2ZXIiLCJjbG9uZURlZXAiLCJjaHJvbWVVc2VSdW5uaW5nQXBwIiwiZXh0cmFjdENocm9tZUFuZHJvaWRQYWNrYWdlRnJvbUNvbnRleHROYW1lIiwiYW5kcm9pZFBhY2thZ2UiLCJtYXRjaCIsImxlbmd0aCIsImNocm9tZUFuZHJvaWRQYWNrYWdlIiwic2V0dXBOZXdDaHJvbWVkcml2ZXIiLCJjdXJEZXZpY2VJZCIsIm9uIiwiQ2hyb21lZHJpdmVyIiwiRVZFTlRfQ0hBTkdFRCIsIm1zZyIsInN0YXRlIiwiU1RBVEVfU1RPUFBFRCIsIm9uQ2hyb21lZHJpdmVyU3RvcCIsImNocm9tZWRyaXZlciIsInByb3h5UmVxUmVzIiwicHJveHlSZXEiLCJiaW5kIiwiandwUHJveHlBY3RpdmUiLCJ3YXJuIiwiZXJyIiwic3RhcnRVbmV4cGVjdGVkU2h1dGRvd24iLCJrZXlzIiwicmVtb3ZlQWxsTGlzdGVuZXJzIiwic3RvcCIsIm1lc3NhZ2UiLCJ2aWV3TmFtZSIsInNob3VsZERpc21pc3NDaHJvbWVXZWxjb21lIiwiY2hyb21lT3B0aW9ucyIsImlzQXJyYXkiLCJhcmdzIiwiZGlzbWlzc0Nocm9tZVdlbGNvbWUiLCJpbmZvIiwiYWN0aXZpdHkiLCJnZXRDdXJyZW50QWN0aXZpdHkiLCJlbCIsImZpbmRFbE9yRWxzIiwiY2xpY2siLCJFTEVNRU5UIiwiZSIsInN0YXJ0Q2hyb21lU2Vzc2lvbiIsImtub3duUGFja2FnZXMiLCJjaHJvbWVCdW5kbGVJZCIsImNocm9tZUFuZHJvaWRBY3Rpdml0eSIsImFwcEFjdGl2aXR5IiwiaGFzV29ya2luZ1dlYnZpZXciLCJyZXN0YXJ0IiwiY2hyb21lRHJpdmVyUG9ydCIsImdldFBvcnQiLCJCIiwicHJvbWlzaWZ5IiwiUG9ydEZpbmRlciIsInBvcnQiLCJleGVjdXRhYmxlIiwiY2hyb21lZHJpdmVyRXhlY3V0YWJsZSIsInZlcmJvc2UiLCJzaG93Q2hyb21lZHJpdmVyTG9nIiwiZXhlY3V0YWJsZURpciIsImNocm9tZWRyaXZlckV4ZWN1dGFibGVEaXIiLCJtYXBwaW5nUGF0aCIsImNocm9tZWRyaXZlckNocm9tZU1hcHBpbmdGaWxlIiwiYnVuZGxlSWQiLCJ1c2VTeXN0ZW1FeGVjdXRhYmxlIiwiY2hyb21lZHJpdmVyVXNlU3lzdGVtRXhlY3V0YWJsZSIsImRpc2FibGVCdWlsZENoZWNrIiwiY2hyb21lZHJpdmVyRGlzYWJsZUJ1aWxkQ2hlY2siLCJvcHQiLCJlbmRzV2l0aCIsIm1lcmdlIiwiY2FwcyIsImFuZHJvaWRVc2VSdW5uaW5nQXBwIiwiYW5kcm9pZEFjdGl2aXR5IiwiY2hyb21lQW5kcm9pZFByb2Nlc3MiLCJhbmRyb2lkUHJvY2VzcyIsImxvZ2dpbmdQcmVmcyIsImVuYWJsZVBlcmZvcm1hbmNlTG9nZ2luZyIsIm5ld1ByZWYiLCJwZXJmb3JtYW5jZSIsIk9iamVjdCIsImFzc2lnbiIsImJyb3dzZXJOYW1lIiwicGFnZUxvYWRTdHJhdGVneSIsImRlY29yYXRlQ2hyb21lT3B0aW9ucyIsInN0YXJ0Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBSUEsSUFBSUEsUUFBUSxHQUFHLEVBQWY7QUFBQSxJQUFtQkMsT0FBTyxHQUFHLEVBQTdCO0FBQUEsSUFBaUNDLFVBQVUsR0FBRyxFQUE5Qzs7OztBQU1BRixRQUFRLENBQUNHLGlCQUFULEdBQTZCLGtCQUFrQjtBQUc3QyxTQUFPLEtBQUtDLFVBQUwsSUFBbUIsS0FBS0Msa0JBQUwsRUFBMUI7QUFDRCxDQUpEOztBQU1BTCxRQUFRLENBQUNNLFdBQVQsR0FBdUIsa0JBQWtCO0FBQ3ZDLE1BQUlDLFFBQUo7O0FBQ0EsTUFBSSxLQUFLQyxlQUFULEVBQTBCO0FBR3hCRCxJQUFBQSxRQUFRLEdBQUcsQ0FBQ0UsNEJBQUQsQ0FBWDtBQUNELEdBSkQsTUFJTztBQUVMRixJQUFBQSxRQUFRLEdBQUcsTUFBTUcsd0JBQWVDLFdBQWYsQ0FBMkIsS0FBS0MsR0FBaEMsRUFDZixLQUFLQyxJQUFMLENBQVVDLG1CQURLLENBQWpCO0FBRUQ7O0FBQ0QsT0FBS0MsUUFBTCxHQUFnQkMsZ0JBQUVDLEtBQUYsQ0FBUSxDQUFDQywwQkFBRCxDQUFSLEVBQXNCWCxRQUF0QixDQUFoQjs7QUFDQVksa0JBQUlDLEtBQUosQ0FBVyx1QkFBc0JDLElBQUksQ0FBQ0MsU0FBTCxDQUFlLEtBQUtQLFFBQXBCLENBQThCLEVBQS9EOztBQUNBLFNBQU8sS0FBS0EsUUFBWjtBQUNELENBZEQ7O0FBZ0JBZixRQUFRLENBQUN1QixV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Q0FBQ0ssWUFBTCxHQUFvQjNHLElBQUksQ0FBQzJHLFlBQXpCO0FBQ0Q7O0FBQ0QsTUFBSTNHLElBQUksQ0FBQzRHLHdCQUFULEVBQW1DO0FBQ2pDdEcsb0JBQUk4QyxJQUFKLENBQVUsK0RBQUQsR0FDQyx1RUFEVjs7QUFFQSxVQUFNeUQsT0FBTyxHQUFHO0FBQUNDLE1BQUFBLFdBQVcsRUFBRTtBQUFkLEtBQWhCO0FBR0FSLElBQUFBLElBQUksQ0FBQ0ssWUFBTCxHQUFvQkwsSUFBSSxDQUFDSyxZQUFMLEdBQ2xCSSxNQUFNLENBQUNDLE1BQVAsQ0FBYyxFQUFkLEVBQWtCVixJQUFJLENBQUNLLFlBQXZCLEVBQXFDRSxPQUFyQyxDQURrQixHQUVsQkEsT0FGRjtBQUdEOztBQUNELE1BQUk3RyxJQUFJLENBQUNpSCxXQUFMLEtBQXFCLGtCQUF6QixFQUE2QztBQUMzQ1gsSUFBQUEsSUFBSSxDQUFDekMsYUFBTCxDQUFtQjJDLGVBQW5CLEdBQXFDeEcsSUFBSSxDQUFDNkUsV0FBMUM7QUFDRDs7QUFDRCxNQUFJN0UsSUFBSSxDQUFDa0gsZ0JBQVQsRUFBMkI7QUFDekJaLElBQUFBLElBQUksQ0FBQ1ksZ0JBQUwsR0FBd0JsSCxJQUFJLENBQUNrSCxnQkFBN0I7QUFDRDs7QUFDRFosRUFBQUEsSUFBSSxHQUFHekcsd0JBQWVzSCxxQkFBZixDQUFxQ2IsSUFBckMsRUFBMkN0RyxJQUEzQyxFQUFpRHVDLFdBQWpELENBQVA7QUFDQSxRQUFNUSxZQUFZLENBQUNxRSxLQUFiLENBQW1CZCxJQUFuQixDQUFOO0FBQ0EsU0FBT3ZELFlBQVA7QUFDRCxDQXRFRDs7QUF1RUEsTUFBTVQsb0JBQW9CLEdBQUdsRCxPQUFPLENBQUNrRCxvQkFBckM7O0FBRUF5RSxNQUFNLENBQUNDLE1BQVAsQ0FBYzNILFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCBDaHJvbWVkcml2ZXIgZnJvbSAnYXBwaXVtLWNocm9tZWRyaXZlcic7XG5pbXBvcnQgUG9ydEZpbmRlciBmcm9tICdwb3J0ZmluZGVyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBkZWZhdWx0IGFzIHdlYnZpZXdIZWxwZXJzLFxuICAgICAgICAgTkFUSVZFX1dJTiwgV0VCVklFV19CQVNFLCBXRUJWSUVXX1dJTiwgQ0hST01JVU1fV0lOIH0gZnJvbSAnLi4vd2Vidmlldy1oZWxwZXJzJztcblxuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cblxuLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogQWN0dWFsIE1KU09OV1AgY29tbWFuZCBoYW5kbGVyc1xuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqL1xuY29tbWFuZHMuZ2V0Q3VycmVudENvbnRleHQgPSBhc3luYyBmdW5jdGlvbiAoKSB7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hd2FpdFxuICAvLyBpZiB0aGUgY3VycmVudCBjb250ZXh0IGlzIGBudWxsYCwgaW5kaWNhdGluZyBubyBjb250ZXh0XG4gIC8vIGV4cGxpY2l0bHkgc2V0LCBpdCBpcyB0aGUgZGVmYXVsdCBjb250ZXh0XG4gIHJldHVybiB0aGlzLmN1ckNvbnRleHQgfHwgdGhpcy5kZWZhdWx0Q29udGV4dE5hbWUoKTtcbn07XG5cbmNvbW1hbmRzLmdldENvbnRleHRzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICBsZXQgd2Vidmlld3M7XG4gIGlmICh0aGlzLmlzQ2hyb21lU2Vzc2lvbikge1xuICAgIC8vIGlmIHdlIGhhdmUgYSBDaHJvbWUgYnJvd3NlciBzZXNzaW9uLCB3ZSBvbmx5IGNhcmUgYWJvdXQgdGhlIENocm9tZVxuICAgIC8vIGNvbnRleHQgYW5kIHRoZSBuYXRpdmUgY29udGV4dFxuICAgIHdlYnZpZXdzID0gW0NIUk9NSVVNX1dJTl07XG4gIH0gZWxzZSB7XG4gICAgLy8gb3RoZXJ3aXNlIHdlIHVzZSBBREIgdG8gZmlndXJlIG91dCB3aGljaCB3ZWJ2aWV3cyBhcmUgYXZhaWxhYmxlXG4gICAgd2Vidmlld3MgPSBhd2FpdCB3ZWJ2aWV3SGVscGVycy5nZXRXZWJ2aWV3cyh0aGlzLmFkYixcbiAgICAgIHRoaXMub3B0cy5hbmRyb2lkRGV2aWNlU29ja2V0KTtcbiAgfVxuICB0aGlzLmNvbnRleHRzID0gXy51bmlvbihbTkFUSVZFX1dJTl0sIHdlYnZpZXdzKTtcbiAgbG9nLmRlYnVnKGBBdmFpbGFibGUgY29udGV4dHM6ICR7SlNPTi5zdHJpbmdpZnkodGhpcy5jb250ZXh0cyl9YCk7XG4gIHJldHVybiB0aGlzLmNvbnRleHRzO1xufTtcblxuY29tbWFuZHMuc2V0Q29udGV4dCA9IGFzeW5jIGZ1bmN0aW9uIChuYW1lKSB7XG4gIGlmIChuYW1lID09PSBudWxsKSB7XG4gICAgbmFtZSA9IHRoaXMuZGVmYXVsdENvbnRleHROYW1lKCk7XG4gIH0gZWxzZSBpZiAobmFtZSA9PT0gV0VCVklFV19XSU4pIHtcbiAgICAvLyBoYW5kbGUgc2V0Q29udGV4dCBcIldFQlZJRVdcIlxuICAgIG5hbWUgPSB0aGlzLmRlZmF1bHRXZWJ2aWV3TmFtZSgpO1xuICB9XG4gIGxldCBjb250ZXh0cyA9IGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcbiAgLy8gaWYgdGhlIGNvbnRleHQgd2Ugd2FudCBkb2Vzbid0IGV4aXN0LCBmYWlsXG4gIGlmICghXy5pbmNsdWRlcyhjb250ZXh0cywgbmFtZSkpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaENvbnRleHRFcnJvcigpO1xuICB9XG4gIC8vIGlmIHdlJ3JlIGFscmVhZHkgaW4gdGhlIGNvbnRleHQgd2Ugd2FudCwgZG8gbm90aGluZ1xuICBpZiAobmFtZSA9PT0gdGhpcy5jdXJDb250ZXh0KSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgYXdhaXQgdGhpcy5zd2l0Y2hDb250ZXh0KG5hbWUpO1xuICB0aGlzLmN1ckNvbnRleHQgPSBuYW1lO1xufTtcblxuaGVscGVycy5zd2l0Y2hDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUpIHtcbiAgLy8gV2UgaGF2ZSBzb21lIG9wdGlvbnMgd2hlbiBpdCBjb21lcyB0byB3ZWJ2aWV3cy4gSWYgd2Ugd2FudCBhXG4gIC8vIENocm9tZWRyaXZlciB3ZWJ2aWV3LCB3ZSBjYW4gb25seSBjb250cm9sIG9uZSBhdCBhIHRpbWUuXG4gIGlmICh0aGlzLmlzQ2hyb21lZHJpdmVyQ29udGV4dChuYW1lKSkge1xuICAgIC8vIHN0YXJ0IHByb3h5aW5nIGNvbW1hbmRzIGRpcmVjdGx5IHRvIGNocm9tZWRyaXZlclxuICAgIGF3YWl0IHRoaXMuc3RhcnRDaHJvbWVkcml2ZXJQcm94eShuYW1lKTtcbiAgfSBlbHNlIGlmICh0aGlzLmlzQ2hyb21lZHJpdmVyQ29udGV4dCh0aGlzLmN1ckNvbnRleHQpKSB7XG4gICAgLy8gaWYgd2UncmUgbW92aW5nIHRvIGEgbm9uLWNocm9tZWRyaXZlciB3ZWJ2aWV3LCBhbmQgb3VyIGN1cnJlbnQgY29udGV4dFxuICAgIC8vIF9pc18gYSBjaHJvbWVkcml2ZXIgd2VidmlldywgaWYgY2FwcyByZWNyZWF0ZUNocm9tZURyaXZlclNlc3Npb25zIGlzIHNldFxuICAgIC8vIHRvIHRydWUgdGhlbiBraWxsIGNocm9tZWRyaXZlciBzZXNzaW9uIHVzaW5nIHN0b3BDaHJvbWVkcml2ZXJQcm94aWVzIG9yXG4gICAgLy8gZWxzZSBzaW1wbHkgc3VzcGVuZCBwcm94eWluZyB0byB0aGUgbGF0dGVyXG4gICAgaWYgKHRoaXMub3B0cy5yZWNyZWF0ZUNocm9tZURyaXZlclNlc3Npb25zKSB7XG4gICAgICBsb2cuZGVidWcoXCJyZWNyZWF0ZUNocm9tZURyaXZlclNlc3Npb25zIHNldCB0byB0cnVlOyBraWxsaW5nIGV4aXN0aW5nIGNocm9tZWRyaXZlcnNcIik7XG4gICAgICBhd2FpdCB0aGlzLnN0b3BDaHJvbWVkcml2ZXJQcm94aWVzKCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGF3YWl0IHRoaXMuc3VzcGVuZENocm9tZWRyaXZlclByb3h5KCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIHRocm93IG5ldyBFcnJvcihgRGlkbid0IGtub3cgaG93IHRvIGhhbmRsZSBzd2l0Y2hpbmcgdG8gY29udGV4dCAnJHtuYW1lfSdgKTtcbiAgfVxufTtcblxuXG4vKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqIE9uLW9iamVjdCBjb250ZXh0LXJlbGF0ZWQgaGVscGVyc1xuICogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbi8vIFRoZSByZWFzb24gdGhpcyBpcyBhIGZ1bmN0aW9uIGFuZCBub3QganVzdCBhIGNvbnN0YW50IGlzIHRoYXQgYm90aCBhbmRyb2lkLVxuLy8gZHJpdmVyIGFuZCBzZWxlbmRyb2lkLWRyaXZlciB1c2UgdGhpcyBsb2dpYywgYW5kIGVhY2ggb25lIHJldHVybnNcbi8vIGEgZGlmZmVyZW50IGRlZmF1bHQgY29udGV4dCBuYW1lXG5oZWxwZXJzLmRlZmF1bHRDb250ZXh0TmFtZSA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIE5BVElWRV9XSU47XG59O1xuXG5oZWxwZXJzLmRlZmF1bHRXZWJ2aWV3TmFtZSA9IGZ1bmN0aW9uICgpIHtcbiAgcmV0dXJuIFdFQlZJRVdfQkFTRSArIHRoaXMub3B0cy5hcHBQYWNrYWdlO1xufTtcblxuaGVscGVycy5pc1dlYkNvbnRleHQgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiB0aGlzLmN1ckNvbnRleHQgIT09IG51bGwgJiYgdGhpcy5jdXJDb250ZXh0ICE9PSBOQVRJVkVfV0lOO1xufTtcblxuLy8gVHVybiBvbiBwcm94eWluZyB0byBhbiBleGlzdGluZyBDaHJvbWVkcml2ZXIgc2Vzc2lvbiBvciBhIG5ldyBvbmVcbmhlbHBlcnMuc3RhcnRDaHJvbWVkcml2ZXJQcm94eSA9IGFzeW5jIGZ1bmN0aW9uIChjb250ZXh0KSB7XG4gIGxvZy5kZWJ1ZyhgQ29ubmVjdGluZyB0byBjaHJvbWUtYmFja2VkIHdlYnZpZXcgY29udGV4dCAnJHtjb250ZXh0fSdgKTtcblxuICBsZXQgY2Q7XG4gIGlmICh0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW2NvbnRleHRdKSB7XG4gICAgLy8gaW4gdGhlIGNhc2Ugd2hlcmUgd2UndmUgYWxyZWFkeSBzZXQgdXAgYSBjaHJvbWVkcml2ZXIgZm9yIGEgY29udGV4dCxcbiAgICAvLyB3ZSB3YW50IHRvIHJlY29ubmVjdCB0byBpdCwgbm90IGNyZWF0ZSBhIHdob2xlIG5ldyBvbmVcbiAgICBsb2cuZGVidWcoYEZvdW5kIGV4aXN0aW5nIENocm9tZWRyaXZlciBmb3IgY29udGV4dCAnJHtjb250ZXh0fScuIFVzaW5nIGl0LmApO1xuICAgIGNkID0gdGhpcy5zZXNzaW9uQ2hyb21lZHJpdmVyc1tjb250ZXh0XTtcbiAgICBhd2FpdCBzZXR1cEV4aXN0aW5nQ2hyb21lZHJpdmVyKGNkKTtcbiAgfSBlbHNlIHtcbiAgICBsZXQgb3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG4gICAgb3B0cy5jaHJvbWVVc2VSdW5uaW5nQXBwID0gdHJ1ZTtcbiAgICBpZiAob3B0cy5leHRyYWN0Q2hyb21lQW5kcm9pZFBhY2thZ2VGcm9tQ29udGV4dE5hbWUpIHtcbiAgICAgIGxldCBhbmRyb2lkUGFja2FnZSA9IGNvbnRleHQubWF0Y2goYCR7V0VCVklFV19CQVNFfSguKylgKTtcbiAgICAgIGlmIChhbmRyb2lkUGFja2FnZSAmJiBhbmRyb2lkUGFja2FnZS5sZW5ndGggPiAwKSB7XG4gICAgICAgIG9wdHMuY2hyb21lQW5kcm9pZFBhY2thZ2UgPSBhbmRyb2lkUGFja2FnZVsxXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjZCA9IGF3YWl0IHRoaXMuc2V0dXBOZXdDaHJvbWVkcml2ZXIob3B0cywgdGhpcy5hZGIuY3VyRGV2aWNlSWQsIHRoaXMuYWRiKTtcbiAgICAvLyBiaW5kIG91ciBzdG9wL2V4aXQgaGFuZGxlciwgcGFzc2luZyBpbiBjb250ZXh0IHNvIHdlIGtub3cgd2hpY2hcbiAgICAvLyBvbmUgc3RvcHBlZCB1bmV4cGVjdGVkbHlcbiAgICBjZC5vbihDaHJvbWVkcml2ZXIuRVZFTlRfQ0hBTkdFRCwgKG1zZykgPT4ge1xuICAgICAgaWYgKG1zZy5zdGF0ZSA9PT0gQ2hyb21lZHJpdmVyLlNUQVRFX1NUT1BQRUQpIHtcbiAgICAgICAgdGhpcy5vbkNocm9tZWRyaXZlclN0b3AoY29udGV4dCk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgLy8gc2F2ZSB0aGUgY2hyb21lZHJpdmVyIG9iamVjdCB1bmRlciB0aGUgY29udGV4dFxuICAgIHRoaXMuc2Vzc2lvbkNocm9tZWRyaXZlcnNbY29udGV4dF0gPSBjZDtcbiAgfVxuICAvLyBob29rIHVwIHRoZSBsb2NhbCB2YXJpYWJsZXMgc28gd2UgY2FuIHByb3h5IHRoaXMgYml6XG4gIHRoaXMuY2hyb21lZHJpdmVyID0gY2Q7XG4gIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmNocm9tZWRyaXZlci5wcm94eVJlcS5iaW5kKHRoaXMuY2hyb21lZHJpdmVyKTtcbiAgdGhpcy5qd3BQcm94eUFjdGl2ZSA9IHRydWU7XG59O1xuXG4vLyBTdG9wIHByb3h5aW5nIHRvIGFueSBDaHJvbWVkcml2ZXJcbmhlbHBlcnMuc3VzcGVuZENocm9tZWRyaXZlclByb3h5ID0gZnVuY3Rpb24gKCkge1xuICB0aGlzLmNocm9tZWRyaXZlciA9IG51bGw7XG4gIHRoaXMucHJveHlSZXFSZXMgPSBudWxsO1xuICB0aGlzLmp3cFByb3h5QWN0aXZlID0gZmFsc2U7XG59O1xuXG4vLyBIYW5kbGUgYW4gb3V0LW9mLWJhbmQgQ2hyb21lZHJpdmVyIHN0b3AgZXZlbnRcbmhlbHBlcnMub25DaHJvbWVkcml2ZXJTdG9wID0gYXN5bmMgZnVuY3Rpb24gKGNvbnRleHQpIHtcbiAgbG9nLndhcm4oYENocm9tZWRyaXZlciBmb3IgY29udGV4dCAke2NvbnRleHR9IHN0b3BwZWQgdW5leHBlY3RlZGx5YCk7XG4gIGlmIChjb250ZXh0ID09PSB0aGlzLmN1ckNvbnRleHQpIHtcbiAgICAvLyB3ZSBleGl0ZWQgdW5leHBlY3RlZGx5IHdoaWxlIGF1dG9tYXRpbmcgdGhlIGN1cnJlbnQgY29udGV4dCBhbmQgc28gd2FudFxuICAgIC8vIHRvIHNodXQgZG93biB0aGUgc2Vzc2lvbiBhbmQgcmVzcG9uZCB3aXRoIGFuIGVycm9yXG4gICAgbGV0IGVyciA9IG5ldyBFcnJvcihcIkNocm9tZWRyaXZlciBxdWl0IHVuZXhwZWN0ZWRseSBkdXJpbmcgc2Vzc2lvblwiKTtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0VW5leHBlY3RlZFNodXRkb3duKGVycik7XG4gIH0gZWxzZSB7XG4gICAgLy8gaWYgYSBDaHJvbWVkcml2ZXIgaW4gdGhlIG5vbi1hY3RpdmUgY29udGV4dCBiYXJmcywgd2UgZG9uJ3QgcmVhbGx5XG4gICAgLy8gY2FyZSwgd2UnbGwganVzdCBtYWtlIGEgbmV3IG9uZSBuZXh0IHRpbWUgd2UgbmVlZCB0aGUgY29udGV4dC5cbiAgICBsb2cud2FybihcIkNocm9tZWRyaXZlciBxdWl0IHVuZXhwZWN0ZWRseSwgYnV0IGl0IHdhc24ndCB0aGUgYWN0aXZlIFwiICtcbiAgICAgICAgICAgICAgICBcImNvbnRleHQsIGlnbm9yaW5nXCIpO1xuICAgIGRlbGV0ZSB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW2NvbnRleHRdO1xuICB9XG59O1xuXG4vLyBJbnRlbnRpb25hbGx5IHN0b3AgYWxsIHRoZSBjaHJvbWVkcml2ZXJzIGN1cnJlbnRseSBhY3RpdmUsIGFuZCBpZ25vcmVcbi8vIHRoZWlyIGV4aXQgZXZlbnRzXG5oZWxwZXJzLnN0b3BDaHJvbWVkcml2ZXJQcm94aWVzID0gYXN5bmMgZnVuY3Rpb24gKCkge1xuICB0aGlzLnN1c3BlbmRDaHJvbWVkcml2ZXJQcm94eSgpOyAvLyBtYWtlIHN1cmUgd2UgdHVybiBvZmYgdGhlIHByb3h5IGZsYWdcbiAgZm9yIChsZXQgY29udGV4dCBvZiBfLmtleXModGhpcy5zZXNzaW9uQ2hyb21lZHJpdmVycykpIHtcbiAgICBsZXQgY2QgPSB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW2NvbnRleHRdO1xuICAgIGxvZy5kZWJ1ZyhgU3RvcHBpbmcgY2hyb21lZHJpdmVyIGZvciBjb250ZXh0ICR7Y29udGV4dH1gKTtcbiAgICAvLyBzdG9wIGxpc3RlbmluZyBmb3IgdGhlIHN0b3BwZWQgc3RhdGUgZXZlbnRcbiAgICBjZC5yZW1vdmVBbGxMaXN0ZW5lcnMoQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjZC5zdG9wKCk7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBsb2cud2FybihgRXJyb3Igc3RvcHBpbmcgQ2hyb21lZHJpdmVyOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cbiAgICBkZWxldGUgdGhpcy5zZXNzaW9uQ2hyb21lZHJpdmVyc1tjb250ZXh0XTtcbiAgfVxufTtcblxuaGVscGVycy5pc0Nocm9tZWRyaXZlckNvbnRleHQgPSBmdW5jdGlvbiAodmlld05hbWUpIHtcbiAgcmV0dXJuIF8uaW5jbHVkZXModmlld05hbWUsIFdFQlZJRVdfV0lOKSB8fCB2aWV3TmFtZSA9PT0gQ0hST01JVU1fV0lOO1xufTtcblxuaGVscGVycy5zaG91bGREaXNtaXNzQ2hyb21lV2VsY29tZSA9IGZ1bmN0aW9uIHNob3VsZERpc21pc3NDaHJvbWVXZWxjb21lICgpIHtcbiAgcmV0dXJuICEhdGhpcy5vcHRzLmNocm9tZU9wdGlvbnMgJiZcbiAgICAgICAgIF8uaXNBcnJheSh0aGlzLm9wdHMuY2hyb21lT3B0aW9ucy5hcmdzKSAmJlxuICAgICAgICAgdGhpcy5vcHRzLmNocm9tZU9wdGlvbnMuYXJncy5pbmNsdWRlcygnLS1uby1maXJzdC1ydW4nKTtcbn07XG5cbmhlbHBlcnMuZGlzbWlzc0Nocm9tZVdlbGNvbWUgPSBhc3luYyBmdW5jdGlvbiBkaXNtaXNzQ2hyb21lV2VsY29tZSAoKSB7XG4gIGxvZy5pbmZvKFwiVHJ5aW5nIHRvIGRpc21pc3MgQ2hyb21lIHdlbGNvbWVcIik7XG4gIGxldCBhY3Rpdml0eSA9IGF3YWl0IHRoaXMuZ2V0Q3VycmVudEFjdGl2aXR5KCk7XG4gIGlmIChhY3Rpdml0eSAhPT0gXCJvcmcuY2hyb21pdW0uY2hyb21lLmJyb3dzZXIuZmlyc3RydW4uRmlyc3RSdW5BY3Rpdml0eVwiKSB7XG4gICAgbG9nLmluZm8oXCJDaHJvbWUgd2VsY29tZSBkaWFsb2cgbmV2ZXIgc2hvd2VkIHVwISBDb250aW51aW5nXCIpO1xuICAgIHJldHVybjtcbiAgfVxuICBsZXQgZWwgPSBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzKCdpZCcsICdjb20uYW5kcm9pZC5jaHJvbWU6aWQvdGVybXNfYWNjZXB0JywgZmFsc2UpO1xuICBhd2FpdCB0aGlzLmNsaWNrKGVsLkVMRU1FTlQpO1xuICB0cnkge1xuICAgIGxldCBlbCA9IGF3YWl0IHRoaXMuZmluZEVsT3JFbHMoJ2lkJywgJ2NvbS5hbmRyb2lkLmNocm9tZTppZC9uZWdhdGl2ZV9idXR0b24nLCBmYWxzZSk7XG4gICAgYXdhaXQgdGhpcy5jbGljayhlbC5FTEVNRU5UKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIC8vIERPIE5PVEhJTkcsIFRISVMgREVWSUNFIERJRE5UIExBVU5DSCBUSEUgU0lHTklOIERJQUxPR1xuICAgIC8vIElUIE1VU1QgQkUgQSBOT04gR01TIERFVklDRVxuICAgIGxvZy53YXJuKGBUaGlzIGRldmljZSBkaWQgbm90IHNob3cgQ2hyb21lIFNpZ25JbiBkaWFsb2csICR7ZS5tZXNzYWdlfWApO1xuICB9XG59O1xuXG5oZWxwZXJzLnN0YXJ0Q2hyb21lU2Vzc2lvbiA9IGFzeW5jIGZ1bmN0aW9uIHN0YXJ0Q2hyb21lU2Vzc2lvbiAoKSB7XG4gIGxvZy5pbmZvKFwiU3RhcnRpbmcgYSBjaHJvbWUtYmFzZWQgYnJvd3NlciBzZXNzaW9uXCIpO1xuICBsZXQgb3B0cyA9IF8uY2xvbmVEZWVwKHRoaXMub3B0cyk7XG4gIG9wdHMuY2hyb21lVXNlUnVubmluZ0FwcCA9IGZhbHNlO1xuXG4gIGNvbnN0IGtub3duUGFja2FnZXMgPSBbXG4gICAgJ29yZy5jaHJvbWl1bS5jaHJvbWUuc2hlbGwnLFxuICAgICdjb20uYW5kcm9pZC5jaHJvbWUnLFxuICAgICdjb20uY2hyb21lLmJldGEnLFxuICAgICdvcmcuY2hyb21pdW0uY2hyb21lJyxcbiAgICAnb3JnLmNocm9taXVtLndlYnZpZXdfc2hlbGwnLFxuICBdO1xuXG4gIGlmIChfLmluY2x1ZGVzKGtub3duUGFja2FnZXMsIHRoaXMub3B0cy5hcHBQYWNrYWdlKSkge1xuICAgIG9wdHMuY2hyb21lQnVuZGxlSWQgPSB0aGlzLm9wdHMuYXBwUGFja2FnZTtcbiAgfSBlbHNlIHtcbiAgICBvcHRzLmNocm9tZUFuZHJvaWRBY3Rpdml0eSA9IHRoaXMub3B0cy5hcHBBY3Rpdml0eTtcbiAgfVxuICB0aGlzLmNocm9tZWRyaXZlciA9IGF3YWl0IHRoaXMuc2V0dXBOZXdDaHJvbWVkcml2ZXIob3B0cywgdGhpcy5hZGIuY3VyRGV2aWNlSWQsIHRoaXMuYWRiKTtcbiAgdGhpcy5jaHJvbWVkcml2ZXIub24oQ2hyb21lZHJpdmVyLkVWRU5UX0NIQU5HRUQsIChtc2cpID0+IHtcbiAgICBpZiAobXNnLnN0YXRlID09PSBDaHJvbWVkcml2ZXIuU1RBVEVfU1RPUFBFRCkge1xuICAgICAgdGhpcy5vbkNocm9tZWRyaXZlclN0b3AoQ0hST01JVU1fV0lOKTtcbiAgICB9XG4gIH0pO1xuXG4gIC8vIE5vdyB0aGF0IHdlIGhhdmUgYSBDaHJvbWUgc2Vzc2lvbiwgd2UgZW5zdXJlIHRoYXQgdGhlIGNvbnRleHQgaXNcbiAgLy8gYXBwcm9wcmlhdGVseSBzZXQgYW5kIHRoYXQgdGhpcyBjaHJvbWVkcml2ZXIgaXMgYWRkZWQgdG8gdGhlIGxpc3RcbiAgLy8gb2Ygc2Vzc2lvbiBjaHJvbWVkcml2ZXJzIHNvIHdlIGNhbiBzd2l0Y2ggYmFjayBhbmQgZm9ydGhcbiAgdGhpcy5jdXJDb250ZXh0ID0gQ0hST01JVU1fV0lOO1xuICB0aGlzLnNlc3Npb25DaHJvbWVkcml2ZXJzW0NIUk9NSVVNX1dJTl0gPSB0aGlzLmNocm9tZWRyaXZlcjtcbiAgdGhpcy5wcm94eVJlcVJlcyA9IHRoaXMuY2hyb21lZHJpdmVyLnByb3h5UmVxLmJpbmQodGhpcy5jaHJvbWVkcml2ZXIpO1xuICB0aGlzLmp3cFByb3h5QWN0aXZlID0gdHJ1ZTtcblxuICBpZiAodGhpcy5zaG91bGREaXNtaXNzQ2hyb21lV2VsY29tZSgpKSB7XG4gICAgLy8gZGlzbWlzcyBDaHJvbWUgd2VsY29tZSBkaWFsb2dcbiAgICBhd2FpdCB0aGlzLmRpc21pc3NDaHJvbWVXZWxjb21lKCk7XG4gIH1cbn07XG5cblxuLyogLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqIEludGVybmFsIGxpYnJhcnkgZnVuY3Rpb25zXG4gKiAtLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqL1xuXG5hc3luYyBmdW5jdGlvbiBzZXR1cEV4aXN0aW5nQ2hyb21lZHJpdmVyIChjaHJvbWVkcml2ZXIpIHtcbiAgLy8gY2hlY2sgdGhlIHN0YXR1cyBieSBzZW5kaW5nIGEgc2ltcGxlIHdpbmRvdy1iYXNlZCBjb21tYW5kIHRvIENocm9tZURyaXZlclxuICAvLyBpZiB0aGVyZSBpcyBhbiBlcnJvciwgd2Ugd2FudCB0byByZWNyZWF0ZSB0aGUgQ2hyb21lRHJpdmVyIHNlc3Npb25cbiAgaWYgKCFhd2FpdCBjaHJvbWVkcml2ZXIuaGFzV29ya2luZ1dlYnZpZXcoKSkge1xuICAgIGxvZy5kZWJ1ZyhcIkNocm9tZURyaXZlciBpcyBub3QgYXNzb2NpYXRlZCB3aXRoIGEgd2luZG93LiBcIiArXG4gICAgICAgICAgICAgICAgIFwiUmUtaW5pdGlhbGl6aW5nIHRoZSBzZXNzaW9uLlwiKTtcbiAgICBhd2FpdCBjaHJvbWVkcml2ZXIucmVzdGFydCgpO1xuICB9XG4gIHJldHVybiBjaHJvbWVkcml2ZXI7XG59XG5cbmhlbHBlcnMuc2V0dXBOZXdDaHJvbWVkcml2ZXIgPSBhc3luYyBmdW5jdGlvbiBzZXR1cE5ld0Nocm9tZWRyaXZlciAob3B0cywgY3VyRGV2aWNlSWQsIGFkYikge1xuICAvLyBpZiBhIHBvcnQgd2Fzbid0IGdpdmVuLCBwaWNrIGEgcmFuZG9tIGF2YWlsYWJsZSBvbmVcbiAgaWYgKCFvcHRzLmNocm9tZURyaXZlclBvcnQpIHtcbiAgICBjb25zdCBnZXRQb3J0ID0gQi5wcm9taXNpZnkoUG9ydEZpbmRlci5nZXRQb3J0LCB7Y29udGV4dDogUG9ydEZpbmRlcn0pO1xuICAgIG9wdHMuY2hyb21lRHJpdmVyUG9ydCA9IGF3YWl0IGdldFBvcnQoKTtcbiAgICBsb2cuZGVidWcoYEEgcG9ydCB3YXMgbm90IGdpdmVuLCB1c2luZyByYW5kb20gcG9ydDogJHtvcHRzLmNocm9tZURyaXZlclBvcnR9YCk7XG4gIH1cblxuICBjb25zdCBjaHJvbWVkcml2ZXIgPSBuZXcgQ2hyb21lZHJpdmVyKHtcbiAgICBwb3J0OiBvcHRzLmNocm9tZURyaXZlclBvcnQsXG4gICAgZXhlY3V0YWJsZTogb3B0cy5jaHJvbWVkcml2ZXJFeGVjdXRhYmxlLFxuICAgIGFkYixcbiAgICB2ZXJib3NlOiAhIW9wdHMuc2hvd0Nocm9tZWRyaXZlckxvZyxcbiAgICBleGVjdXRhYmxlRGlyOiBvcHRzLmNocm9tZWRyaXZlckV4ZWN1dGFibGVEaXIsXG4gICAgbWFwcGluZ1BhdGg6IG9wdHMuY2hyb21lZHJpdmVyQ2hyb21lTWFwcGluZ0ZpbGUsXG4gICAgYnVuZGxlSWQ6IG9wdHMuY2hyb21lQnVuZGxlSWQsXG4gICAgdXNlU3lzdGVtRXhlY3V0YWJsZTogb3B0cy5jaHJvbWVkcml2ZXJVc2VTeXN0ZW1FeGVjdXRhYmxlLFxuICAgIGRpc2FibGVCdWlsZENoZWNrOiBvcHRzLmNocm9tZWRyaXZlckRpc2FibGVCdWlsZENoZWNrLFxuICB9KTtcblxuICAvLyBtYWtlIHN1cmUgdGhlcmUgYXJlIGNocm9tZU9wdGlvbnNcbiAgb3B0cy5jaHJvbWVPcHRpb25zID0gb3B0cy5jaHJvbWVPcHRpb25zIHx8IHt9O1xuICAvLyB0cnkgb3V0IGFueSBwcmVmaXhlZCBjaHJvbWVPcHRpb25zLFxuICAvLyBhbmQgc3RyaXAgdGhlIHByZWZpeFxuICBmb3IgKGNvbnN0IG9wdCBvZiBfLmtleXMob3B0cykpIHtcbiAgICBpZiAob3B0LmVuZHNXaXRoKCc6Y2hyb21lT3B0aW9ucycpKSB7XG4gICAgICBsb2cud2FybihgTWVyZ2luZyAnJHtvcHR9JyBpbnRvICdjaHJvbWVPcHRpb25zJy4gVGhpcyBtYXkgY2F1c2UgdW5leHBlY3RlZCBiZWhhdmlvcmApO1xuICAgICAgXy5tZXJnZShvcHRzLmNocm9tZU9wdGlvbnMsIG9wdHNbb3B0XSk7XG4gICAgfVxuICB9XG5cbiAgbGV0IGNhcHMgPSB7XG4gICAgY2hyb21lT3B0aW9uczoge1xuICAgICAgYW5kcm9pZFBhY2thZ2U6IG9wdHMuY2hyb21lT3B0aW9ucy5hbmRyb2lkUGFja2FnZSB8fCBvcHRzLmFwcFBhY2thZ2UsXG4gICAgfVxuICB9O1xuICBpZiAob3B0cy5jaHJvbWVVc2VSdW5uaW5nQXBwKSB7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRVc2VSdW5uaW5nQXBwID0gb3B0cy5jaHJvbWVVc2VSdW5uaW5nQXBwO1xuICB9XG4gIGlmIChvcHRzLmNocm9tZUFuZHJvaWRQYWNrYWdlKSB7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRQYWNrYWdlID0gb3B0cy5jaHJvbWVBbmRyb2lkUGFja2FnZTtcbiAgfVxuICBpZiAob3B0cy5jaHJvbWVBbmRyb2lkQWN0aXZpdHkpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZEFjdGl2aXR5ID0gb3B0cy5jaHJvbWVBbmRyb2lkQWN0aXZpdHk7XG4gIH1cbiAgaWYgKG9wdHMuY2hyb21lQW5kcm9pZFByb2Nlc3MpIHtcbiAgICBjYXBzLmNocm9tZU9wdGlvbnMuYW5kcm9pZFByb2Nlc3MgPSBvcHRzLmNocm9tZUFuZHJvaWRQcm9jZXNzO1xuICB9XG4gIGlmIChvcHRzLmxvZ2dpbmdQcmVmcykge1xuICAgIGNhcHMubG9nZ2luZ1ByZWZzID0gb3B0cy5sb2dnaW5nUHJlZnM7XG4gIH1cbiAgaWYgKG9wdHMuZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nKSB7XG4gICAgbG9nLndhcm4oYFRoZSAnZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nJyBjYXAgaXMgZGVwcmVjYXRlZDsgc2ltcGx5IHVzZSBgICtcbiAgICAgICAgICAgICBgdGhlICdsb2dnaW5nUHJlZnMnIGNhcCBpbnN0ZWFkLCB3aXRoIGEgJ3BlcmZvcm1hbmNlJyBrZXkgc2V0IHRvICdBTEwnYCk7XG4gICAgY29uc3QgbmV3UHJlZiA9IHtwZXJmb3JtYW5jZTogJ0FMTCd9O1xuXG4gICAgLy8gZG9uJ3Qgb3ZlcndyaXRlIG90aGVyIGxvZ2dpbmcgcHJlZnMgdGhhdCBoYXZlIGJlZW4gc2VudCBpbiBpZiB0aGV5IGV4aXN0XG4gICAgY2Fwcy5sb2dnaW5nUHJlZnMgPSBjYXBzLmxvZ2dpbmdQcmVmcyA/XG4gICAgICBPYmplY3QuYXNzaWduKHt9LCBjYXBzLmxvZ2dpbmdQcmVmcywgbmV3UHJlZikgOlxuICAgICAgbmV3UHJlZjtcbiAgfVxuICBpZiAob3B0cy5icm93c2VyTmFtZSA9PT0gJ2Nocm9taXVtLXdlYnZpZXcnKSB7XG4gICAgY2Fwcy5jaHJvbWVPcHRpb25zLmFuZHJvaWRBY3Rpdml0eSA9IG9wdHMuYXBwQWN0aXZpdHk7XG4gIH1cbiAgaWYgKG9wdHMucGFnZUxvYWRTdHJhdGVneSkge1xuICAgIGNhcHMucGFnZUxvYWRTdHJhdGVneSA9IG9wdHMucGFnZUxvYWRTdHJhdGVneTtcbiAgfVxuICBjYXBzID0gd2Vidmlld0hlbHBlcnMuZGVjb3JhdGVDaHJvbWVPcHRpb25zKGNhcHMsIG9wdHMsIGN1ckRldmljZUlkKTtcbiAgYXdhaXQgY2hyb21lZHJpdmVyLnN0YXJ0KGNhcHMpO1xuICByZXR1cm4gY2hyb21lZHJpdmVyO1xufTtcbmNvbnN0IHNldHVwTmV3Q2hyb21lZHJpdmVyID0gaGVscGVycy5zZXR1cE5ld0Nocm9tZWRyaXZlcjtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycywgc2V0dXBOZXdDaHJvbWVkcml2ZXIgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
