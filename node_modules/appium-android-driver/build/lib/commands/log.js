"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _lodash = _interopRequireDefault(require("lodash"));

var _ws = _interopRequireDefault(require("ws"));

var _appiumBaseDriver = require("appium-base-driver");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

const WEBSOCKET_ENDPOINT = sessionId => `${_appiumBaseDriver.DEFAULT_WS_PATHNAME_PREFIX}/session/${sessionId}/appium/device/logcat`;

function toLogRecord(timestamp, level, message) {
  return {
    timestamp,
    level,
    message
  };
}

extensions.supportedLogTypes = {
  logcat: {
    description: 'Logs for Android applications on real device and emulators via ADB',
    getter: async self => await self.adb.getLogcatLogs()
  },
  bugreport: {
    description: `'adb bugreport' output for advanced issues diagnostic`,
    getter: async self => {
      const output = await self.adb.bugreport();
      const timestamp = Date.now();
      return output.split(_os.default.EOL).map(x => toLogRecord(timestamp, 'ALL', x));
    }
  },
  server: {
    description: 'Appium server logs',
    getter: self => {
      if (!self.relaxedSecurityEnabled) {
        throw new Error('Appium server must have relaxed security flag set ' + 'in order to be able to get server logs');
      }

      const timestamp = Date.now();
      return _logger.default.unwrap().record.map(x => toLogRecord(timestamp, 'ALL', _lodash.default.isEmpty(x.prefix) ? x.message : `[${x.prefix}] ${x.message}`));
    }
  }
};

commands.mobileStartLogsBroadcast = async function () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (!_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    _logger.default.debug(`The logcat broadcasting web socket server is already listening at ${pathname}`);

    return;
  }

  _logger.default.info(`Assigning logcat broadcasting web socket server to ${pathname}`);

  const wss = new _ws.default.Server({
    noServer: true
  });
  wss.on('connection', (ws, req) => {
    if (req) {
      const remoteIp = _lodash.default.isEmpty(req.headers['x-forwarded-for']) ? req.connection.remoteAddress : req.headers['x-forwarded-for'];

      _logger.default.debug(`Established a new logcat listener web socket connection from ${remoteIp}`);
    } else {
      _logger.default.debug('Established a new logcat listener web socket connection');
    }

    if (_lodash.default.isEmpty(this._logcatWebsocketListener)) {
      this._logcatWebsocketListener = logRecord => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(logRecord.message);
        }
      };
    }

    this.adb.setLogcatListener(this._logcatWebsocketListener);
    ws.on('close', (code, reason) => {
      if (!_lodash.default.isEmpty(this._logcatWebsocketListener)) {
        try {
          this.adb.removeLogcatListener(this._logcatWebsocketListener);
        } catch (ign) {}

        this._logcatWebsocketListener = null;
      }

      let closeMsg = 'Logcat listener web socket is closed.';

      if (!_lodash.default.isEmpty(code)) {
        closeMsg += ` Code: ${code}.`;
      }

      if (!_lodash.default.isEmpty(reason)) {
        closeMsg += ` Reason: ${reason}.`;
      }

      _logger.default.debug(closeMsg);
    });
  });
  await this.server.addWebSocketHandler(pathname, wss);
};

commands.mobileStopLogsBroadcast = async function () {
  const pathname = WEBSOCKET_ENDPOINT(this.sessionId);

  if (_lodash.default.isEmpty((await this.server.getWebSocketHandlers(pathname)))) {
    return;
  }

  _logger.default.debug('Stopping the logcat broadcasting web socket server');

  await this.server.removeWebSocketHandler(pathname);
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9sb2cuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIldFQlNPQ0tFVF9FTkRQT0lOVCIsInNlc3Npb25JZCIsIkRFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYIiwidG9Mb2dSZWNvcmQiLCJ0aW1lc3RhbXAiLCJsZXZlbCIsIm1lc3NhZ2UiLCJzdXBwb3J0ZWRMb2dUeXBlcyIsImxvZ2NhdCIsImRlc2NyaXB0aW9uIiwiZ2V0dGVyIiwic2VsZiIsImFkYiIsImdldExvZ2NhdExvZ3MiLCJidWdyZXBvcnQiLCJvdXRwdXQiLCJEYXRlIiwibm93Iiwic3BsaXQiLCJvcyIsIkVPTCIsIm1hcCIsIngiLCJzZXJ2ZXIiLCJyZWxheGVkU2VjdXJpdHlFbmFibGVkIiwiRXJyb3IiLCJsb2ciLCJ1bndyYXAiLCJyZWNvcmQiLCJfIiwiaXNFbXB0eSIsInByZWZpeCIsIm1vYmlsZVN0YXJ0TG9nc0Jyb2FkY2FzdCIsInBhdGhuYW1lIiwiZ2V0V2ViU29ja2V0SGFuZGxlcnMiLCJkZWJ1ZyIsImluZm8iLCJ3c3MiLCJXZWJTb2NrZXQiLCJTZXJ2ZXIiLCJub1NlcnZlciIsIm9uIiwid3MiLCJyZXEiLCJyZW1vdGVJcCIsImhlYWRlcnMiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsIl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lciIsImxvZ1JlY29yZCIsInJlYWR5U3RhdGUiLCJPUEVOIiwic2VuZCIsInNldExvZ2NhdExpc3RlbmVyIiwiY29kZSIsInJlYXNvbiIsInJlbW92ZUxvZ2NhdExpc3RlbmVyIiwiaWduIiwiY2xvc2VNc2ciLCJhZGRXZWJTb2NrZXRIYW5kbGVyIiwibW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQSxNQUFNQyxrQkFBa0IsR0FBSUMsU0FBRCxJQUFnQixHQUFFQyw0Q0FBMkIsWUFBV0QsU0FBVSx1QkFBN0Y7O0FBR0EsU0FBU0UsV0FBVCxDQUFzQkMsU0FBdEIsRUFBaUNDLEtBQWpDLEVBQXdDQyxPQUF4QyxFQUFpRDtBQUMvQyxTQUFPO0FBQ0xGLElBQUFBLFNBREs7QUFFTEMsSUFBQUEsS0FGSztBQUdMQyxJQUFBQTtBQUhLLEdBQVA7QUFLRDs7QUFFRFAsVUFBVSxDQUFDUSxpQkFBWCxHQUErQjtBQUM3QkMsRUFBQUEsTUFBTSxFQUFFO0FBQ05DLElBQUFBLFdBQVcsRUFBRSxvRUFEUDtBQUVOQyxJQUFBQSxNQUFNLEVBQUUsTUFBT0MsSUFBUCxJQUFnQixNQUFNQSxJQUFJLENBQUNDLEdBQUwsQ0FBU0MsYUFBVDtBQUZ4QixHQURxQjtBQUs3QkMsRUFBQUEsU0FBUyxFQUFFO0FBQ1RMLElBQUFBLFdBQVcsRUFBRyx1REFETDtBQUVUQyxJQUFBQSxNQUFNLEVBQUUsTUFBT0MsSUFBUCxJQUFnQjtBQUN0QixZQUFNSSxNQUFNLEdBQUcsTUFBTUosSUFBSSxDQUFDQyxHQUFMLENBQVNFLFNBQVQsRUFBckI7QUFDQSxZQUFNVixTQUFTLEdBQUdZLElBQUksQ0FBQ0MsR0FBTCxFQUFsQjtBQUNBLGFBQU9GLE1BQU0sQ0FBQ0csS0FBUCxDQUFhQyxZQUFHQyxHQUFoQixFQUNKQyxHQURJLENBQ0NDLENBQUQsSUFBT25CLFdBQVcsQ0FBQ0MsU0FBRCxFQUFZLEtBQVosRUFBbUJrQixDQUFuQixDQURsQixDQUFQO0FBRUQ7QUFQUSxHQUxrQjtBQWM3QkMsRUFBQUEsTUFBTSxFQUFFO0FBQ05kLElBQUFBLFdBQVcsRUFBRSxvQkFEUDtBQUVOQyxJQUFBQSxNQUFNLEVBQUdDLElBQUQsSUFBVTtBQUNoQixVQUFJLENBQUNBLElBQUksQ0FBQ2Esc0JBQVYsRUFBa0M7QUFDaEMsY0FBTSxJQUFJQyxLQUFKLENBQVUsdURBQ0Esd0NBRFYsQ0FBTjtBQUVEOztBQUNELFlBQU1yQixTQUFTLEdBQUdZLElBQUksQ0FBQ0MsR0FBTCxFQUFsQjtBQUNBLGFBQU9TLGdCQUFJQyxNQUFKLEdBQWFDLE1BQWIsQ0FDSlAsR0FESSxDQUNDQyxDQUFELElBQU9uQixXQUFXLENBQUNDLFNBQUQsRUFDQyxLQURELEVBRUN5QixnQkFBRUMsT0FBRixDQUFVUixDQUFDLENBQUNTLE1BQVosSUFBc0JULENBQUMsQ0FBQ2hCLE9BQXhCLEdBQW1DLElBQUdnQixDQUFDLENBQUNTLE1BQU8sS0FBSVQsQ0FBQyxDQUFDaEIsT0FBUSxFQUY5RCxDQURsQixDQUFQO0FBS0Q7QUFiSztBQWRxQixDQUEvQjs7QUF1Q0FULFFBQVEsQ0FBQ21DLHdCQUFULEdBQW9DLGtCQUFrQjtBQUNwRCxRQUFNQyxRQUFRLEdBQUdqQyxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUksQ0FBQzRCLGdCQUFFQyxPQUFGLEVBQVUsTUFBTSxLQUFLUCxNQUFMLENBQVlXLG9CQUFaLENBQWlDRCxRQUFqQyxDQUFoQixFQUFMLEVBQWtFO0FBQ2hFUCxvQkFBSVMsS0FBSixDQUFXLHFFQUFvRUYsUUFBUyxFQUF4Rjs7QUFDQTtBQUNEOztBQUVEUCxrQkFBSVUsSUFBSixDQUFVLHNEQUFxREgsUUFBUyxFQUF4RTs7QUFFQSxRQUFNSSxHQUFHLEdBQUcsSUFBSUMsWUFBVUMsTUFBZCxDQUFxQjtBQUMvQkMsSUFBQUEsUUFBUSxFQUFFO0FBRHFCLEdBQXJCLENBQVo7QUFHQUgsRUFBQUEsR0FBRyxDQUFDSSxFQUFKLENBQU8sWUFBUCxFQUFxQixDQUFDQyxFQUFELEVBQUtDLEdBQUwsS0FBYTtBQUNoQyxRQUFJQSxHQUFKLEVBQVM7QUFDUCxZQUFNQyxRQUFRLEdBQUdmLGdCQUFFQyxPQUFGLENBQVVhLEdBQUcsQ0FBQ0UsT0FBSixDQUFZLGlCQUFaLENBQVYsSUFDYkYsR0FBRyxDQUFDRyxVQUFKLENBQWVDLGFBREYsR0FFYkosR0FBRyxDQUFDRSxPQUFKLENBQVksaUJBQVosQ0FGSjs7QUFHQW5CLHNCQUFJUyxLQUFKLENBQVcsZ0VBQStEUyxRQUFTLEVBQW5GO0FBQ0QsS0FMRCxNQUtPO0FBQ0xsQixzQkFBSVMsS0FBSixDQUFVLHlEQUFWO0FBQ0Q7O0FBRUQsUUFBSU4sZ0JBQUVDLE9BQUYsQ0FBVSxLQUFLa0Isd0JBQWYsQ0FBSixFQUE4QztBQUM1QyxXQUFLQSx3QkFBTCxHQUFpQ0MsU0FBRCxJQUFlO0FBQzdDLFlBQUlQLEVBQUUsSUFBSUEsRUFBRSxDQUFDUSxVQUFILEtBQWtCWixZQUFVYSxJQUF0QyxFQUE0QztBQUMxQ1QsVUFBQUEsRUFBRSxDQUFDVSxJQUFILENBQVFILFNBQVMsQ0FBQzNDLE9BQWxCO0FBQ0Q7QUFDRixPQUpEO0FBS0Q7O0FBQ0QsU0FBS00sR0FBTCxDQUFTeUMsaUJBQVQsQ0FBMkIsS0FBS0wsd0JBQWhDO0FBRUFOLElBQUFBLEVBQUUsQ0FBQ0QsRUFBSCxDQUFNLE9BQU4sRUFBZSxDQUFDYSxJQUFELEVBQU9DLE1BQVAsS0FBa0I7QUFDL0IsVUFBSSxDQUFDMUIsZ0JBQUVDLE9BQUYsQ0FBVSxLQUFLa0Isd0JBQWYsQ0FBTCxFQUErQztBQUM3QyxZQUFJO0FBQ0YsZUFBS3BDLEdBQUwsQ0FBUzRDLG9CQUFULENBQThCLEtBQUtSLHdCQUFuQztBQUNELFNBRkQsQ0FFRSxPQUFPUyxHQUFQLEVBQVksQ0FBRTs7QUFDaEIsYUFBS1Qsd0JBQUwsR0FBZ0MsSUFBaEM7QUFDRDs7QUFFRCxVQUFJVSxRQUFRLEdBQUcsdUNBQWY7O0FBQ0EsVUFBSSxDQUFDN0IsZ0JBQUVDLE9BQUYsQ0FBVXdCLElBQVYsQ0FBTCxFQUFzQjtBQUNwQkksUUFBQUEsUUFBUSxJQUFLLFVBQVNKLElBQUssR0FBM0I7QUFDRDs7QUFDRCxVQUFJLENBQUN6QixnQkFBRUMsT0FBRixDQUFVeUIsTUFBVixDQUFMLEVBQXdCO0FBQ3RCRyxRQUFBQSxRQUFRLElBQUssWUFBV0gsTUFBTyxHQUEvQjtBQUNEOztBQUNEN0Isc0JBQUlTLEtBQUosQ0FBVXVCLFFBQVY7QUFDRCxLQWhCRDtBQWlCRCxHQXBDRDtBQXFDQSxRQUFNLEtBQUtuQyxNQUFMLENBQVlvQyxtQkFBWixDQUFnQzFCLFFBQWhDLEVBQTBDSSxHQUExQyxDQUFOO0FBQ0QsQ0FsREQ7O0FBd0RBeEMsUUFBUSxDQUFDK0QsdUJBQVQsR0FBbUMsa0JBQWtCO0FBQ25ELFFBQU0zQixRQUFRLEdBQUdqQyxrQkFBa0IsQ0FBQyxLQUFLQyxTQUFOLENBQW5DOztBQUNBLE1BQUk0QixnQkFBRUMsT0FBRixFQUFVLE1BQU0sS0FBS1AsTUFBTCxDQUFZVyxvQkFBWixDQUFpQ0QsUUFBakMsQ0FBaEIsRUFBSixFQUFpRTtBQUMvRDtBQUNEOztBQUVEUCxrQkFBSVMsS0FBSixDQUFVLG9EQUFWOztBQUNBLFFBQU0sS0FBS1osTUFBTCxDQUFZc0Msc0JBQVosQ0FBbUM1QixRQUFuQyxDQUFOO0FBQ0QsQ0FSRDs7QUFVQTZCLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjaEUsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBXZWJTb2NrZXQgZnJvbSAnd3MnO1xuaW1wb3J0IHsgREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVggfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IFdFQlNPQ0tFVF9FTkRQT0lOVCA9IChzZXNzaW9uSWQpID0+IGAke0RFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYfS9zZXNzaW9uLyR7c2Vzc2lvbklkfS9hcHBpdW0vZGV2aWNlL2xvZ2NhdGA7XG5cbi8vIGh0dHBzOi8vZ2l0aHViLmNvbS9TZWxlbml1bUhRL3NlbGVuaXVtL2Jsb2IvMGQ0MjU2NzZiM2M5ZGYyNjFkZDY0MTkxN2Y4NjdkNGQ1Y2U3Nzc0ZC9qYXZhL2NsaWVudC9zcmMvb3JnL29wZW5xYS9zZWxlbml1bS9sb2dnaW5nL0xvZ0VudHJ5LmphdmFcbmZ1bmN0aW9uIHRvTG9nUmVjb3JkICh0aW1lc3RhbXAsIGxldmVsLCBtZXNzYWdlKSB7XG4gIHJldHVybiB7XG4gICAgdGltZXN0YW1wLFxuICAgIGxldmVsLFxuICAgIG1lc3NhZ2UsXG4gIH07XG59XG5cbmV4dGVuc2lvbnMuc3VwcG9ydGVkTG9nVHlwZXMgPSB7XG4gIGxvZ2NhdDoge1xuICAgIGRlc2NyaXB0aW9uOiAnTG9ncyBmb3IgQW5kcm9pZCBhcHBsaWNhdGlvbnMgb24gcmVhbCBkZXZpY2UgYW5kIGVtdWxhdG9ycyB2aWEgQURCJyxcbiAgICBnZXR0ZXI6IGFzeW5jIChzZWxmKSA9PiBhd2FpdCBzZWxmLmFkYi5nZXRMb2djYXRMb2dzKCksXG4gIH0sXG4gIGJ1Z3JlcG9ydDoge1xuICAgIGRlc2NyaXB0aW9uOiBgJ2FkYiBidWdyZXBvcnQnIG91dHB1dCBmb3IgYWR2YW5jZWQgaXNzdWVzIGRpYWdub3N0aWNgLFxuICAgIGdldHRlcjogYXN5bmMgKHNlbGYpID0+IHtcbiAgICAgIGNvbnN0IG91dHB1dCA9IGF3YWl0IHNlbGYuYWRiLmJ1Z3JlcG9ydCgpO1xuICAgICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcbiAgICAgIHJldHVybiBvdXRwdXQuc3BsaXQob3MuRU9MKVxuICAgICAgICAubWFwKCh4KSA9PiB0b0xvZ1JlY29yZCh0aW1lc3RhbXAsICdBTEwnLCB4KSk7XG4gICAgfSxcbiAgfSxcbiAgc2VydmVyOiB7XG4gICAgZGVzY3JpcHRpb246ICdBcHBpdW0gc2VydmVyIGxvZ3MnLFxuICAgIGdldHRlcjogKHNlbGYpID0+IHtcbiAgICAgIGlmICghc2VsZi5yZWxheGVkU2VjdXJpdHlFbmFibGVkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQXBwaXVtIHNlcnZlciBtdXN0IGhhdmUgcmVsYXhlZCBzZWN1cml0eSBmbGFnIHNldCAnICtcbiAgICAgICAgICAgICAgICAgICAgICAgICdpbiBvcmRlciB0byBiZSBhYmxlIHRvIGdldCBzZXJ2ZXIgbG9ncycpO1xuICAgICAgfVxuICAgICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcbiAgICAgIHJldHVybiBsb2cudW53cmFwKCkucmVjb3JkXG4gICAgICAgIC5tYXAoKHgpID0+IHRvTG9nUmVjb3JkKHRpbWVzdGFtcCxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ0FMTCcsXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF8uaXNFbXB0eSh4LnByZWZpeCkgPyB4Lm1lc3NhZ2UgOiBgWyR7eC5wcmVmaXh9XSAke3gubWVzc2FnZX1gKVxuICAgICAgICApO1xuICAgIH0sXG4gIH0sXG59O1xuXG4vKipcbiAqIFN0YXJ0cyBBbmRyb2lkIGxvZ2NhdCBicm9hZGNhc3Qgd2Vic29ja2V0IG9uIHRoZSBzYW1lIGhvc3QgYW5kIHBvcnRcbiAqIHdoZXJlIEFwcGl1bSBzZXJ2ZXIgaXMgcnVubmluZyBhdCBgL3dzL3Nlc3Npb24vOnNlc3Npb25JZDovYXBwaXVtL2xvZ2NhdGAgZW5kcG9pbnQuIFRoZSBtZXRob2RcbiAqIHdpbGwgcmV0dXJuIGltbWVkaWF0ZWx5IGlmIHRoZSB3ZWIgc29ja2V0IGlzIGFscmVhZHkgbGlzdGVuaW5nLlxuICpcbiAqIEVhY2ggY29ubmVjdGVkIHdlYmNva2V0IGxpc3RlbmVyIHdpbGwgcmVjZWl2ZSBsb2djYXQgbG9nIGxpbmVzXG4gKiBhcyBzb29uIGFzIHRoZXkgYXJlIHZpc2libGUgdG8gQXBwaXVtLlxuICovXG5jb21tYW5kcy5tb2JpbGVTdGFydExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKCFfLmlzRW1wdHkoYXdhaXQgdGhpcy5zZXJ2ZXIuZ2V0V2ViU29ja2V0SGFuZGxlcnMocGF0aG5hbWUpKSkge1xuICAgIGxvZy5kZWJ1ZyhgVGhlIGxvZ2NhdCBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXIgaXMgYWxyZWFkeSBsaXN0ZW5pbmcgYXQgJHtwYXRobmFtZX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsb2cuaW5mbyhgQXNzaWduaW5nIGxvZ2NhdCBicm9hZGNhc3Rpbmcgd2ViIHNvY2tldCBzZXJ2ZXIgdG8gJHtwYXRobmFtZX1gKTtcbiAgLy8gaHR0cHM6Ly9naXRodWIuY29tL3dlYnNvY2tldHMvd3MvYmxvYi9tYXN0ZXIvZG9jL3dzLm1kXG4gIGNvbnN0IHdzcyA9IG5ldyBXZWJTb2NrZXQuU2VydmVyKHtcbiAgICBub1NlcnZlcjogdHJ1ZSxcbiAgfSk7XG4gIHdzcy5vbignY29ubmVjdGlvbicsICh3cywgcmVxKSA9PiB7XG4gICAgaWYgKHJlcSkge1xuICAgICAgY29uc3QgcmVtb3RlSXAgPSBfLmlzRW1wdHkocmVxLmhlYWRlcnNbJ3gtZm9yd2FyZGVkLWZvciddKVxuICAgICAgICA/IHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3NcbiAgICAgICAgOiByZXEuaGVhZGVyc1sneC1mb3J3YXJkZWQtZm9yJ107XG4gICAgICBsb2cuZGVidWcoYEVzdGFibGlzaGVkIGEgbmV3IGxvZ2NhdCBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24gZnJvbSAke3JlbW90ZUlwfWApO1xuICAgIH0gZWxzZSB7XG4gICAgICBsb2cuZGVidWcoJ0VzdGFibGlzaGVkIGEgbmV3IGxvZ2NhdCBsaXN0ZW5lciB3ZWIgc29ja2V0IGNvbm5lY3Rpb24nKTtcbiAgICB9XG5cbiAgICBpZiAoXy5pc0VtcHR5KHRoaXMuX2xvZ2NhdFdlYnNvY2tldExpc3RlbmVyKSkge1xuICAgICAgdGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIgPSAobG9nUmVjb3JkKSA9PiB7XG4gICAgICAgIGlmICh3cyAmJiB3cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAgIHdzLnNlbmQobG9nUmVjb3JkLm1lc3NhZ2UpO1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cbiAgICB0aGlzLmFkYi5zZXRMb2djYXRMaXN0ZW5lcih0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lcik7XG5cbiAgICB3cy5vbignY2xvc2UnLCAoY29kZSwgcmVhc29uKSA9PiB7XG4gICAgICBpZiAoIV8uaXNFbXB0eSh0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lcikpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICB0aGlzLmFkYi5yZW1vdmVMb2djYXRMaXN0ZW5lcih0aGlzLl9sb2djYXRXZWJzb2NrZXRMaXN0ZW5lcik7XG4gICAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgICAgdGhpcy5fbG9nY2F0V2Vic29ja2V0TGlzdGVuZXIgPSBudWxsO1xuICAgICAgfVxuXG4gICAgICBsZXQgY2xvc2VNc2cgPSAnTG9nY2F0IGxpc3RlbmVyIHdlYiBzb2NrZXQgaXMgY2xvc2VkLic7XG4gICAgICBpZiAoIV8uaXNFbXB0eShjb2RlKSkge1xuICAgICAgICBjbG9zZU1zZyArPSBgIENvZGU6ICR7Y29kZX0uYDtcbiAgICAgIH1cbiAgICAgIGlmICghXy5pc0VtcHR5KHJlYXNvbikpIHtcbiAgICAgICAgY2xvc2VNc2cgKz0gYCBSZWFzb246ICR7cmVhc29ufS5gO1xuICAgICAgfVxuICAgICAgbG9nLmRlYnVnKGNsb3NlTXNnKTtcbiAgICB9KTtcbiAgfSk7XG4gIGF3YWl0IHRoaXMuc2VydmVyLmFkZFdlYlNvY2tldEhhbmRsZXIocGF0aG5hbWUsIHdzcyk7XG59O1xuXG4vKipcbiAqIFN0b3BzIHRoZSBwcmV2aW91c2x5IHN0YXJ0ZWQgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZXNvY2tldCBzZXJ2ZXIuXG4gKiBUaGlzIG1ldGhvZCB3aWxsIHJldHVybiBpbW1lZGlhdGVseSBpZiBubyBzZXJ2ZXIgaXMgcnVubmluZy5cbiAqL1xuY29tbWFuZHMubW9iaWxlU3RvcExvZ3NCcm9hZGNhc3QgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHBhdGhuYW1lID0gV0VCU09DS0VUX0VORFBPSU5UKHRoaXMuc2Vzc2lvbklkKTtcbiAgaWYgKF8uaXNFbXB0eShhd2FpdCB0aGlzLnNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycyhwYXRobmFtZSkpKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgbG9nLmRlYnVnKCdTdG9wcGluZyB0aGUgbG9nY2F0IGJyb2FkY2FzdGluZyB3ZWIgc29ja2V0IHNlcnZlcicpO1xuICBhd2FpdCB0aGlzLnNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyKHBhdGhuYW1lKTtcbn07XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7Il0sImZpbGUiOiJsaWIvY29tbWFuZHMvbG9nLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
