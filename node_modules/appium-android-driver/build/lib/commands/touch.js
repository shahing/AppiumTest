"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _androidHelpers = _interopRequireDefault(require("../android-helpers"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.doTouchAction = async function (action, opts) {
  switch (action) {
    case 'tap':
      return await this.tap(opts.element, opts.x, opts.y, opts.count);

    case 'press':
      return await this.touchDown(opts.element, opts.x, opts.y);

    case 'release':
      return await this.touchUp(opts.element, opts.x, opts.y);

    case 'moveTo':
      return await this.touchMove(opts.element, opts.x, opts.y);

    case 'wait':
      return await _bluebird.default.delay(opts.ms);

    case 'longPress':
      if (typeof opts.duration === 'undefined' || !opts.duration) {
        opts.duration = 1000;
      }

      return await this.touchLongClick(opts.element, opts.x, opts.y, opts.duration);

    case 'cancel':
      _logger.default.warn("Cancel action currently has no effect");

      break;

    default:
      _logger.default.errorAndThrow(`unknown action ${action}`);

  }
};

helpers.doTouchDrag = async function (gestures) {
  let longPress = gestures[0];
  let moveTo = gestures[1];
  let startX = longPress.options.x || 0,
      startY = longPress.options.y || 0,
      endX = moveTo.options.x || 0,
      endY = moveTo.options.y || 0;

  if (longPress.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(longPress.options.element);
    startX += x || 0;
    startY += y || 0;
  }

  if (moveTo.options.element) {
    let {
      x,
      y
    } = await this.getLocationInView(moveTo.options.element);
    endX += x || 0;
    endY += y || 0;
  }

  let apiLevel = await this.adb.getApiLevel();
  let duration = apiLevel >= 5 ? 2 : 1;

  if (longPress.options && longPress.options.duration) {
    duration = Math.max(longPress.options.duration / 1000, duration);
  }

  return await this.drag(startX, startY, endX, endY, duration, 1, longPress.options.element, moveTo.options.element);
};

helpers.fixRelease = async function (gestures) {
  let release = _lodash.default.last(gestures);

  release.options = release.options || {};

  if (release.options.element || release.options.x && release.options.y) {
    return;
  }

  gestures = _lodash.default.clone(gestures);
  let ref = null;

  for (let gesture of gestures.reverse()) {
    let opts = gesture.options;

    if (opts.element || opts.x && opts.y) {
      ref = gesture;
      break;
    }
  }

  if (ref) {
    let opts = ref.options;

    if (opts.element) {
      let loc = await this.getLocationInView(opts.element);

      if (opts.x && opts.y) {
        release.options = {
          x: loc.x + opts.x,
          y: loc.y + opts.y
        };
      } else {
        let size = await this.getSize(opts.element);
        release.options = {
          x: loc.x + size.width / 2,
          y: loc.y + size.height / 2
        };
      }
    } else {
      release.options = _lodash.default.pick(opts, 'x', 'y');
    }
  }

  return release;
};

helpers.performGesture = async function (gesture) {
  try {
    return await this.doTouchAction(gesture.action, gesture.options || {});
  } catch (e) {
    if ((0, _appiumBaseDriver.isErrorType)(e, _appiumBaseDriver.errors.NoSuchElementError) && gesture.action === 'release' && gesture.options.element) {
      delete gesture.options.element;

      _logger.default.debug(`retrying release without element opts: ${gesture.options}.`);

      return await this.doTouchAction(gesture.action, gesture.options || {});
    }

    throw e;
  }
};

commands.performTouch = async function (gestures) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  if (gestures.length === 4 && gestures[0].action === 'press' && gestures[1].action === 'wait' && gestures[2].action === 'moveTo' && gestures[3].action === 'release') {
    let swipeOpts = await this.getSwipeOptions(gestures);
    return await this.swipe(swipeOpts.startX, swipeOpts.startY, swipeOpts.endX, swipeOpts.endY, swipeOpts.duration, swipeOpts.touchCount, swipeOpts.element);
  }

  let actions = _lodash.default.map(gestures, "action");

  if (actions[0] === 'longPress' && actions[1] === 'moveTo' && actions[2] === 'release') {
    return await this.doTouchDrag(gestures);
  } else {
    if (actions.length === 2) {
      if (_lodash.default.head(actions) === 'press' && _lodash.default.last(actions) === 'release') {
        actions[0] = 'tap';
        gestures[0].action = 'tap';
      }

      if ((_lodash.default.head(actions) === 'tap' || _lodash.default.head(actions) === 'longPress') && _lodash.default.last(actions) === 'release') {
        gestures.pop();
        actions.pop();
      }
    } else {
      if (actions[0] === 'longPress') {
        actions = ['press', 'wait', ...actions.slice(1)];
        let press = gestures.shift();
        press.action = 'press';
        let wait = {
          action: 'wait',
          options: {
            ms: press.options.duration || 1000
          }
        };
        delete press.options.duration;
        gestures = [press, wait, ...gestures];
      }
    }

    let fixedGestures = await this.parseTouch(gestures, false);

    if (actions[actions.length - 1] === 'release') {
      actions[actions.length - 1] = await this.fixRelease(gestures);
    }

    for (let g of fixedGestures) {
      await this.performGesture(g);
    }
  }
};

helpers.parseTouch = async function (gestures, multi) {
  if (multi && _lodash.default.last(gestures).action === 'release') {
    gestures.pop();
  }

  let touchStateObjects = await (0, _asyncbox.asyncmap)(gestures, async gesture => {
    let options = gesture.options || {};

    if (_lodash.default.includes(['press', 'moveTo', 'tap', 'longPress'], gesture.action)) {
      options.offset = false;
      let elementId = gesture.options.element;

      if (elementId) {
        let pos = await this.getLocationInView(elementId);

        if (gesture.options.x || gesture.options.y) {
          options.x = pos.x + (gesture.options.x || 0);
          options.y = pos.y + (gesture.options.y || 0);
        } else {
          const {
            width,
            height
          } = await this.getSize(elementId);
          options.x = pos.x + width / 2;
          options.y = pos.y + height / 2;
        }

        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      } else {
        options.x = gesture.options.x || 0;
        options.y = gesture.options.y || 0;
        let touchStateObject = {
          action: gesture.action,
          options,
          timeOffset: 0.005
        };
        return touchStateObject;
      }
    } else {
      let offset = 0.005;

      if (gesture.action === 'wait') {
        options = gesture.options;
        offset = parseInt(gesture.options.ms, 10) / 1000;
      }

      let touchStateObject = {
        action: gesture.action,
        options,
        timeOffset: offset
      };
      return touchStateObject;
    }
  }, false);
  let prevPos = null,
      time = 0;

  for (let state of touchStateObjects) {
    if (_lodash.default.isUndefined(state.options.x) && _lodash.default.isUndefined(state.options.y) && prevPos !== null) {
      state.options.x = prevPos.x;
      state.options.y = prevPos.y;
    }

    if (state.options.offset && prevPos) {
      state.options.x += prevPos.x;
      state.options.y += prevPos.y;
    }

    delete state.options.offset;

    if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
      prevPos = state.options;
    }

    if (multi) {
      let timeOffset = state.timeOffset;
      time += timeOffset;
      state.time = _androidHelpers.default.truncateDecimals(time, 3);

      if (!_lodash.default.isUndefined(state.options.x) && !_lodash.default.isUndefined(state.options.y)) {
        state.touch = {
          x: state.options.x,
          y: state.options.y
        };
      }

      delete state.options;
    }

    delete state.timeOffset;
  }

  return touchStateObjects;
};

commands.performMultiAction = async function (actions, elementId) {
  if (this.isWebContext()) {
    throw new _appiumBaseDriver.errors.NotYetImplementedError();
  }

  if (actions.length === 1) {
    throw new Error("Multi Pointer Gestures need at least two actions. " + "Use Touch Actions for a single action.");
  }

  let states = await (0, _asyncbox.asyncmap)(actions, async action => {
    return await this.parseTouch(action, true);
  }, false);
  return await this.doPerformMultiAction(elementId, states);
};

commands.doPerformMultiAction = async function (elementId, states) {
  let opts;

  if (elementId) {
    opts = {
      elementId,
      actions: states
    };
    return await this.bootstrap.sendAction("element:performMultiPointerGesture", opts);
  } else {
    opts = {
      actions: states
    };
    return await this.bootstrap.sendAction("performMultiPointerGesture", opts);
  }
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy90b3VjaC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZG9Ub3VjaEFjdGlvbiIsImFjdGlvbiIsIm9wdHMiLCJ0YXAiLCJlbGVtZW50IiwieCIsInkiLCJjb3VudCIsInRvdWNoRG93biIsInRvdWNoVXAiLCJ0b3VjaE1vdmUiLCJCIiwiZGVsYXkiLCJtcyIsImR1cmF0aW9uIiwidG91Y2hMb25nQ2xpY2siLCJsb2ciLCJ3YXJuIiwiZXJyb3JBbmRUaHJvdyIsImRvVG91Y2hEcmFnIiwiZ2VzdHVyZXMiLCJsb25nUHJlc3MiLCJtb3ZlVG8iLCJzdGFydFgiLCJvcHRpb25zIiwic3RhcnRZIiwiZW5kWCIsImVuZFkiLCJnZXRMb2NhdGlvbkluVmlldyIsImFwaUxldmVsIiwiYWRiIiwiZ2V0QXBpTGV2ZWwiLCJNYXRoIiwibWF4IiwiZHJhZyIsImZpeFJlbGVhc2UiLCJyZWxlYXNlIiwiXyIsImxhc3QiLCJjbG9uZSIsInJlZiIsImdlc3R1cmUiLCJyZXZlcnNlIiwibG9jIiwic2l6ZSIsImdldFNpemUiLCJ3aWR0aCIsImhlaWdodCIsInBpY2siLCJwZXJmb3JtR2VzdHVyZSIsImUiLCJlcnJvcnMiLCJOb1N1Y2hFbGVtZW50RXJyb3IiLCJkZWJ1ZyIsInBlcmZvcm1Ub3VjaCIsImlzV2ViQ29udGV4dCIsIk5vdFlldEltcGxlbWVudGVkRXJyb3IiLCJsZW5ndGgiLCJzd2lwZU9wdHMiLCJnZXRTd2lwZU9wdGlvbnMiLCJzd2lwZSIsInRvdWNoQ291bnQiLCJhY3Rpb25zIiwibWFwIiwiaGVhZCIsInBvcCIsInNsaWNlIiwicHJlc3MiLCJzaGlmdCIsIndhaXQiLCJmaXhlZEdlc3R1cmVzIiwicGFyc2VUb3VjaCIsImciLCJtdWx0aSIsInRvdWNoU3RhdGVPYmplY3RzIiwiaW5jbHVkZXMiLCJvZmZzZXQiLCJlbGVtZW50SWQiLCJwb3MiLCJ0b3VjaFN0YXRlT2JqZWN0IiwidGltZU9mZnNldCIsInBhcnNlSW50IiwicHJldlBvcyIsInRpbWUiLCJzdGF0ZSIsImlzVW5kZWZpbmVkIiwiYW5kcm9pZEhlbHBlcnMiLCJ0cnVuY2F0ZURlY2ltYWxzIiwidG91Y2giLCJwZXJmb3JtTXVsdGlBY3Rpb24iLCJFcnJvciIsInN0YXRlcyIsImRvUGVyZm9ybU11bHRpQWN0aW9uIiwiYm9vdHN0cmFwIiwic2VuZEFjdGlvbiIsIk9iamVjdCIsImFzc2lnbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxJQUFJQSxRQUFRLEdBQUcsRUFBZjtBQUFBLElBQW1CQyxPQUFPLEdBQUcsRUFBN0I7QUFBQSxJQUFpQ0MsVUFBVSxHQUFHLEVBQTlDOzs7O0FBRUFGLFFBQVEsQ0FBQ0csYUFBVCxHQUF5QixnQkFBZ0JDLE1BQWhCLEVBQXdCQyxJQUF4QixFQUE4QjtBQUNyRCxVQUFRRCxNQUFSO0FBQ0UsU0FBSyxLQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtFLEdBQUwsQ0FBU0QsSUFBSSxDQUFDRSxPQUFkLEVBQXVCRixJQUFJLENBQUNHLENBQTVCLEVBQStCSCxJQUFJLENBQUNJLENBQXBDLEVBQXVDSixJQUFJLENBQUNLLEtBQTVDLENBQWI7O0FBQ0YsU0FBSyxPQUFMO0FBQ0UsYUFBTyxNQUFNLEtBQUtDLFNBQUwsQ0FBZU4sSUFBSSxDQUFDRSxPQUFwQixFQUE2QkYsSUFBSSxDQUFDRyxDQUFsQyxFQUFxQ0gsSUFBSSxDQUFDSSxDQUExQyxDQUFiOztBQUNGLFNBQUssU0FBTDtBQUNFLGFBQU8sTUFBTSxLQUFLRyxPQUFMLENBQWFQLElBQUksQ0FBQ0UsT0FBbEIsRUFBMkJGLElBQUksQ0FBQ0csQ0FBaEMsRUFBbUNILElBQUksQ0FBQ0ksQ0FBeEMsQ0FBYjs7QUFDRixTQUFLLFFBQUw7QUFDRSxhQUFPLE1BQU0sS0FBS0ksU0FBTCxDQUFlUixJQUFJLENBQUNFLE9BQXBCLEVBQTZCRixJQUFJLENBQUNHLENBQWxDLEVBQXFDSCxJQUFJ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Q0FBMEJmLFNBQTFCLEVBQXFDYyxNQUFyQyxDQUFiO0FBQ0QsQ0FoQkQ7O0FBd0JBOUYsUUFBUSxDQUFDK0Ysb0JBQVQsR0FBZ0MsZ0JBQWdCZixTQUFoQixFQUEyQmMsTUFBM0IsRUFBbUM7QUFDakUsTUFBSXpGLElBQUo7O0FBQ0EsTUFBSTJFLFNBQUosRUFBZTtBQUNiM0UsSUFBQUEsSUFBSSxHQUFHO0FBQ0wyRSxNQUFBQSxTQURLO0FBRUxmLE1BQUFBLE9BQU8sRUFBRTZCO0FBRkosS0FBUDtBQUlBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsb0NBQTFCLEVBQWdFNUYsSUFBaEUsQ0FBYjtBQUNELEdBTkQsTUFNTztBQUNMQSxJQUFBQSxJQUFJLEdBQUc7QUFDTDRELE1BQUFBLE9BQU8sRUFBRTZCO0FBREosS0FBUDtBQUdBLFdBQU8sTUFBTSxLQUFLRSxTQUFMLENBQWVDLFVBQWYsQ0FBMEIsNEJBQTFCLEVBQXdENUYsSUFBeEQsQ0FBYjtBQUNEO0FBQ0YsQ0FkRDs7QUFnQkE2RixNQUFNLENBQUNDLE1BQVAsQ0FBY2pHLFVBQWQsRUFBMEJGLFFBQTFCLEVBQW9DQyxPQUFwQztlQUVlQyxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBhbmRyb2lkSGVscGVycyBmcm9tICcuLi9hbmRyb2lkLWhlbHBlcnMnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgZXJyb3JzLCBpc0Vycm9yVHlwZSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBhc3luY21hcCB9IGZyb20gJ2FzeW5jYm94JztcblxubGV0IGNvbW1hbmRzID0ge30sIGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb21tYW5kcy5kb1RvdWNoQWN0aW9uID0gYXN5bmMgZnVuY3Rpb24gKGFjdGlvbiwgb3B0cykge1xuICBzd2l0Y2ggKGFjdGlvbikge1xuICAgIGNhc2UgJ3RhcCc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50YXAob3B0cy5lbGVtZW50LCBvcHRzLngsIG9wdHMueSwgb3B0cy5jb3VudCk7XG4gICAgY2FzZSAncHJlc3MnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hEb3duKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnkpO1xuICAgIGNhc2UgJ3JlbGVhc2UnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hVcChvcHRzLmVsZW1lbnQsIG9wdHMueCwgb3B0cy55KTtcbiAgICBjYXNlICdtb3ZlVG8nOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudG91Y2hNb3ZlKG9wdHMuZWxlbWVudCwgb3B0cy54LCBvcHRzLnkpO1xuICAgIGNhc2UgJ3dhaXQnOlxuICAgICAgcmV0dXJuIGF3YWl0IEIuZGVsYXkob3B0cy5tcyk7XG4gICAgY2FzZSAnbG9uZ1ByZXNzJzpcbiAgICAgIGlmICh0eXBlb2Ygb3B0cy5kdXJhdGlvbiA9PT0gJ3VuZGVmaW5lZCcgfHwgIW9wdHMuZHVyYXRpb24pIHtcbiAgICAgICAgb3B0cy5kdXJhdGlvbiA9IDEwMDA7XG4gICAgICB9XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy50b3VjaExvbmdDbGljayhvcHRzLmVsZW1lbnQsIG9wdHMueCwgb3B0cy55LCBvcHRzLmR1cmF0aW9uKTtcbiAgICBjYXNlICdjYW5jZWwnOlxuICAgICAgLy8gVE9ETzogY2xhcmlmeSBiZWhhdmlvciBvZiAnY2FuY2VsJyBhY3Rpb24gYW5kIGZpeCB0aGlzXG4gICAgICBsb2cud2FybihcIkNhbmNlbCBhY3Rpb24gY3VycmVudGx5IGhhcyBubyBlZmZlY3RcIik7XG4gICAgICBicmVhaztcbiAgICBkZWZhdWx0OlxuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYHVua25vd24gYWN0aW9uICR7YWN0aW9ufWApO1xuICB9XG59O1xuXG5cbi8vIGRyYWcgaXMgKm5vdCogcHJlc3MtbW92ZS1yZWxlYXNlLCBzbyB3ZSBuZWVkIHRvIHRyYW5zbGF0ZVxuLy8gZHJhZyB3b3JrcyBmaW5lIGZvciBzY3JvbGwsIGFzIHdlbGxcbmhlbHBlcnMuZG9Ub3VjaERyYWcgPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZXMpIHtcbiAgbGV0IGxvbmdQcmVzcyA9IGdlc3R1cmVzWzBdO1xuICBsZXQgbW92ZVRvID0gZ2VzdHVyZXNbMV07XG4gIGxldCBzdGFydFggPSBsb25nUHJlc3Mub3B0aW9ucy54IHx8IDAsXG4gICAgICBzdGFydFkgPSBsb25nUHJlc3Mub3B0aW9ucy55IHx8IDAsXG4gICAgICBlbmRYID0gbW92ZVRvLm9wdGlvbnMueCB8fCAwLFxuICAgICAgZW5kWSA9IG1vdmVUby5vcHRpb25zLnkgfHwgMDtcbiAgaWYgKGxvbmdQcmVzcy5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhsb25nUHJlc3Mub3B0aW9ucy5lbGVtZW50KTtcbiAgICBzdGFydFggKz0geCB8fCAwO1xuICAgIHN0YXJ0WSArPSB5IHx8IDA7XG4gIH1cbiAgaWYgKG1vdmVUby5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICBsZXQge3gsIHl9ID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhtb3ZlVG8ub3B0aW9ucy5lbGVtZW50KTtcbiAgICBlbmRYICs9IHggfHwgMDtcbiAgICBlbmRZICs9IHkgfHwgMDtcbiAgfVxuXG4gIGxldCBhcGlMZXZlbCA9IGF3YWl0IHRoaXMuYWRiLmdldEFwaUxldmVsKCk7XG4gIC8vIGxvbGxpcG9wIHRha2VzIGEgbGl0dGxlIGxvbmdlciB0byBnZXQgdGhpbmdzIHJvbGxpbmdcbiAgbGV0IGR1cmF0aW9uID0gYXBpTGV2ZWwgPj0gNSA/IDIgOiAxO1xuICAvLyBtYWtlIHN1cmUgdGhhdCBpZiB0aGUgbG9uZyBwcmVzcyBoYXMgYSBkdXJhdGlvbiwgd2UgdXNlIGl0LlxuICBpZiAobG9uZ1ByZXNzLm9wdGlvbnMgJiYgbG9uZ1ByZXNzLm9wdGlvbnMuZHVyYXRpb24pIHtcbiAgICBkdXJhdGlvbiA9IE1hdGgubWF4KGxvbmdQcmVzcy5vcHRpb25zLmR1cmF0aW9uIC8gMTAwMCwgZHVyYXRpb24pO1xuICB9XG5cbiAgLy8gYGRyYWdgIHdpbGwgdGFrZSBjYXJlIG9mIHdoZXRoZXIgdGhlcmUgaXMgYW4gZWxlbWVudCBvciBub3QgYXQgdGhhdCBsZXZlbFxuICByZXR1cm4gYXdhaXQgdGhpcy5kcmFnKHN0YXJ0WCwgc3RhcnRZLCBlbmRYLCBlbmRZLCBkdXJhdGlvbiwgMSwgbG9uZ1ByZXNzLm9wdGlvbnMuZWxlbWVudCwgbW92ZVRvLm9wdGlvbnMuZWxlbWVudCk7XG59O1xuXG4vLyBSZWxlYXNlIGdlc3R1cmUgbmVlZHMgZWxlbWVudCBvciBjby1vcmRpbmF0ZXMgdG8gcmVsZWFzZSBpdCBmcm9tIHRoYXQgcG9zaXRpb25cbi8vIG9yIGVsc2UgcmVsZWFzZSBnZXN0dXJlIGlzIHBlcmZvcm1lZCBmcm9tIGNlbnRlciBvZiB0aGUgc2NyZWVuLCBzbyB0byBmaXggaXRcbi8vIFRoaXMgbWV0aG9kIHNldHMgY28tb3JkaW5hdGVzL2VsZW1lbnQgdG8gcmVsZWFzZSBnZXN0dXJlIGlmIGl0IGhhcyBubyBvcHRpb25zIHNldCBhbHJlYWR5LlxuaGVscGVycy5maXhSZWxlYXNlID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGxldCByZWxlYXNlID0gXy5sYXN0KGdlc3R1cmVzKTtcbiAgLy8gc29tZXRpbWVzIHRoZXJlIGFyZSBubyBvcHRpb25zXG4gIHJlbGVhc2Uub3B0aW9ucyA9IHJlbGVhc2Uub3B0aW9ucyB8fCB7fTtcbiAgLy8gbm90aGluZyB0byBkbyBpZiByZWxlYXNlIG9wdGlvbnMgYXJlIGFscmVhZHkgc2V0XG4gIGlmIChyZWxlYXNlLm9wdGlvbnMuZWxlbWVudCB8fCAocmVsZWFzZS5vcHRpb25zLnggJiYgcmVsZWFzZS5vcHRpb25zLnkpKSB7XG4gICAgcmV0dXJuO1xuICB9XG4gIC8vIHdpdGhvdXQgY29vcmRpbmF0ZXMsIGByZWxlYXNlYCB1c2VzIHRoZSBjZW50ZXIgb2YgdGhlIHNjcmVlbiwgd2hpY2gsXG4gIC8vIGdlbmVyYWxseSBzcGVha2luZywgaXMgbm90IHdoYXQgd2Ugd2FudFxuICAvLyB0aGVyZWZvcmU6IGxvb3AgYmFja3dhcmRzIGFuZCB1c2UgdGhlIGxhc3QgY29tbWFuZCB3aXRoIGFuIGVsZW1lbnQgYW5kL29yXG4gIC8vIG9mZnNldCBjb29yZGluYXRlc1xuICBnZXN0dXJlcyA9IF8uY2xvbmUoZ2VzdHVyZXMpO1xuICBsZXQgcmVmID0gbnVsbDtcbiAgZm9yIChsZXQgZ2VzdHVyZSBvZiBnZXN0dXJlcy5yZXZlcnNlKCkpIHtcbiAgICBsZXQgb3B0cyA9IGdlc3R1cmUub3B0aW9ucztcbiAgICBpZiAob3B0cy5lbGVtZW50IHx8IChvcHRzLnggJiYgb3B0cy55KSkge1xuICAgICAgcmVmID0gZ2VzdHVyZTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfVxuICBpZiAocmVmKSB7XG4gICAgbGV0IG9wdHMgPSByZWYub3B0aW9ucztcbiAgICBpZiAob3B0cy5lbGVtZW50KSB7XG4gICAgICBsZXQgbG9jID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhvcHRzLmVsZW1lbnQpO1xuICAgICAgaWYgKG9wdHMueCAmJiBvcHRzLnkpIHtcbiAgICAgICAgLy8gdGhpcyBpcyBhbiBvZmZzZXQgZnJvbSB0aGUgZWxlbWVudFxuICAgICAgICByZWxlYXNlLm9wdGlvbnMgPSB7XG4gICAgICAgICAgeDogbG9jLnggKyBvcHRzLngsXG4gICAgICAgICAgeTogbG9jLnkgKyBvcHRzLnlcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIHRoaXMgaXMgdGhlIGNlbnRlciBvZiB0aGUgZWxlbWVudFxuICAgICAgICBsZXQgc2l6ZSA9IGF3YWl0IHRoaXMuZ2V0U2l6ZShvcHRzLmVsZW1lbnQpO1xuICAgICAgICByZWxlYXNlLm9wdGlvbnMgPSB7XG4gICAgICAgICAgeDogbG9jLnggKyBzaXplLndpZHRoIC8gMixcbiAgICAgICAgICB5OiBsb2MueSArIHNpemUuaGVpZ2h0IC8gMlxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICByZWxlYXNlLm9wdGlvbnMgPSBfLnBpY2sob3B0cywgJ3gnLCAneScpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmVsZWFzZTtcbn07XG5cbi8vIFBlcmZvcm0gb25lIGdlc3R1cmVcbmhlbHBlcnMucGVyZm9ybUdlc3R1cmUgPSBhc3luYyBmdW5jdGlvbiAoZ2VzdHVyZSkge1xuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hBY3Rpb24oZ2VzdHVyZS5hY3Rpb24sIGdlc3R1cmUub3B0aW9ucyB8fCB7fSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICAvLyBzb21ldGltZSB0aGUgZWxlbWVudCBpcyBub3QgYXZhaWxhYmxlIHdoZW4gcmVsZWFzaW5nLCByZXRyeSB3aXRob3V0IGl0XG4gICAgaWYgKGlzRXJyb3JUeXBlKGUsIGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IpICYmIGdlc3R1cmUuYWN0aW9uID09PSAncmVsZWFzZScgJiZcbiAgICAgICAgZ2VzdHVyZS5vcHRpb25zLmVsZW1lbnQpIHtcbiAgICAgIGRlbGV0ZSBnZXN0dXJlLm9wdGlvbnMuZWxlbWVudDtcbiAgICAgIGxvZy5kZWJ1ZyhgcmV0cnlpbmcgcmVsZWFzZSB3aXRob3V0IGVsZW1lbnQgb3B0czogJHtnZXN0dXJlLm9wdGlvbnN9LmApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZG9Ub3VjaEFjdGlvbihnZXN0dXJlLmFjdGlvbiwgZ2VzdHVyZS5vcHRpb25zIHx8IHt9KTtcbiAgICB9XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuY29tbWFuZHMucGVyZm9ybVRvdWNoID0gYXN5bmMgZnVuY3Rpb24gKGdlc3R1cmVzKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICAvLyBwcmVzcy13YWl0LW1vdmVUby1yZWxlYXNlIGlzIGBzd2lwZWAsIHNvIHVzZSBuYXRpdmUgbWV0aG9kXG4gIGlmIChnZXN0dXJlcy5sZW5ndGggPT09IDQgJiZcbiAgICAgIGdlc3R1cmVzWzBdLmFjdGlvbiA9PT0gJ3ByZXNzJyAmJlxuICAgICAgZ2VzdHVyZXNbMV0uYWN0aW9uID09PSAnd2FpdCcgJiZcbiAgICAgIGdlc3R1cmVzWzJdLmFjdGlvbiA9PT0gJ21vdmVUbycgJiZcbiAgICAgIGdlc3R1cmVzWzNdLmFjdGlvbiA9PT0gJ3JlbGVhc2UnKSB7XG5cbiAgICBsZXQgc3dpcGVPcHRzID0gYXdhaXQgdGhpcy5nZXRTd2lwZU9wdGlvbnMoZ2VzdHVyZXMpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnN3aXBlKHN3aXBlT3B0cy5zdGFydFgsIHN3aXBlT3B0cy5zdGFydFksIHN3aXBlT3B0cy5lbmRYLFxuICAgICAgICBzd2lwZU9wdHMuZW5kWSwgc3dpcGVPcHRzLmR1cmF0aW9uLCBzd2lwZU9wdHMudG91Y2hDb3VudCxcbiAgICAgICAgc3dpcGVPcHRzLmVsZW1lbnQpO1xuICB9XG4gIGxldCBhY3Rpb25zID0gXy5tYXAoZ2VzdHVyZXMsIFwiYWN0aW9uXCIpO1xuXG4gIGlmIChhY3Rpb25zWzBdID09PSAnbG9uZ1ByZXNzJyAmJiBhY3Rpb25zWzFdID09PSAnbW92ZVRvJyAmJiBhY3Rpb25zWzJdID09PSAncmVsZWFzZScpIHtcbiAgICAvLyBzb21lIHRoaW5ncyBhcmUgc3BlY2lhbFxuICAgIHJldHVybiBhd2FpdCB0aGlzLmRvVG91Y2hEcmFnKGdlc3R1cmVzKTtcbiAgfSBlbHNlIHtcbiAgICBpZiAoYWN0aW9ucy5sZW5ndGggPT09IDIpIHtcbiAgICAgIC8vIGBwcmVzc2Agd2l0aG91dCBhIHdhaXQgaXMgdG9vIHNsb3cgYW5kIGdldHMgaW50ZXJwcmV0dGVkIGFzIGEgYGxvbmdQcmVzc2BcbiAgICAgIGlmIChfLmhlYWQoYWN0aW9ucykgPT09ICdwcmVzcycgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgYWN0aW9uc1swXSA9ICd0YXAnO1xuICAgICAgICBnZXN0dXJlc1swXS5hY3Rpb24gPSAndGFwJztcbiAgICAgIH1cblxuICAgICAgLy8gdGhlIGBsb25nUHJlc3NgIGFuZCBgdGFwYCBtZXRob2RzIHJlbGVhc2Ugb24gdGhlaXIgb3duXG4gICAgICBpZiAoKF8uaGVhZChhY3Rpb25zKSA9PT0gJ3RhcCcgfHwgXy5oZWFkKGFjdGlvbnMpID09PSAnbG9uZ1ByZXNzJykgJiYgXy5sYXN0KGFjdGlvbnMpID09PSAncmVsZWFzZScpIHtcbiAgICAgICAgZ2VzdHVyZXMucG9wKCk7XG4gICAgICAgIGFjdGlvbnMucG9wKCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIGxvbmdwcmVzcyBmb2xsb3dlZCBieSBhbnl0aGluZyBvdGhlciB0aGFuIHJlbGVhc2Ugc2hvdWxkIGJlY29tZSBhIHByZXNzIGFuZCB3YWl0XG4gICAgICBpZiAoYWN0aW9uc1swXSA9PT0gJ2xvbmdQcmVzcycpIHtcbiAgICAgICAgYWN0aW9ucyA9IFsncHJlc3MnLCAnd2FpdCcsIC4uLmFjdGlvbnMuc2xpY2UoMSldO1xuXG4gICAgICAgIGxldCBwcmVzcyA9IGdlc3R1cmVzLnNoaWZ0KCk7XG4gICAgICAgIHByZXNzLmFjdGlvbiA9ICdwcmVzcyc7XG4gICAgICAgIGxldCB3YWl0ID0ge1xuICAgICAgICAgIGFjdGlvbjogJ3dhaXQnLFxuICAgICAgICAgIG9wdGlvbnM6IHttczogcHJlc3Mub3B0aW9ucy5kdXJhdGlvbiB8fCAxMDAwfVxuICAgICAgICB9O1xuICAgICAgICBkZWxldGUgcHJlc3Mub3B0aW9ucy5kdXJhdGlvbjtcbiAgICAgICAgZ2VzdHVyZXMgPSBbcHJlc3MsIHdhaXQsIC4uLmdlc3R1cmVzXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBsZXQgZml4ZWRHZXN0dXJlcyA9IGF3YWl0IHRoaXMucGFyc2VUb3VjaChnZXN0dXJlcywgZmFsc2UpO1xuICAgIC8vIGZpeCByZWxlYXNlIGFjdGlvbiB0aGVuIHBlcmZvcm0gYWxsIGFjdGlvbnNcbiAgICBpZiAoYWN0aW9uc1thY3Rpb25zLmxlbmd0aCAtIDFdID09PSAncmVsZWFzZScpIHtcbiAgICAgIGFjdGlvbnNbYWN0aW9ucy5sZW5ndGggLSAxXSA9IGF3YWl0IHRoaXMuZml4UmVsZWFzZShnZXN0dXJlcyk7XG4gICAgfVxuICAgIGZvciAobGV0IGcgb2YgZml4ZWRHZXN0dXJlcykge1xuICAgICAgYXdhaXQgdGhpcy5wZXJmb3JtR2VzdHVyZShnKTtcbiAgICB9XG4gIH1cbn07XG5cbmhlbHBlcnMucGFyc2VUb3VjaCA9IGFzeW5jIGZ1bmN0aW9uIChnZXN0dXJlcywgbXVsdGkpIHtcbiAgLy8gYmVjYXVzZSBtdWx0aS10b3VjaCByZWxlYXNlcyBhdCB0aGUgZW5kIGJ5IGRlZmF1bHRcbiAgaWYgKG11bHRpICYmIF8ubGFzdChnZXN0dXJlcykuYWN0aW9uID09PSAncmVsZWFzZScpIHtcbiAgICBnZXN0dXJlcy5wb3AoKTtcbiAgfVxuXG4gIGxldCB0b3VjaFN0YXRlT2JqZWN0cyA9IGF3YWl0IGFzeW5jbWFwKGdlc3R1cmVzLCBhc3luYyAoZ2VzdHVyZSkgPT4ge1xuICAgIGxldCBvcHRpb25zID0gZ2VzdHVyZS5vcHRpb25zIHx8IHt9O1xuICAgIGlmIChfLmluY2x1ZGVzKFsncHJlc3MnLCAnbW92ZVRvJywgJ3RhcCcsICdsb25nUHJlc3MnXSwgZ2VzdHVyZS5hY3Rpb24pKSB7XG4gICAgICBvcHRpb25zLm9mZnNldCA9IGZhbHNlO1xuICAgICAgbGV0IGVsZW1lbnRJZCA9IGdlc3R1cmUub3B0aW9ucy5lbGVtZW50O1xuICAgICAgaWYgKGVsZW1lbnRJZCkge1xuICAgICAgICBsZXQgcG9zID0gYXdhaXQgdGhpcy5nZXRMb2NhdGlvbkluVmlldyhlbGVtZW50SWQpO1xuICAgICAgICBpZiAoZ2VzdHVyZS5vcHRpb25zLnggfHwgZ2VzdHVyZS5vcHRpb25zLnkpIHtcbiAgICAgICAgICBvcHRpb25zLnggPSBwb3MueCArIChnZXN0dXJlLm9wdGlvbnMueCB8fCAwKTtcbiAgICAgICAgICBvcHRpb25zLnkgPSBwb3MueSArIChnZXN0dXJlLm9wdGlvbnMueSB8fCAwKTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmdldFNpemUoZWxlbWVudElkKTtcbiAgICAgICAgICBvcHRpb25zLnggPSBwb3MueCArICh3aWR0aCAvIDIpO1xuICAgICAgICAgIG9wdGlvbnMueSA9IHBvcy55ICsgKGhlaWdodCAvIDIpO1xuICAgICAgICB9XG4gICAgICAgIGxldCB0b3VjaFN0YXRlT2JqZWN0ID0ge1xuICAgICAgICAgIGFjdGlvbjogZ2VzdHVyZS5hY3Rpb24sXG4gICAgICAgICAgb3B0aW9ucyxcbiAgICAgICAgICB0aW1lT2Zmc2V0OiAwLjAwNSxcbiAgICAgICAgfTtcbiAgICAgICAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3Q7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBvcHRpb25zLnggPSAoZ2VzdHVyZS5vcHRpb25zLnggfHwgMCk7XG4gICAgICAgIG9wdGlvbnMueSA9IChnZXN0dXJlLm9wdGlvbnMueSB8fCAwKTtcblxuICAgICAgICBsZXQgdG91Y2hTdGF0ZU9iamVjdCA9IHtcbiAgICAgICAgICBhY3Rpb246IGdlc3R1cmUuYWN0aW9uLFxuICAgICAgICAgIG9wdGlvbnMsXG4gICAgICAgICAgdGltZU9mZnNldDogMC4wMDUsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiB0b3VjaFN0YXRlT2JqZWN0O1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICBsZXQgb2Zmc2V0ID0gMC4wMDU7XG4gICAgICBpZiAoZ2VzdHVyZS5hY3Rpb24gPT09ICd3YWl0Jykge1xuICAgICAgICBvcHRpb25zID0gZ2VzdHVyZS5vcHRpb25zO1xuICAgICAgICBvZmZzZXQgPSAocGFyc2VJbnQoZ2VzdHVyZS5vcHRpb25zLm1zLCAxMCkgLyAxMDAwKTtcbiAgICAgIH1cbiAgICAgIGxldCB0b3VjaFN0YXRlT2JqZWN0ID0ge1xuICAgICAgICBhY3Rpb246IGdlc3R1cmUuYWN0aW9uLFxuICAgICAgICBvcHRpb25zLFxuICAgICAgICB0aW1lT2Zmc2V0OiBvZmZzZXQsXG4gICAgICB9O1xuICAgICAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3Q7XG4gICAgfVxuICB9LCBmYWxzZSk7XG4gIC8vIHdlIG5lZWQgdG8gY2hhbmdlIHRoZSB0aW1lICh3aGljaCBpcyBub3cgYW4gb2Zmc2V0KVxuICAvLyBhbmQgdGhlIHBvc2l0aW9uICh3aGljaCBtYXkgYmUgYW4gb2Zmc2V0KVxuICBsZXQgcHJldlBvcyA9IG51bGwsXG4gICAgICB0aW1lID0gMDtcbiAgZm9yIChsZXQgc3RhdGUgb2YgdG91Y2hTdGF0ZU9iamVjdHMpIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChzdGF0ZS5vcHRpb25zLngpICYmIF8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy55KSAmJiBwcmV2UG9zICE9PSBudWxsKSB7XG4gICAgICAvLyB0aGlzIGhhcHBlbnMgd2l0aCB3YWl0XG4gICAgICBzdGF0ZS5vcHRpb25zLnggPSBwcmV2UG9zLng7XG4gICAgICBzdGF0ZS5vcHRpb25zLnkgPSBwcmV2UG9zLnk7XG4gICAgfVxuICAgIGlmIChzdGF0ZS5vcHRpb25zLm9mZnNldCAmJiBwcmV2UG9zKSB7XG4gICAgICAvLyB0aGUgY3VycmVudCBwb3NpdGlvbiBpcyBhbiBvZmZzZXRcbiAgICAgIHN0YXRlLm9wdGlvbnMueCArPSBwcmV2UG9zLng7XG4gICAgICBzdGF0ZS5vcHRpb25zLnkgKz0gcHJldlBvcy55O1xuICAgIH1cbiAgICBkZWxldGUgc3RhdGUub3B0aW9ucy5vZmZzZXQ7XG4gICAgaWYgKCFfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueCkgJiYgIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy55KSkge1xuICAgICAgcHJldlBvcyA9IHN0YXRlLm9wdGlvbnM7XG4gICAgfVxuXG4gICAgaWYgKG11bHRpKSB7XG4gICAgICBsZXQgdGltZU9mZnNldCA9IHN0YXRlLnRpbWVPZmZzZXQ7XG4gICAgICB0aW1lICs9IHRpbWVPZmZzZXQ7XG4gICAgICBzdGF0ZS50aW1lID0gYW5kcm9pZEhlbHBlcnMudHJ1bmNhdGVEZWNpbWFscyh0aW1lLCAzKTtcblxuICAgICAgLy8gbXVsdGkgZ2VzdHVyZXMgcmVxdWlyZSAndG91Y2gnIHJhdGhlciB0aGFuICdvcHRpb25zJ1xuICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKHN0YXRlLm9wdGlvbnMueCkgJiYgIV8uaXNVbmRlZmluZWQoc3RhdGUub3B0aW9ucy55KSkge1xuICAgICAgICBzdGF0ZS50b3VjaCA9IHtcbiAgICAgICAgICB4OiBzdGF0ZS5vcHRpb25zLngsXG4gICAgICAgICAgeTogc3RhdGUub3B0aW9ucy55XG4gICAgICAgIH07XG4gICAgICB9XG4gICAgICBkZWxldGUgc3RhdGUub3B0aW9ucztcbiAgICB9XG4gICAgZGVsZXRlIHN0YXRlLnRpbWVPZmZzZXQ7XG4gIH1cbiAgcmV0dXJuIHRvdWNoU3RhdGVPYmplY3RzO1xufTtcblxuXG5jb21tYW5kcy5wZXJmb3JtTXVsdGlBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiAoYWN0aW9ucywgZWxlbWVudElkKSB7XG4gIGlmICh0aGlzLmlzV2ViQ29udGV4dCgpKSB7XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Ob3RZZXRJbXBsZW1lbnRlZEVycm9yKCk7XG4gIH1cblxuICAvLyBBbmRyb2lkIG5lZWRzIGF0IGxlYXN0IHR3byBhY3Rpb25zIHRvIGJlIGFibGUgdG8gcGVyZm9ybSBhIG11bHRpIHBvaW50ZXIgZ2VzdHVyZVxuICBpZiAoYWN0aW9ucy5sZW5ndGggPT09IDEpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJNdWx0aSBQb2ludGVyIEdlc3R1cmVzIG5lZWQgYXQgbGVhc3QgdHdvIGFjdGlvbnMuIFwiICtcbiAgICAgICAgXCJVc2UgVG91Y2ggQWN0aW9ucyBmb3IgYSBzaW5nbGUgYWN0aW9uLlwiKTtcbiAgfVxuXG4gIGxldCBzdGF0ZXMgPSBhd2FpdCBhc3luY21hcChhY3Rpb25zLCBhc3luYyAoYWN0aW9uKSA9PiB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucGFyc2VUb3VjaChhY3Rpb24sIHRydWUpO1xuICB9LCBmYWxzZSk7XG5cbiAgcmV0dXJuIGF3YWl0IHRoaXMuZG9QZXJmb3JtTXVsdGlBY3Rpb24oZWxlbWVudElkLCBzdGF0ZXMpO1xufTtcblxuLyoqXG4gKiBSZWFzb24gZm9yIGlzb2xhdGluZyBkb1BlcmZvcm1NdWx0aUFjdGlvbiBmcm9tIHBlcmZvcm1NdWx0aUFjdGlvbiBpcyBmb3IgcmV1c2luZyBwZXJmb3JtTXVsdGlBY3Rpb25cbiAqIGFjcm9zcyBhbmRyb2lkLWRyaXZlcnMgKGxpa2UgYXBwaXVtLXVpYXV0b21hdG9yMi1kcml2ZXIpIGFuZCB0byBhdm9pZCBjb2RlIGR1cGxpY2F0aW9uLlxuICogT3RoZXIgYW5kcm9pZC1kcml2ZXJzIChsaWtlIGFwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyKSBuZWVkIHRvIG92ZXJyaWRlIGRvUGVyZm9ybU11bHRpQWN0aW9uXG4gKiB0byBmYWNpbGl0YXRlIHBlcmZvcm1NdWx0aUFjdGlvbi5cbiAqL1xuY29tbWFuZHMuZG9QZXJmb3JtTXVsdGlBY3Rpb24gPSBhc3luYyBmdW5jdGlvbiAoZWxlbWVudElkLCBzdGF0ZXMpIHtcbiAgbGV0IG9wdHM7XG4gIGlmIChlbGVtZW50SWQpIHtcbiAgICBvcHRzID0ge1xuICAgICAgZWxlbWVudElkLFxuICAgICAgYWN0aW9uczogc3RhdGVzXG4gICAgfTtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5ib290c3RyYXAuc2VuZEFjdGlvbihcImVsZW1lbnQ6cGVyZm9ybU11bHRpUG9pbnRlckdlc3R1cmVcIiwgb3B0cyk7XG4gIH0gZWxzZSB7XG4gICAgb3B0cyA9IHtcbiAgICAgIGFjdGlvbnM6IHN0YXRlc1xuICAgIH07XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuYm9vdHN0cmFwLnNlbmRBY3Rpb24oXCJwZXJmb3JtTXVsdGlQb2ludGVyR2VzdHVyZVwiLCBvcHRzKTtcbiAgfVxufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3RvdWNoLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
