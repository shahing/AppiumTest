"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.FINGERPRINT_UNLOCK = exports.PATTERN_UNLOCK = exports.PASSWORD_UNLOCK = exports.PIN_UNLOCK = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _asyncbox = require("asyncbox");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

const PIN_UNLOCK = "pin";
exports.PIN_UNLOCK = PIN_UNLOCK;
const PASSWORD_UNLOCK = "password";
exports.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
const PATTERN_UNLOCK = "pattern";
exports.PATTERN_UNLOCK = PATTERN_UNLOCK;
const FINGERPRINT_UNLOCK = "fingerprint";
exports.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
const UNLOCK_TYPES = [PIN_UNLOCK, PASSWORD_UNLOCK, PATTERN_UNLOCK, FINGERPRINT_UNLOCK];
const KEYCODE_NUMPAD_ENTER = "66";
const UNLOCK_WAIT_TIME = 100;
const HIDE_KEYBOARD_WAIT_TIME = 100;
const INPUT_KEYS_WAIT_TIME = 100;
let helpers = {};
exports.helpers = helpers;

helpers.isValidUnlockType = function (type) {
  return UNLOCK_TYPES.indexOf(type) !== -1;
};

helpers.isValidKey = function (type, key) {
  if (_lodash.default.isUndefined(key)) {
    return false;
  }

  if (type === PIN_UNLOCK || type === FINGERPRINT_UNLOCK) {
    return /^[0-9]+$/.test(key.trim());
  }

  if (type === PATTERN_UNLOCK) {
    if (!/^[1-9]{2,9}$/.test(key.trim())) {
      return false;
    }

    return !/([1-9]).*?\1/.test(key.trim());
  }

  if (type === PASSWORD_UNLOCK) {
    return /.{4,}/g.test(key);
  }

  throw new Error(`Invalid unlock type ${type}`);
};

helpers.dismissKeyguard = async function (driver, adb) {
  let isKeyboardShown = await driver.isKeyboardShown();

  if (isKeyboardShown) {
    await driver.hideKeyboard();
    await (0, _asyncbox.sleep)(HIDE_KEYBOARD_WAIT_TIME);
  }

  _logger.default.info("Dismiss notifications from unlock view");

  await adb.shell(["service", "call", "notification", "1"]);
  await adb.back();

  if ((await adb.getApiLevel()) > 21) {
    _logger.default.info("Trying to dismiss keyguard");

    await adb.shell(["wm", "dismiss-keyguard"]);
    return;
  }

  _logger.default.info("Swiping up to dismiss keyguard");

  await helpers.swipeUp(driver);
};

helpers.swipeUp = async function (driver) {
  let windowSize = await driver.getWindowSize();
  let x0 = parseInt(windowSize.x / 2, 10);
  let y0 = windowSize.y - 10;
  let yP = 100;
  let actions = [{
    action: 'press',
    options: {
      element: null,
      x: x0,
      y: y0
    }
  }, {
    action: 'moveTo',
    options: {
      element: null,
      x: x0,
      y: yP
    }
  }, {
    action: 'release'
  }];
  await driver.performTouch(actions);
};

helpers.encodePassword = function (key) {
  return key.replace(/\s/ig, "%s");
};

helpers.stringKeyToArr = function (key) {
  return key.trim().replace(/\s+/g, '').split(/\s*/);
};

helpers.fingerprintUnlock = async function (adb, driver, capabilities) {
  if ((await adb.getApiLevel()) < 23) {
    throw new Error("Fingerprint unlock only works for Android 6+ emulators");
  }

  await adb.fingerprint(capabilities.unlockKey);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.pinUnlock = async function (adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using pin ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let keys = helpers.stringKeyToArr(capabilities.unlockKey);

  if ((await adb.getApiLevel()) >= 21) {
    let els = await driver.findElOrEls("id", "com.android.systemui:id/digit_text", true);

    if (_lodash.default.isEmpty(els)) {
      throw new Error("Error finding unlock pin buttons!");
    }

    let pins = {};

    for (let el of els) {
      let text = await driver.getAttribute("text", _appiumSupport.util.unwrapElement(el));
      pins[text] = el;
    }

    for (let pin of keys) {
      let el = pins[pin];
      await driver.click(_appiumSupport.util.unwrapElement(el));
    }
  } else {
    for (let pin of keys) {
      let el = await driver.findElOrEls('id', `com.android.keyguard:id/key${pin}`, false);

      if (el === null) {
        throw new Error(`Error finding unlock pin '${pin}' button!`);
      }

      await driver.click(_appiumSupport.util.unwrapElement(el));
    }
  }

  const el = await driver.findElOrEls('xpath', "//*[contains(@resource-id, 'id/key_enter')]", false);
  await driver.click(_appiumSupport.util.unwrapElement(el));
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.passwordUnlock = async function (adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using password ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let key = capabilities.unlockKey;
  key = helpers.encodePassword(key);
  await adb.shell(["input", "text", key]);
  await (0, _asyncbox.sleep)(INPUT_KEYS_WAIT_TIME);
  await adb.shell(["input", "keyevent", KEYCODE_NUMPAD_ENTER]);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.getPatternKeyPosition = function (key, initPos, piece) {
  const cols = 3;
  const pins = 9;

  let xPos = (key, x, piece) => {
    return Math.round(x + (key % cols || cols) * piece - piece / 2);
  };

  let yPos = (key, y, piece) => {
    return Math.round(y + (Math.ceil((key % pins || pins) / cols) * piece - piece / 2));
  };

  return {
    x: xPos(key, initPos.x, piece),
    y: yPos(key, initPos.y, piece)
  };
};

helpers.getPatternActions = function (keys, initPos, piece) {
  let actions = [];
  let lastPos;

  for (let key of keys) {
    let keyPos = helpers.getPatternKeyPosition(key, initPos, piece);

    if (key === keys[0]) {
      actions.push({
        action: 'press',
        options: {
          element: null,
          x: keyPos.x,
          y: keyPos.y
        }
      });
      lastPos = keyPos;
      continue;
    }

    let moveTo = {
      x: 0,
      y: 0
    };
    let diffX = keyPos.x - lastPos.x;

    if (diffX > 0) {
      moveTo.x = piece;

      if (Math.abs(diffX) > piece) {
        moveTo.x += piece;
      }
    } else if (diffX < 0) {
      moveTo.x = -1 * piece;

      if (Math.abs(diffX) > piece) {
        moveTo.x -= piece;
      }
    }

    let diffY = keyPos.y - lastPos.y;

    if (diffY > 0) {
      moveTo.y = piece;

      if (Math.abs(diffY) > piece) {
        moveTo.y += piece;
      }
    } else if (diffY < 0) {
      moveTo.y = -1 * piece;

      if (Math.abs(diffY) > piece) {
        moveTo.y -= piece;
      }
    }

    actions.push({
      action: 'moveTo',
      options: {
        element: null,
        x: moveTo.x,
        y: moveTo.y
      }
    });
    lastPos = keyPos;
  }

  actions.push({
    action: 'release'
  });
  return actions;
};

helpers.patternUnlock = async function (adb, driver, capabilities) {
  _logger.default.info(`Trying to unlock device using pattern ${capabilities.unlockKey}`);

  await helpers.dismissKeyguard(driver, adb);
  let keys = helpers.stringKeyToArr(capabilities.unlockKey);
  let apiLevel = await adb.getApiLevel();
  let el = await driver.findElOrEls("id", `com.android.${apiLevel >= 21 ? 'systemui' : 'keyguard'}:id/lockPatternView`, false);
  let initPos = await driver.getLocation(_appiumSupport.util.unwrapElement(el));
  let size = await driver.getSize(_appiumSupport.util.unwrapElement(el));
  let actions = helpers.getPatternActions(keys, initPos, size.width / 3);
  await driver.performTouch(actions);
  await (0, _asyncbox.sleep)(UNLOCK_WAIT_TIME);
};

helpers.PIN_UNLOCK = PIN_UNLOCK;
helpers.PASSWORD_UNLOCK = PASSWORD_UNLOCK;
helpers.PATTERN_UNLOCK = PATTERN_UNLOCK;
helpers.FINGERPRINT_UNLOCK = FINGERPRINT_UNLOCK;
var _default = helpers;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91bmxvY2staGVscGVycy5qcyJdLCJuYW1lcyI6WyJQSU5fVU5MT0NLIiwiUEFTU1dPUkRfVU5MT0NLIiwiUEFUVEVSTl9VTkxPQ0siLCJGSU5HRVJQUklOVF9VTkxPQ0siLCJVTkxPQ0tfVFlQRVMiLCJLRVlDT0RFX05VTVBBRF9FTlRFUiIsIlVOTE9DS19XQUlUX1RJTUUiLCJISURFX0tFWUJPQVJEX1dBSVRfVElNRSIsIklOUFVUX0tFWVNfV0FJVF9USU1FIiwiaGVscGVycyIsImlzVmFsaWRVbmxvY2tUeXBlIiwidHlwZSIsImluZGV4T2YiLCJpc1ZhbGlkS2V5Iiwia2V5IiwiXyIsImlzVW5kZWZpbmVkIiwidGVzdCIsInRyaW0iLCJFcnJvciIsImRpc21pc3NLZXlndWFyZCIsImRyaXZlciIsImFkYiIsImlzS2V5Ym9hcmRTaG93biIsImhpZGVLZXlib2FyZCIsImxvZ2dlciIsImluZm8iLCJzaGVsbCIsImJhY2siLCJnZXRBcGlMZXZlbCIsInN3aXBlVXAiLCJ3aW5kb3dTaXplIiwiZ2V0V2luZG93U2l6ZSIsIngwIiwicGFyc2VJbnQiLCJ4IiwieTAiLCJ5IiwieVAiLCJhY3Rpb25zIiwiYWN0aW9uIiwib3B0aW9ucyIsImVsZW1lbnQiLCJwZXJmb3JtVG91Y2giLCJlbmNvZGVQYXNzd29yZCIsInJlcGxhY2UiLCJzdHJpbmdLZXlUb0FyciIsInNwbGl0IiwiZmluZ2VycHJpbnRVbmxvY2siLCJjYXBhYmlsaXRpZXMiLCJmaW5nZXJwcmludCIsInVubG9ja0tleSIsInBpblVubG9jayIsImtleXMiLCJlbHMiLCJmaW5kRWxPckVscyIsImlzRW1wdHkiLCJwaW5zIiwiZWwiLCJ0ZXh0IiwiZ2V0QXR0cmlidXRlIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJwaW4iLCJjbGljayIsInBhc3N3b3JkVW5sb2NrIiwiZ2V0UGF0dGVybktleVBvc2l0aW9uIiwiaW5pdFBvcyIsInBpZWNlIiwiY29scyIsInhQb3MiLCJNYXRoIiwicm91bmQiLCJ5UG9zIiwiY2VpbCIsImdldFBhdHRlcm5BY3Rpb25zIiwibGFzdFBvcyIsImtleVBvcyIsInB1c2giLCJtb3ZlVG8iLCJkaWZmWCIsImFicyIsImRpZmZZIiwicGF0dGVyblVubG9jayIsImFwaUxldmVsIiwiZ2V0TG9jYXRpb24iLCJzaXplIiwiZ2V0U2l6ZSIsIndpZHRoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFVBQVUsR0FBRyxLQUFuQjs7QUFDQSxNQUFNQyxlQUFlLEdBQUcsVUFBeEI7O0FBQ0EsTUFBTUMsY0FBYyxHQUFHLFNBQXZCOztBQUNBLE1BQU1DLGtCQUFrQixHQUFHLGFBQTNCOztBQUNBLE1BQU1DLFlBQVksR0FBRyxDQUFDSixVQUFELEVBQWFDLGVBQWIsRUFBOEJDLGNBQTlCLEVBQThDQyxrQkFBOUMsQ0FBckI7QUFDQSxNQUFNRSxvQkFBb0IsR0FBRyxJQUE3QjtBQUNBLE1BQU1DLGdCQUFnQixHQUFHLEdBQXpCO0FBQ0EsTUFBTUMsdUJBQXVCLEdBQUcsR0FBaEM7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxHQUE3QjtBQUVBLElBQUlDLE9BQU8sR0FBRyxFQUFkOzs7QUFDQUEsT0FBTyxDQUFDQyxpQkFBUixHQUE0QixVQUFVQyxJQUFWLEVBQWdCO0FBQzFDLFNBQU9QLFlBQVksQ0FBQ1EsT0FBYixDQUFxQkQsSUFBckIsTUFBK0IsQ0FBQyxDQUF2QztBQUNELENBRkQ7O0FBSUFGLE9BQU8sQ0FBQ0ksVUFBUixHQUFxQixVQUFVRixJQUFWLEVBQWdCRyxHQUFoQixFQUFxQjtBQUN4QyxNQUFJQyxnQkFBRUMsV0FBRixDQUFjRixHQUFkLENBQUosRUFBd0I7QUFDdEIsV0FBTyxLQUFQO0FBQ0Q7O0FBQ0QsTUFBSUgsSUFBSSxLQUFLWCxVQUFULElBQXVCVyxJQUFJLEtBQUtSLGtCQUFwQyxFQUF3RDtBQUN0RCxXQUFPLFdBQVdjLElBQVgsQ0FBZ0JILEdBQUcsQ0FBQ0ksSUFBSixFQUFoQixDQUFQO0FBQ0Q7O0FB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RSxXQUFQLENBQW1CeEIsb0JBQUtDLGFBQUwsQ0FBbUJKLEVBQW5CLENBQW5CLENBQXBCO0FBQ0EsTUFBSTRCLElBQUksR0FBRyxNQUFNakUsTUFBTSxDQUFDa0UsT0FBUCxDQUFlMUIsb0JBQUtDLGFBQUwsQ0FBbUJKLEVBQW5CLENBQWYsQ0FBakI7QUFFQSxNQUFJbkIsT0FBTyxHQUFHOUIsT0FBTyxDQUFDa0UsaUJBQVIsQ0FBMEJ0QixJQUExQixFQUFnQ2MsT0FBaEMsRUFBeUNtQixJQUFJLENBQUNFLEtBQUwsR0FBYSxDQUF0RCxDQUFkO0FBRUEsUUFBTW5FLE1BQU0sQ0FBQ3NCLFlBQVAsQ0FBb0JKLE9BQXBCLENBQU47QUFFQSxRQUFNLHFCQUFNakMsZ0JBQU4sQ0FBTjtBQUNELENBMUJEOztBQTRCQUcsT0FBTyxDQUFDVCxVQUFSLEdBQXFCQSxVQUFyQjtBQUNBUyxPQUFPLENBQUNSLGVBQVIsR0FBMEJBLGVBQTFCO0FBQ0FRLE9BQU8sQ0FBQ1AsY0FBUixHQUF5QkEsY0FBekI7QUFDQU8sT0FBTyxDQUFDTixrQkFBUixHQUE2QkEsa0JBQTdCO2VBR2VNLE8iLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHNsZWVwIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmNvbnN0IFBJTl9VTkxPQ0sgPSBcInBpblwiO1xuY29uc3QgUEFTU1dPUkRfVU5MT0NLID0gXCJwYXNzd29yZFwiO1xuY29uc3QgUEFUVEVSTl9VTkxPQ0sgPSBcInBhdHRlcm5cIjtcbmNvbnN0IEZJTkdFUlBSSU5UX1VOTE9DSyA9IFwiZmluZ2VycHJpbnRcIjtcbmNvbnN0IFVOTE9DS19UWVBFUyA9IFtQSU5fVU5MT0NLLCBQQVNTV09SRF9VTkxPQ0ssIFBBVFRFUk5fVU5MT0NLLCBGSU5HRVJQUklOVF9VTkxPQ0tdO1xuY29uc3QgS0VZQ09ERV9OVU1QQURfRU5URVIgPSBcIjY2XCI7XG5jb25zdCBVTkxPQ0tfV0FJVF9USU1FID0gMTAwO1xuY29uc3QgSElERV9LRVlCT0FSRF9XQUlUX1RJTUUgPSAxMDA7XG5jb25zdCBJTlBVVF9LRVlTX1dBSVRfVElNRSA9IDEwMDtcblxubGV0IGhlbHBlcnMgPSB7fTtcbmhlbHBlcnMuaXNWYWxpZFVubG9ja1R5cGUgPSBmdW5jdGlvbiAodHlwZSkge1xuICByZXR1cm4gVU5MT0NLX1RZUEVTLmluZGV4T2YodHlwZSkgIT09IC0xO1xufTtcblxuaGVscGVycy5pc1ZhbGlkS2V5ID0gZnVuY3Rpb24gKHR5cGUsIGtleSkge1xuICBpZiAoXy5pc1VuZGVmaW5lZChrZXkpKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIGlmICh0eXBlID09PSBQSU5fVU5MT0NLIHx8IHR5cGUgPT09IEZJTkdFUlBSSU5UX1VOTE9DSykge1xuICAgIHJldHVybiAvXlswLTldKyQvLnRlc3Qoa2V5LnRyaW0oKSk7XG4gIH1cbiAgaWYgKHR5cGUgPT09IFBBVFRFUk5fVU5MT0NLKSB7XG4gICAgaWYgKCEvXlsxLTldezIsOX0kLy50ZXN0KGtleS50cmltKCkpKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIHJldHVybiAhKC8oWzEtOV0pLio/XFwxLy50ZXN0KGtleS50cmltKCkpKTtcbiAgfVxuICAvLyBEb250IHRyaW0gcGFzc3dvcmQga2V5LCB5b3UgY2FuIHVzZSBibGFuayBzcGFjZXMgaW4geW91ciBhbmRyb2lkIHBhc3N3b3JkXG4gIC8vIMKvXFxfKOODhClfL8KvXG4gIGlmICh0eXBlID09PSBQQVNTV09SRF9VTkxPQ0spIHtcbiAgICByZXR1cm4gLy57NCx9L2cudGVzdChrZXkpO1xuICB9XG4gIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCB1bmxvY2sgdHlwZSAke3R5cGV9YCk7XG59O1xuXG5oZWxwZXJzLmRpc21pc3NLZXlndWFyZCA9IGFzeW5jIGZ1bmN0aW9uIChkcml2ZXIsIGFkYikge1xuICBsZXQgaXNLZXlib2FyZFNob3duID0gYXdhaXQgZHJpdmVyLmlzS2V5Ym9hcmRTaG93bigpO1xuICBpZiAoaXNLZXlib2FyZFNob3duKSB7XG4gICAgYXdhaXQgZHJpdmVyLmhpZGVLZXlib2FyZCgpO1xuICAgIC8vIFdhaXRzIGEgYml0IGZvciB0aGUga2V5Ym9hcmQgdG8gaGlkZVxuICAgIGF3YWl0IHNsZWVwKEhJREVfS0VZQk9BUkRfV0FJVF9USU1FKTtcbiAgfVxuICAvLyBkaXNtaXNzIG5vdGlmaWNhdGlvbnNcbiAgbG9nZ2VyLmluZm8oXCJEaXNtaXNzIG5vdGlmaWNhdGlvbnMgZnJvbSB1bmxvY2sgdmlld1wiKTtcbiAgYXdhaXQgYWRiLnNoZWxsKFtcInNlcnZpY2VcIiwgXCJjYWxsXCIsIFwibm90aWZpY2F0aW9uXCIsIFwiMVwiXSk7XG4gIGF3YWl0IGFkYi5iYWNrKCk7XG4gIGlmIChhd2FpdCBhZGIuZ2V0QXBpTGV2ZWwoKSA+IDIxKSB7XG4gICAgbG9nZ2VyLmluZm8oXCJUcnlpbmcgdG8gZGlzbWlzcyBrZXlndWFyZFwiKTtcbiAgICBhd2FpdCBhZGIuc2hlbGwoW1wid21cIiwgXCJkaXNtaXNzLWtleWd1YXJkXCJdKTtcbiAgICByZXR1cm47XG4gIH1cbiAgbG9nZ2VyLmluZm8oXCJTd2lwaW5nIHVwIHRvIGRpc21pc3Mga2V5Z3VhcmRcIik7XG4gIGF3YWl0IGhlbHBlcnMuc3dpcGVVcChkcml2ZXIpO1xufTtcblxuaGVscGVycy5zd2lwZVVwID0gYXN5bmMgZnVuY3Rpb24gKGRyaXZlcikge1xuICBsZXQgd2luZG93U2l6ZSA9IGF3YWl0IGRyaXZlci5nZXRXaW5kb3dTaXplKCk7XG4gIGxldCB4MCA9IHBhcnNlSW50KHdpbmRvd1NpemUueCAvIDIsIDEwKTtcbiAgbGV0IHkwID0gd2luZG93U2l6ZS55IC0gMTA7XG4gIGxldCB5UCA9IDEwMDtcbiAgbGV0IGFjdGlvbnMgPSBbXG4gICAge2FjdGlvbjogJ3ByZXNzJywgb3B0aW9uczoge2VsZW1lbnQ6IG51bGwsIHg6IHgwLCB5OiB5MH19LFxuICAgIHthY3Rpb246ICdtb3ZlVG8nLCBvcHRpb25zOiB7ZWxlbWVudDogbnVsbCwgeDogeDAsIHk6IHlQfX0sXG4gICAge2FjdGlvbjogJ3JlbGVhc2UnfVxuICBdO1xuICBhd2FpdCBkcml2ZXIucGVyZm9ybVRvdWNoKGFjdGlvbnMpO1xufTtcblxuaGVscGVycy5lbmNvZGVQYXNzd29yZCA9IGZ1bmN0aW9uIChrZXkpIHtcbiAgcmV0dXJuIGtleS5yZXBsYWNlKC9cXHMvaWcsIFwiJXNcIik7XG59O1xuXG5oZWxwZXJzLnN0cmluZ0tleVRvQXJyID0gZnVuY3Rpb24gKGtleSkge1xuICByZXR1cm4ga2V5LnRyaW0oKS5yZXBsYWNlKC9cXHMrL2csICcnKS5zcGxpdCgvXFxzKi8pO1xufTtcblxuaGVscGVycy5maW5nZXJwcmludFVubG9jayA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGRyaXZlciwgY2FwYWJpbGl0aWVzKSB7XG4gIGlmIChhd2FpdCBhZGIuZ2V0QXBpTGV2ZWwoKSA8IDIzKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiRmluZ2VycHJpbnQgdW5sb2NrIG9ubHkgd29ya3MgZm9yIEFuZHJvaWQgNisgZW11bGF0b3JzXCIpO1xuICB9XG4gIGF3YWl0IGFkYi5maW5nZXJwcmludChjYXBhYmlsaXRpZXMudW5sb2NrS2V5KTtcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG59O1xuXG5oZWxwZXJzLnBpblVubG9jayA9IGFzeW5jIGZ1bmN0aW9uIChhZGIsIGRyaXZlciwgY2FwYWJpbGl0aWVzKSB7XG4gIGxvZ2dlci5pbmZvKGBUcnlpbmcgdG8gdW5sb2NrIGRldmljZSB1c2luZyBwaW4gJHtjYXBhYmlsaXRpZXMudW5sb2NrS2V5fWApO1xuICBhd2FpdCBoZWxwZXJzLmRpc21pc3NLZXlndWFyZChkcml2ZXIsIGFkYik7XG4gIGxldCBrZXlzID0gaGVscGVycy5zdHJpbmdLZXlUb0FycihjYXBhYmlsaXRpZXMudW5sb2NrS2V5KTtcbiAgaWYgKGF3YWl0IGFkYi5nZXRBcGlMZXZlbCgpID49IDIxKSB7XG4gICAgbGV0IGVscyA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscyhcImlkXCIsIFwiY29tLmFuZHJvaWQuc3lzdGVtdWk6aWQvZGlnaXRfdGV4dFwiLCB0cnVlKTtcbiAgICBpZiAoXy5pc0VtcHR5KGVscykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcIkVycm9yIGZpbmRpbmcgdW5sb2NrIHBpbiBidXR0b25zIVwiKTtcbiAgICB9XG4gICAgbGV0IHBpbnMgPSB7fTtcbiAgICBmb3IgKGxldCBlbCBvZiBlbHMpIHtcbiAgICAgIGxldCB0ZXh0ID0gYXdhaXQgZHJpdmVyLmdldEF0dHJpYnV0ZShcInRleHRcIiwgdXRpbC51bndyYXBFbGVtZW50KGVsKSk7XG4gICAgICBwaW5zW3RleHRdID0gZWw7XG4gICAgfVxuICAgIGZvciAobGV0IHBpbiBvZiBrZXlzKSB7XG4gICAgICBsZXQgZWwgPSBwaW5zW3Bpbl07XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sodXRpbC51bndyYXBFbGVtZW50KGVsKSk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGZvciAobGV0IHBpbiBvZiBrZXlzKSB7XG4gICAgICBsZXQgZWwgPSBhd2FpdCBkcml2ZXIuZmluZEVsT3JFbHMoJ2lkJywgYGNvbS5hbmRyb2lkLmtleWd1YXJkOmlkL2tleSR7cGlufWAsIGZhbHNlKTtcbiAgICAgIGlmIChlbCA9PT0gbnVsbCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEVycm9yIGZpbmRpbmcgdW5sb2NrIHBpbiAnJHtwaW59JyBidXR0b24hYCk7XG4gICAgICB9XG4gICAgICBhd2FpdCBkcml2ZXIuY2xpY2sodXRpbC51bndyYXBFbGVtZW50KGVsKSk7XG4gICAgfVxuICB9XG4gIGNvbnN0IGVsID0gYXdhaXQgZHJpdmVyLmZpbmRFbE9yRWxzKCd4cGF0aCcsIFwiLy8qW2NvbnRhaW5zKEByZXNvdXJjZS1pZCwgJ2lkL2tleV9lbnRlcicpXVwiLCBmYWxzZSk7XG4gIGF3YWl0IGRyaXZlci5jbGljayh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgLy8gV2FpdHMgYSBiaXQgZm9yIHRoZSBkZXZpY2UgdG8gYmUgdW5sb2NrZWRcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG59O1xuXG5oZWxwZXJzLnBhc3N3b3JkVW5sb2NrID0gYXN5bmMgZnVuY3Rpb24gKGFkYiwgZHJpdmVyLCBjYXBhYmlsaXRpZXMpIHtcbiAgbG9nZ2VyLmluZm8oYFRyeWluZyB0byB1bmxvY2sgZGV2aWNlIHVzaW5nIHBhc3N3b3JkICR7Y2FwYWJpbGl0aWVzLnVubG9ja0tleX1gKTtcbiAgYXdhaXQgaGVscGVycy5kaXNtaXNzS2V5Z3VhcmQoZHJpdmVyLCBhZGIpO1xuICBsZXQga2V5ID0gY2FwYWJpbGl0aWVzLnVubG9ja0tleTtcbiAgLy8gUmVwbGFjZSBibGFuayBzcGFjZXMgd2l0aCAlc1xuICBrZXkgPSBoZWxwZXJzLmVuY29kZVBhc3N3b3JkKGtleSk7XG4gIC8vIFdoeSBhZGIgPyBJdCB3YXMgbGVzcyBmbGFreVxuICBhd2FpdCBhZGIuc2hlbGwoW1wiaW5wdXRcIiwgXCJ0ZXh0XCIsIGtleV0pO1xuICAvLyBXaHkgc2xlZXBzID8gQXZvaWQgc29tZSBmbGFreW5lc3Mgd2FpdGluZyBmb3IgdGhlIGlucHV0IHRvIHJlY2VpdmUgdGhlIGtleXNcbiAgYXdhaXQgc2xlZXAoSU5QVVRfS0VZU19XQUlUX1RJTUUpO1xuICBhd2FpdCBhZGIuc2hlbGwoW1wiaW5wdXRcIiwgXCJrZXlldmVudFwiLCBLRVlDT0RFX05VTVBBRF9FTlRFUl0pO1xuICAvLyBXYWl0cyBhIGJpdCBmb3IgdGhlIGRldmljZSB0byBiZSB1bmxvY2tlZFxuICBhd2FpdCBzbGVlcChVTkxPQ0tfV0FJVF9USU1FKTtcbn07XG5cbmhlbHBlcnMuZ2V0UGF0dGVybktleVBvc2l0aW9uID0gZnVuY3Rpb24gKGtleSwgaW5pdFBvcywgcGllY2UpIHtcbiAgLypcbiAgSG93IHRoZSBtYXRoIHdvcmtzOlxuICBXZSBoYXZlIDkgYnV0dG9ucyBkaXZpZGVkIGluIDMgY29sdW1ucyBhbmQgMyByb3dzIGluc2lkZSB0aGUgbG9ja1BhdHRlcm5WaWV3LFxuICBldmVyeSBidXR0b24gaGFzIGEgcG9zaXRpb24gb24gdGhlIHNjcmVlbiBjb3JyZXNwb25kaW5nIHRvIHRoZSBsb2NrUGF0dGVyblZpZXcgc2luY2VcbiAgaXQgaXMgdGhlIHBhcmVudCB2aWV3IHJpZ2h0IGF0IHRoZSBtaWRkbGUgb2YgZWFjaCBjb2x1bW4gb3Igcm93LlxuICAqL1xuICBjb25zdCBjb2xzID0gMztcbiAgY29uc3QgcGlucyA9IDk7XG4gIGxldCB4UG9zID0gKGtleSwgeCwgcGllY2UpID0+IHtcbiAgICByZXR1cm4gTWF0aC5yb3VuZCh4ICsgKChrZXkgJSBjb2xzKSB8fCBjb2xzKSAqIHBpZWNlIC0gcGllY2UgLyAyKTtcbiAgfTtcbiAgbGV0IHlQb3MgPSAoa2V5LCB5LCBwaWVjZSkgPT4ge1xuICAgIHJldHVybiBNYXRoLnJvdW5kKHkgKyAoTWF0aC5jZWlsKCgoa2V5ICUgcGlucykgfHwgcGlucykgLyBjb2xzKSAqIHBpZWNlIC0gcGllY2UgLyAyKSk7XG4gIH07XG4gIHJldHVybiB7eDogeFBvcyhrZXksIGluaXRQb3MueCwgcGllY2UpLCB5OiB5UG9zKGtleSwgaW5pdFBvcy55LCBwaWVjZSl9O1xufTtcblxuaGVscGVycy5nZXRQYXR0ZXJuQWN0aW9ucyA9IGZ1bmN0aW9uIChrZXlzLCBpbml0UG9zLCBwaWVjZSkge1xuICBsZXQgYWN0aW9ucyA9IFtdO1xuICBsZXQgbGFzdFBvcztcbiAgZm9yIChsZXQga2V5IG9mIGtleXMpIHtcbiAgICBsZXQga2V5UG9zID0gaGVscGVycy5nZXRQYXR0ZXJuS2V5UG9zaXRpb24oa2V5LCBpbml0UG9zLCBwaWVjZSk7XG4gICAgaWYgKGtleSA9PT0ga2V5c1swXSkge1xuICAgICAgYWN0aW9ucy5wdXNoKHthY3Rpb246ICdwcmVzcycsIG9wdGlvbnM6IHtlbGVtZW50OiBudWxsLCB4OiBrZXlQb3MueCwgeToga2V5UG9zLnl9fSk7XG4gICAgICBsYXN0UG9zID0ga2V5UG9zO1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIGxldCBtb3ZlVG8gPSB7eDogMCwgeTogMH07XG4gICAgbGV0IGRpZmZYID0ga2V5UG9zLnggLSBsYXN0UG9zLng7XG4gICAgaWYgKGRpZmZYID4gMCkge1xuICAgICAgbW92ZVRvLnggPSBwaWVjZTtcbiAgICAgIGlmIChNYXRoLmFicyhkaWZmWCkgPiBwaWVjZSkge1xuICAgICAgICBtb3ZlVG8ueCArPSBwaWVjZTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKGRpZmZYIDwgMCkge1xuICAgICAgbW92ZVRvLnggPSAtMSAqIHBpZWNlO1xuICAgICAgaWYgKE1hdGguYWJzKGRpZmZYKSA+IHBpZWNlKSB7XG4gICAgICAgIG1vdmVUby54IC09IHBpZWNlO1xuICAgICAgfVxuICAgIH1cbiAgICBsZXQgZGlmZlkgPSBrZXlQb3MueSAtIGxhc3RQb3MueTtcbiAgICBpZiAoZGlmZlkgPiAwKSB7XG4gICAgICBtb3ZlVG8ueSA9IHBpZWNlO1xuICAgICAgaWYgKE1hdGguYWJzKGRpZmZZKSA+IHBpZWNlKSB7XG4gICAgICAgIG1vdmVUby55ICs9IHBpZWNlO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoZGlmZlkgPCAwKSB7XG4gICAgICBtb3ZlVG8ueSA9IC0xICogcGllY2U7XG4gICAgICBpZiAoTWF0aC5hYnMoZGlmZlkpID4gcGllY2UpIHtcbiAgICAgICAgbW92ZVRvLnkgLT0gcGllY2U7XG4gICAgICB9XG4gICAgfVxuICAgIGFjdGlvbnMucHVzaCh7YWN0aW9uOiAnbW92ZVRvJywgb3B0aW9uczoge2VsZW1lbnQ6IG51bGwsIHg6IG1vdmVUby54LCB5OiBtb3ZlVG8ueX19KTtcbiAgICBsYXN0UG9zID0ga2V5UG9zO1xuICB9XG4gIGFjdGlvbnMucHVzaCh7YWN0aW9uOiAncmVsZWFzZSd9KTtcbiAgcmV0dXJuIGFjdGlvbnM7XG59O1xuXG5oZWxwZXJzLnBhdHRlcm5VbmxvY2sgPSBhc3luYyBmdW5jdGlvbiAoYWRiLCBkcml2ZXIsIGNhcGFiaWxpdGllcykge1xuICBsb2dnZXIuaW5mbyhgVHJ5aW5nIHRvIHVubG9jayBkZXZpY2UgdXNpbmcgcGF0dGVybiAke2NhcGFiaWxpdGllcy51bmxvY2tLZXl9YCk7XG4gIGF3YWl0IGhlbHBlcnMuZGlzbWlzc0tleWd1YXJkKGRyaXZlciwgYWRiKTtcbiAgbGV0IGtleXMgPSBoZWxwZXJzLnN0cmluZ0tleVRvQXJyKGNhcGFiaWxpdGllcy51bmxvY2tLZXkpO1xuICAvKiBXZSBzZXQgdGhlIGRldmljZSBwYXR0ZXJuIGJ1dHRvbnMgYXMgbnVtYmVyIG9mIGEgcmVndWxhciBwaG9uZVxuICAgKiAgfCDigKIg4oCiIOKAoiB8ICAgICB8IDEgMiAzIHxcbiAgICogIHwg4oCiIOKAoiDigKIgfCAtLT4gfCA0IDUgNiB8XG4gICAqICB8IOKAoiDigKIg4oCiIHwgICAgIHwgNyA4IDkgfFxuXG4gIFRoZSBwYXR0ZXJuIHZpZXcgYnV0dG9ucyBhcmUgbm90IHNlZWluZyBieSB0aGUgdWlhdXRvbWF0b3Igc2luY2UgdGhleSBhcmVcbiAgaW5jbHVkZWQgaW5zaWRlIGEgRnJhbWVMYXlvdXQsIHNvIHdlIGFyZSBnb2luZyB0byB0cnkgY2xpY2tpbmcgb24gdGhlIGJ1dHRvbnNcbiAgdXNpbmcgdGhlIHBhcmVudCB2aWV3IGJvdW5kcyBhbmQgbWF0aC5cbiAgKi9cbiAgbGV0IGFwaUxldmVsID0gYXdhaXQgYWRiLmdldEFwaUxldmVsKCk7XG4gIGxldCBlbCA9IGF3YWl0IGRyaXZlci5maW5kRWxPckVscyhcImlkXCIsXG4gICAgYGNvbS5hbmRyb2lkLiR7YXBpTGV2ZWwgPj0gMjEgPyAnc3lzdGVtdWknIDogJ2tleWd1YXJkJ306aWQvbG9ja1BhdHRlcm5WaWV3YCxcbiAgICBmYWxzZVxuICApO1xuICBsZXQgaW5pdFBvcyA9IGF3YWl0IGRyaXZlci5nZXRMb2NhdGlvbih1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgbGV0IHNpemUgPSBhd2FpdCBkcml2ZXIuZ2V0U2l6ZSh1dGlsLnVud3JhcEVsZW1lbnQoZWwpKTtcbiAgLy8gR2V0IGFjdGlvbnMgdG8gcGVyZm9ybVxuICBsZXQgYWN0aW9ucyA9IGhlbHBlcnMuZ2V0UGF0dGVybkFjdGlvbnMoa2V5cywgaW5pdFBvcywgc2l6ZS53aWR0aCAvIDMpO1xuICAvLyBQZXJmb3JtIGdlc3R1cmVcbiAgYXdhaXQgZHJpdmVyLnBlcmZvcm1Ub3VjaChhY3Rpb25zKTtcbiAgLy8gV2FpdHMgYSBiaXQgZm9yIHRoZSBkZXZpY2UgdG8gYmUgdW5sb2NrZWRcbiAgYXdhaXQgc2xlZXAoVU5MT0NLX1dBSVRfVElNRSk7XG59O1xuXG5oZWxwZXJzLlBJTl9VTkxPQ0sgPSBQSU5fVU5MT0NLO1xuaGVscGVycy5QQVNTV09SRF9VTkxPQ0sgPSBQQVNTV09SRF9VTkxPQ0s7XG5oZWxwZXJzLlBBVFRFUk5fVU5MT0NLID0gUEFUVEVSTl9VTkxPQ0s7XG5oZWxwZXJzLkZJTkdFUlBSSU5UX1VOTE9DSyA9IEZJTkdFUlBSSU5UX1VOTE9DSztcblxuZXhwb3J0IHsgUElOX1VOTE9DSywgUEFTU1dPUkRfVU5MT0NLLCBQQVRURVJOX1VOTE9DSywgRklOR0VSUFJJTlRfVU5MT0NLLCBoZWxwZXJzIH07XG5leHBvcnQgZGVmYXVsdCBoZWxwZXJzO1xuIl0sImZpbGUiOiJsaWIvdW5sb2NrLWhlbHBlcnMuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
