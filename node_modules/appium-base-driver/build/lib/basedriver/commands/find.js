"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.CUSTOM_STRATEGY = exports.IMAGE_STRATEGY = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

var _2 = require("../../..");

var _images = require("./images");

var _protocol = require("../../protocol/protocol");

var _imageElement = require("../image-element");

const commands = {},
      helpers = {},
      extensions = {};
exports.helpers = helpers;
exports.commands = commands;
const IMAGE_STRATEGY = '-image';
exports.IMAGE_STRATEGY = IMAGE_STRATEGY;
const CUSTOM_STRATEGY = '-custom';
exports.CUSTOM_STRATEGY = CUSTOM_STRATEGY;

helpers.findElOrElsWithProcessing = async function (strategy, selector, mult, context) {
  this.validateLocatorStrategy(strategy);

  try {
    return await this.findElOrEls(strategy, selector, mult, context);
  } catch (err) {
    if (this.opts.printPageSourceOnFindFailure) {
      const src = await this.getPageSource();

      _logger.default.debug(`Error finding element${mult ? 's' : ''}: ${err.message}`);

      _logger.default.debug(`Page source requested through 'printPageSourceOnFindFailure':`);

      _logger.default.debug(src);
    }

    throw err;
  }
};

commands.findElement = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: false
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, false);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, false);
};

commands.findElements = async function (strategy, selector) {
  if (strategy === IMAGE_STRATEGY) {
    return await this.findByImage(selector, {
      multiple: true
    });
  } else if (strategy === CUSTOM_STRATEGY) {
    return await this.findByCustom(selector, true);
  }

  return await this.findElOrElsWithProcessing(strategy, selector, true);
};

commands.findElementFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, false, elementId);
};

commands.findElementsFromElement = async function (strategy, selector, elementId) {
  return await this.findElOrElsWithProcessing(strategy, selector, true, elementId);
};

commands.findByCustom = async function (selector, multiple) {
  const plugins = this.opts.customFindModules;

  if (!plugins) {
    throw new Error('Finding an element using a plugin is currently an ' + 'incubating feature. To use it you must manually install one or more ' + 'plugin modules in a way that they can be required by Appium, for ' + 'example installing them from the Appium directory, installing them ' + 'globally, or installing them elsewhere and passing an absolute path as ' + 'the capability. Then construct an object where the key is the shortcut ' + 'name for this plugin and the value is the module name or absolute path, ' + 'for example: {"p1": "my-find-plugin"}, and pass this in as the ' + "'customFindModules' capability.");
  }

  if (!_lodash.default.isPlainObject(plugins)) {
    throw new Error("Invalid format for the 'customFindModules' capability. " + 'It should be an object with keys corresponding to the short names and ' + 'values corresponding to the full names of the element finding plugins');
  }

  let [plugin, realSelector] = selector.split(':');

  if (_lodash.default.size(plugins) > 1 && !realSelector) {
    throw new Error(`Multiple element finding plugins were registered ` + `(${_lodash.default.keys(plugins)}), but your selector did not indicate which plugin ` + `to use. Ensure you put the short name of the plugin followed by ':' as ` + `the initial part of the selector string.`);
  }

  if (_lodash.default.size(plugins) === 1 && !realSelector) {
    realSelector = plugin;
    plugin = _lodash.default.keys(plugins)[0];
  }

  if (!plugins[plugin]) {
    throw new Error(`Selector specified use of element finding plugin ` + `'${plugin}' but it was not registered in the 'customFindModules' ` + `capability.`);
  }

  let finder;

  try {
    _logger.default.debug(`Find plugin '${plugin}' requested; will attempt to use it ` + `from '${plugins[plugin]}'`);

    finder = require(plugins[plugin]);
  } catch (err) {
    throw new Error(`Could not load your custom find module '${plugin}'. Did ` + `you put it somewhere Appium can 'require' it? Original error: ${err}`);
  }

  if (!finder || !_lodash.default.isFunction(finder.find)) {
    throw new Error('Your custom find module did not appear to be constructed ' + 'correctly. It needs to export an object with a `find` method.');
  }

  const customFinderLog = _appiumSupport.logger.getLogger(plugin);

  let elements;

  const condition = async () => {
    elements = await finder.find(this, customFinderLog, realSelector, multiple);

    if (!_lodash.default.isEmpty(elements) || multiple) {
      return true;
    }

    return false;
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (err.message.match(/Condition unmet/)) {
      throw new _2.errors.NoSuchElementError();
    }

    throw err;
  }

  return multiple ? elements : elements[0];
};

helpers.findByImage = async function (b64Template, {
  shouldCheckStaleness = false,
  multiple = false
}) {
  const {
    imageMatchThreshold: threshold,
    fixImageTemplateSize
  } = this.settings.getSettings();

  _logger.default.info(`Finding image element with match threshold ${threshold}`);

  if (!this.getWindowSize) {
    throw new Error("This driver does not support the required 'getWindowSize' command");
  }

  const {
    width: screenWidth,
    height: screenHeight
  } = await this.getWindowSize();

  if (fixImageTemplateSize) {
    b64Template = await this.ensureTemplateSize(b64Template, screenWidth, screenHeight);
  }

  let rect = null;

  const condition = async () => {
    try {
      let b64Screenshot = await this.getScreenshotForImageFind(screenWidth, screenHeight);
      rect = (await this.compareImages(_images.MATCH_TEMPLATE_MODE, b64Screenshot, b64Template, {
        threshold
      })).rect;
      return true;
    } catch (err) {
      if (err.message.match(/Cannot find any occurrences/)) {
        return false;
      }

      throw err;
    }
  };

  try {
    await this.implicitWaitForCondition(condition);
  } catch (err) {
    if (!err.message.match(/Condition unmet/)) {
      throw err;
    }
  }

  if (!rect) {
    if (multiple) {
      return [];
    }

    throw new _2.errors.NoSuchElementError();
  }

  _logger.default.info(`Image template matched: ${JSON.stringify(rect)}`);

  const imgEl = new _imageElement.ImageElement(b64Template, rect);

  if (shouldCheckStaleness) {
    return imgEl;
  }

  this._imgElCache.set(imgEl.id, imgEl);

  const protoKey = this.isW3CProtocol() ? _protocol.W3C_ELEMENT_KEY : _protocol.MJSONWP_ELEMENT_KEY;
  const protocolEl = imgEl.asElement(protoKey);
  return multiple ? [protocolEl] : protocolEl;
};

helpers.ensureTemplateSize = async function (b64Template, screenWidth, screenHeight) {
  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Template);
  let {
    width: tplWidth,
    height: tplHeight
  } = imgObj.bitmap;

  if (tplWidth <= screenWidth && tplHeight <= screenHeight) {
    return b64Template;
  }

  imgObj = imgObj.scaleToFit(screenWidth, screenHeight);
  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

helpers.getScreenshotForImageFind = async function (screenWidth, screenHeight) {
  if (!this.getScreenshot) {
    throw new Error("This driver does not support the required 'getScreenshot' command");
  }

  let b64Screenshot = await this.getScreenshot();

  if (!this.settings.getSettings().fixImageFindScreenshotDims) {
    _logger.default.info(`Not verifying screenshot dimensions match screen`);

    return b64Screenshot;
  }

  _logger.default.info('Verifying screenshot size and aspect ratio');

  let imgObj = await _appiumSupport.imageUtil.getJimpImage(b64Screenshot);
  let {
    width: shotWidth,
    height: shotHeight
  } = imgObj.bitmap;

  if (screenWidth === shotWidth && screenHeight === shotHeight) {
    _logger.default.info('Screenshot size matched screen size');

    return b64Screenshot;
  }

  const screenAR = screenWidth / screenHeight;
  const shotAR = shotWidth / shotHeight;

  if (screenAR === shotAR) {
    _logger.default.info('Screenshot aspect ratio matched screen aspect ratio');
  } else {
    _logger.default.warn(`When trying to find an element, determined that the screen ` + `aspect ratio and screenshot aspect ratio are different. Screen ` + `is ${screenWidth}x${screenHeight} whereas screenshot is ` + `${shotWidth}x${shotHeight}.`);

    shotWidth = shotWidth / (shotAR / screenAR);

    _logger.default.warn(`Resizing screenshot to ${shotWidth}x${shotHeight} to match ` + `screen aspect ratio so that image element coordinates have a ` + `greater chance of being correct.`);

    imgObj = imgObj.resize(shotWidth, shotHeight);
  }

  if (screenWidth !== shotWidth) {
    _logger.default.info(`Scaling screenshot from ${shotWidth}x${shotHeight} to match ` + `screen at ${screenWidth}x${screenHeight}`);

    imgObj = imgObj.resize(screenWidth, screenHeight);
  }

  return (await imgObj.getBuffer(_appiumSupport.imageUtil.MIME_PNG)).toString('base64');
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9iYXNlZHJpdmVyL2NvbW1hbmRzL2ZpbmQuanMiXSwibmFtZXMiOlsiY29tbWFuZHMiLCJoZWxwZXJzIiwiZXh0ZW5zaW9ucyIsIklNQUdFX1NUUkFURUdZIiwiQ1VTVE9NX1NUUkFURUdZIiwiZmluZEVsT3JFbHNXaXRoUHJvY2Vzc2luZyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsInZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5IiwiZmluZEVsT3JFbHMiLCJlcnIiLCJvcHRzIiwicHJpbnRQYWdlU291cmNlT25GaW5kRmFpbHVyZSIsInNyYyIsImdldFBhZ2VTb3VyY2UiLCJsb2ciLCJkZWJ1ZyIsIm1lc3NhZ2UiLCJmaW5kRWxlbWVudCIsImZpbmRCeUltYWdlIiwibXVsdGlwbGUiLCJmaW5kQnlDdXN0b20iLCJmaW5kRWxlbWVudHMiLCJmaW5kRWxlbWVudEZyb21FbGVtZW50IiwiZWxlbWVudElkIiwiZmluZEVsZW1lbnRzRnJvbUVsZW1lbnQiLCJwbHVnaW5zIiwiY3VzdG9tRmluZE1vZHVsZXMiLCJFcnJvciIsIl8iLCJpc1BsYWluT2JqZWN0IiwicGx1Z2luIiwicmVhbFNlbGVjdG9yIiwic3BsaXQiLCJzaXplIiwia2V5cyIsImZpbmRlciIsInJlcXVpcmUiLCJpc0Z1bmN0aW9uIiwiZmluZCIsImN1c3RvbUZpbmRlckxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsImVsZW1lbnRzIiwiY29uZGl0aW9uIiwiaXNFbXB0eSIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsIm1hdGNoIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiYjY0VGVtcGxhdGUiLCJzaG91bGRDaGVja1N0YWxlbmVzcyIsImltYWdlTWF0Y2hUaHJlc2hvbGQiLCJ0aHJlc2hvbGQiLCJmaXhJbWFnZVRlbXBsYXRlU2l6ZSIsInNldHRpbmdzIiwiZ2V0U2V0dGluZ3MiLCJpbmZvIiwiZ2V0V2luZG93U2l6ZSIsIndpZHRoIiwic2NyZWVuV2lkdGgiLCJoZWlnaHQiLCJzY3JlZW5IZWlnaHQiLCJlbnN1cmVUZW1wbGF0ZVNpemUiLCJyZWN0IiwiYjY0U2NyZWVuc2hvdCIsImdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQiLCJjb21wYXJlSW1hZ2VzIiwiTUFUQ0hfVEVNUExBVEVfTU9ERSIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbWdFbCIsIkltYWdlRWxlbWVudCIsIl9pbWdFbENhY2hlIiwic2V0IiwiaWQiLCJwcm90b0tleSIsImlzVzNDUHJvdG9jb2wiLCJXM0NfRUxFTUVOVF9LRVkiLCJNSlNPTldQX0VMRU1FTlRfS0VZIiwicHJvdG9jb2xFbCIsImFzRWxlbWVudCIsImltZ09iaiIsImltYWdlVXRpbCIsImdldEppbXBJbWFnZSIsInRwbFdpZHRoIiwidHBsSGVpZ2h0IiwiYml0bWFwIiwic2NhbGVUb0ZpdCIsImdldEJ1ZmZlciIsIk1JTUVfUE5HIiwidG9TdHJpbmciLCJnZXRTY3JlZW5zaG90IiwiZml4SW1hZ2VGaW5kU2NyZWVuc2hvdERpbXMiLCJzaG90V2lkdGgiLCJzaG90SGVpZ2h0Iiwic2NyZWVuQVIiLCJzaG90QVIiLCJ3YXJuIiwicmVzaXplIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjtBQUFBLE1BQXFCQyxPQUFPLEdBQUcsRUFBL0I7QUFBQSxNQUFtQ0MsVUFBVSxHQUFHLEVBQWhEOzs7QUFFQSxNQUFNQyxjQUFjLEdBQUcsUUFBdkI7O0FBQ0EsTUFBTUMsZUFBZSxHQUFHLFNBQXhCOzs7QUFjQUgsT0FBTyxDQUFDSSx5QkFBUixHQUFvQyxnQkFBZ0JDLFFBQWhCLEVBQTBCQyxRQUExQixFQUFvQ0MsSUFBcEMsRUFBMENDLE9BQTFDLEVBQW1EO0FBQ3JGLE9BQUtDLHVCQUFMLENBQTZCSixRQUE3Qjs7QUFDQSxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUtLLFdBQUwsQ0FBaUJMLFFBQWpCLEVBQTJCQyxRQUEzQixFQUFxQ0MsSUFBckMsRUFBMkNDLE9BQTNDLENBQWI7QUFDRCxHQUZELENBRUUsT0FBT0csR0FBUCxFQUFZO0FBQ1osUUFBSSxLQUFLQyxJQUFMLENBQVVDLDRCQUFkLEVBQTRDO0FBQzFDLFlBQU1DLEdBQUcsR0FBRyxNQUFNLEtBQUtDLGFBQUwsRUFBbEI7O0FBQ0FDLHNCQUFJQyxLQUFKLENBQVcsd0JBQXVCVixJQUFJLEdBQUcsR0FBSCxHQUFTLEVBQUcsS0FBSUksR0FBRyxDQUFDTyxPQUFRLEVBQWxFOztBQUNBRixzQkFBSUMsS0FBSixDQUFXLCtEQUFYOztBQUNBRCxzQkFBSUMsS0FBSixDQUFVSCxHQUFWO0FBQ0Q7O0FBRUQsVUFBTUgsR0FBTjtBQUNEO0FBQ0YsQ0FkRDs7QUFnQkFaLFFBQVEsQ0FBQ29CLFdBQVQsR0FBdUIsZ0JBQWdCZCxRQUFoQixFQUEwQkMsUUFBMUIsRUFBb0M7QUFDekQsTUFBSUQsUUFBUSxLQUFLSCxjQUFqQixFQUFpQztBQUMvQixXQUFPLE1BQU0sS0FBS2tCLFdBQUwsQ0FBaUJkLFFBQWpCLEVBQTJCO0FBQUNlLE1BQUFBLFFBQVEsRUFBRTtBQUFYLEtBQTNCLENBQWI7QUFDRCxHQUZELE1BRU8sSUFBSWhCLFFBQVEsS0FBS0YsZUFBakIsRUFBa0M7QUFDdkMsV0FBTyxNQUFNLEtBQUttQixZQUFMLENBQWtCaEIsUUFBbEIsRUFBNEIsS0FBNUIsQ0FBYjtBQUNEOztBQUVELFNBQU8sTUFBTSxLQUFLRix5QkFBTCxDQUErQkMsUUFBL0IsRUFBeUNDLFFBQXpDLEVBQW1ELEtBQW5ELENBQWI7QUFDRCxDQVJEOztBQVVBUCxRQUFRLENBQUN3QixZQUFULEdBQXdCLGdCQUFnQmxCLFFBQWhCLEVBQTBCQyxRQUExQixFQUFvQztBQUMxRCxNQUFJRCxRQUFRLEtBQUtILGNBQWpCLEVBQWlDO0FBQy9CLFdBQU8sTUFBTSxLQUFLa0IsV0FBTCxDQUFpQmQsUUFBakIsRUFBMkI7QUFBQ2UsTUFBQUEsUUFBUSxFQUFFO0FBQVgsS0FBM0IsQ0FBYjtBQUNELEdBRkQsTUFFTyxJQUFJaEIsUUFBUSxLQUFLRixlQUFqQixFQUFrQztBQUN2QyxXQUFPLE1BQU0sS0FBS21CLFlBQUwsQ0FBa0JoQixRQUFsQixFQUE0QixJQUE1QixDQUFiO0FBQ0Q7O0FBRUQsU0FBTyxNQUFNLEtBQUtGLHlCQUFMLENBQStCQyxRQUEvQixFQUF5Q0MsUUFBekMsRUFBbUQsSUFBbkQsQ0FBYjtBQUNELENBUkQ7O0FBVUFQLFFBQVEsQ0FBQ3lCLHNCQUFULEdBQWtDLGdCQUFnQm5CLFFBQWhCLEVBQTBCQyxRQUExQixFQUFvQ21CLFNBQXBDLEVBQStDO0FBQy9FLFNBQU8sTUFBTSxLQUFLckIseUJBQUwsQ0FBK0JDLFFBQS9CLEVBQXlDQyxRQUF6QyxFQUFtRCxLQUFuRCxFQUEwRG1CLFNBQTFELENBQWI7QUFDRCxDQUZEOztBQUlBMUIsUUFBUSxDQUFDMkIsdUJBQVQsR0FBbUMsZ0JBQWdCckIsUUFBaEIsRUFBMEJDLFFBQTFCLEVBQW9DbUIsU0FBcEMsRUFBK0M7QUFDaEYsU0FBTyxNQUFNLEtBQUtyQix5QkFBTCxDQUErQkMsUUFBL0IsRUFBeUNDLFFBQXpDLEVBQW1ELElBQW5ELEVBQXlEbUIsU0FBekQsQ0FBYjtBQUNELENBRkQ7O0FBYUExQixRQUFRLENBQUN1QixZQUFULEdBQXdCLGdCQUFnQmhCLFFBQWhCLEVBQTBCZSxRQUExQixFQUFvQztBQUMxRCxRQUFNTSxPQUFPLEdBQUcsS0FBS2YsSUFBTCxDQUFVZ0IsaUJBQTFCOztBQUdBLE1BQUksQ0FBQ0QsT0FBTCxFQUFjO0FBR1osVUFBTSxJQUFJRSxLQUFKLENBQVUsdURBQ2Qsc0VBRGMsR0FFZCxtRUFGYyxHQUdkLHFFQUhjLEdBSWQseUVBSmMsR0FLZCx5RUFMYyxHQU1kLDBFQU5jLEdBT2QsaUVBUGMsR0FRZCxpQ0FSSSxDQUFOO0FBU0Q7O0FBR0QsTUFBSSxDQUFDQyxnQkFBRUMsYUFBRixDQUFnQkosT0FBaEIsQ0FBTCxFQUErQjtBQUM3QixVQUFNLElBQUlFLEtBQUosQ0FBVSw0REFDZCx3RUFEYyxHQUVkLHVFQUZJLENBQU47QUFHRDs7QUFJRCxNQUFJLENBQUNHLE1BQUQsRUFBU0MsWUFBVCxJQUF5QjNCLFFBQVEsQ0FBQzRCLEtBQVQsQ0FBZSxHQUFmLENBQTdCOztBQUlBLE1BQUlKLGdCQUFFSyxJQUFGLENBQU9SLE9BQVAsSUFBa0IsQ0FBbEIsSUFBdUIsQ0FBQ00sWUFBNUIsRUFBMEM7QUFDeEMsVUFBTSxJQUFJSixLQUFKLENBQVcsbURBQUQsR0FDYixJQUFHQyxnQkFBRU0sSUFBRixDQUFPVCxPQUFQLENBQWdCLHFEQUROLEdBRWIseUVBRmEsR0FHYiwwQ0FIRyxDQUFOO0FBSUQ7O0FBSUQsTUFBSUcsZ0JBQUVLLElBQUYsQ0FBT1IsT0FBUCxNQUFvQixDQUFwQixJQUF5QixDQUFDTSxZQUE5QixFQUE0QztBQUMxQ0EsSUFBQUEsWUFBWSxHQUFHRCxNQUFmO0FBQ0FBLElBQUFBLE1BQU0sR0FBR0YsZ0JBQUVNLElBQUYsQ0FBT1QsT0FBUCxFQUFnQixDQUFoQixDQUFUO0FBQ0Q7O0FBRUQsTUFBSSxDQUFDQSxPQUFPLENBQUNLLE1BQUQsQ0FBWixFQUFzQjtBQUNwQixVQUFNLElBQUlILEtBQUosQ0FBVyxtREFBRCxHQUNiLElBQUdHLE1BQU8seURBREcsR0FFYixhQUZHLENBQU47QUFHRDs7QUFFRCxNQUFJSyxNQUFKOztBQUNBLE1BQUk7QUFDRnJCLG9CQUFJQyxLQUFKLENBQVcsZ0JBQWVlLE1BQU8sc0NBQXZCLEdBQ1AsU0FBUUwsT0FBTyxDQUFDSyxNQUFELENBQVMsR0FEM0I7O0FBRUFLLElBQUFBLE1BQU0sR0FBR0MsT0FBTyxDQUFDWCxPQUFPLENBQUNLLE1BQUQsQ0FBUixDQUFoQjtBQUNELEdBSkQsQ0FJRSxPQUFPckIsR0FBUCxFQUFZO0FBQ1osVUFBTSxJQUFJa0IsS0FBSixDQUFXLDJDQUEwQ0csTUFBTyxTQUFsRCxHQUNiLGlFQUFnRXJCLEdBQUksRUFEakUsQ0FBTjtBQUVEOztBQUVELE1BQUksQ0FBQzBCLE1BQUQsSUFBVyxDQUFDUCxnQkFBRVMsVUFBRixDQUFhRixNQUFNLENBQUNHLElBQXBCLENBQWhCLEVBQTJDO0FBQ3pDLFVBQU0sSUFBSVgsS0FBSixDQUFVLDhEQUNaLCtEQURFLENBQU47QUFFRDs7QUFFRCxRQUFNWSxlQUFlLEdBQUdDLHNCQUFPQyxTQUFQLENBQWlCWCxNQUFqQixDQUF4Qjs7QUFFQSxNQUFJWSxRQUFKOztBQUNBLFFBQU1DLFNBQVMsR0FBRyxZQUFZO0FBTTVCRCxJQUFBQSxRQUFRLEdBQUcsTUFBTVAsTUFBTSxDQUFDRyxJQUFQLENBQVksSUFBWixFQUFrQkMsZUFBbEIsRUFBbUNSLFlBQW5DLEVBQWlEWixRQUFqRCxDQUFqQjs7QUFJQSxRQUFJLENBQUNTLGdCQUFFZ0IsT0FBRixDQUFVRixRQUFWLENBQUQsSUFBd0J2QixRQUE1QixFQUFzQztBQUNwQyxhQUFPLElBQVA7QUFDRDs7QUFHRCxXQUFPLEtBQVA7QUFDRCxHQWhCRDs7QUFrQkEsTUFBSTtBQUVGLFVBQU0sS0FBSzBCLHdCQUFMLENBQThCRixTQUE5QixDQUFOO0FBQ0QsR0FIRCxDQUdFLE9BQU9sQyxHQUFQLEVBQVk7QUFDWixRQUFJQSxHQUFHLENBQUNPLE9BQUosQ0FBWThCLEtBQVosQ0FBa0IsaUJBQWxCLENBQUosRUFBMEM7QUFDeEMsWUFBTSxJQUFJQyxVQUFPQyxrQkFBWCxFQUFOO0FBQ0Q7O0FBQ0QsVUFBTXZDLEdBQU47QUFDRDs7QUFFRCxTQUFPVSxRQUFRLEdBQUd1QixRQUFILEdBQWNBLFFBQVEsQ0FBQyxDQUFELENBQXJDO0FBQ0QsQ0FsR0Q7O0FBc0hBNUMsT0FBTyxDQUFDb0IsV0FBUixHQUFzQixnQkFBZ0IrQixXQUFoQixFQUE2QjtBQUNqREMsRUFBQUEsb0JBQW9CLEdBQUcsS0FEMEI7QUFFakQvQixFQUFBQSxRQUFRLEdBQUc7QUFGc0MsQ0FBN0IsRUFHbkI7QUFDRCxRQUFNO0FBQ0pnQyxJQUFBQSxtQkFBbUIsRUFBRUMsU0FEakI7QUFFSkMsSUFBQUE7QUFGSSxNQUdGLEtBQUtDLFFBQUwsQ0FBY0MsV0FBZCxFQUhKOztBQUtBekMsa0JBQUkwQyxJQUFKLENBQVUsOENBQTZDSixTQUFVLEVBQWpFOztBQUNBLE1BQUksQ0FBQyxLQUFLSyxhQUFWLEVBQXlCO0FBQ3ZCLFVBQU0sSUFBSTlCLEtBQUosQ0FBVSxtRUFBVixDQUFOO0FBQ0Q7O0FBQ0QsUUFBTTtBQUFDK0IsSUFBQUEsS0FBSyxFQUFFQyxXQUFSO0FBQXFCQyxJQUFBQSxNQUFNLEVBQUVDO0FBQTdCLE1BQTZDLE1BQU0sS0FBS0osYUFBTCxFQUF6RDs7QUFNQSxNQUFJSixvQkFBSixFQUEwQjtBQUN4QkosSUFBQUEsV0FBVyxHQUFHLE1BQU0sS0FBS2Esa0JBQUwsQ0FBd0JiLFdBQXhCLEVBQXFDVSxXQUFyQyxFQUNsQkUsWUFEa0IsQ0FBcEI7QUFFRDs7QUFFRCxNQUFJRSxJQUFJLEdBQUcsSUFBWDs7QUFDQSxRQUFNcEIsU0FBUyxHQUFHLFlBQVk7QUFDNUIsUUFBSTtBQUNGLFVBQUlxQixhQUFhLEdBQUcsTUFBTSxLQUFLQyx5QkFBTCxDQUErQk4sV0FBL0IsRUFBNENFLFlBQTVDLENBQTFCO0FBQ0FFLE1BQUFBLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBS0csYUFBTCxDQUFtQkMsMkJBQW5CLEVBQXdDSCxhQUF4QyxFQUNaZixXQURZLEVBQ0M7QUFBQ0csUUFBQUE7QUFBRCxPQURELENBQVAsRUFDc0JXLElBRDdCO0FBRUEsYUFBTyxJQUFQO0FBQ0QsS0FMRCxDQUtFLE9BQU90RCxHQUFQLEVBQVk7QUFLWixVQUFJQSxHQUFHLENBQUNPLE9BQUosQ0FBWThCLEtBQVosQ0FBa0IsNkJBQWxCLENBQUosRUFBc0Q7QUFDcEQsZUFBTyxLQUFQO0FBQ0Q7O0FBQ0QsWUFBTXJDLEdBQU47QUFDRDtBQUNGLEdBaEJEOztBQWtCQSxNQUFJO0FBQ0YsVUFBTSxLQUFLb0Msd0JBQUwsQ0FBOEJGLFNBQTlCLENBQU47QUFDRCxHQUZELENBRUUsT0FBT2xDLEdBQVAsRUFBWTtBQU9aLFFBQUksQ0FBQ0EsR0FBRyxDQUFDTyxPQUFKLENBQVk4QixLQUFaLENBQWtCLGlCQUFsQixDQUFMLEVBQTJDO0FBQ3pDLFlBQU1yQyxHQUFOO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJLENBQUNzRCxJQUFMLEVBQVc7QUFDVCxRQUFJNUMsUUFBSixFQUFjO0FBQ1osYUFBTyxFQUFQO0FBQ0Q7O0FBQ0QsVUFBTSxJQUFJNEIsVUFBT0Msa0JBQVgsRUFBTjtBQUNEOztBQUVEbEMsa0JBQUkwQyxJQUFKLENBQVUsMkJBQTBCWSxJQUFJLENBQUNDLFNBQUwsQ0FBZU4sSUFBZixDQUFxQixFQUF6RDs7QUFDQSxRQUFNTyxLQUFLLEdBQUcsSUFBSUMsMEJBQUosQ0FBaUJ0QixXQUFqQixFQUE4QmMsSUFBOUIsQ0FBZDs7QUFLQSxNQUFJYixvQkFBSixFQUEwQjtBQUN4QixXQUFPb0IsS0FBUDtBQUNEOztBQUVELE9BQUtFLFdBQUwsQ0FBaUJDLEdBQWpCLENBQXFCSCxLQUFLLENBQUNJLEVBQTNCLEVBQStCSixLQUEvQjs7QUFDQSxRQUFNSyxRQUFRLEdBQUcsS0FBS0MsYUFBTCxLQUF1QkMseUJBQXZCLEdBQXlDQyw2QkFBMUQ7QUFDQSxRQUFNQyxVQUFVLEdBQUdULEtBQUssQ0FBQ1UsU0FBTixDQUFnQkwsUUFBaEIsQ0FBbkI7QUFDQSxTQUFPeEQsUUFBUSxHQUFHLENBQUM0RCxVQUFELENBQUgsR0FBa0JBLFVBQWpDO0FBQ0QsQ0E5RUQ7O0FBeUZBakYsT0FBTyxDQUFDZ0Usa0JBQVIsR0FBNkIsZ0JBQWdCYixXQUFoQixFQUE2QlUsV0FBN0IsRUFBMENFLFlBQTFDLEVBQXdEO0FBQ25GLE1BQUlvQixNQUFNLEdBQUcsTUFBTUMseUJBQVVDLFlBQVYsQ0FBdUJsQyxXQUF2QixDQUFuQjtBQUNBLE1BQUk7QUFBQ1MsSUFBQUEsS0FBSyxFQUFFMEIsUUFBUjtBQUFrQnhCLElBQUFBLE1BQU0sRUFBRXlCO0FBQTFCLE1BQXVDSixNQUFNLENBQUNLLE1BQWxEOztBQUdBLE1BQUlGLFFBQVEsSUFBSXpCLFdBQVosSUFBMkIwQixTQUFTLElBQUl4QixZQUE1QyxFQUEwRDtBQUN4RCxXQUFPWixXQUFQO0FBQ0Q7O0FBR0RnQyxFQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ00sVUFBUCxDQUFrQjVCLFdBQWxCLEVBQStCRSxZQUEvQixDQUFUO0FBQ0EsU0FBTyxDQUFDLE1BQU1vQixNQUFNLENBQUNPLFNBQVAsQ0FBaUJOLHlCQUFVTyxRQUEzQixDQUFQLEVBQTZDQyxRQUE3QyxDQUFzRCxRQUF0RCxDQUFQO0FBQ0QsQ0FaRDs7QUF1QkE1RixPQUFPLENBQUNtRSx5QkFBUixHQUFvQyxnQkFBZ0JOLFdBQWhCLEVBQTZCRSxZQUE3QixFQUEyQztBQUM3RSxNQUFJLENBQUMsS0FBSzhCLGFBQVYsRUFBeUI7QUFDdkIsVUFBTSxJQUFJaEUsS0FBSixDQUFVLG1FQUFWLENBQU47QUFDRDs7QUFFRCxNQUFJcUMsYUFBYSxHQUFHLE1BQU0sS0FBSzJCLGFBQUwsRUFBMUI7O0FBSUEsTUFBSSxDQUFDLEtBQUtyQyxRQUFMLENBQWNDLFdBQWQsR0FBNEJxQywwQkFBakMsRUFBNkQ7QUFDM0Q5RSxvQkFBSTBDLElBQUosQ0FBVSxrREFBVjs7QUFDQSxXQUFPUSxhQUFQO0FBQ0Q7O0FBSURsRCxrQkFBSTBDLElBQUosQ0FBUyw0Q0FBVDs7QUFFQSxNQUFJeUIsTUFBTSxHQUFHLE1BQU1DLHlCQUFVQyxZQUFWLENBQXVCbkIsYUFBdkIsQ0FBbkI7QUFDQSxNQUFJO0FBQUNOLElBQUFBLEtBQUssRUFBRW1DLFNBQVI7QUFBbUJqQyxJQUFBQSxNQUFNLEVBQUVrQztBQUEzQixNQUF5Q2IsTUFBTSxDQUFDSyxNQUFwRDs7QUFFQSxNQUFJM0IsV0FBVyxLQUFLa0MsU0FBaEIsSUFBNkJoQyxZQUFZLEtBQUtpQyxVQUFsRCxFQUE4RDtBQUc1RGhGLG9CQUFJMEMsSUFBSixDQUFTLHFDQUFUOztBQUNBLFdBQU9RLGFBQVA7QUFDRDs7QUFRRCxRQUFNK0IsUUFBUSxHQUFHcEMsV0FBVyxHQUFHRSxZQUEvQjtBQUNBLFFBQU1tQyxNQUFNLEdBQUdILFNBQVMsR0FBR0MsVUFBM0I7O0FBRUEsTUFBSUMsUUFBUSxLQUFLQyxNQUFqQixFQUF5QjtBQUN2QmxGLG9CQUFJMEMsSUFBSixDQUFTLHFEQUFUO0FBQ0QsR0FGRCxNQUVPO0FBQ0wxQyxvQkFBSW1GLElBQUosQ0FBVSw2REFBRCxHQUNDLGlFQURELEdBRUMsTUFBS3RDLFdBQVksSUFBR0UsWUFBYSx5QkFGbEMsR0FHQyxHQUFFZ0MsU0FBVSxJQUFHQyxVQUFXLEdBSHBDOztBQUlBRCxJQUFBQSxTQUFTLEdBQUdBLFNBQVMsSUFBSUcsTUFBTSxHQUFHRCxRQUFiLENBQXJCOztBQUNBakYsb0JBQUltRixJQUFKLENBQVUsMEJBQXlCSixTQUFVLElBQUdDLFVBQVcsWUFBbEQsR0FDQywrREFERCxHQUVDLGtDQUZWOztBQUdBYixJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ2lCLE1BQVAsQ0FBY0wsU0FBZCxFQUF5QkMsVUFBekIsQ0FBVDtBQUNEOztBQUlELE1BQUluQyxXQUFXLEtBQUtrQyxTQUFwQixFQUErQjtBQUM3Qi9FLG9CQUFJMEMsSUFBSixDQUFVLDJCQUEwQnFDLFNBQVUsSUFBR0MsVUFBVyxZQUFuRCxHQUNDLGFBQVluQyxXQUFZLElBQUdFLFlBQWEsRUFEbEQ7O0FBRUFvQixJQUFBQSxNQUFNLEdBQUdBLE1BQU0sQ0FBQ2lCLE1BQVAsQ0FBY3ZDLFdBQWQsRUFBMkJFLFlBQTNCLENBQVQ7QUFDRDs7QUFFRCxTQUFPLENBQUMsTUFBTW9CLE1BQU0sQ0FBQ08sU0FBUCxDQUFpQk4seUJBQVVPLFFBQTNCLENBQVAsRUFBNkNDLFFBQTdDLENBQXNELFFBQXRELENBQVA7QUFDRCxDQTVERDs7QUErREFTLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjckcsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBsb2dnZXIsIGltYWdlVXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICcuLi8uLi8uLic7XG5pbXBvcnQgeyBNQVRDSF9URU1QTEFURV9NT0RFIH0gZnJvbSAnLi9pbWFnZXMnO1xuaW1wb3J0IHsgVzNDX0VMRU1FTlRfS0VZLCBNSlNPTldQX0VMRU1FTlRfS0VZIH0gZnJvbSAnLi4vLi4vcHJvdG9jb2wvcHJvdG9jb2wnO1xuaW1wb3J0IHsgSW1hZ2VFbGVtZW50IH0gZnJvbSAnLi4vaW1hZ2UtZWxlbWVudCc7XG5cblxuY29uc3QgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbnN0IElNQUdFX1NUUkFURUdZID0gJy1pbWFnZSc7XG5jb25zdCBDVVNUT01fU1RSQVRFR1kgPSAnLWN1c3RvbSc7XG5cbi8vIE92ZXJyaWRlIHRoZSBmb2xsb3dpbmcgZnVuY3Rpb24gZm9yIHlvdXIgb3duIGRyaXZlciwgYW5kIHRoZSByZXN0IGlzIHRha2VuXG4vLyBjYXJlIG9mIVxuXG4vLyBoZWxwZXJzLmZpbmRFbE9yRWxzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge31cbi8vICAgc3RyYXRlZ3k6IGxvY2F0b3Igc3RyYXRlZ3lcbi8vICAgc2VsZWN0b3I6IHRoZSBhY3R1YWwgc2VsZWN0b3IgZm9yIGZpbmRpbmcgYW4gZWxlbWVudFxuLy8gICBtdWx0OiBtdWx0aXBsZSBlbGVtZW50cyBvciBqdXN0IG9uZT9cbi8vICAgY29udGV4dDogZmluZGluZyBhbiBlbGVtZW50IGZyb20gdGhlIHJvb3QgY29udGV4dD8gb3Igc3RhcnRpbmcgZnJvbSBhbm90aGVyIGVsZW1lbnRcbi8vXG4vLyBSZXR1cm5zIGFuIG9iamVjdCB3aGljaCBhZGhlcmVzIHRvIHRoZSB3YXkgdGhlIEpTT04gV2lyZSBQcm90b2NvbCByZXByZXNlbnRzIGVsZW1lbnRzOlxuLy8geyBFTEVNRU5UOiAjIH0gICAgZWc6IHsgRUxFTUVOVDogMyB9ICBvciB7IEVMRU1FTlQ6IDEuMDIzIH1cblxuaGVscGVycy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICB0aGlzLnZhbGlkYXRlTG9jYXRvclN0cmF0ZWd5KHN0cmF0ZWd5KTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVscyhzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodGhpcy5vcHRzLnByaW50UGFnZVNvdXJjZU9uRmluZEZhaWx1cmUpIHtcbiAgICAgIGNvbnN0IHNyYyA9IGF3YWl0IHRoaXMuZ2V0UGFnZVNvdXJjZSgpO1xuICAgICAgbG9nLmRlYnVnKGBFcnJvciBmaW5kaW5nIGVsZW1lbnQke211bHQgPyAncycgOiAnJ306ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBsb2cuZGVidWcoYFBhZ2Ugc291cmNlIHJlcXVlc3RlZCB0aHJvdWdoICdwcmludFBhZ2VTb3VyY2VPbkZpbmRGYWlsdXJlJzpgKTtcbiAgICAgIGxvZy5kZWJ1ZyhzcmMpO1xuICAgIH1cbiAgICAvLyBzdGlsbCB3YW50IHRoZSBlcnJvciB0byBvY2N1clxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMuZmluZEVsZW1lbnQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yKSB7XG4gIGlmIChzdHJhdGVneSA9PT0gSU1BR0VfU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlJbWFnZShzZWxlY3Rvciwge211bHRpcGxlOiBmYWxzZX0pO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSBDVVNUT01fU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlDdXN0b20oc2VsZWN0b3IsIGZhbHNlKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCBmYWxzZSk7XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yKSB7XG4gIGlmIChzdHJhdGVneSA9PT0gSU1BR0VfU1RSQVRFR1kpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5maW5kQnlJbWFnZShzZWxlY3Rvciwge211bHRpcGxlOiB0cnVlfSk7XG4gIH0gZWxzZSBpZiAoc3RyYXRlZ3kgPT09IENVU1RPTV9TVFJBVEVHWSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmZpbmRCeUN1c3RvbShzZWxlY3RvciwgdHJ1ZSk7XG4gIH1cblxuICByZXR1cm4gYXdhaXQgdGhpcy5maW5kRWxPckVsc1dpdGhQcm9jZXNzaW5nKHN0cmF0ZWd5LCBzZWxlY3RvciwgdHJ1ZSk7XG59O1xuXG5jb21tYW5kcy5maW5kRWxlbWVudEZyb21FbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgZWxlbWVudElkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCBmYWxzZSwgZWxlbWVudElkKTtcbn07XG5cbmNvbW1hbmRzLmZpbmRFbGVtZW50c0Zyb21FbGVtZW50ID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgZWxlbWVudElkKSB7XG4gIHJldHVybiBhd2FpdCB0aGlzLmZpbmRFbE9yRWxzV2l0aFByb2Nlc3Npbmcoc3RyYXRlZ3ksIHNlbGVjdG9yLCB0cnVlLCBlbGVtZW50SWQpO1xufTtcblxuLyoqXG4gKiBGaW5kIGFuIGVsZW1lbnQgdXNpbmcgYSBjdXN0b20gcGx1Z2luIHNwZWNpZmllZCBieSB0aGUgY3VzdG9tRmluZE1vZHVsZXMgY2FwLlxuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSBzZWxlY3RvciAtIHRoZSBzZWxlY3RvciB3aGljaCB0aGUgcGx1Z2luIHdpbGwgdXNlIHRvIGZpbmRcbiAqIGVsZW1lbnRzXG4gKiBAcGFyYW0ge2Jvb2xlYW59IG11bHRpcGxlIC0gd2hldGhlciB3ZSB3YW50IG9uZSBlbGVtZW50IG9yIG11bHRpcGxlXG4gKlxuICogQHJldHVybnMge1dlYkVsZW1lbnR9IC0gV2ViRHJpdmVyIGVsZW1lbnQgb3IgbGlzdCBvZiBlbGVtZW50c1xuICovXG5jb21tYW5kcy5maW5kQnlDdXN0b20gPSBhc3luYyBmdW5jdGlvbiAoc2VsZWN0b3IsIG11bHRpcGxlKSB7XG4gIGNvbnN0IHBsdWdpbnMgPSB0aGlzLm9wdHMuY3VzdG9tRmluZE1vZHVsZXM7XG5cbiAgLy8gZmlyc3QgZW5zdXJlIHRoZSB1c2VyIGhhcyByZWdpc3RlcmVkIG9uZSBvciBtb3JlIGZpbmQgcGx1Z2luc1xuICBpZiAoIXBsdWdpbnMpIHtcbiAgICAvLyBUT0RPIHRoaXMgaW5mbyBzaG91bGQgZ28gaW4gZG9jcyBpbnN0ZWFkOyB1cGRhdGUgd2hlbiBkb2NzIGZvciB0aGlzXG4gICAgLy8gZmVhdHVyZSBleGlzdFxuICAgIHRocm93IG5ldyBFcnJvcignRmluZGluZyBhbiBlbGVtZW50IHVzaW5nIGEgcGx1Z2luIGlzIGN1cnJlbnRseSBhbiAnICtcbiAgICAgICdpbmN1YmF0aW5nIGZlYXR1cmUuIFRvIHVzZSBpdCB5b3UgbXVzdCBtYW51YWxseSBpbnN0YWxsIG9uZSBvciBtb3JlICcgK1xuICAgICAgJ3BsdWdpbiBtb2R1bGVzIGluIGEgd2F5IHRoYXQgdGhleSBjYW4gYmUgcmVxdWlyZWQgYnkgQXBwaXVtLCBmb3IgJyArXG4gICAgICAnZXhhbXBsZSBpbnN0YWxsaW5nIHRoZW0gZnJvbSB0aGUgQXBwaXVtIGRpcmVjdG9yeSwgaW5zdGFsbGluZyB0aGVtICcgK1xuICAgICAgJ2dsb2JhbGx5LCBvciBpbnN0YWxsaW5nIHRoZW0gZWxzZXdoZXJlIGFuZCBwYXNzaW5nIGFuIGFic29sdXRlIHBhdGggYXMgJyArXG4gICAgICAndGhlIGNhcGFiaWxpdHkuIFRoZW4gY29uc3RydWN0IGFuIG9iamVjdCB3aGVyZSB0aGUga2V5IGlzIHRoZSBzaG9ydGN1dCAnICtcbiAgICAgICduYW1lIGZvciB0aGlzIHBsdWdpbiBhbmQgdGhlIHZhbHVlIGlzIHRoZSBtb2R1bGUgbmFtZSBvciBhYnNvbHV0ZSBwYXRoLCAnICtcbiAgICAgICdmb3IgZXhhbXBsZToge1wicDFcIjogXCJteS1maW5kLXBsdWdpblwifSwgYW5kIHBhc3MgdGhpcyBpbiBhcyB0aGUgJyArXG4gICAgICBcIidjdXN0b21GaW5kTW9kdWxlcycgY2FwYWJpbGl0eS5cIik7XG4gIH1cblxuICAvLyB0aGVuIGRvIHNvbWUgYmFzaWMgY2hlY2tpbmcgb2YgdGhlIHR5cGUgb2YgdGhlIGNhcGFiaWxpdHlcbiAgaWYgKCFfLmlzUGxhaW5PYmplY3QocGx1Z2lucykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJJbnZhbGlkIGZvcm1hdCBmb3IgdGhlICdjdXN0b21GaW5kTW9kdWxlcycgY2FwYWJpbGl0eS4gXCIgK1xuICAgICAgJ0l0IHNob3VsZCBiZSBhbiBvYmplY3Qgd2l0aCBrZXlzIGNvcnJlc3BvbmRpbmcgdG8gdGhlIHNob3J0IG5hbWVzIGFuZCAnICtcbiAgICAgICd2YWx1ZXMgY29ycmVzcG9uZGluZyB0byB0aGUgZnVsbCBuYW1lcyBvZiB0aGUgZWxlbWVudCBmaW5kaW5nIHBsdWdpbnMnKTtcbiAgfVxuXG4gIC8vIGdldCB0aGUgbmFtZSBvZiB0aGUgcGFydGljdWxhciBwbHVnaW4gdXNlZCBmb3IgdGhpcyBpbnZvY2F0aW9uIG9mIGZpbmQsXG4gIC8vIGFuZCBzZXBhcmF0ZSBpdCBmcm9tIHRoZSBzZWxlY3RvciB3ZSB3aWxsIHBhc3MgdG8gdGhlIHBsdWdpblxuICBsZXQgW3BsdWdpbiwgcmVhbFNlbGVjdG9yXSA9IHNlbGVjdG9yLnNwbGl0KCc6Jyk7XG5cbiAgLy8gaWYgdGhlIHVzZXIgZGlkbid0IHNwZWNpZnkgYSBwbHVnaW4gZm9yIHRoaXMgZmluZCBpbnZvY2F0aW9uLCBhbmQgd2UgaGFkXG4gIC8vIG11bHRpcGxlIHBsdWdpbnMgcmVnaXN0ZXJlZCwgdGhhdCdzIGEgcHJvYmxlbVxuICBpZiAoXy5zaXplKHBsdWdpbnMpID4gMSAmJiAhcmVhbFNlbGVjdG9yKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBNdWx0aXBsZSBlbGVtZW50IGZpbmRpbmcgcGx1Z2lucyB3ZXJlIHJlZ2lzdGVyZWQgYCArXG4gICAgICBgKCR7Xy5rZXlzKHBsdWdpbnMpfSksIGJ1dCB5b3VyIHNlbGVjdG9yIGRpZCBub3QgaW5kaWNhdGUgd2hpY2ggcGx1Z2luIGAgK1xuICAgICAgYHRvIHVzZS4gRW5zdXJlIHlvdSBwdXQgdGhlIHNob3J0IG5hbWUgb2YgdGhlIHBsdWdpbiBmb2xsb3dlZCBieSAnOicgYXMgYCArXG4gICAgICBgdGhlIGluaXRpYWwgcGFydCBvZiB0aGUgc2VsZWN0b3Igc3RyaW5nLmApO1xuICB9XG5cbiAgLy8gYnV0IGlmIHRoZXkgZGlkIG5vdCBzcGVjaWZ5IGEgcGx1Z2luIGFuZCB3ZSBvbmx5IGhhdmUgb25lIHBsdWdpbiwganVzdCB1c2VcbiAgLy8gdGhhdCBvbmVcbiAgaWYgKF8uc2l6ZShwbHVnaW5zKSA9PT0gMSAmJiAhcmVhbFNlbGVjdG9yKSB7XG4gICAgcmVhbFNlbGVjdG9yID0gcGx1Z2luO1xuICAgIHBsdWdpbiA9IF8ua2V5cyhwbHVnaW5zKVswXTtcbiAgfVxuXG4gIGlmICghcGx1Z2luc1twbHVnaW5dKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTZWxlY3RvciBzcGVjaWZpZWQgdXNlIG9mIGVsZW1lbnQgZmluZGluZyBwbHVnaW4gYCArXG4gICAgICBgJyR7cGx1Z2lufScgYnV0IGl0IHdhcyBub3QgcmVnaXN0ZXJlZCBpbiB0aGUgJ2N1c3RvbUZpbmRNb2R1bGVzJyBgICtcbiAgICAgIGBjYXBhYmlsaXR5LmApO1xuICB9XG5cbiAgbGV0IGZpbmRlcjtcbiAgdHJ5IHtcbiAgICBsb2cuZGVidWcoYEZpbmQgcGx1Z2luICcke3BsdWdpbn0nIHJlcXVlc3RlZDsgd2lsbCBhdHRlbXB0IHRvIHVzZSBpdCBgICtcbiAgICAgIGBmcm9tICcke3BsdWdpbnNbcGx1Z2luXX0nYCk7XG4gICAgZmluZGVyID0gcmVxdWlyZShwbHVnaW5zW3BsdWdpbl0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBsb2FkIHlvdXIgY3VzdG9tIGZpbmQgbW9kdWxlICcke3BsdWdpbn0nLiBEaWQgYCArXG4gICAgICBgeW91IHB1dCBpdCBzb21ld2hlcmUgQXBwaXVtIGNhbiAncmVxdWlyZScgaXQ/IE9yaWdpbmFsIGVycm9yOiAke2Vycn1gKTtcbiAgfVxuXG4gIGlmICghZmluZGVyIHx8ICFfLmlzRnVuY3Rpb24oZmluZGVyLmZpbmQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdZb3VyIGN1c3RvbSBmaW5kIG1vZHVsZSBkaWQgbm90IGFwcGVhciB0byBiZSBjb25zdHJ1Y3RlZCAnICtcbiAgICAgICAgJ2NvcnJlY3RseS4gSXQgbmVlZHMgdG8gZXhwb3J0IGFuIG9iamVjdCB3aXRoIGEgYGZpbmRgIG1ldGhvZC4nKTtcbiAgfVxuXG4gIGNvbnN0IGN1c3RvbUZpbmRlckxvZyA9IGxvZ2dlci5nZXRMb2dnZXIocGx1Z2luKTtcblxuICBsZXQgZWxlbWVudHM7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICAvLyBnZXQgYSBsaXN0IG9mIG1hdGNoZWQgZWxlbWVudHMgZnJvbSB0aGUgY3VzdG9tIGZpbmRlciwgd2hpY2ggY2FuXG4gICAgLy8gcG90ZW50aWFsbHkgdXNlIHRoZSBlbnRpcmUgc3VpdGUgb2YgbWV0aG9kcyB0aGUgY3VycmVudCBkcml2ZXIgcHJvdmlkZXMuXG4gICAgLy8gdGhlIGZpbmRlciBzaG91bGQgYWx3YXlzIHJldHVybiBhIGxpc3Qgb2YgZWxlbWVudHMsIGJ1dCBtYXkgdXNlIHRoZVxuICAgIC8vIGtub3dsZWRnZSBvZiB3aGV0aGVyIHdlIGFyZSBsb29raW5nIGZvciBvbmUgb3IgbWFueSB0byBwZXJmb3JtIGludGVybmFsXG4gICAgLy8gb3B0aW1pemF0aW9uc1xuICAgIGVsZW1lbnRzID0gYXdhaXQgZmluZGVyLmZpbmQodGhpcywgY3VzdG9tRmluZGVyTG9nLCByZWFsU2VsZWN0b3IsIG11bHRpcGxlKTtcblxuICAgIC8vIGlmIHdlJ3JlIGxvb2tpbmcgZm9yIG11bHRpcGxlIGVsZW1lbnRzLCBvciBpZiB3ZSdyZSBsb29raW5nIGZvciBvbmx5XG4gICAgLy8gb25lIGFuZCBmb3VuZCBpdCwgd2UncmUgZG9uZVxuICAgIGlmICghXy5pc0VtcHR5KGVsZW1lbnRzKSB8fCBtdWx0aXBsZSkge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuXG4gICAgLy8gb3RoZXJ3aXNlIHdlIHNob3VsZCByZXRyeSwgc28gcmV0dXJuIGZhbHNlIHRvIHRyaWdnZXIgdGhlIHJldHJ5IGxvb3BcbiAgICByZXR1cm4gZmFsc2U7XG4gIH07XG5cbiAgdHJ5IHtcbiAgICAvLyBtYWtlIHN1cmUgd2UgcmVzcGVjdCBpbXBsaWNpdCB3YWl0XG4gICAgYXdhaXQgdGhpcy5pbXBsaWNpdFdhaXRGb3JDb25kaXRpb24oY29uZGl0aW9uKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5tZXNzYWdlLm1hdGNoKC9Db25kaXRpb24gdW5tZXQvKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IoKTtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG5cbiAgcmV0dXJuIG11bHRpcGxlID8gZWxlbWVudHMgOiBlbGVtZW50c1swXTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gRmluZEJ5SW1hZ2VPcHRpb25zXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFtzaG91bGRDaGVja1N0YWxlbmVzcz1mYWxzZV0gLSB3aGV0aGVyIHRoaXMgY2FsbCB0byBmaW5kIGFuXG4gKiBpbWFnZSBpcyBtZXJlbHkgdG8gY2hlY2sgc3RhbGVuZXNzLiBJZiBzbyB3ZSBjYW4gYnlwYXNzIGEgbG90IG9mIGxvZ2ljXG4gKiBAcHJvcGVydHkge2Jvb2xlYW59IFttdWx0aXBsZT1mYWxzZV0gLSBXaGV0aGVyIHdlIGFyZSBmaW5kaW5nIG9uZSBlbGVtZW50IG9yXG4gKiBtdWx0aXBsZVxuICovXG5cbi8qKlxuICogRmluZCBhIHNjcmVlbiByZWN0IHJlcHJlc2VudGVkIGJ5IGFuIEltYWdlRWxlbWVudCBjb3JyZXNwb25kaW5nIHRvIGFuIGltYWdlXG4gKiB0ZW1wbGF0ZSBzZW50IGluIGJ5IHRoZSBjbGllbnRcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYjY0VGVtcGxhdGUgLSBiYXNlNjQtZW5jb2RlZCBpbWFnZSB1c2VkIGFzIGEgdGVtcGxhdGUgdG8gYmVcbiAqIG1hdGNoZWQgaW4gdGhlIHNjcmVlbnNob3RcbiAqIEBwYXJhbSB7RmluZEJ5SW1hZ2VPcHRpb25zfSAtIGFkZGl0aW9uYWwgb3B0aW9uc1xuICpcbiAqIEByZXR1cm5zIHtXZWJFbGVtZW50fSAtIFdlYkRyaXZlciBlbGVtZW50IHdpdGggYSBzcGVjaWFsIGlkIHByZWZpeFxuICovXG5oZWxwZXJzLmZpbmRCeUltYWdlID0gYXN5bmMgZnVuY3Rpb24gKGI2NFRlbXBsYXRlLCB7XG4gIHNob3VsZENoZWNrU3RhbGVuZXNzID0gZmFsc2UsXG4gIG11bHRpcGxlID0gZmFsc2UsXG59KSB7XG4gIGNvbnN0IHtcbiAgICBpbWFnZU1hdGNoVGhyZXNob2xkOiB0aHJlc2hvbGQsXG4gICAgZml4SW1hZ2VUZW1wbGF0ZVNpemVcbiAgfSA9IHRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKTtcblxuICBsb2cuaW5mbyhgRmluZGluZyBpbWFnZSBlbGVtZW50IHdpdGggbWF0Y2ggdGhyZXNob2xkICR7dGhyZXNob2xkfWApO1xuICBpZiAoIXRoaXMuZ2V0V2luZG93U2l6ZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlRoaXMgZHJpdmVyIGRvZXMgbm90IHN1cHBvcnQgdGhlIHJlcXVpcmVkICdnZXRXaW5kb3dTaXplJyBjb21tYW5kXCIpO1xuICB9XG4gIGNvbnN0IHt3aWR0aDogc2NyZWVuV2lkdGgsIGhlaWdodDogc2NyZWVuSGVpZ2h0fSA9IGF3YWl0IHRoaXMuZ2V0V2luZG93U2l6ZSgpO1xuXG4gIC8vIHNvbWVvbmUgbWlnaHQgaGF2ZSBzZW50IGluIGEgdGVtcGxhdGUgdGhhdCdzIGxhcmdlciB0aGFuIHRoZSBzY3JlZW5cbiAgLy8gZGltZW5zaW9ucy4gSWYgc28gbGV0J3MgY2hlY2sgYW5kIGN1dCBpdCBkb3duIHRvIHNpemUgc2luY2UgdGhlIGFsZ29yaXRobVxuICAvLyB3aWxsIG5vdCB3b3JrIHVubGVzcyB3ZSBkby4gQnV0IGJlY2F1c2UgaXQgcmVxdWlyZXMgc29tZSBwb3RlbnRpYWxseVxuICAvLyBleHBlbnNpdmUgY29tbWFuZHMsIG9ubHkgZG8gdGhpcyBpZiB0aGUgdXNlciBoYXMgcmVxdWVzdGVkIGl0IGluIHNldHRpbmdzLlxuICBpZiAoZml4SW1hZ2VUZW1wbGF0ZVNpemUpIHtcbiAgICBiNjRUZW1wbGF0ZSA9IGF3YWl0IHRoaXMuZW5zdXJlVGVtcGxhdGVTaXplKGI2NFRlbXBsYXRlLCBzY3JlZW5XaWR0aCxcbiAgICAgIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICBsZXQgcmVjdCA9IG51bGw7XG4gIGNvbnN0IGNvbmRpdGlvbiA9IGFzeW5jICgpID0+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IGI2NFNjcmVlbnNob3QgPSBhd2FpdCB0aGlzLmdldFNjcmVlbnNob3RGb3JJbWFnZUZpbmQoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gICAgICByZWN0ID0gKGF3YWl0IHRoaXMuY29tcGFyZUltYWdlcyhNQVRDSF9URU1QTEFURV9NT0RFLCBiNjRTY3JlZW5zaG90LFxuICAgICAgICBiNjRUZW1wbGF0ZSwge3RocmVzaG9sZH0pKS5yZWN0O1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAvLyBpZiBjb21wYXJlSW1hZ2VzIGZhaWxzLCB3ZSdsbCBnZXQgYSBzcGVjaWZpYyBlcnJvciwgYnV0IHdlIHNob3VsZFxuICAgICAgLy8gcmV0cnksIHNvIHRyYXAgdGhhdCBhbmQganVzdCByZXR1cm4gZmFsc2UgdG8gdHJpZ2dlciB0aGUgbmV4dCByb3VuZCBvZlxuICAgICAgLy8gaW1wbGljaXRseSB3YWl0aW5nLiBGb3Igb3RoZXIgZXJyb3JzLCB0aHJvdyB0aGVtIHRvIGdldCBvdXQgb2YgdGhlXG4gICAgICAvLyBpbXBsaWNpdCB3YWl0IGxvb3BcbiAgICAgIGlmIChlcnIubWVzc2FnZS5tYXRjaCgvQ2Fubm90IGZpbmQgYW55IG9jY3VycmVuY2VzLykpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfTtcblxuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGNvbmRpdGlvbik7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIHRoaXMgYGltcGxpY2l0V2FpdEZvckNvbmRpdGlvbmAgbWV0aG9kIHdpbGwgdGhyb3cgYSAnQ29uZGl0aW9uIHVubWV0J1xuICAgIC8vIGVycm9yIGlmIGFuIGVsZW1lbnQgaXMgbm90IGZvdW5kIGV2ZW50dWFsbHkuIEluIHRoYXQgY2FzZSwgd2Ugd2lsbFxuICAgIC8vIGhhbmRsZSB0aGUgZWxlbWVudCBub3QgZm91bmQgcmVzcG9uc2UgYmVsb3cuIEluIHRoZSBjYXNlIHdoZXJlIGdldCBzb21lXG4gICAgLy8gX290aGVyXyBraW5kIG9mIGVycm9yLCBpdCBtZWFucyBzb21ldGhpbmcgYmxldyB1cCB0b3RhbGx5IGFwYXJ0IGZyb20gdGhlXG4gICAgLy8gaW1wbGljaXQgd2FpdCB0aW1lb3V0LiBXZSBzaG91bGQgbm90IG1hc2sgdGhhdCBlcnJvciBhbmQgaW5zdGVhZCB0aHJvd1xuICAgIC8vIGl0IHN0cmFpZ2h0YXdheVxuICAgIGlmICghZXJyLm1lc3NhZ2UubWF0Y2goL0NvbmRpdGlvbiB1bm1ldC8pKSB7XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9XG5cbiAgaWYgKCFyZWN0KSB7XG4gICAgaWYgKG11bHRpcGxlKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuICAgIHRocm93IG5ldyBlcnJvcnMuTm9TdWNoRWxlbWVudEVycm9yKCk7XG4gIH1cblxuICBsb2cuaW5mbyhgSW1hZ2UgdGVtcGxhdGUgbWF0Y2hlZDogJHtKU09OLnN0cmluZ2lmeShyZWN0KX1gKTtcbiAgY29uc3QgaW1nRWwgPSBuZXcgSW1hZ2VFbGVtZW50KGI2NFRlbXBsYXRlLCByZWN0KTtcblxuICAvLyBpZiB3ZSdyZSBqdXN0IGNoZWNraW5nIHN0YWxlbmVzcywgcmV0dXJuIHN0cmFpZ2h0YXdheSBzbyB3ZSBkb24ndCBhZGRcbiAgLy8gYSBuZXcgZWxlbWVudCB0byB0aGUgY2FjaGUuIHNob3VsZENoZWNrU3RhbGVuZXNzIGRvZXMgbm90IHN1cHBvcnQgbXVsdGlwbGVcbiAgLy8gZWxlbWVudHMsIHNpbmNlIGl0IGlzIGEgcHVyZWx5IGludGVybmFsIG1lY2hhbmlzbVxuICBpZiAoc2hvdWxkQ2hlY2tTdGFsZW5lc3MpIHtcbiAgICByZXR1cm4gaW1nRWw7XG4gIH1cblxuICB0aGlzLl9pbWdFbENhY2hlLnNldChpbWdFbC5pZCwgaW1nRWwpO1xuICBjb25zdCBwcm90b0tleSA9IHRoaXMuaXNXM0NQcm90b2NvbCgpID8gVzNDX0VMRU1FTlRfS0VZIDogTUpTT05XUF9FTEVNRU5UX0tFWTtcbiAgY29uc3QgcHJvdG9jb2xFbCA9IGltZ0VsLmFzRWxlbWVudChwcm90b0tleSk7XG4gIHJldHVybiBtdWx0aXBsZSA/IFtwcm90b2NvbEVsXSA6IHByb3RvY29sRWw7XG59O1xuXG4vKipcbiAqIEVuc3VyZSB0aGF0IHRoZSBpbWFnZSB0ZW1wbGF0ZSBzZW50IGluIGZvciBhIGZpbmQgaXMgb2YgYSBzdWl0YWJsZSBzaXplXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IGI2NFRlbXBsYXRlIC0gYmFzZTY0LWVuY29kZWQgaW1hZ2VcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBpbWFnZSwgcG90ZW50aWFsbHkgcmVzaXplZFxuICovXG5oZWxwZXJzLmVuc3VyZVRlbXBsYXRlU2l6ZSA9IGFzeW5jIGZ1bmN0aW9uIChiNjRUZW1wbGF0ZSwgc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCkge1xuICBsZXQgaW1nT2JqID0gYXdhaXQgaW1hZ2VVdGlsLmdldEppbXBJbWFnZShiNjRUZW1wbGF0ZSk7XG4gIGxldCB7d2lkdGg6IHRwbFdpZHRoLCBoZWlnaHQ6IHRwbEhlaWdodH0gPSBpbWdPYmouYml0bWFwO1xuXG4gIC8vIGlmIHRoZSB0ZW1wbGF0ZSBmaXRzIGluc2lkZSB0aGUgc2NyZWVuIGRpbWVuc2lvbnMsIHdlJ3JlIGdvb2RcbiAgaWYgKHRwbFdpZHRoIDw9IHNjcmVlbldpZHRoICYmIHRwbEhlaWdodCA8PSBzY3JlZW5IZWlnaHQpIHtcbiAgICByZXR1cm4gYjY0VGVtcGxhdGU7XG4gIH1cblxuICAvLyBvdGhlcndpc2UsIHNjYWxlIGl0IHRvIGZpdCBpbnNpZGUgdGhlIHNjcmVlbiBkaW1lbnNpb25zXG4gIGltZ09iaiA9IGltZ09iai5zY2FsZVRvRml0KHNjcmVlbldpZHRoLCBzY3JlZW5IZWlnaHQpO1xuICByZXR1cm4gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuLyoqXG4gKiBHZXQgdGhlIHNjcmVlbnNob3QgaW1hZ2UgdGhhdCB3aWxsIGJlIHVzZWQgZm9yIGZpbmQgYnkgZWxlbWVudCwgcG90ZW50aWFsbHlcbiAqIGFsdGVyaW5nIGl0IGluIHZhcmlvdXMgd2F5cyBiYXNlZCBvbiB1c2VyLXJlcXVlc3RlZCBzZXR0aW5nc1xuICpcbiAqIEBwYXJhbSB7aW50fSBzY3JlZW5XaWR0aCAtIHdpZHRoIG9mIHNjcmVlblxuICogQHBhcmFtIHtpbnR9IHNjcmVlbkhlaWdodCAtIGhlaWdodCBvZiBzY3JlZW5cbiAqXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBiYXNlNjQtZW5jb2RlZCBzY3JlZW5zaG90XG4gKi9cbmhlbHBlcnMuZ2V0U2NyZWVuc2hvdEZvckltYWdlRmluZCA9IGFzeW5jIGZ1bmN0aW9uIChzY3JlZW5XaWR0aCwgc2NyZWVuSGVpZ2h0KSB7XG4gIGlmICghdGhpcy5nZXRTY3JlZW5zaG90KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiVGhpcyBkcml2ZXIgZG9lcyBub3Qgc3VwcG9ydCB0aGUgcmVxdWlyZWQgJ2dldFNjcmVlbnNob3QnIGNvbW1hbmRcIik7XG4gIH1cblxuICBsZXQgYjY0U2NyZWVuc2hvdCA9IGF3YWl0IHRoaXMuZ2V0U2NyZWVuc2hvdCgpO1xuXG4gIC8vIGlmIHRoZSB1c2VyIGhhcyByZXF1ZXN0ZWQgbm90IHRvIGNvcnJlY3QgZm9yIGFzcGVjdCBvciBzaXplIGRpZmZlcmVuY2VzXG4gIC8vIGJldHdlZW4gdGhlIHNjcmVlbnNob3QgYW5kIHRoZSBzY3JlZW4sIGp1c3QgcmV0dXJuIHRoZSBzY3JlZW5zaG90IG5vd1xuICBpZiAoIXRoaXMuc2V0dGluZ3MuZ2V0U2V0dGluZ3MoKS5maXhJbWFnZUZpbmRTY3JlZW5zaG90RGltcykge1xuICAgIGxvZy5pbmZvKGBOb3QgdmVyaWZ5aW5nIHNjcmVlbnNob3QgZGltZW5zaW9ucyBtYXRjaCBzY3JlZW5gKTtcbiAgICByZXR1cm4gYjY0U2NyZWVuc2hvdDtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgZG8gc29tZSB2ZXJpZmljYXRpb24gb24gdGhlIHNjcmVlbnNob3QgdG8gbWFrZSBzdXJlIGl0IG1hdGNoZXNcbiAgLy8gdGhlIHNjcmVlbiBzaXplIGFuZCBhc3BlY3QgcmF0aW9cbiAgbG9nLmluZm8oJ1ZlcmlmeWluZyBzY3JlZW5zaG90IHNpemUgYW5kIGFzcGVjdCByYXRpbycpO1xuXG4gIGxldCBpbWdPYmogPSBhd2FpdCBpbWFnZVV0aWwuZ2V0SmltcEltYWdlKGI2NFNjcmVlbnNob3QpO1xuICBsZXQge3dpZHRoOiBzaG90V2lkdGgsIGhlaWdodDogc2hvdEhlaWdodH0gPSBpbWdPYmouYml0bWFwO1xuXG4gIGlmIChzY3JlZW5XaWR0aCA9PT0gc2hvdFdpZHRoICYmIHNjcmVlbkhlaWdodCA9PT0gc2hvdEhlaWdodCkge1xuICAgIC8vIHRoZSBoZWlnaHQgYW5kIHdpZHRoIG9mIHRoZSBzY3JlZW5zaG90IGFuZCB0aGUgZGV2aWNlIHNjcmVlbiBtYXRjaCwgd2hpY2hcbiAgICAvLyBtZWFucyB3ZSBzaG91bGQgYmUgc2FmZSB3aGVuIGRvaW5nIHRlbXBsYXRlIG1hdGNoZXNcbiAgICBsb2cuaW5mbygnU2NyZWVuc2hvdCBzaXplIG1hdGNoZWQgc2NyZWVuIHNpemUnKTtcbiAgICByZXR1cm4gYjY0U2NyZWVuc2hvdDtcbiAgfVxuXG4gIC8vIG90aGVyd2lzZSwgaWYgdGhleSBkb24ndCBtYXRjaCwgaXQgY291bGQgc3BlbGwgcHJvYmxlbXMgZm9yIHRoZSBhY2N1cmFjeVxuICAvLyBvZiBjb29yZGluYXRlcyByZXR1cm5lZCBieSB0aGUgaW1hZ2UgbWF0Y2ggYWxnb3JpdGhtLCBzaW5jZSB3ZSBtYXRjaCBiYXNlZFxuICAvLyBvbiB0aGUgc2NyZWVuc2hvdCBjb29yZGluYXRlcyBub3QgdGhlIGRldmljZSBjb29yZGluYXRlcyB0aGVtc2VsdmVzLiBUaGVyZVxuICAvLyBhcmUgdHdvIHBvdGVudGlhbCB0eXBlcyBvZiBtaXNtYXRjaDogYXNwZWN0IHJhdGlvIG1pc21hdGNoIGFuZCBzY2FsZVxuICAvLyBtaXNtYXRjaC4gd2UgbmVlZCB0byBkZXRlY3QgYW5kIGZpeCBib3RoXG5cbiAgY29uc3Qgc2NyZWVuQVIgPSBzY3JlZW5XaWR0aCAvIHNjcmVlbkhlaWdodDtcbiAgY29uc3Qgc2hvdEFSID0gc2hvdFdpZHRoIC8gc2hvdEhlaWdodDtcblxuICBpZiAoc2NyZWVuQVIgPT09IHNob3RBUikge1xuICAgIGxvZy5pbmZvKCdTY3JlZW5zaG90IGFzcGVjdCByYXRpbyBtYXRjaGVkIHNjcmVlbiBhc3BlY3QgcmF0aW8nKTtcbiAgfSBlbHNlIHtcbiAgICBsb2cud2FybihgV2hlbiB0cnlpbmcgdG8gZmluZCBhbiBlbGVtZW50LCBkZXRlcm1pbmVkIHRoYXQgdGhlIHNjcmVlbiBgICtcbiAgICAgICAgICAgICBgYXNwZWN0IHJhdGlvIGFuZCBzY3JlZW5zaG90IGFzcGVjdCByYXRpbyBhcmUgZGlmZmVyZW50LiBTY3JlZW4gYCArXG4gICAgICAgICAgICAgYGlzICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fSB3aGVyZWFzIHNjcmVlbnNob3QgaXMgYCArXG4gICAgICAgICAgICAgYCR7c2hvdFdpZHRofXgke3Nob3RIZWlnaHR9LmApO1xuICAgIHNob3RXaWR0aCA9IHNob3RXaWR0aCAvIChzaG90QVIgLyBzY3JlZW5BUik7XG4gICAgbG9nLndhcm4oYFJlc2l6aW5nIHNjcmVlbnNob3QgdG8gJHtzaG90V2lkdGh9eCR7c2hvdEhlaWdodH0gdG8gbWF0Y2ggYCArXG4gICAgICAgICAgICAgYHNjcmVlbiBhc3BlY3QgcmF0aW8gc28gdGhhdCBpbWFnZSBlbGVtZW50IGNvb3JkaW5hdGVzIGhhdmUgYSBgICtcbiAgICAgICAgICAgICBgZ3JlYXRlciBjaGFuY2Ugb2YgYmVpbmcgY29ycmVjdC5gKTtcbiAgICBpbWdPYmogPSBpbWdPYmoucmVzaXplKHNob3RXaWR0aCwgc2hvdEhlaWdodCk7XG4gIH1cblxuICAvLyBub3cgd2Uga25vdyB0aGUgYXNwZWN0IHJhdGlvcyBtYXRjaCwgYnV0IHRoZXJlIG1pZ2h0IHN0aWxsIGJlIGEgc2NhbGVcbiAgLy8gbWlzbWF0Y2gsIHNvIGp1c3QgcmVzaXplIGJhc2VkIG9uIHRoZSBzY3JlZW4gZGltZW5zaW9uc1xuICBpZiAoc2NyZWVuV2lkdGggIT09IHNob3RXaWR0aCkge1xuICAgIGxvZy5pbmZvKGBTY2FsaW5nIHNjcmVlbnNob3QgZnJvbSAke3Nob3RXaWR0aH14JHtzaG90SGVpZ2h0fSB0byBtYXRjaCBgICtcbiAgICAgICAgICAgICBgc2NyZWVuIGF0ICR7c2NyZWVuV2lkdGh9eCR7c2NyZWVuSGVpZ2h0fWApO1xuICAgIGltZ09iaiA9IGltZ09iai5yZXNpemUoc2NyZWVuV2lkdGgsIHNjcmVlbkhlaWdodCk7XG4gIH1cblxuICByZXR1cm4gKGF3YWl0IGltZ09iai5nZXRCdWZmZXIoaW1hZ2VVdGlsLk1JTUVfUE5HKSkudG9TdHJpbmcoJ2Jhc2U2NCcpO1xufTtcblxuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGNvbW1hbmRzLCBoZWxwZXJzLCBJTUFHRV9TVFJBVEVHWSwgQ1VTVE9NX1NUUkFURUdZIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvYmFzZWRyaXZlci9jb21tYW5kcy9maW5kLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uLy4uIn0=
