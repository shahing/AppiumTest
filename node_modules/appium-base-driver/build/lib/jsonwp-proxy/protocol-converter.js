"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _driver = _interopRequireDefault(require("../basedriver/driver"));

var _appiumSupport = require("appium-support");

const log = _appiumSupport.logger.getLogger('Protocol Converter');

const COMMAND_URLS_CONFLICTS = [{
  commandNames: ['execute', 'executeAsync'],
  jsonwpConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute_async' : '/execute'),
  w3cConverter: url => url.replace(/\/execute.*/, url.includes('async') ? '/execute/async' : '/execute/sync')
}, {
  commandNames: ['getElementScreenshot'],
  jsonwpConverter: url => url.replace(/\/element\/([^/]+)\/screenshot$/, '/screenshot/$1'),
  w3cConverter: url => url.replace(/\/screenshot\/([^/]+)/, '/element/$1/screenshot')
}, {
  commandNames: ['getWindowHandles', 'getWindowHandle'],
  jsonwpConverter: url => {
    return /\/window$/.test(url) ? url.replace(/\/window$/, '/window_handle') : url.replace(/\/window\/handle(s?)$/, '/window_handle$1');
  },
  w3cConverter: url => {
    return /\/window_handle$/.test(url) ? url.replace(/\/window_handle$/, '/window') : url.replace(/\/window_handles$/, '/window/handles');
  }
}];
const {
  MJSONWP,
  W3C
} = _driver.default.DRIVER_PROTOCOL;

class ProtocolConverter {
  constructor(proxyFunc) {
    this.proxyFunc = proxyFunc;
    this._downstreamProtocol = null;
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getTimeoutRequestObjects(body) {
    if (this.downstreamProtocol === W3C && _lodash.default.has(body, 'ms') && _lodash.default.has(body, 'type')) {
      const typeToW3C = x => x === 'page load' ? 'pageLoad' : x;

      return [{
        [typeToW3C(body.type)]: body.ms
      }];
    }

    if (this.downstreamProtocol === MJSONWP && (!_lodash.default.has(body, 'ms') || !_lodash.default.has(body, 'type'))) {
      const typeToJSONWP = x => x === 'pageLoad' ? 'page load' : x;

      return _lodash.default.toPairs(body).filter(pair => /^\d+(?:[.,]\d*?)?$/.test(`${pair[1]}`)).map(pair => {
        return {
          type: typeToJSONWP(pair[0]),
          ms: pair[1]
        };
      });
    }

    return [body];
  }

  async proxySetTimeouts(url, method, body) {
    let response, resBody;
    const timeoutRequestObjects = this.getTimeoutRequestObjects(body);
    log.debug(`Will send the following request bodies to /timeouts: ${JSON.stringify(timeoutRequestObjects)}`);

    for (const timeoutObj of timeoutRequestObjects) {
      [response, resBody] = await this.proxyFunc(url, method, timeoutObj);

      if (this.downstreamProtocol !== MJSONWP) {
        return [response, resBody];
      }

      if (response.statusCode >= 400) {
        return [response, resBody];
      }
    }

    return [response, resBody];
  }

  async proxySetWindow(url, method, body) {
    const bodyObj = _appiumSupport.util.safeJsonParse(body);

    if (_lodash.default.isPlainObject(bodyObj)) {
      if (this.downstreamProtocol === W3C && _lodash.default.has(bodyObj, 'name') && !_lodash.default.has(bodyObj, 'handle')) {
        log.debug(`Reassigned 'name' value '${bodyObj.name}' to 'handle' as per W3C spec`);
        return await this.proxyFunc(url, method, {
          handle: bodyObj.name
        });
      }

      if (this.downstreamProtocol === MJSONWP && _lodash.default.has(bodyObj, 'handle') && !_lodash.default.has(bodyObj, 'name')) {
        log.debug(`Reassigned 'handle' value '${bodyObj.handle}' to 'name' as per JSONWP spec`);
        return await this.proxyFunc(url, method, {
          name: bodyObj.handle
        });
      }
    }

    return await this.proxyFunc(url, method, body);
  }

  async convertAndProxy(commandName, url, method, body) {
    if (!this.downstreamProtocol) {
      return await this.proxyFunc(url, method, body);
    }

    switch (commandName) {
      case 'timeouts':
        return await this.proxySetTimeouts(url, method, body);

      case 'setWindow':
        return await this.proxySetWindow(url, method, body);

      default:
        break;
    }

    for (const _ref of COMMAND_URLS_CONFLICTS) {
      const {
        commandNames,
        jsonwpConverter,
        w3cConverter
      } = _ref;

      if (!commandNames.includes(commandName)) {
        continue;
      }

      const rewrittenUrl = this.downstreamProtocol === MJSONWP ? jsonwpConverter(url) : w3cConverter(url);

      if (rewrittenUrl === url) {
        log.debug(`Did not know how to rewrite the original URL '${url}' ` + `for ${this.downstreamProtocol} protocol`);
        break;
      }

      log.info(`Rewrote the original URL '${url}' to '${rewrittenUrl}' ` + `for ${this.downstreamProtocol} protocol`);
      return await this.proxyFunc(rewrittenUrl, method, body);
    }

    return await this.proxyFunc(url, method, body);
  }

}

var _default = ProtocolConverter;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9qc29ud3AtcHJveHkvcHJvdG9jb2wtY29udmVydGVyLmpzIl0sIm5hbWVzIjpbImxvZyIsImxvZ2dlciIsImdldExvZ2dlciIsIkNPTU1BTkRfVVJMU19DT05GTElDVFMiLCJjb21tYW5kTmFtZXMiLCJqc29ud3BDb252ZXJ0ZXIiLCJ1cmwiLCJyZXBsYWNlIiwiaW5jbHVkZXMiLCJ3M2NDb252ZXJ0ZXIiLCJ0ZXN0IiwiTUpTT05XUCIsIlczQyIsIkJhc2VEcml2ZXIiLCJEUklWRVJfUFJPVE9DT0wiLCJQcm90b2NvbENvbnZlcnRlciIsImNvbnN0cnVjdG9yIiwicHJveHlGdW5jIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzIiwiYm9keSIsIl8iLCJoYXMiLCJ0eXBlVG9XM0MiLCJ4IiwidHlwZSIsIm1zIiwidHlwZVRvSlNPTldQIiwidG9QYWlycyIsImZpbHRlciIsInBhaXIiLCJtYXAiLCJwcm94eVNldFRpbWVvdXRzIiwibWV0aG9kIiwicmVzcG9uc2UiLCJyZXNCb2R5IiwidGltZW91dFJlcXVlc3RPYmplY3RzIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5IiwidGltZW91dE9iaiIsInN0YXR1c0NvZGUiLCJwcm94eVNldFdpbmRvdyIsImJvZHlPYmoiLCJ1dGlsIiwic2FmZUpzb25QYXJzZSIsImlzUGxhaW5PYmplY3QiLCJuYW1lIiwiaGFuZGxlIiwiY29udmVydEFuZFByb3h5IiwiY29tbWFuZE5hbWUiLCJyZXdyaXR0ZW5VcmwiLCJpbmZvIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLEdBQUcsR0FBR0Msc0JBQU9DLFNBQVAsQ0FBaUIsb0JBQWpCLENBQVo7O0FBR0EsTUFBTUMsc0JBQXNCLEdBQUcsQ0FDN0I7QUFDRUMsRUFBQUEsWUFBWSxFQUFFLENBQUMsU0FBRCxFQUFZLGNBQVos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S0FBS0YsU0FBTCxDQUFlb0MsWUFBZixFQUE2QmxCLE1BQTdCLEVBQXFDYixJQUFyQyxDQUFiO0FBQ0Q7O0FBR0QsV0FBTyxNQUFNLEtBQUtMLFNBQUwsQ0FBZVgsR0FBZixFQUFvQjZCLE1BQXBCLEVBQTRCYixJQUE1QixDQUFiO0FBQ0Q7O0FBM0lxQjs7ZUE4SVRQLGlCIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBCYXNlRHJpdmVyIGZyb20gJy4uL2Jhc2Vkcml2ZXIvZHJpdmVyJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuY29uc3QgbG9nID0gbG9nZ2VyLmdldExvZ2dlcignUHJvdG9jb2wgQ29udmVydGVyJyk7XG5cblxuY29uc3QgQ09NTUFORF9VUkxTX0NPTkZMSUNUUyA9IFtcbiAge1xuICAgIGNvbW1hbmROYW1lczogWydleGVjdXRlJywgJ2V4ZWN1dGVBc3luYyddLFxuICAgIGpzb253cENvbnZlcnRlcjogKHVybCkgPT4gdXJsLnJlcGxhY2UoL1xcL2V4ZWN1dGUuKi8sXG4gICAgICB1cmwuaW5jbHVkZXMoJ2FzeW5jJykgPyAnL2V4ZWN1dGVfYXN5bmMnIDogJy9leGVjdXRlJyksXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZXhlY3V0ZS4qLyxcbiAgICAgIHVybC5pbmNsdWRlcygnYXN5bmMnKSA/ICcvZXhlY3V0ZS9hc3luYycgOiAnL2V4ZWN1dGUvc3luYycpLFxuICB9LFxuICB7XG4gICAgY29tbWFuZE5hbWVzOiBbJ2dldEVsZW1lbnRTY3JlZW5zaG90J10sXG4gICAganNvbndwQ29udmVydGVyOiAodXJsKSA9PiB1cmwucmVwbGFjZSgvXFwvZWxlbWVudFxcLyhbXi9dKylcXC9zY3JlZW5zaG90JC8sXG4gICAgICAnL3NjcmVlbnNob3QvJDEnKSxcbiAgICB3M2NDb252ZXJ0ZXI6ICh1cmwpID0+IHVybC5yZXBsYWNlKC9cXC9zY3JlZW5zaG90XFwvKFteL10rKS8sXG4gICAgICAnL2VsZW1lbnQvJDEvc2NyZWVuc2hvdCcpLFxuICB9LFxuICB7XG4gICAgY29tbWFuZE5hbWVzOiBbJ2dldFdpbmRvd0hhbmRsZXMnLCAnZ2V0V2luZG93SGFuZGxlJ10sXG4gICAganNvbndwQ29udmVydGVyOiAodXJsKSA9PiB7XG4gICAgICByZXR1cm4gL1xcL3dpbmRvdyQvLnRlc3QodXJsKVxuICAgICAgICA/IHVybC5yZXBsYWNlKC9cXC93aW5kb3ckLywgJy93aW5kb3dfaGFuZGxlJylcbiAgICAgICAgOiB1cmwucmVwbGFjZSgvXFwvd2luZG93XFwvaGFuZGxlKHM/KSQvLCAnL3dpbmRvd19oYW5kbGUkMScpO1xuICAgIH0sXG4gICAgdzNjQ29udmVydGVyOiAodXJsKSA9PiB7XG4gICAgICByZXR1cm4gL1xcL3dpbmRvd19oYW5kbGUkLy50ZXN0KHVybClcbiAgICAgICAgPyB1cmwucmVwbGFjZSgvXFwvd2luZG93X2hhbmRsZSQvLCAnL3dpbmRvdycpXG4gICAgICAgIDogdXJsLnJlcGxhY2UoL1xcL3dpbmRvd19oYW5kbGVzJC8sICcvd2luZG93L2hhbmRsZXMnKTtcbiAgICB9LFxuICB9LFxuXTtcblxuY29uc3Qge01KU09OV1AsIFczQ30gPSBCYXNlRHJpdmVyLkRSSVZFUl9QUk9UT0NPTDtcblxuXG5jbGFzcyBQcm90b2NvbENvbnZlcnRlciB7XG4gIGNvbnN0cnVjdG9yIChwcm94eUZ1bmMpIHtcbiAgICB0aGlzLnByb3h5RnVuYyA9IHByb3h5RnVuYztcbiAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSBudWxsO1xuICB9XG5cbiAgc2V0IGRvd25zdHJlYW1Qcm90b2NvbCAodmFsdWUpIHtcbiAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSB2YWx1ZTtcbiAgfVxuXG4gIGdldCBkb3duc3RyZWFtUHJvdG9jb2wgKCkge1xuICAgIHJldHVybiB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2w7XG4gIH1cblxuICAvKipcbiAgICogVzNDIC90aW1lb3V0cyBjYW4gdGFrZSBhcyBtYW55IGFzIDMgdGltZW91dCB0eXBlcyBhdCBvbmNlLCBNSlNPTldQIC90aW1lb3V0cyBvbmx5IHRha2VzIG9uZVxuICAgKiBhdCBhIHRpbWUuIFNvIGlmIHdlJ3JlIHVzaW5nIFczQyBhbmQgcHJveHlpbmcgdG8gTUpTT05XUCBhbmQgdGhlcmUncyBtb3JlIHRoYW4gb25lIHRpbWVvdXQgdHlwZVxuICAgKiBwcm92aWRlZCBpbiB0aGUgcmVxdWVzdCwgd2UgbmVlZCB0byBkbyAzIHByb3hpZXMgYW5kIGNvbWJpbmUgdGhlIHJlc3VsdFxuICAgKlxuICAgKiBAcGFyYW0ge09iamVjdH0gYm9keSBSZXF1ZXN0IGJvZHlcbiAgICogQHJldHVybiB7QXJyYXl9IEFycmF5IG9mIFczQyArIE1KU09OV1AgY29tcGF0aWJsZSB0aW1lb3V0IG9iamVjdHNcbiAgICovXG4gIGdldFRpbWVvdXRSZXF1ZXN0T2JqZWN0cyAoYm9keSkge1xuICAgIGlmICh0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gVzNDICYmIF8uaGFzKGJvZHksICdtcycpICYmIF8uaGFzKGJvZHksICd0eXBlJykpIHtcbiAgICAgIGNvbnN0IHR5cGVUb1czQyA9ICh4KSA9PiB4ID09PSAncGFnZSBsb2FkJyA/ICdwYWdlTG9hZCcgOiB4O1xuICAgICAgcmV0dXJuIFt7XG4gICAgICAgIFt0eXBlVG9XM0MoYm9keS50eXBlKV06IGJvZHkubXMsXG4gICAgICB9XTtcbiAgICB9XG5cbiAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IE1KU09OV1AgJiYgKCFfLmhhcyhib2R5LCAnbXMnKSB8fCAhXy5oYXMoYm9keSwgJ3R5cGUnKSkpIHtcbiAgICAgIGNvbnN0IHR5cGVUb0pTT05XUCA9ICh4KSA9PiB4ID09PSAncGFnZUxvYWQnID8gJ3BhZ2UgbG9hZCcgOiB4O1xuICAgICAgcmV0dXJuIF8udG9QYWlycyhib2R5KVxuICAgICAgICAvLyBPbmx5IHRyYW5zZm9ybSB0aGUgZW50cnkgaWYgbXMgdmFsdWUgaXMgYSB2YWxpZCBwb3NpdGl2ZSBmbG9hdCBudW1iZXJcbiAgICAgICAgLmZpbHRlcigocGFpcikgPT4gL15cXGQrKD86Wy4sXVxcZCo/KT8kLy50ZXN0KGAke3BhaXJbMV19YCkpXG4gICAgICAgIC5tYXAoKHBhaXIpID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgdHlwZTogdHlwZVRvSlNPTldQKHBhaXJbMF0pLFxuICAgICAgICAgICAgbXM6IHBhaXJbMV0sXG4gICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFtib2R5XTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQcm94eSBhbiBhcnJheSBvZiB0aW1lb3V0IG9iamVjdHMgYW5kIG1lcmdlIHRoZSByZXN1bHRcbiAgICogQHBhcmFtIHtTdHJpbmd9IHVybCBFbmRwb2ludCB1cmxcbiAgICogQHBhcmFtIHtTdHJpbmd9IG1ldGhvZCBFbmRwb2ludCBtZXRob2RcbiAgICogQHBhcmFtIHtPYmplY3R9IGJvZHkgUmVxdWVzdCBib2R5XG4gICAqL1xuICBhc3luYyBwcm94eVNldFRpbWVvdXRzICh1cmwsIG1ldGhvZCwgYm9keSkge1xuICAgIGxldCByZXNwb25zZSwgcmVzQm9keTtcblxuICAgIGNvbnN0IHRpbWVvdXRSZXF1ZXN0T2JqZWN0cyA9IHRoaXMuZ2V0VGltZW91dFJlcXVlc3RPYmplY3RzKGJvZHkpO1xuICAgIGxvZy5kZWJ1ZyhgV2lsbCBzZW5kIHRoZSBmb2xsb3dpbmcgcmVxdWVzdCBib2RpZXMgdG8gL3RpbWVvdXRzOiAke0pTT04uc3RyaW5naWZ5KHRpbWVvdXRSZXF1ZXN0T2JqZWN0cyl9YCk7XG4gICAgZm9yIChjb25zdCB0aW1lb3V0T2JqIG9mIHRpbWVvdXRSZXF1ZXN0T2JqZWN0cykge1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5XSA9IGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCB0aW1lb3V0T2JqKTtcblxuICAgICAgLy8gSWYgd2UgZ290IGEgbm9uLU1KU09OV1AgcmVzcG9uc2UsIHJldHVybiB0aGUgcmVzdWx0LCBub3RoaW5nIGxlZnQgdG8gZG9cbiAgICAgIGlmICh0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCAhPT0gTUpTT05XUCkge1xuICAgICAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgICAgIH1cblxuICAgICAgLy8gSWYgd2UgZ290IGFuIGVycm9yLCByZXR1cm4gdGhlIGVycm9yIHJpZ2h0IGF3YXlcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID49IDQwMCkge1xuICAgICAgICByZXR1cm4gW3Jlc3BvbnNlLCByZXNCb2R5XTtcbiAgICAgIH1cblxuICAgICAgLy8gLi4uT3RoZXJ3aXNlLCBjb250aW51ZSB0byB0aGUgbmV4dCB0aW1lb3V0cyBjYWxsXG4gICAgfVxuICAgIHJldHVybiBbcmVzcG9uc2UsIHJlc0JvZHldO1xuICB9XG5cbiAgYXN5bmMgcHJveHlTZXRXaW5kb3cgKHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgY29uc3QgYm9keU9iaiA9IHV0aWwuc2FmZUpzb25QYXJzZShib2R5KTtcbiAgICBpZiAoXy5pc1BsYWluT2JqZWN0KGJvZHlPYmopKSB7XG4gICAgICBpZiAodGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPT09IFczQyAmJiBfLmhhcyhib2R5T2JqLCAnbmFtZScpICYmICFfLmhhcyhib2R5T2JqLCAnaGFuZGxlJykpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBSZWFzc2lnbmVkICduYW1lJyB2YWx1ZSAnJHtib2R5T2JqLm5hbWV9JyB0byAnaGFuZGxlJyBhcyBwZXIgVzNDIHNwZWNgKTtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCB7aGFuZGxlOiBib2R5T2JqLm5hbWV9KTtcbiAgICAgIH1cbiAgICAgIGlmICh0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUCAmJiBfLmhhcyhib2R5T2JqLCAnaGFuZGxlJykgJiYgIV8uaGFzKGJvZHlPYmosICduYW1lJykpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBSZWFzc2lnbmVkICdoYW5kbGUnIHZhbHVlICcke2JvZHlPYmouaGFuZGxlfScgdG8gJ25hbWUnIGFzIHBlciBKU09OV1Agc3BlY2ApO1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIHtuYW1lOiBib2R5T2JqLmhhbmRsZX0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5RnVuYyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gIH1cblxuICAvKipcbiAgICogSGFuZGxlIFwiY3Jvc3NpbmdcIiBlbmRwb2ludHMgZm9yIHRoZSBjYXNlXG4gICAqIHdoZW4gdXBzdHJlYW0gYW5kIGRvd25zdHJlYW0gZHJpdmVycyBvcGVyYXRlIGRpZmZlcmVudCBwcm90b2NvbHNcbiAgICpcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNvbW1hbmROYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cmxcbiAgICogQHBhcmFtIHtzdHJpbmd9IG1ldGhvZFxuICAgKiBAcGFyYW0gez9zdHJpbmd8b2JqZWN0fSBib2R5XG4gICAqIEByZXR1cm5zIFRoZSBwcm94eWZ5aW5nIHJlc3VsdCBhcyBbcmVzcG9uc2UsIHJlc3BvbnNlQm9keV0gdHVwbGVcbiAgICovXG4gIGFzeW5jIGNvbnZlcnRBbmRQcm94eSAoY29tbWFuZE5hbWUsIHVybCwgbWV0aG9kLCBib2R5KSB7XG4gICAgaWYgKCF0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCkge1xuICAgICAgLy8gVGhlcmUgaXMgbm8gcG9pbnQgdG8gY29udmVydCBhbnl0aGluZyBpZiB3ZSBkbyBub3Qga25vd1xuICAgICAgLy8gZm9yIHdoaWNoIHByb3RvY29sIHRoZSBjb252ZXJzaW9uIHNob3VsZCBiZSBkb25lXG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUZ1bmModXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH1cblxuICAgIC8vIFNhbWUgdXJsLCBidXQgZGlmZmVyZW50IGFyZ3VtZW50c1xuICAgIHN3aXRjaCAoY29tbWFuZE5hbWUpIHtcbiAgICAgIGNhc2UgJ3RpbWVvdXRzJzpcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlTZXRUaW1lb3V0cyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBjYXNlICdzZXRXaW5kb3cnOlxuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eVNldFdpbmRvdyh1cmwsIG1ldGhvZCwgYm9keSk7XG4gICAgICBkZWZhdWx0OlxuICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvLyBTYW1lIGFyZ3VtZW50cywgYnV0IGRpZmZlcmVudCBVUkxzXG4gICAgZm9yIChjb25zdCB7Y29tbWFuZE5hbWVzLCBqc29ud3BDb252ZXJ0ZXIsIHczY0NvbnZlcnRlcn0gb2YgQ09NTUFORF9VUkxTX0NPTkZMSUNUUykge1xuICAgICAgaWYgKCFjb21tYW5kTmFtZXMuaW5jbHVkZXMoY29tbWFuZE5hbWUpKSB7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCByZXdyaXR0ZW5VcmwgPSB0aGlzLmRvd25zdHJlYW1Qcm90b2NvbCA9PT0gTUpTT05XUFxuICAgICAgICA/IGpzb253cENvbnZlcnRlcih1cmwpXG4gICAgICAgIDogdzNjQ29udmVydGVyKHVybCk7XG4gICAgICBpZiAocmV3cml0dGVuVXJsID09PSB1cmwpIHtcbiAgICAgICAgbG9nLmRlYnVnKGBEaWQgbm90IGtub3cgaG93IHRvIHJld3JpdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyBgICtcbiAgICAgICAgICBgZm9yICR7dGhpcy5kb3duc3RyZWFtUHJvdG9jb2x9IHByb3RvY29sYCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oYFJld3JvdGUgdGhlIG9yaWdpbmFsIFVSTCAnJHt1cmx9JyB0byAnJHtyZXdyaXR0ZW5Vcmx9JyBgICtcbiAgICAgICAgYGZvciAke3RoaXMuZG93bnN0cmVhbVByb3RvY29sfSBwcm90b2NvbGApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHJld3JpdHRlblVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG5cbiAgICAvLyBObyBtYXRjaGVzIGZvdW5kLiBQcm9jZWVkIG5vcm1hbGx5XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlGdW5jKHVybCwgbWV0aG9kLCBib2R5KTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBQcm90b2NvbENvbnZlcnRlcjtcbiJdLCJmaWxlIjoibGliL2pzb253cC1wcm94eS9wcm90b2NvbC1jb252ZXJ0ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
