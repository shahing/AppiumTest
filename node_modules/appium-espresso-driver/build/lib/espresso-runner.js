"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.REQUIRED_PARAMS = exports.EspressoRunner = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _package = require("../../package.json");

const TEST_APK_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'app', 'build', 'outputs', 'apk', 'androidTest', 'debug', 'app-debug-androidTest.apk');

const TEST_MANIFEST_PATH = _path.default.resolve(__dirname, '..', '..', 'espresso-server', 'AndroidManifest-test.xml');

const TEST_APK_PKG = 'io.appium.espressoserver.test';
const REQUIRED_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'appPackage', 'forceEspressoRebuild'];
exports.REQUIRED_PARAMS = REQUIRED_PARAMS;
const ESPRESSO_SERVER_LAUNCH_TIMEOUT = 30000;
const TARGET_PACKAGE_CONTAINER = '/data/local/tmp/espresso.apppackage';

class EspressoRunner {
  constructor(opts = {}) {
    for (let req of REQUIRED_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort,
      base: ''
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.modServerPath = _path.default.resolve(this.tmpDir, `${TEST_APK_PKG}_${_package.version}_${this.appPackage}.apk`);
    this.serverLaunchTimeout = opts.serverLaunchTimeout || ESPRESSO_SERVER_LAUNCH_TIMEOUT;
  }

  async isAppPackageChanged() {
    if (!(await this.adb.fileExists(TARGET_PACKAGE_CONTAINER))) {
      _logger.default.debug('The previous target application package is unknown');

      return true;
    }

    const previousAppPackage = (await this.adb.shell(['cat', TARGET_PACKAGE_CONTAINER])).trim();

    _logger.default.debug(`The previous target application package was '${previousAppPackage}'. ` + `The current package is '${this.appPackage}'`);

    return previousAppPackage !== this.appPackage;
  }

  async installServer() {
    const appState = await this.adb.getApplicationInstallState(this.modServerPath, TEST_APK_PKG);
    const shouldUninstallApp = [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
    const shouldInstallApp = shouldUninstallApp || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);

    if (shouldUninstallApp) {
      _logger.default.info(`Uninstalling Espresso Test Server apk from the target device (pkg: '${TEST_APK_PKG}')`);

      try {
        await this.adb.uninstallApk(TEST_APK_PKG);
      } catch (err) {
        _logger.default.warn(`Error uninstalling '${TEST_APK_PKG}': ${err.message}`);
      }
    }

    if (shouldInstallApp) {
      _logger.default.info(`Installing Espresso Test Server apk from the target device (path: '${this.modServerPath}')`);

      try {
        await this.adb.install(this.modServerPath, {
          replace: false
        });

        _logger.default.info(`Installed Espresso Test Server apk '${this.modServerPath}' (pkg: '${TEST_APK_PKG}')`);
      } catch (err) {
        _logger.default.errorAndThrow(`Cannot install '${this.modServerPath}' because of '${err.message}'`);
      }
    }
  }

  async installTestApk() {
    let rebuild = this.forceEspressoRebuild;

    if (rebuild) {
      _logger.default.debug(`'forceEspressoRebuild' capability is enabled`);
    } else if (await this.isAppPackageChanged()) {
      _logger.default.info(`Forcing Espresso server rebuild because of changed application package`);

      rebuild = true;
    }

    if (rebuild && (await _appiumSupport.fs.exists(this.modServerPath))) {
      _logger.default.debug(`Deleting the obsolete Espresso server package '${this.modServerPath}'`);

      await _appiumSupport.fs.unlink(this.modServerPath);
    }

    if (!(await _appiumSupport.fs.exists(this.modServerPath))) {
      await this.buildNewModServer();
    }

    const isSigned = await this.adb.checkApkCert(this.modServerPath, TEST_APK_PKG);

    if (!isSigned) {
      await this.adb.sign(this.modServerPath);
    }

    if ((rebuild || !isSigned) && (await this.adb.uninstallApk(TEST_APK_PKG))) {
      _logger.default.info('Uninstalled the obsolete Espresso server package from the device under test');
    }

    await this.installServer();
  }

  async buildNewModServer() {
    _logger.default.info(`Repackaging espresso server for: '${this.appPackage}'`);

    const packageTmpDir = _path.default.resolve(this.tmpDir, this.appPackage);

    const newManifestPath = _path.default.resolve(this.tmpDir, 'AndroidManifest.xml');

    await _appiumSupport.fs.rimraf(newManifestPath);

    _logger.default.info(`Creating new manifest: '${newManifestPath}'`);

    await (0, _appiumSupport.mkdirp)(packageTmpDir);
    await _appiumSupport.fs.copyFile(TEST_MANIFEST_PATH, newManifestPath);
    await this.adb.compileManifest(newManifestPath, TEST_APK_PKG, this.appPackage);
    await this.adb.insertManifest(newManifestPath, TEST_APK_PATH, this.modServerPath);

    _logger.default.info(`Repackaged espresso server ready: '${this.modServerPath}'`);
  }

  async startSession(caps) {
    const cmd = ['shell', 'am', 'instrument', '-w', '-e', 'debug', process.env.ESPRESSO_JAVA_DEBUG === 'true' ? 'true' : 'false', `${TEST_APK_PKG}/androidx.test.runner.AndroidJUnitRunner`];

    _logger.default.info(`Starting Espresso Server v${_package.version} with cmd: adb ${cmd.join(' ')}`);

    let hasSocketError = false;
    this.instProcess = this.adb.createSubProcess(cmd);
    this.instProcess.on('exit', (code, signal) => {
      _logger.default.info(`Instrumentation process exited with code ${code} from signal ${signal}`);
    });
    this.instProcess.on('die', (code, signal) => {
      _logger.default.error(`Instrumentation process died with code ${code} and signal ${signal}`);
    });
    this.instProcess.on('stream-line', line => {
      _logger.default.debug(`[Instrumentation]${line.trim()}`);

      if (line.toLowerCase().includes("java.net.socketexception")) {
        hasSocketError = true;
      }
    });
    await this.instProcess.start((stdout, stderr) => {
      const out = stdout.trim() || stderr.trim();

      if (out.includes('io.appium.espressoserver.EspressoServerRunnerTest:')) {
        return true;
      }

      if (out.toLowerCase().includes('exception')) {
        throw new Error(out);
      }
    }, this.serverLaunchTimeout);

    _logger.default.info('Waiting for Espresso to be online...');

    try {
      await (0, _asyncbox.retryInterval)(20, 1000, async () => {
        await this.jwproxy.command('/status', 'GET');
      });
    } catch (e) {
      if (hasSocketError) {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start due to Socket exception. Espresso Server requires the 'INTERNET' permission to be set in the Android manifest for the app-under-test (<uses-permission android:name="android.permission.INTERNET" />)`);
      } else {
        _logger.default.errorAndThrow(`Timed out waiting for Espresso Server to start. Original error: ${e.message}`);
      }
    }

    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
    await this.recordTargetAppPackage();
  }

  async recordTargetAppPackage() {
    await this.adb.shell([`echo "${this.appPackage}" > "${TARGET_PACKAGE_CONTAINER}"`]);

    _logger.default.info(`Recorded the target application package '${this.appPackage}' to ${TARGET_PACKAGE_CONTAINER}`);
  }

  async deleteSession() {
    _logger.default.debug('Deleting Espresso server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation Espresso deleteSession worked; ` + `Error was: ${err}`);
    }

    if (this.instProcess && this.instProcess.isRunning) {
      await this.instProcess.stop();
    }
  }

}

exports.EspressoRunner = EspressoRunner;
var _default = EspressoRunner;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9lc3ByZXNzby1ydW5uZXIuanMiXSwibmFtZXMiOlsiVEVTVF9BUEtfUEFUSCIsInBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwiVEVTVF9NQU5JRkVTVF9QQVRIIiwiVEVTVF9BUEtfUEtHIiwiUkVRVUlSRURfUEFSQU1TIiwiRVNQUkVTU09fU0VSVkVSX0xBVU5DSF9USU1FT1VUIiwiVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSIiwiRXNwcmVzc29SdW5uZXIiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJyZXEiLCJ1dGlsIiwiaGFzVmFsdWUiLCJFcnJvciIsImp3cHJveHkiLCJKV1Byb3h5Iiwic2VydmVyIiwiaG9zdCIsInBvcnQiLCJzeXN0ZW1Qb3J0IiwiYmFzZSIsInByb3h5UmVxUmVzIiwiYmluZCIsIm1vZFNlcnZlclBhdGgiLCJ0bXBEaXIiLCJ2ZXJzaW9uIiwiYXBwUGFja2FnZSIsInNlcnZlckxhdW5jaFRpbWVvdXQiLCJpc0FwcFBhY2thZ2VDaGFuZ2VkIiwiYWRiIiwiZmlsZUV4aXN0cyIsImxvZ2dlciIsImRlYnVnIiwicHJldmlvdXNBcHBQYWNrYWdlIiwic2hlbGwiLCJ0cmltIiwiaW5zdGFsbFNlcnZlciIsImFwcFN0YXRlIiwiZ2V0QXBwbGljYXRpb25JbnN0YWxsU3RhdGUiLCJzaG91bGRVbmluc3RhbGxBcHAiLCJBUFBfSU5TVEFMTF9TVEFURSIsIk9MREVSX1ZFUlNJT05fSU5TVEFMTEVEIiwiTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJpbmNsdWRlcyIsInNob3VsZEluc3RhbGxBcHAiLCJOT1RfSU5TVEFMTEVEIiwiaW5mbyIsInVuaW5zdGFsbEFwayIsImVyciIsIndhcm4iLCJtZXNzYWdlIiwiaW5zdGFsbCIsInJlcGxhY2UiLCJlcnJvckFuZFRocm93IiwiaW5zdGFsbFRlc3RBcGsiLCJyZWJ1aWxkIiwiZm9yY2VFc3ByZXNzb1JlYnVpbGQiLCJmcyIsImV4aXN0cyIsInVubGluayIsImJ1aWxkTmV3TW9kU2VydmVyIiwiaXNTaWduZWQiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwicGFja2FnZVRtcERpciIsIm5ld01hbmlmZXN0UGF0aCIsInJpbXJhZiIsImNvcHlGaWxlIiwiY29tcGlsZU1hbmlmZXN0IiwiaW5zZXJ0TWFuaWZlc3QiLCJzdGFydFNlc3Npb24iLCJjYXBzIiwiY21kIiwicHJvY2VzcyIsImVudiIsIkVTUFJFU1NPX0pBVkFfREVCVUciLCJqb2luIiwiaGFzU29ja2V0RXJyb3IiLCJpbnN0UHJvY2VzcyIsImNyZWF0ZVN1YlByb2Nlc3MiLCJvbiIsImNvZGUiLCJzaWduYWwiLCJlcnJvciIsImxpbmUiLCJ0b0xvd2VyQ2FzZSIsInN0YXJ0Iiwic3Rkb3V0Iiwic3RkZXJyIiwib3V0IiwiY29tbWFuZCIsImUiLCJkZXNpcmVkQ2FwYWJpbGl0aWVzIiwicmVjb3JkVGFyZ2V0QXBwUGFja2FnZSIsImRlbGV0ZVNlc3Npb24iLCJpc1J1bm5pbmciLCJzdG9wIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGFBQWEsR0FBR0MsY0FBS0MsT0FBTCxDQUFhQyxTQUFiLEVBQXdCLElBQXhCLEVBQThCLElBQTlCLEVBQW9DLGlCQUFwQyxFQUF1RCxLQUF2RCxFQUE4RCxPQUE5RCxFQUF1RSxTQUF2RSxFQUFrRixLQUFsRixFQUF5RixhQUF6RixFQUF3RyxPQUF4RyxFQUFpSCwyQkFBakgsQ0FBdEI7O0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUdILGNBQUtDLE9BQUwsQ0FBYUMsU0FBYixFQUF3QixJQUF4QixFQUE4QixJQUE5QixFQUFvQyxpQkFBcEMsRUFBdUQsMEJBQXZELENBQTNCOztBQUNBLE1BQU1FLFlBQVksR0FBRywrQkFBckI7QUFDQSxNQUFNQyxlQUFlLEdBQUcsQ0FBQyxLQUFELEVBQVEsUUFBUixFQUFrQixNQUFsQixFQUEwQixZQUExQixFQUF3QyxZQUF4QyxFQUFzRCxZQUF0RCxFQUFvRSxzQkFBcEUsQ0FBeEI7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QVcsUUFBT3BCLHdCQUF5QixHQUExRCxDQUFmLENBQU47O0FBQ0F5QixvQkFBT2UsSUFBUCxDQUFhLDRDQUEyQyxLQUFLcEIsVUFBVyxRQUFPcEIsd0JBQXlCLEVBQXhHO0FBQ0Q7O0FBRUQsUUFBTXdGLGFBQU4sR0FBdUI7QUFDckIvRCxvQkFBT0MsS0FBUCxDQUFhLGtDQUFiOztBQUdBLFFBQUk7QUFDRixZQUFNLEtBQUtsQixPQUFMLENBQWE0RSxPQUFiLENBQXFCLEdBQXJCLEVBQTBCLFFBQTFCLENBQU47QUFDRCxLQUZELENBRUUsT0FBTzFDLEdBQVAsRUFBWTtBQUNaakIsc0JBQU9rQixJQUFQLENBQWEsMERBQUQsR0FDUCxjQUFhRCxHQUFJLEVBRHRCO0FBRUQ7O0FBRUQsUUFBSSxLQUFLOEIsV0FBTCxJQUFvQixLQUFLQSxXQUFMLENBQWlCaUIsU0FBekMsRUFBb0Q7QUFDbEQsWUFBTSxLQUFLakIsV0FBTCxDQUFpQmtCLElBQWpCLEVBQU47QUFDRDtBQUNGOztBQTNMa0I7OztlQStMTnpGLGMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBKV1Byb3h5IH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHJldHJ5SW50ZXJ2YWwgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHV0aWwsIG1rZGlycCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IHZlcnNpb24gfSBmcm9tICcuLi8uLi9wYWNrYWdlLmpzb24nOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIGltcG9ydC9uby11bnJlc29sdmVkXG5cblxuY29uc3QgVEVTVF9BUEtfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnYXBwJywgJ2J1aWxkJywgJ291dHB1dHMnLCAnYXBrJywgJ2FuZHJvaWRUZXN0JywgJ2RlYnVnJywgJ2FwcC1kZWJ1Zy1hbmRyb2lkVGVzdC5hcGsnKTtcbmNvbnN0IFRFU1RfTUFOSUZFU1RfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICdlc3ByZXNzby1zZXJ2ZXInLCAnQW5kcm9pZE1hbmlmZXN0LXRlc3QueG1sJyk7XG5jb25zdCBURVNUX0FQS19QS0cgPSAnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLnRlc3QnO1xuY29uc3QgUkVRVUlSRURfUEFSQU1TID0gWydhZGInLCAndG1wRGlyJywgJ2hvc3QnLCAnc3lzdGVtUG9ydCcsICdkZXZpY2VQb3J0JywgJ2FwcFBhY2thZ2UnLCAnZm9yY2VFc3ByZXNzb1JlYnVpbGQnXTtcbmNvbnN0IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVCA9IDMwMDAwO1xuY29uc3QgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSID0gJy9kYXRhL2xvY2FsL3RtcC9lc3ByZXNzby5hcHBwYWNrYWdlJztcblxuY2xhc3MgRXNwcmVzc29SdW5uZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUVVJUkVEX1BBUkFNUykge1xuICAgICAgaWYgKCFvcHRzIHx8ICF1dGlsLmhhc1ZhbHVlKG9wdHNbcmVxXSkpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBPcHRpb24gJyR7cmVxfScgaXMgcmVxdWlyZWQhYCk7XG4gICAgICB9XG4gICAgICB0aGlzW3JlcV0gPSBvcHRzW3JlcV07XG4gICAgfVxuICAgIHRoaXMuandwcm94eSA9IG5ldyBKV1Byb3h5KHtzZXJ2ZXI6IHRoaXMuaG9zdCwgcG9ydDogdGhpcy5zeXN0ZW1Qb3J0LCBiYXNlOiAnJ30pO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5tb2RTZXJ2ZXJQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMudG1wRGlyLCBgJHtURVNUX0FQS19QS0d9XyR7dmVyc2lvbn1fJHt0aGlzLmFwcFBhY2thZ2V9LmFwa2ApO1xuXG4gICAgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0ID0gb3B0cy5zZXJ2ZXJMYXVuY2hUaW1lb3V0IHx8IEVTUFJFU1NPX1NFUlZFUl9MQVVOQ0hfVElNRU9VVDtcbiAgfVxuXG4gIGFzeW5jIGlzQXBwUGFja2FnZUNoYW5nZWQgKCkge1xuICAgIGlmICghYXdhaXQgdGhpcy5hZGIuZmlsZUV4aXN0cyhUQVJHRVRfUEFDS0FHRV9DT05UQUlORVIpKSB7XG4gICAgICBsb2dnZXIuZGVidWcoJ1RoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSBpcyB1bmtub3duJyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgY29uc3QgcHJldmlvdXNBcHBQYWNrYWdlID0gKGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsnY2F0JywgVEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSXSkpLnRyaW0oKTtcbiAgICBsb2dnZXIuZGVidWcoYFRoZSBwcmV2aW91cyB0YXJnZXQgYXBwbGljYXRpb24gcGFja2FnZSB3YXMgJyR7cHJldmlvdXNBcHBQYWNrYWdlfScuIGAgK1xuICAgICAgYFRoZSBjdXJyZW50IHBhY2thZ2UgaXMgJyR7dGhpcy5hcHBQYWNrYWdlfSdgKTtcbiAgICByZXR1cm4gcHJldmlvdXNBcHBQYWNrYWdlICE9PSB0aGlzLmFwcFBhY2thZ2U7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbHMgRXNwcmVzc28gc2VydmVyIGFwayBvbiB0byB0aGUgZGV2aWNlIG9yIGVtdWxhdG9yLlxuICAgKiBFYWNoIGFkYiBjb21tYW5kIHVzZXMgZGVmYXVsdCB0aW1lb3V0IGJ5IHRoZW0uXG4gICAqL1xuICBhc3luYyBpbnN0YWxsU2VydmVyICgpIHtcbiAgICBjb25zdCBhcHBTdGF0ZSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlKHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcblxuICAgIGNvbnN0IHNob3VsZFVuaW5zdGFsbEFwcCA9IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk9MREVSX1ZFUlNJT05fSU5TVEFMTEVELFxuICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTkVXRVJfVkVSU0lPTl9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcbiAgICBjb25zdCBzaG91bGRJbnN0YWxsQXBwID0gc2hvdWxkVW5pbnN0YWxsQXBwIHx8IFtcbiAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5PVF9JTlNUQUxMRURcbiAgICBdLmluY2x1ZGVzKGFwcFN0YXRlKTtcblxuICAgIGlmIChzaG91bGRVbmluc3RhbGxBcHApIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBVbmluc3RhbGxpbmcgRXNwcmVzc28gVGVzdCBTZXJ2ZXIgYXBrIGZyb20gdGhlIHRhcmdldCBkZXZpY2UgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi51bmluc3RhbGxBcGsoVEVTVF9BUEtfUEtHKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2dnZXIud2FybihgRXJyb3IgdW5pbnN0YWxsaW5nICcke1RFU1RfQVBLX1BLR30nOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChzaG91bGRJbnN0YWxsQXBwKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdGFsbGluZyBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgZnJvbSB0aGUgdGFyZ2V0IGRldmljZSAocGF0aDogJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScpYCk7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKHRoaXMubW9kU2VydmVyUGF0aCwgeyByZXBsYWNlOiBmYWxzZSB9KTtcbiAgICAgICAgbG9nZ2VyLmluZm8oYEluc3RhbGxlZCBFc3ByZXNzbyBUZXN0IFNlcnZlciBhcGsgJyR7dGhpcy5tb2RTZXJ2ZXJQYXRofScgKHBrZzogJyR7VEVTVF9BUEtfUEtHfScpYCk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYENhbm5vdCBpbnN0YWxsICcke3RoaXMubW9kU2VydmVyUGF0aH0nIGJlY2F1c2Ugb2YgJyR7ZXJyLm1lc3NhZ2V9J2ApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxUZXN0QXBrICgpIHtcbiAgICBsZXQgcmVidWlsZCA9IHRoaXMuZm9yY2VFc3ByZXNzb1JlYnVpbGQ7XG4gICAgaWYgKHJlYnVpbGQpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgJ2ZvcmNlRXNwcmVzc29SZWJ1aWxkJyBjYXBhYmlsaXR5IGlzIGVuYWJsZWRgKTtcbiAgICB9IGVsc2UgaWYgKGF3YWl0IHRoaXMuaXNBcHBQYWNrYWdlQ2hhbmdlZCgpKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgRm9yY2luZyBFc3ByZXNzbyBzZXJ2ZXIgcmVidWlsZCBiZWNhdXNlIG9mIGNoYW5nZWQgYXBwbGljYXRpb24gcGFja2FnZWApO1xuICAgICAgcmVidWlsZCA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHJlYnVpbGQgJiYgYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpIHtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgRGVsZXRpbmcgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlICcke3RoaXMubW9kU2VydmVyUGF0aH0nYCk7XG4gICAgICBhd2FpdCBmcy51bmxpbmsodGhpcy5tb2RTZXJ2ZXJQYXRoKTtcbiAgICB9XG4gICAgaWYgKCEoYXdhaXQgZnMuZXhpc3RzKHRoaXMubW9kU2VydmVyUGF0aCkpKSB7XG4gICAgICBhd2FpdCB0aGlzLmJ1aWxkTmV3TW9kU2VydmVyKCk7XG4gICAgfVxuICAgIGNvbnN0IGlzU2lnbmVkID0gYXdhaXQgdGhpcy5hZGIuY2hlY2tBcGtDZXJ0KHRoaXMubW9kU2VydmVyUGF0aCwgVEVTVF9BUEtfUEtHKTtcbiAgICBpZiAoIWlzU2lnbmVkKSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKHRoaXMubW9kU2VydmVyUGF0aCk7XG4gICAgfVxuICAgIGlmICgocmVidWlsZCB8fCAhaXNTaWduZWQpICYmIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhURVNUX0FQS19QS0cpKSB7XG4gICAgICBsb2dnZXIuaW5mbygnVW5pbnN0YWxsZWQgdGhlIG9ic29sZXRlIEVzcHJlc3NvIHNlcnZlciBwYWNrYWdlIGZyb20gdGhlIGRldmljZSB1bmRlciB0ZXN0Jyk7XG4gICAgfVxuXG4gICAgYXdhaXQgdGhpcy5pbnN0YWxsU2VydmVyKCk7XG4gIH1cblxuICBhc3luYyBidWlsZE5ld01vZFNlcnZlciAoKSB7XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnaW5nIGVzcHJlc3NvIHNlcnZlciBmb3I6ICcke3RoaXMuYXBwUGFja2FnZX0nYCk7XG4gICAgY29uc3QgcGFja2FnZVRtcERpciA9IHBhdGgucmVzb2x2ZSh0aGlzLnRtcERpciwgdGhpcy5hcHBQYWNrYWdlKTtcbiAgICBjb25zdCBuZXdNYW5pZmVzdFBhdGggPSBwYXRoLnJlc29sdmUodGhpcy50bXBEaXIsICdBbmRyb2lkTWFuaWZlc3QueG1sJyk7XG4gICAgYXdhaXQgZnMucmltcmFmKG5ld01hbmlmZXN0UGF0aCk7XG5cbiAgICBsb2dnZXIuaW5mbyhgQ3JlYXRpbmcgbmV3IG1hbmlmZXN0OiAnJHtuZXdNYW5pZmVzdFBhdGh9J2ApO1xuICAgIGF3YWl0IG1rZGlycChwYWNrYWdlVG1wRGlyKTtcbiAgICBhd2FpdCBmcy5jb3B5RmlsZShURVNUX01BTklGRVNUX1BBVEgsIG5ld01hbmlmZXN0UGF0aCk7XG4gICAgYXdhaXQgdGhpcy5hZGIuY29tcGlsZU1hbmlmZXN0KG5ld01hbmlmZXN0UGF0aCwgVEVTVF9BUEtfUEtHLCB0aGlzLmFwcFBhY2thZ2UpOyAvLyBjcmVhdGVzIGEgZmlsZSBgJHtuZXdNYW5pZmVzdFBhdGh9LmFwa2BcbiAgICBhd2FpdCB0aGlzLmFkYi5pbnNlcnRNYW5pZmVzdChuZXdNYW5pZmVzdFBhdGgsIFRFU1RfQVBLX1BBVEgsIHRoaXMubW9kU2VydmVyUGF0aCk7IC8vIGNvcGllcyBmcm9tIHNlY29uZCB0byB0aGlyZCBhbmQgYWRkIG1hbmlmZXN0XG4gICAgbG9nZ2VyLmluZm8oYFJlcGFja2FnZWQgZXNwcmVzc28gc2VydmVyIHJlYWR5OiAnJHt0aGlzLm1vZFNlcnZlclBhdGh9J2ApO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uIChjYXBzKSB7XG4gICAgY29uc3QgY21kID0gW1xuICAgICAgJ3NoZWxsJyxcbiAgICAgICdhbScsICdpbnN0cnVtZW50JyxcbiAgICAgICctdycsXG4gICAgICAnLWUnLCAnZGVidWcnLCBwcm9jZXNzLmVudi5FU1BSRVNTT19KQVZBX0RFQlVHID09PSAndHJ1ZScgPyAndHJ1ZScgOiAnZmFsc2UnLFxuICAgICAgYCR7VEVTVF9BUEtfUEtHfS9hbmRyb2lkeC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXJgLFxuICAgIF07XG5cbiAgICBsb2dnZXIuaW5mbyhgU3RhcnRpbmcgRXNwcmVzc28gU2VydmVyIHYke3ZlcnNpb259IHdpdGggY21kOiBhZGIgJHtjbWQuam9pbignICcpfWApO1xuXG4gICAgbGV0IGhhc1NvY2tldEVycm9yID0gZmFsc2U7XG5cbiAgICAvLyBzdGFydCB0aGUgaW5zdHJ1bWVudGF0aW9uIHByb2Nlc3NcbiAgICB0aGlzLmluc3RQcm9jZXNzID0gdGhpcy5hZGIuY3JlYXRlU3ViUHJvY2VzcyhjbWQpO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgICBsb2dnZXIuaW5mbyhgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZXhpdGVkIHdpdGggY29kZSAke2NvZGV9IGZyb20gc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ2RpZScsIChjb2RlLCBzaWduYWwpID0+IHtcbiAgICAgIGxvZ2dlci5lcnJvcihgSW5zdHJ1bWVudGF0aW9uIHByb2Nlc3MgZGllZCB3aXRoIGNvZGUgJHtjb2RlfSBhbmQgc2lnbmFsICR7c2lnbmFsfWApO1xuICAgIH0pO1xuICAgIHRoaXMuaW5zdFByb2Nlc3Mub24oJ3N0cmVhbS1saW5lJywgbGluZSA9PiB7XG4gICAgICBsb2dnZXIuZGVidWcoYFtJbnN0cnVtZW50YXRpb25dJHtsaW5lLnRyaW0oKX1gKTtcblxuICAgICAgLy8gQSAnU29ja2V0RXhjZXB0aW9uJyBpbmRpY2F0ZXMgdGhhdCB3ZSBjb3VsZG4ndCBjb25uZWN0IHRvIHRoZSBFc3ByZXNzbyBTZXJ2ZXIsIGJlY2F1c2UgdGhlIElOVEVSTkVUIHBlcm1pc3Npb24gaXMgbm90IHNldFxuICAgICAgaWYgKGxpbmUudG9Mb3dlckNhc2UoKS5pbmNsdWRlcyhcImphdmEubmV0LnNvY2tldGV4Y2VwdGlvblwiKSkge1xuICAgICAgICBoYXNTb2NrZXRFcnJvciA9IHRydWU7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBhd2FpdCB0aGlzLmluc3RQcm9jZXNzLnN0YXJ0KChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgICAgLy8gZm9yIGFueSBjYWxsIHRvIHRoZSBzdGFydCBkZXRlY3Rvciwgb25lIG9mIHN0ZG91dCBvciBzdGRlcnIgd2lsbCBoYXZlXG4gICAgICAvLyBjb250ZW50LCBzbyBtZXJnZSBmb3IgY2hlY2tzIGhlcmVcbiAgICAgIGNvbnN0IG91dCA9IHN0ZG91dC50cmltKCkgfHwgc3RkZXJyLnRyaW0oKTtcblxuICAgICAgLy8gYWRiIGFsd2F5cyBwcmludHMgdGhpcyBvdXQgb24gc3VjY2Vzcy4gSWYgdGhpcyBpcyBmb3VuZCBub3QgdG8gYmUgdGhlXG4gICAgICAvLyBjYXNlLCBhZGQgb3RoZXIgY29uZGl0aW9uc1xuICAgICAgaWYgKG91dC5pbmNsdWRlcygnaW8uYXBwaXVtLmVzcHJlc3Nvc2VydmVyLkVzcHJlc3NvU2VydmVyUnVubmVyVGVzdDonKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdXQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnZXhjZXB0aW9uJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKG91dCk7XG4gICAgICB9XG4gICAgfSwgdGhpcy5zZXJ2ZXJMYXVuY2hUaW1lb3V0KTtcblxuICAgIGxvZ2dlci5pbmZvKCdXYWl0aW5nIGZvciBFc3ByZXNzbyB0byBiZSBvbmxpbmUuLi4nKTtcblxuICAgIC8vIHdhaXQgMjBzIGZvciBlc3ByZXNzbyB0byBiZSBvbmxpbmVcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcmV0cnlJbnRlcnZhbCgyMCwgMTAwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnL3N0YXR1cycsICdHRVQnKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGlmIChoYXNTb2NrZXRFcnJvcikge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydCBkdWUgdG8gU29ja2V0IGV4Y2VwdGlvbi4gRXNwcmVzc28gU2VydmVyIHJlcXVpcmVzIHRoZSAnSU5URVJORVQnIHBlcm1pc3Npb24gdG8gYmUgc2V0IGluIHRoZSBBbmRyb2lkIG1hbmlmZXN0IGZvciB0aGUgYXBwLXVuZGVyLXRlc3QgKDx1c2VzLXBlcm1pc3Npb24gYW5kcm9pZDpuYW1lPVwiYW5kcm9pZC5wZXJtaXNzaW9uLklOVEVSTkVUXCIgLz4pYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBsb2dnZXIuZXJyb3JBbmRUaHJvdyhgVGltZWQgb3V0IHdhaXRpbmcgZm9yIEVzcHJlc3NvIFNlcnZlciB0byBzdGFydC4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvc2Vzc2lvbicsICdQT1NUJywge2Rlc2lyZWRDYXBhYmlsaXRpZXM6IGNhcHN9KTtcblxuICAgIGF3YWl0IHRoaXMucmVjb3JkVGFyZ2V0QXBwUGFja2FnZSgpO1xuICB9XG5cbiAgYXN5bmMgcmVjb3JkVGFyZ2V0QXBwUGFja2FnZSAoKSB7XG4gICAgYXdhaXQgdGhpcy5hZGIuc2hlbGwoW2BlY2hvIFwiJHt0aGlzLmFwcFBhY2thZ2V9XCIgPiBcIiR7VEFSR0VUX1BBQ0tBR0VfQ09OVEFJTkVSfVwiYF0pO1xuICAgIGxvZ2dlci5pbmZvKGBSZWNvcmRlZCB0aGUgdGFyZ2V0IGFwcGxpY2F0aW9uIHBhY2thZ2UgJyR7dGhpcy5hcHBQYWNrYWdlfScgdG8gJHtUQVJHRVRfUEFDS0FHRV9DT05UQUlORVJ9YCk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIEVzcHJlc3NvIHNlcnZlciBzZXNzaW9uJyk7XG4gICAgLy8gcmVseSBvbiBqd3Byb3h5J3MgaW50ZWxsaWdlbmNlIHRvIGtub3cgd2hhdCB3ZSdyZSB0YWxraW5nIGFib3V0IGFuZFxuICAgIC8vIGRlbGV0ZSB0aGUgY3VycmVudCBzZXNzaW9uXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHRoaXMuandwcm94eS5jb21tYW5kKCcvJywgJ0RFTEVURScpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLndhcm4oYERpZCBub3QgZ2V0IGNvbmZpcm1hdGlvbiBFc3ByZXNzbyBkZWxldGVTZXNzaW9uIHdvcmtlZDsgYCArXG4gICAgICAgICAgYEVycm9yIHdhczogJHtlcnJ9YCk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaW5zdFByb2Nlc3MgJiYgdGhpcy5pbnN0UHJvY2Vzcy5pc1J1bm5pbmcpIHtcbiAgICAgIGF3YWl0IHRoaXMuaW5zdFByb2Nlc3Muc3RvcCgpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgeyBFc3ByZXNzb1J1bm5lciwgUkVRVUlSRURfUEFSQU1TIH07XG5leHBvcnQgZGVmYXVsdCBFc3ByZXNzb1J1bm5lcjtcbiJdLCJmaWxlIjoibGliL2VzcHJlc3NvLXJ1bm5lci5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLiJ9
