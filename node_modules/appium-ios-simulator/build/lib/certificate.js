"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.TrustStore = exports.Certificate = exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _crypto = _interopRequireDefault(require("crypto"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _utils = require("./utils");

const openssl = _bluebird.default.promisify(require('openssl-wrapper').exec);

const tset = `<?xml version="1.0" encoding="UTF-8"?>\n
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <array/>
</plist>`;

class Certificate {
  constructor(pemFilename) {
    this.pemFilename = pemFilename;
  }

  add(dir) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let data = (yield _this.getDerData(_this.pemFilename)).toString('hex');
      let subject = yield _this.getSubject(_this.pemFilename);
      let sha1 = (yield _this.getFingerPrint(_this.data)).toString('hex');
      let trustStore = new TrustStore(dir);
      return yield trustStore.addRecord(sha1, tset, subject, data);
    })();
  }

  has(dir) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let subject = yield _this2.getSubject(_this2.pemFilename);
      let trustStore = new TrustStore(dir);

      if (!(yield trustStore.hasRecords(subject))) {
        return false;
      }

      let previousFingerprint = yield trustStore.getFingerPrintFromRecord(subject);
      let currentFingerprint = yield _this2.getFingerPrint();
      return previousFingerprint.toString() === currentFingerprint.toString();
    })();
  }

  remove(dir) {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let subject = yield _this3.getSubject(_this3.pemFilename);
      let trustStore = new TrustStore(dir);
      return yield trustStore.removeRecord(subject);
    })();
  }

  getDerData() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this4.data) {
        return _this4.data;
      }

      _this4.data = yield openssl('x509', {
        outform: 'der',
        in: _this4.pemFilename
      });
      return _this4.data;
    })();
  }

  getFingerPrint() {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this5.fingerprint) {
        return _this5.fingerprint;
      }

      let data = yield _this5.getDerData();

      let shasum = _crypto.default.createHash('sha1');

      shasum.update(data);
      _this5.fingerprint = shasum.digest();
      return _this5.fingerprint;
    })();
  }

  getSubject() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this6.subject) {
        return _this6.subject;
      }

      let subject = yield openssl('x509', {
        noout: true,
        subject: true,
        in: _this6.pemFilename
      });
      let subRegex = /^subject[\w\W]*\/CN=([\w\W]*)(\n)?/;
      _this6.subject = subject.toString().match(subRegex)[1];
      return _this6.subject;
    })();
  }

}

exports.Certificate = Certificate;

class TrustStore {
  constructor(sharedResourceDir) {
    this.sharedResourceDir = sharedResourceDir;
  }

  getDB() {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (_this7.db) {
        return _this7.db;
      }

      let keychainsPath = _path.default.resolve(_this7.sharedResourceDir, 'Library', 'Keychains');

      if (!(yield _appiumSupport.fs.exists(keychainsPath))) {
        yield (0, _appiumSupport.mkdirp)(keychainsPath);
      }

      _this7.db = _path.default.resolve(keychainsPath, 'TrustStore.sqlite3');
      yield (0, _utils.execSQLiteQuery)(_this7.db, `CREATE TABLE IF NOT EXISTS tsettings (sha1 BLOB NOT NULL DEFAULT '', subj BLOB NOT NULL DEFAULT '', tset BLOB, data BLOB, PRIMARY KEY(sha1));`);

      try {
        yield (0, _utils.execSQLiteQuery)(_this7.db, 'CREATE INDEX isubj ON tsettings(subj);');
      } catch (e) {}

      return _this7.db;
    })();
  }

  addRecord(sha1, tset, subj, data) {
    var _this8 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let db = yield _this8.getDB();

      if (yield _this8.hasRecords(subj)) {
        return yield (0, _utils.execSQLiteQuery)(db, `UPDATE tsettings SET sha1=x'?', tset='?', data=x'?' WHERE subj='?'`, sha1, tset, data, subj);
      } else {
        return yield (0, _utils.execSQLiteQuery)(db, `INSERT INTO tsettings (sha1, subj, tset, data) VALUES (x'?', '?', '?', x'?')`, sha1, subj, tset, data);
      }
    })();
  }

  removeRecord(subj) {
    var _this9 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return yield (0, _utils.execSQLiteQuery)((yield _this9.getDB()), `DELETE FROM tsettings WHERE subj = '?'`, subj);
    })();
  }

  hasRecords(subj) {
    var _this10 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      return (yield _this10.getRecordCount(subj)) > 0;
    })();
  }

  getRecordCount(subj) {
    var _this11 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let result = yield (0, _utils.execSQLiteQuery)((yield _this11.getDB()), `SELECT count(*) FROM tsettings WHERE subj = '?'`, subj);
      return parseInt(result.split('=')[1], 10);
    })();
  }

  getFingerPrintFromRecord(subj) {
    var _this12 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      let result = yield (0, _utils.execSQLiteQuery)((yield _this12.getDB()), `SELECT sha1 FROM tsettings WHERE subj='?'`, subj);

      if (result) {
        return Buffer.from(result.split('=')[1].trim());
      }
    })();
  }

}

exports.TrustStore = TrustStore;
var _default = Certificate;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6WyJvcGVuc3NsIiwiQiIsInByb21pc2lmeSIsInJlcXVpcmUiLCJleGVjIiwidHNldCIsIkNlcnRpZmljYXRlIiwiY29uc3RydWN0b3IiLCJwZW1GaWxlbmFtZSIsImFkZCIsImRpciIsImRhdGEiLCJnZXREZXJEYXRhIiwidG9TdHJpbmciLCJzdWJqZWN0IiwiZ2V0U3ViamVjdCIsInNoYTEiLCJnZXRGaW5nZXJQcmludCIsInRydXN0U3RvcmUiLCJUcnVzdFN0b3JlIiwiYWRkUmVjb3JkIiwiaGFzIiwiaGFzUmVjb3JkcyIsInByZXZpb3VzRmluZ2VycHJpbnQiLCJnZXRGaW5nZXJQcmludEZyb21SZWNvcmQiLCJjdXJyZW50RmluZ2VycHJpbnQiLCJyZW1vdmUiLCJyZW1vdmVSZWNvcmQiLCJvdXRmb3JtIiwiaW4iLCJmaW5nZXJwcmludCIsInNoYXN1bSIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJub291dCIsInN1YlJlZ2V4IiwibWF0Y2giLCJzaGFyZWRSZXNvdXJjZURpciIsImdldERCIiwiZGIiLCJrZXljaGFpbnNQYXRoIiwicGF0aCIsInJlc29sdmUiLCJmcyIsImV4aXN0cyIsImUiLCJzdWJqIiwiZ2V0UmVjb3JkQ291bnQiLCJyZXN1bHQiLCJwYXJzZUludCIsInNwbGl0IiwiQnVmZmVyIiwiZnJvbSIsInRyaW0iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsT0FBTyxHQUFHQyxrQkFBRUMsU0FBRixDQUFZQyxPQUFPLENBQUMsaUJBQUQsQ0FBUCxDQUEyQkMsSUFBdkMsQ0FBaEI7O0FBRUEsTUFBTUMsSUFBSSxHQUFJOzs7O1NBQWQ7O0FBU0EsTUFBTUMsV0FBTixDQUFrQjtBQUVoQkMsRUFBQUEsV0FBVyxDQUFFQyxXQUFGLEVBQWU7QUFDeEIsU0FBS0EsV0FBTCxHQUFtQkEsV0FB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LENBQUNFLEtBQVAsQ0FBYSxHQUFiLEVBQWtCLENBQWxCLENBQUQsRUFBdUIsRUFBdkIsQ0FBZjtBQUYwQjtBQUczQjs7QUFNSzVCLEVBQUFBLHdCQUFOLENBQWdDd0IsSUFBaEMsRUFBc0M7QUFBQTs7QUFBQTtBQUNwQyxVQUFJRSxNQUFNLFNBQVMsbUNBQXNCLE9BQUksQ0FBQ1YsS0FBTCxFQUF0QixHQUFxQywyQ0FBckMsRUFBaUZRLElBQWpGLENBQW5COztBQUNBLFVBQUlFLE1BQUosRUFBWTtBQUNWLGVBQU9HLE1BQU0sQ0FBQ0MsSUFBUCxDQUFZSixNQUFNLENBQUNFLEtBQVAsQ0FBYSxHQUFiLEVBQWtCLENBQWxCLEVBQXFCRyxJQUFyQixFQUFaLENBQVA7QUFDRDtBQUptQztBQUtyQzs7QUE5RWM7OztlQWlGRmpELFciLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgY3J5cHRvIGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCBta2RpcnAgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjU1FMaXRlUXVlcnkgfSBmcm9tICcuL3V0aWxzJztcblxuY29uc3Qgb3BlbnNzbCA9IEIucHJvbWlzaWZ5KHJlcXVpcmUoJ29wZW5zc2wtd3JhcHBlcicpLmV4ZWMpO1xuXG5jb25zdCB0c2V0ID0gYDw/eG1sIHZlcnNpb249XCIxLjBcIiBlbmNvZGluZz1cIlVURi04XCI/PlxcblxuICAgIDwhRE9DVFlQRSBwbGlzdCBQVUJMSUMgXCItLy9BcHBsZS8vRFREIFBMSVNUIDEuMC8vRU5cIiBcImh0dHA6Ly93d3cuYXBwbGUuY29tL0RURHMvUHJvcGVydHlMaXN0LTEuMC5kdGRcIj5cbiAgICA8cGxpc3QgdmVyc2lvbj1cIjEuMFwiPlxuICAgIDxhcnJheS8+XG48L3BsaXN0PmA7XG5cbi8qKlxuICogTGlicmFyeSBmb3IgcHJvZ3JhbWF0aWNhbGx5IGFkZGluZyBjZXJ0aWZpY2F0ZXNcbiAqL1xuY2xhc3MgQ2VydGlmaWNhdGUge1xuXG4gIGNvbnN0cnVjdG9yIChwZW1GaWxlbmFtZSkge1xuICAgIHRoaXMucGVtRmlsZW5hbWUgPSBwZW1GaWxlbmFtZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgYSBjZXJ0aWZpY2F0ZSB0byB0aGUgVHJ1c3RTdG9yZVxuICAgKi9cbiAgYXN5bmMgYWRkIChkaXIpIHtcbiAgICBsZXQgZGF0YSA9IChhd2FpdCB0aGlzLmdldERlckRhdGEodGhpcy5wZW1GaWxlbmFtZSkpLnRvU3RyaW5nKCdoZXgnKTtcbiAgICBsZXQgc3ViamVjdCA9IChhd2FpdCB0aGlzLmdldFN1YmplY3QodGhpcy5wZW1GaWxlbmFtZSkpO1xuICAgIGxldCBzaGExID0gKGF3YWl0IHRoaXMuZ2V0RmluZ2VyUHJpbnQodGhpcy5kYXRhKSkudG9TdHJpbmcoJ2hleCcpO1xuXG4gICAgbGV0IHRydXN0U3RvcmUgPSBuZXcgVHJ1c3RTdG9yZShkaXIpO1xuICAgIHJldHVybiBhd2FpdCB0cnVzdFN0b3JlLmFkZFJlY29yZChzaGExLCB0c2V0LCBzdWJqZWN0LCBkYXRhKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYga2V5Y2hhaW4gYXQgZ2l2ZW4gZGlyZWN0b3J5IGhhcyB0aGlzIGNlcnRpZmljYXRlXG4gICAqL1xuICBhc3luYyBoYXMgKGRpcikge1xuICAgIGxldCBzdWJqZWN0ID0gYXdhaXQgdGhpcy5nZXRTdWJqZWN0KHRoaXMucGVtRmlsZW5hbWUpO1xuICAgIGxldCB0cnVzdFN0b3JlID0gbmV3IFRydXN0U3RvcmUoZGlyKTtcblxuICAgIC8vIFJldHVybiBmYWxzZSBpZiByZWNvcmQgd2l0aCB0aGlzIHN1YmplY3QgaXMgbm90IGZvdW5kXG4gICAgaWYgKCFhd2FpdCB0cnVzdFN0b3JlLmhhc1JlY29yZHMoc3ViamVjdCkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBJZiByZWNvcmQgaXMgZm91bmQsIGNoZWNrIGZpbmdlcnByaW50cyB0byB2ZXJpZnkgdGhhdCB0aGV5IGRpZG4ndCBjaGFuZ2VcbiAgICBsZXQgcHJldmlvdXNGaW5nZXJwcmludCA9IGF3YWl0IHRydXN0U3RvcmUuZ2V0RmluZ2VyUHJpbnRGcm9tUmVjb3JkKHN1YmplY3QpO1xuICAgIGxldCBjdXJyZW50RmluZ2VycHJpbnQgPSBhd2FpdCB0aGlzLmdldEZpbmdlclByaW50KCk7XG4gICAgcmV0dXJuIHByZXZpb3VzRmluZ2VycHJpbnQudG9TdHJpbmcoKSA9PT0gY3VycmVudEZpbmdlcnByaW50LnRvU3RyaW5nKCk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGNlcnRpZmljYXRlIGZyb20gdGhlIFRydXN0U3RvcmVcbiAgICovXG4gIGFzeW5jIHJlbW92ZSAoZGlyKSB7XG4gICAgbGV0IHN1YmplY3QgPSBhd2FpdCB0aGlzLmdldFN1YmplY3QodGhpcy5wZW1GaWxlbmFtZSk7XG4gICAgbGV0IHRydXN0U3RvcmUgPSBuZXcgVHJ1c3RTdG9yZShkaXIpO1xuICAgIHJldHVybiBhd2FpdCB0cnVzdFN0b3JlLnJlbW92ZVJlY29yZChzdWJqZWN0KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUcmFuc2xhdGUgUEVNIGZpbGUgdG8gREVSIGJ1ZmZlclxuICAgKi9cbiAgYXN5bmMgZ2V0RGVyRGF0YSAoKSB7XG4gICAgaWYgKHRoaXMuZGF0YSkge1xuICAgICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0ICdwZW0nIGZpbGUgdG8gJ2RlcidcbiAgICB0aGlzLmRhdGEgPSBhd2FpdCBvcGVuc3NsKCd4NTA5Jywge1xuICAgICAgb3V0Zm9ybTogJ2RlcicsXG4gICAgICBpbjogdGhpcy5wZW1GaWxlbmFtZVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIHRoaXMuZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgU0hBMSBmaW5nZXJwcmludCBmcm9tIGRlciBkYXRhIGJlZm9yZVxuICAgKi9cbiAgYXN5bmMgZ2V0RmluZ2VyUHJpbnQgKCkge1xuICAgIGlmICh0aGlzLmZpbmdlcnByaW50KSB7XG4gICAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgICB9XG5cbiAgICBsZXQgZGF0YSA9IGF3YWl0IHRoaXMuZ2V0RGVyRGF0YSgpO1xuICAgIGxldCBzaGFzdW0gPSBjcnlwdG8uY3JlYXRlSGFzaCgnc2hhMScpO1xuICAgIHNoYXN1bS51cGRhdGUoZGF0YSk7XG4gICAgdGhpcy5maW5nZXJwcmludCA9IHNoYXN1bS5kaWdlc3QoKTtcbiAgICByZXR1cm4gdGhpcy5maW5nZXJwcmludDtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZSB0aGUgc3ViamVjdCBmcm9tIHRoZSBkZXIgZGF0YVxuICAgKi9cbiAgYXN5bmMgZ2V0U3ViamVjdCAoKSB7XG4gICAgaWYgKHRoaXMuc3ViamVjdCkge1xuICAgICAgcmV0dXJuIHRoaXMuc3ViamVjdDtcbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0ICdwZW0nIGZpbGUgdG8gJ2RlcidcbiAgICBsZXQgc3ViamVjdCA9IGF3YWl0IG9wZW5zc2woJ3g1MDknLCB7XG4gICAgICBub291dDogdHJ1ZSxcbiAgICAgIHN1YmplY3Q6IHRydWUsXG4gICAgICBpbjogdGhpcy5wZW1GaWxlbmFtZVxuICAgIH0pO1xuICAgIGxldCBzdWJSZWdleCA9IC9ec3ViamVjdFtcXHdcXFddKlxcL0NOPShbXFx3XFxXXSopKFxcbik/LztcbiAgICB0aGlzLnN1YmplY3QgPSBzdWJqZWN0LnRvU3RyaW5nKCkubWF0Y2goc3ViUmVnZXgpWzFdO1xuICAgIHJldHVybiB0aGlzLnN1YmplY3Q7XG4gIH1cblxufVxuXG4vKipcbiAqIEludGVyZmFjZSBmb3IgYWRkaW5nIGFuZCByZW1vdmluZyByZWNvcmRzIHRvIFRydXN0U3RvcmUuc3FsaXRlMyBkYXRhYmFzZXMgdGhhdCBLZXljaGFpbnMgdXNlXG4gKi9cbmNsYXNzIFRydXN0U3RvcmUge1xuICBjb25zdHJ1Y3RvciAoc2hhcmVkUmVzb3VyY2VEaXIpIHtcbiAgICB0aGlzLnNoYXJlZFJlc291cmNlRGlyID0gc2hhcmVkUmVzb3VyY2VEaXI7XG4gIH1cblxuICAvKipcbiAgICogR2V0IFRydXN0U3RvcmUgZGF0YWJhc2UgYXNzb2NpYXRlZCB3aXRoIHRoaXMgc2ltdWxhdG9yXG4gICAqL1xuICBhc3luYyBnZXREQiAoKSB7XG4gICAgaWYgKHRoaXMuZGIpIHtcbiAgICAgIHJldHVybiB0aGlzLmRiO1xuICAgIH1cblxuICAgIC8vIElmIHRoZSBzaW0gZG9lc24ndCBoYXZlIGEga2V5Y2hhaW5zIGRpcmVjdG9yeSwgY3JlYXRlIG9uZVxuICAgIGxldCBrZXljaGFpbnNQYXRoID0gcGF0aC5yZXNvbHZlKHRoaXMuc2hhcmVkUmVzb3VyY2VEaXIsICdMaWJyYXJ5JywgJ0tleWNoYWlucycpO1xuICAgIGlmICghKGF3YWl0IGZzLmV4aXN0cyhrZXljaGFpbnNQYXRoKSkpIHtcbiAgICAgIGF3YWl0IG1rZGlycChrZXljaGFpbnNQYXRoKTtcbiAgICB9XG5cbiAgICAvLyBPcGVuIHNxbGl0ZSBkYXRhYmFzZVxuICAgIHRoaXMuZGIgPSBwYXRoLnJlc29sdmUoa2V5Y2hhaW5zUGF0aCwgJ1RydXN0U3RvcmUuc3FsaXRlMycpO1xuXG4gICAgLy8gSWYgaXQgZG9lc24ndCBoYXZlIGEgdHNldHRpbmdzIHRhYmxlLCBjcmVhdGUgb25lXG4gICAgYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KHRoaXMuZGIsIGBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB0c2V0dGluZ3MgKHNoYTEgQkxPQiBOT1QgTlVMTCBERUZBVUxUICcnLCBzdWJqIEJMT0IgTk9UIE5VTEwgREVGQVVMVCAnJywgdHNldCBCTE9CLCBkYXRhIEJMT0IsIFBSSU1BUlkgS0VZKHNoYTEpKTtgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgZXhlY1NRTGl0ZVF1ZXJ5KHRoaXMuZGIsICdDUkVBVEUgSU5ERVggaXN1YmogT04gdHNldHRpbmdzKHN1YmopOycpO1xuICAgIH0gY2F0Y2ggKGUpIHsgfVxuXG5cbiAgICByZXR1cm4gdGhpcy5kYjtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgcmVjb3JkIHRvIHRzZXR0aW5nc1xuICAgKi9cbiAgYXN5bmMgYWRkUmVjb3JkIChzaGExLCB0c2V0LCBzdWJqLCBkYXRhKSB7XG4gICAgbGV0IGRiID0gYXdhaXQgdGhpcy5nZXREQigpO1xuICAgIGlmIChhd2FpdCB0aGlzLmhhc1JlY29yZHMoc3ViaikpIHtcbiAgICAgIHJldHVybiBhd2FpdCBleGVjU1FMaXRlUXVlcnkoZGIsIGBVUERBVEUgdHNldHRpbmdzIFNFVCBzaGExPXgnPycsIHRzZXQ9Jz8nLCBkYXRhPXgnPycgV0hFUkUgc3Viaj0nPydgLCBzaGExLCB0c2V0LCBkYXRhLCBzdWJqKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShkYiwgYElOU0VSVCBJTlRPIHRzZXR0aW5ncyAoc2hhMSwgc3ViaiwgdHNldCwgZGF0YSkgVkFMVUVTICh4Jz8nLCAnPycsICc/JywgeCc/JylgLCBzaGExLCBzdWJqLCB0c2V0LCBkYXRhKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHJlY29yZCBmcm9tIHRzZXR0aW5ncyB0aGF0IG1hdGNoZXMgdGhlIHN1YmplY3RcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIHJlbW92ZVJlY29yZCAoc3Viaikge1xuICAgIHJldHVybiBhd2FpdCBleGVjU1FMaXRlUXVlcnkoYXdhaXQgdGhpcy5nZXREQigpLCBgREVMRVRFIEZST00gdHNldHRpbmdzIFdIRVJFIHN1YmogPSAnPydgLCBzdWJqKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYSByZWNvcmQgZnJvbSB0c2V0dGluZ3MgdGhhdCBtYXRjaGVzIHRoZSBzdWJqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzdWJqXG4gICAqL1xuICBhc3luYyBoYXNSZWNvcmRzIChzdWJqKSB7XG4gICAgcmV0dXJuIChhd2FpdCB0aGlzLmdldFJlY29yZENvdW50KHN1YmopKSA+IDA7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNvdW50IG9mIGhvdyBtYW55IHJlY29yZHMgaGF2ZSB0aGlzIHN1YmplY3RcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIGdldFJlY29yZENvdW50IChzdWJqKSB7XG4gICAgbGV0IHJlc3VsdCA9IGF3YWl0IGV4ZWNTUUxpdGVRdWVyeShhd2FpdCB0aGlzLmdldERCKCksIGBTRUxFQ1QgY291bnQoKikgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3ViaiA9ICc/J2AsIHN1YmopO1xuICAgIHJldHVybiBwYXJzZUludChyZXN1bHQuc3BsaXQoJz0nKVsxXSwgMTApO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgU0hBMSBmaW5nZXJwcmludCBmb3IgdGhlIHJlY29yZCB0aGF0IGhhcyB0aGlzIHN1YmplY3RcbiAgICogQHBhcmFtIHtzdHJpbmd9IHN1YmpcbiAgICovXG4gIGFzeW5jIGdldEZpbmdlclByaW50RnJvbVJlY29yZCAoc3Viaikge1xuICAgIGxldCByZXN1bHQgPSBhd2FpdCBleGVjU1FMaXRlUXVlcnkoYXdhaXQgdGhpcy5nZXREQigpLCBgU0VMRUNUIHNoYTEgRlJPTSB0c2V0dGluZ3MgV0hFUkUgc3Viaj0nPydgLCBzdWJqKTtcbiAgICBpZiAocmVzdWx0KSB7XG4gICAgICByZXR1cm4gQnVmZmVyLmZyb20ocmVzdWx0LnNwbGl0KCc9JylbMV0udHJpbSgpKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgQ2VydGlmaWNhdGU7XG5leHBvcnQgeyBDZXJ0aWZpY2F0ZSwgVHJ1c3RTdG9yZSB9O1xuIl0sImZpbGUiOiJsaWIvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
