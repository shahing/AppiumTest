"use strict";

var _interopRequireWildcard = require("@babel/runtime/helpers/interopRequireWildcard");

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _asyncToGenerator2 = _interopRequireDefault(require("@babel/runtime/helpers/asyncToGenerator"));

var _simulatorXcode = _interopRequireDefault(require("./simulator-xcode-8"));

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _appiumSupport = require("appium-support");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _logger = _interopRequireDefault(require("./logger"));

var _nodeSimctl = require("node-simctl");

var _asyncbox = require("asyncbox");

var _utils = require("./utils.js");

var fbsimctl = _interopRequireWildcard(require("./fbsimctl-utils"));

const SIMULATOR_SHUTDOWN_TIMEOUT = 15 * 1000;
const startupLock = new _asyncLock.default();
const preferencesPlistGuard = new _asyncLock.default();
const ENROLLMENT_NOTIFICATION_RECEIVER = 'com.apple.BiometricKit.enrollmentChanged';

class SimulatorXcode9 extends _simulatorXcode.default {
  constructor(udid, xcodeVersion) {
    super(udid, xcodeVersion);
  }

  run(opts = {}) {
    var _this = this;

    return (0, _asyncToGenerator2.default)(function* () {
      opts = Object.assign({
        devicePreferences: {},
        isHeadless: false,
        startupTimeout: _this.startupTimeout
      }, opts);

      if (opts.scaleFactor) {
        opts.devicePreferences.SimulatorWindowLastScale = parseFloat(opts.scaleFactor);
      }

      const commonPreferences = {
        RotateWindowWhenSignaledByGuest: true
      };

      if (_lodash.default.isBoolean(opts.connectHardwareKeyboard)) {
        opts.devicePreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
        commonPreferences.ConnectHardwareKeyboard = opts.connectHardwareKeyboard;
      }

      if (!_lodash.default.isEmpty(opts.devicePreferences) || !_lodash.default.isEmpty(commonPreferences)) {
        yield _this.updatePreferences(opts.devicePreferences, commonPreferences);
      }

      const bootSimulator = function () {
        var _ref = (0, _asyncToGenerator2.default)(function* () {
          try {
            yield (0, _asyncbox.retryInterval)(3, 2000, (0, _asyncToGenerator2.default)(function* () {
              return yield (0, _nodeSimctl.bootDevice)(_this.udid);
            }));
          } catch (err) {
            _logger.default.warn(`'xcrun simctl boot ${_this.udid}' command has returned non-zero code. The problem was: ${err.stderr}`);
          }
        });

        return function bootSimulator() {
          return _ref.apply(this, arguments);
        };
      }();

      const waitForShutdown = function () {
        var _ref3 = (0, _asyncToGenerator2.default)(function* () {
          try {
            yield (0, _asyncbox.waitForCondition)((0, _asyncToGenerator2.default)(function* () {
              const _ref5 = yield _this.stat(),
                    state = _ref5.state;

              return state === 'Shutdown';
            }), {
              waitMs: SIMULATOR_SHUTDOWN_TIMEOUT,
              intervalMs: 500
            });
          } catch (err) {
            throw new Error(`Simulator is not in 'Shutdown' state after ${SIMULATOR_SHUTDOWN_TIMEOUT}ms`);
          }
        });

        return function waitForShutdown() {
          return _ref3.apply(this, arguments);
        };
      }();

      let shouldWaitForBoot = true;
      const startTime = process.hrtime();
      yield startupLock.acquire(_this.uiClientBundleId, (0, _asyncToGenerator2.default)(function* () {
        const stat = yield _this.stat();
        const serverState = stat.state;
        const isServerRunning = serverState === 'Booted';
        const isUIClientRunning = yield _this.isUIClientRunning();

        if (opts.isHeadless) {
          if (isServerRunning && !isUIClientRunning) {
            _logger.default.info(`Simulator with UDID ${_this.udid} already booted in headless mode.`);

            shouldWaitForBoot = false;
            return;
          }

          if (yield _this.killUIClient()) {
            _logger.default.info(`Detected the UI client was running and killed it. Verifying the Simulator is in Shutdown state...`);

            yield waitForShutdown();
          }

          _logger.default.info(`Booting Simulator with UDID ${_this.udid} in headless mode. All UI-related capabilities are going to be ignored.`);

          yield bootSimulator();
        } else {
          if (isServerRunning && isUIClientRunning) {
            _logger.default.info(`Both Simulator with UDID ${_this.udid} and the UI client are currently running`);

            shouldWaitForBoot = false;
            return;
          }

          if (['Shutdown', 'Booted'].indexOf(serverState) === -1) {
            if (serverState !== 'Shutting Down') {
              _logger.default.info(`Simulator ${_this.udid} is in '${serverState}' state. Trying to shutdown...`);

              try {
                yield _this.shutdown();
              } catch (err) {
                _logger.default.warn(`Error on Simulator shutdown: ${err.message}`);
              }
            }

            yield waitForShutdown();
          }

          _logger.default.info(`Booting Simulator with UDID ${_this.udid}...`);

          yield bootSimulator();

          if (!isUIClientRunning) {
            yield _this.startUIClient(opts);
          }
        }
      }));

      if (shouldWaitForBoot) {
        yield _this.waitForBoot(opts.startupTimeout);

        _logger.default.info(`Simulator with UDID ${_this.udid} booted in ${process.hrtime(startTime)[0]} seconds`);
      }
    })();
  }

  verifyDevicePreferences(prefs = {}) {
    if (_lodash.default.isEmpty(prefs)) {
      return;
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowLastScale)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowLastScale) || prefs.SimulatorWindowLastScale <= 0) {
        _logger.default.errorAndThrow(`SimulatorWindowLastScale is expected to be a positive float value. ` + `'${prefs.SimulatorWindowLastScale}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowCenter)) {
      const verificationPattern = /{-?\d+(\.\d+)?,-?\d+(\.\d+)?}/;

      if (!_lodash.default.isString(prefs.SimulatorWindowCenter) || !verificationPattern.test(prefs.SimulatorWindowCenter)) {
        _logger.default.errorAndThrow(`SimulatorWindowCenter is expected to match "{floatXPosition,floatYPosition}" format (without spaces). ` + `'${prefs.SimulatorWindowCenter}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowOrientation)) {
      const acceptableValues = ['Portrait', 'LandscapeLeft', 'PortraitUpsideDown', 'LandscapeRight'];

      if (acceptableValues.indexOf(prefs.SimulatorWindowOrientation) === -1) {
        _logger.default.errorAndThrow(`SimulatorWindowOrientation is expected to be one of ${acceptableValues}. ` + `'${prefs.SimulatorWindowOrientation}' is assigned instead.`);
      }
    }

    if (!_lodash.default.isUndefined(prefs.SimulatorWindowRotationAngle)) {
      if (!_lodash.default.isNumber(prefs.SimulatorWindowRotationAngle)) {
        _logger.default.errorAndThrow(`SimulatorWindowRotationAngle is expected to be a valid number. ` + `'${prefs.SimulatorWindowRotationAngle}' is assigned instead.`);
      }
    }
  }

  updatePreferences(devicePrefs = {}, commonPrefs = {}) {
    var _this2 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      if (!_lodash.default.isEmpty(devicePrefs)) {
        _logger.default.debug(`Setting preferences of ${_this2.udid} Simulator to ${JSON.stringify(devicePrefs)}`);
      }

      if (!_lodash.default.isEmpty(commonPrefs)) {
        _logger.default.debug(`Setting common Simulator preferences to ${JSON.stringify(commonPrefs)}`);
      }

      const homeFolderPath = process.env.HOME;

      if (!homeFolderPath) {
        _logger.default.warn(`Cannot get the path to HOME folder from the process environment. ` + `Ignoring Simulator preferences update.`);

        return false;
      }

      _this2.verifyDevicePreferences(devicePrefs);

      const plistPath = _path.default.resolve(homeFolderPath, 'Library', 'Preferences', 'com.apple.iphonesimulator.plist');

      if (!(yield _appiumSupport.fs.hasAccess(plistPath))) {
        _logger.default.warn(`Simulator preferences file '${plistPath}' is not accessible. ` + `Ignoring Simulator preferences update.`);

        return false;
      }

      let newPrefs = {};

      if (!_lodash.default.isEmpty(devicePrefs)) {
        newPrefs.DevicePreferences = {
          [_this2.udid.toUpperCase()]: devicePrefs
        };
      }

      newPrefs = _lodash.default.merge(newPrefs, commonPrefs);
      return yield preferencesPlistGuard.acquire(SimulatorXcode9.name, (0, _asyncToGenerator2.default)(function* () {
        try {
          const currentPlistContent = yield _appiumSupport.plist.parsePlistFile(plistPath);
          yield _appiumSupport.plist.updatePlistFile(plistPath, _lodash.default.merge(currentPlistContent, newPrefs), true);

          _logger.default.debug(`Updated ${_this2.udid} Simulator preferences at '${plistPath}' with ${JSON.stringify(newPrefs)}`);

          return true;
        } catch (e) {
          _logger.default.warn(`Cannot update ${_this2.udid} Simulator preferences at '${plistPath}'. ` + `Try to delete the file manually in order to reset it. Original error: ${e.message}`);

          return false;
        }
      }));
    })();
  }

  shutdown() {
    var _this3 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const _ref8 = yield _this3.stat(),
            state = _ref8.state;

      if (state === 'Shutdown') {
        return;
      }

      yield (0, _asyncbox.retryInterval)(5, 500, _nodeSimctl.shutdown, _this3.udid);
    })();
  }

  clean() {
    var _this4 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.info(`Cleaning simulator ${_this4.udid}`);

      yield (0, _nodeSimctl.eraseDevice)(_this4.udid, 10000);
    })();
  }

  _activateWindow() {
    var _this5 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      try {
        yield fbsimctl.focus(_this5.udid);
      } catch (err) {
        _logger.default.warn(`Cannot focus Simulator window with fbsimctl. Defaulting to AppleScript. ` + `Original error: ${err.message}`);

        const _ref9 = yield _this5.stat(),
              name = _ref9.name,
              sdk = _ref9.sdk;

        return `
        tell application "System Events"
          tell process "Simulator"
            set frontmost to false
            set frontmost to true
            click (menu item 1 where (its name contains "${name} -" and its name contains "${sdk}")) of menu 1 of menu bar item "Window" of menu bar 1
          end tell
        end tell
      `;
      }
    })();
  }

  isBiometricEnrolled() {
    var _this6 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const _ref10 = yield (0, _nodeSimctl.spawn)(_this6.udid, ['notifyutil', '-g', ENROLLMENT_NOTIFICATION_RECEIVER]),
            stdout = _ref10.stdout;

      const match = new RegExp(`${_lodash.default.escapeRegExp(ENROLLMENT_NOTIFICATION_RECEIVER)}\\s+([01])`).exec(stdout);

      if (!match) {
        throw new Error(`Cannot parse biometric enrollment state from '${stdout}'`);
      }

      _logger.default.info(`Current biometric enrolled state for ${_this6.udid} Simulator: ${match[1]}`);

      return match[1] === '1';
    })();
  }

  enrollBiometric(isEnabled = true) {
    var _this7 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      _logger.default.debug(`Setting biometric enrolled state for ${_this7.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);

      yield (0, _nodeSimctl.spawn)(_this7.udid, ['notifyutil', '-s', ENROLLMENT_NOTIFICATION_RECEIVER, isEnabled ? '1' : '0']);
      yield (0, _nodeSimctl.spawn)(_this7.udid, ['notifyutil', '-p', ENROLLMENT_NOTIFICATION_RECEIVER]);

      if ((yield _this7.isBiometricEnrolled()) !== isEnabled) {
        throw new Error(`Cannot set biometric enrolled state for ${_this7.udid} Simulator to '${isEnabled ? 'enabled' : 'disabled'}'`);
      }
    })();
  }

  sendBiometricMatch(shouldMatch = true, biometricName = 'touchId') {
    var _this8 = this;

    return (0, _asyncToGenerator2.default)(function* () {
      const domainComponent = (0, _utils.toBiometricDomainComponent)(biometricName);
      const domain = `com.apple.BiometricKit_Sim.${domainComponent}.${shouldMatch ? '' : 'no'}match`;
      yield (0, _nodeSimctl.spawn)(_this8.udid, ['notifyutil', '-p', domain]);

      _logger.default.info(`Sent notification ${domain} to ${shouldMatch ? 'match' : 'not match'} ${biometricName} biometric ` + `for ${_this8.udid} Simulator`);
    })();
  }

  getLaunchDaemonsRoot() {
    return (0, _asyncToGenerator2.default)(function* () {
      const devRoot = yield (0, _utils.getDeveloperRoot)();
      return _path.default.resolve(devRoot, 'Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/LaunchDaemons');
    })();
  }

}

var _default = SimulatorXcode9;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3IteGNvZGUtOS5qcyJdLCJuYW1lcyI6WyJTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCIsInN0YXJ0dXBMb2NrIiwiQXN5bmNMb2NrIiwicHJlZmVyZW5jZXNQbGlzdEd1YXJkIiwiRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIiLCJTaW11bGF0b3JYY29kZTkiLCJTaW11bGF0b3JYY29kZTgiLCJjb25zdHJ1Y3RvciIsInVkaWQiLCJ4Y29kZVZlcnNpb24iLCJydW4iLCJvcHRzIiwiT2JqZWN0IiwiYXNzaWduIiwiZGV2aWNlUHJlZmVyZW5jZXMiLCJpc0hlYWRsZXNzIiwic3RhcnR1cFRpbWVvdXQiLCJzY2FsZUZhY3RvciIsIlNpbXVsYXRvcldpbmRvd0xhc3RTY2FsZSIsInBhcnNlRmxvYXQiLCJjb21tb25QcmVmZXJlbmNlcyIsIlJvdGF0ZVdpbmRvd1doZW5TaWduYWxlZEJ5R3Vlc3QiLCJfIiwiaXNCb29sZWFuIiwiY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQiLCJDb25uZWN0SGFyZHdhcmVLZXlib2FyZCIsImlzRW1wdHkiLCJ1cGRhdGVQcmVmZXJlbmNlcyIsImJvb3RTaW11bGF0b3IiLCJlcnIiLCJsb2ciLCJ3YXJuIiwic3RkZXJyIiwid2FpdEZvclNodXRkb3duIiwic3RhdCIsInN0YXRlIiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsIkVycm9yIiwic2hvdWxkV2FpdEZvckJvb3QiLCJzdGFydFRpbWUiLCJwcm9jZXNzIiwiaHJ0aW1lIiwiYWNxdWlyZSIsInVpQ2xpZW50QnVuZGxlSWQiLCJzZXJ2ZXJTdGF0ZSIsImlzU2VydmVyUnVubmluZyIsImlzVUlDbGllbnRSdW5uaW5nIiwiaW5mbyIsImtpbGxVSUNsaWVudCIsImluZGV4T2YiLCJzaHV0ZG93biIsIm1lc3NhZ2UiLCJzdGFydFVJQ2xpZW50Iiwid2FpdEZvckJvb3QiLCJ2ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyIsInByZWZzIiwiaXNVbmRlZmluZWQiLCJpc051bWJlciIsImVycm9yQW5kVGhyb3ciLCJTaW11bGF0b3JXaW5kb3dDZW50ZXIiLCJ2ZXJpZmljYXRpb25QYXR0ZXJuIiwiaXNTdHJpbmciLCJ0ZXN0IiwiU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb24iLCJhY2NlcHRhYmxlVmFsdWVzIiwiU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSIsImRldmljZVByZWZzIiwiY29tbW9uUHJlZnMiLCJkZWJ1ZyIsIkpTT04iLCJzdHJpbmdpZnkiLCJob21lRm9sZGVyUGF0aCIsImVudiIsIkhPTUUiLCJwbGlzdFBhdGgiLCJwYXRoIiwicmVzb2x2ZSIsImZzIiwiaGFzQWNjZXNzIiwibmV3UHJlZnMiLCJEZXZpY2VQcmVmZXJlbmNlcyIsInRvVXBwZXJDYXNlIiwibWVyZ2UiLCJuYW1lIiwiY3VycmVudFBsaXN0Q29udGVudCIsInBsaXN0IiwicGFyc2VQbGlzdEZpbGUiLCJ1cGRhdGVQbGlzdEZpbGUiLCJlIiwic2ltY3RsU2h1dGRvd24iLCJjbGVhbiIsIl9hY3RpdmF0ZVdpbmRvdyIsImZic2ltY3RsIiwiZm9jdXMiLCJzZGsiLCJpc0Jpb21ldHJpY0Vucm9sbGVkIiwic3Rkb3V0IiwibWF0Y2giLCJSZWdFeHAiLCJlc2NhcGVSZWdFeHAiLCJleGVjIiwiZW5yb2xsQmlvbWV0cmljIiwiaXNFbmFibGVkIiwic2VuZEJpb21ldHJpY01hdGNoIiwic2hvdWxkTWF0Y2giLCJiaW9tZXRyaWNOYW1lIiwiZG9tYWluQ29tcG9uZW50IiwiZG9tYWluIiwiZ2V0TGF1bmNoRGFlbW9uc1Jvb3QiLCJkZXZSb290Il0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsMEJBQTBCLEdBQUcsS0FBSyxJQUF4QztBQUNBLE1BQU1DLFdBQVcsR0FBRyxJQUFJQyxrQkFBSixFQUFwQjtBQUNBLE1BQU1DLHFCQUFxQixHQUFHLElBQUlE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TUFBSSxDQUFDbEcsSUFBSyxZQURuQjtBQVB1RTtBQVN4RTs7QUFLS3FHLEVBQUFBLG9CQUFOLEdBQThCO0FBQUE7QUFDNUIsWUFBTUMsT0FBTyxTQUFTLDhCQUF0QjtBQUNBLGFBQU9sQyxjQUFLQyxPQUFMLENBQWFpQyxPQUFiLEVBQ0wsMEpBREssQ0FBUDtBQUY0QjtBQUk3Qjs7QUFoVjJDOztlQW9WL0J6RyxlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFNpbXVsYXRvclhjb2RlOCBmcm9tICcuL3NpbXVsYXRvci14Y29kZS04JztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGZzLCBwbGlzdCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBBc3luY0xvY2sgZnJvbSAnYXN5bmMtbG9jayc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHNodXRkb3duIGFzIHNpbWN0bFNodXRkb3duLCBib290RGV2aWNlLCBlcmFzZURldmljZSwgc3Bhd24gfSBmcm9tICdub2RlLXNpbWN0bCc7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uLCByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IHsgdG9CaW9tZXRyaWNEb21haW5Db21wb25lbnQsIGdldERldmVsb3BlclJvb3QgfSBmcm9tICcuL3V0aWxzLmpzJztcbmltcG9ydCAqIGFzIGZic2ltY3RsIGZyb20gJy4vZmJzaW1jdGwtdXRpbHMnO1xuXG5jb25zdCBTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCA9IDE1ICogMTAwMDtcbmNvbnN0IHN0YXJ0dXBMb2NrID0gbmV3IEFzeW5jTG9jaygpO1xuY29uc3QgcHJlZmVyZW5jZXNQbGlzdEd1YXJkID0gbmV3IEFzeW5jTG9jaygpO1xuY29uc3QgRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIgPSAnY29tLmFwcGxlLkJpb21ldHJpY0tpdC5lbnJvbGxtZW50Q2hhbmdlZCc7XG5cbmNsYXNzIFNpbXVsYXRvclhjb2RlOSBleHRlbmRzIFNpbXVsYXRvclhjb2RlOCB7XG4gIGNvbnN0cnVjdG9yICh1ZGlkLCB4Y29kZVZlcnNpb24pIHtcbiAgICBzdXBlcih1ZGlkLCB4Y29kZVZlcnNpb24pO1xuICB9XG5cbiAgLyoqXG4gICAqIEB0eXBlZGVmIHtPYmplY3R9IERldmljZVByZWZlcmVuY2VzXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcn0gU2ltdWxhdG9yRXh0ZXJuYWxEaXNwbGF5IC0gVEJELiBFeGFtcGxlIHZhbHVlOiAyLjExNFxuICAgKiBAcHJvcGVydHkgez9zdHJpbmd9IENocm9tZVRpbnQgLSBUQkQuIEV4YW1wbGUgdmFsdWU6ICcnXG4gICAqIEBwcm9wZXJ0eSB7P251bWJlcn0gU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlIC0gU2NhbGUgdmFsdWUgZm9yIHRoZSBwYXJ0aWN1bGFyIFNpbXVsYXRvciB3aW5kb3cuXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgMS4wIG1lYW5zIDEwMCUgc2NhbGUuXG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb24gLSBTaW11bGF0b3Igd2luZG93IG9yaWVudGF0aW9uLiBQb3NzaWJsZSB2YWx1ZXMgYXJlOlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ1BvcnRyYWl0JywgJ0xhbmRzY2FwZUxlZnQnLCAnUG9ydHJhaXRVcHNpZGVEb3duJyBhbmQgJ0xhbmRzY2FwZVJpZ2h0Jy5cbiAgICogQHByb3BlcnR5IHs/bnVtYmVyfSBTaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlIC0gV2luZG93IHJvdGF0aW9uIGFuZ2xlLiBUaGlzIHZhbHVlIGlzIGV4cGVjdGVkIHRvIGJlIGluIHN5bmNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2l0aCBfU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb25fLiBUaGUgY29ycmVzcG9uZGluZyB2YWx1ZXMgYXJlOlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAwLCA5MCwgMTgwIGFuZCAyNzAuXG4gICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gU2ltdWxhdG9yV2luZG93Q2VudGVyIC0gVGhlIGNvb3JkaW5hdGVzIG9mIFNpbXVsYXRvcidzIHdpbmRvdyBjZW50ZXIgaW4gcGl4ZWxzLFxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBleGFtcGxlICd7LTEyOTQuNSwgNzc1LjV9Jy5cbiAgICogQHByb3BlcnR5IHs/Ym9vbGVhbn0gQ29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQgLSBFcXVhbHMgdG8gMSBpZiBoYXJkd2FyZSBrZXlib2FyZCBzaG91bGQgYmUgY29ubmVjdGVkLlxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE90aGVyd2lzZSAwLlxuICAgKi9cblxuICAvKipcbiAgICogQHR5cGVkZWYge09iamVjdH0gQ29tbW9uUHJlZmVyZW5jZXNcbiAgICogQHByb3BlcnR5IHtib29sZWFufSBDb25uZWN0SGFyZHdhcmVLZXlib2FyZCAtIFdoZXRoZXIgdG8gY29ubmVjdCBoYXJkd2FyZSBrZXlib2FyZFxuICAgKi9cblxuICAvKipcbiAgICogRXhlY3V0ZXMgZ2l2ZW4gU2ltdWxhdG9yIHdpdGggb3B0aW9ucy4gVGhlIFNpbXVsYXRvciB3aWxsIG5vdCBiZSByZXN0YXJ0ZWQgaWZcbiAgICogaXQgaXMgYWxyZWFkeSBydW5uaW5nIGFuZCB0aGUgY3VycmVudCBVSSBzdGF0ZSBtYXRjaGVzIHRvIGBpc0hlYWRsZXNzYCBvcHRpb24uXG4gICAqIEBvdmVycmlkZVxuICAgKlxuICAgKiBAcGFyYW0ge29iamVjdH0gb3B0cyAtIE9uZSBvciBtb3JlIG9mIGF2YWlsYWJsZSBTaW11bGF0b3Igb3B0aW9uczpcbiAgICogICAtIHtzdHJpbmd9IHNjYWxlRmFjdG9yOiBBbnkgcG9zaXRpdmUgZmxvYXQgdmFsdWUuIDEuMCBtZWFucyAxOjEgc2NhbGUuXG4gICAqICAgRGVmaW5lcyB0aGUgd2luZG93IHNjYWxlIHZhbHVlIGZvciB0aGUgVUkgY2xpZW50IHdpbmRvdyBmb3IgdGhlIGN1cnJlbnQgU2ltdWxhdG9yLlxuICAgKiAgIEVxdWFscyB0byBgbnVsbGAgYnkgZGVmYXVsdCwgd2hpY2gga2VlcHMgdGhlIGN1cnJlbnQgc2NhbGUgdW5jaGFuZ2VkLlxuICAgKiAgIC0ge2Jvb2xlYW59IGNvbm5lY3RIYXJkd2FyZUtleWJvYXJkOiB3aGV0aGVyIHRvIGNvbm5lY3QgdGhlIGhhcmR3YXJlIGtleWJvYXJkIHRvIHRoZVxuICAgKiAgIFNpbXVsYXRvciBVSSBjbGllbnQuIEVxdWFscyB0byBgZmFsc2VgIGJ5IGRlZmF1bHQuXG4gICAqICAgLSB7bnVtYmVyfSBzdGFydHVwVGltZW91dDogbnVtYmVyIG9mIG1pbGxpc2Vjb25kcyB0byB3YWl0IHVudGlsIFNpbXVsYXRvciBib290aW5nXG4gICAqICAgcHJvY2VzcyBpcyBjb21wbGV0ZWQuIFRoZSBkZWZhdWx0IHRpbWVvdXQgd2lsbCBiZSB1c2VkIGlmIG5vdCBzZXQgZXhwbGljaXRseS5cbiAgICogICAtIHtib29sZWFufSBpc0hlYWRsZXNzOiB3aGV0aGVyIHRvIHN0YXJ0IHRoZSBTaW11bGF0b3IgaW4gaGVhZGxlc3MgbW9kZSAod2l0aCBVSVxuICAgKiAgIGNsaWVudCBpbnZpc2libGUpLiBgZmFsc2VgIGJ5IGRlZmF1bHQuXG4gICAqICAgLSB7RGV2aWNlUHJlZmVyZW5jZXN9IGRldmljZVByZWZlcmVuY2VzOiBwcmVmZXJlbmNlcyBvZiB0aGUgbmV3bHkgY3JlYXRlZCBTaW11bGF0b3JcbiAgICogICBkZXZpY2VcbiAgICovXG4gIGFzeW5jIHJ1biAob3B0cyA9IHt9KSB7XG4gICAgb3B0cyA9IE9iamVjdC5hc3NpZ24oe1xuICAgICAgZGV2aWNlUHJlZmVyZW5jZXM6IHt9LFxuICAgICAgaXNIZWFkbGVzczogZmFsc2UsXG4gICAgICBzdGFydHVwVGltZW91dDogdGhpcy5zdGFydHVwVGltZW91dCxcbiAgICB9LCBvcHRzKTtcbiAgICBpZiAob3B0cy5zY2FsZUZhY3Rvcikge1xuICAgICAgb3B0cy5kZXZpY2VQcmVmZXJlbmNlcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgPSBwYXJzZUZsb2F0KG9wdHMuc2NhbGVGYWN0b3IpO1xuICAgIH1cbiAgICAvLyBUaGlzIG9wdGlvbiBpcyBuZWNlc3NhcnkgdG8gbWFrZSB0aGUgU2ltdWxhdG9yIHdpbmRvdyBmb2xsb3dcbiAgICAvLyB0aGUgYWN0dWFsIFhDVUlEZXZpY2Ugb3JpZW50YXRpb25cbiAgICBjb25zdCBjb21tb25QcmVmZXJlbmNlcyA9IHtcbiAgICAgIFJvdGF0ZVdpbmRvd1doZW5TaWduYWxlZEJ5R3Vlc3Q6IHRydWVcbiAgICB9O1xuICAgIGlmIChfLmlzQm9vbGVhbihvcHRzLmNvbm5lY3RIYXJkd2FyZUtleWJvYXJkKSkge1xuICAgICAgb3B0cy5kZXZpY2VQcmVmZXJlbmNlcy5Db25uZWN0SGFyZHdhcmVLZXlib2FyZCA9IG9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQ7XG4gICAgICBjb21tb25QcmVmZXJlbmNlcy5Db25uZWN0SGFyZHdhcmVLZXlib2FyZCA9IG9wdHMuY29ubmVjdEhhcmR3YXJlS2V5Ym9hcmQ7XG4gICAgfVxuICAgIGlmICghXy5pc0VtcHR5KG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMpIHx8ICFfLmlzRW1wdHkoY29tbW9uUHJlZmVyZW5jZXMpKSB7XG4gICAgICBhd2FpdCB0aGlzLnVwZGF0ZVByZWZlcmVuY2VzKG9wdHMuZGV2aWNlUHJlZmVyZW5jZXMsIGNvbW1vblByZWZlcmVuY2VzKTtcbiAgICB9XG4gICAgY29uc3QgYm9vdFNpbXVsYXRvciA9IGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHJldHJ5SW50ZXJ2YWwoMywgMjAwMCwgYXN5bmMgKCkgPT4gYXdhaXQgYm9vdERldmljZSh0aGlzLnVkaWQpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihgJ3hjcnVuIHNpbWN0bCBib290ICR7dGhpcy51ZGlkfScgY29tbWFuZCBoYXMgcmV0dXJuZWQgbm9uLXplcm8gY29kZS4gVGhlIHByb2JsZW0gd2FzOiAke2Vyci5zdGRlcnJ9YCk7XG4gICAgICB9XG4gICAgfTtcbiAgICBjb25zdCB3YWl0Rm9yU2h1dGRvd24gPSBhc3luYyAoKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB3YWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgICAgICBjb25zdCB7c3RhdGV9ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgICAgICAgcmV0dXJuIHN0YXRlID09PSAnU2h1dGRvd24nO1xuICAgICAgICB9LCB7d2FpdE1zOiBTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVCwgaW50ZXJ2YWxNczogNTAwfSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTaW11bGF0b3IgaXMgbm90IGluICdTaHV0ZG93bicgc3RhdGUgYWZ0ZXIgJHtTSU1VTEFUT1JfU0hVVERPV05fVElNRU9VVH1tc2ApO1xuICAgICAgfVxuICAgIH07XG4gICAgbGV0IHNob3VsZFdhaXRGb3JCb290ID0gdHJ1ZTtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBwcm9jZXNzLmhydGltZSgpO1xuICAgIGF3YWl0IHN0YXJ0dXBMb2NrLmFjcXVpcmUodGhpcy51aUNsaWVudEJ1bmRsZUlkLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBzdGF0ID0gYXdhaXQgdGhpcy5zdGF0KCk7XG4gICAgICBjb25zdCBzZXJ2ZXJTdGF0ZSA9IHN0YXQuc3RhdGU7XG4gICAgICBjb25zdCBpc1NlcnZlclJ1bm5pbmcgPSBzZXJ2ZXJTdGF0ZSA9PT0gJ0Jvb3RlZCc7XG4gICAgICBjb25zdCBpc1VJQ2xpZW50UnVubmluZyA9IGF3YWl0IHRoaXMuaXNVSUNsaWVudFJ1bm5pbmcoKTtcbiAgICAgIGlmIChvcHRzLmlzSGVhZGxlc3MpIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiAhaXNVSUNsaWVudFJ1bm5pbmcpIHtcbiAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yIHdpdGggVURJRCAke3RoaXMudWRpZH0gYWxyZWFkeSBib290ZWQgaW4gaGVhZGxlc3MgbW9kZS5gKTtcbiAgICAgICAgICBzaG91bGRXYWl0Rm9yQm9vdCA9IGZhbHNlO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoYXdhaXQgdGhpcy5raWxsVUlDbGllbnQoKSkge1xuICAgICAgICAgIC8vIFN0b3BwaW5nIHRoZSBVSSBjbGllbnQgYWxzbyBraWxscyBhbGwgcnVubmluZyBzZXJ2ZXJzLiBTYWQgYnV0IHRydWVcbiAgICAgICAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgdGhlIFVJIGNsaWVudCB3YXMgcnVubmluZyBhbmQga2lsbGVkIGl0LiBWZXJpZnlpbmcgdGhlIFNpbXVsYXRvciBpcyBpbiBTaHV0ZG93biBzdGF0ZS4uLmApO1xuICAgICAgICAgIGF3YWl0IHdhaXRGb3JTaHV0ZG93bigpO1xuICAgICAgICB9XG4gICAgICAgIGxvZy5pbmZvKGBCb290aW5nIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGluIGhlYWRsZXNzIG1vZGUuIEFsbCBVSS1yZWxhdGVkIGNhcGFiaWxpdGllcyBhcmUgZ29pbmcgdG8gYmUgaWdub3JlZC5gKTtcbiAgICAgICAgYXdhaXQgYm9vdFNpbXVsYXRvcigpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGlzU2VydmVyUnVubmluZyAmJiBpc1VJQ2xpZW50UnVubmluZykge1xuICAgICAgICAgIGxvZy5pbmZvKGBCb3RoIFNpbXVsYXRvciB3aXRoIFVESUQgJHt0aGlzLnVkaWR9IGFuZCB0aGUgVUkgY2xpZW50IGFyZSBjdXJyZW50bHkgcnVubmluZ2ApO1xuICAgICAgICAgIHNob3VsZFdhaXRGb3JCb290ID0gZmFsc2U7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG4gICAgICAgIGlmIChbJ1NodXRkb3duJywgJ0Jvb3RlZCddLmluZGV4T2Yoc2VydmVyU3RhdGUpID09PSAtMSkge1xuICAgICAgICAgIGlmIChzZXJ2ZXJTdGF0ZSAhPT0gJ1NodXR0aW5nIERvd24nKSB7XG4gICAgICAgICAgICBsb2cuaW5mbyhgU2ltdWxhdG9yICR7dGhpcy51ZGlkfSBpcyBpbiAnJHtzZXJ2ZXJTdGF0ZX0nIHN0YXRlLiBUcnlpbmcgdG8gc2h1dGRvd24uLi5gKTtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgICAgICBsb2cud2FybihgRXJyb3Igb24gU2ltdWxhdG9yIHNodXRkb3duOiAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgICBhd2FpdCB3YWl0Rm9yU2h1dGRvd24oKTtcbiAgICAgICAgfVxuICAgICAgICBsb2cuaW5mbyhgQm9vdGluZyBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfS4uLmApO1xuICAgICAgICBhd2FpdCBib290U2ltdWxhdG9yKCk7XG4gICAgICAgIGlmICghaXNVSUNsaWVudFJ1bm5pbmcpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnN0YXJ0VUlDbGllbnQob3B0cyk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIGlmIChzaG91bGRXYWl0Rm9yQm9vdCkge1xuICAgICAgYXdhaXQgdGhpcy53YWl0Rm9yQm9vdChvcHRzLnN0YXJ0dXBUaW1lb3V0KTtcbiAgICAgIGxvZy5pbmZvKGBTaW11bGF0b3Igd2l0aCBVRElEICR7dGhpcy51ZGlkfSBib290ZWQgaW4gJHtwcm9jZXNzLmhydGltZShzdGFydFRpbWUpWzBdfSBzZWNvbmRzYCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gdmVyaWZpY2F0aW9uIG9mIGRldmljZSBwcmVmZXJlbmNlcyBjb3JyZWN0bmVzcy5cbiAgICpcbiAgICogQHBhcmFtIHtEZXZpY2VQcmVmZXJlbmNlc30gcHJlZnMgW3t9XSAtIFRoZSBwcmVmZXJlbmNlcyB0byBiZSB2ZXJpZmllZFxuICAgKiBAdGhyb3dzIHtFcnJvcn0gSWYgYW55IG9mIHRoZSBnaXZlbiBwcmVmZXJlbmNlIHZhbHVlcyBkb2VzIG5vdCBtYXRjaCB0aGUgZXhwZWN0ZWRcbiAgICogZm9ybWF0LlxuICAgKi9cbiAgdmVyaWZ5RGV2aWNlUHJlZmVyZW5jZXMgKHByZWZzID0ge30pIHtcbiAgICBpZiAoXy5pc0VtcHR5KHByZWZzKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUpKSB7XG4gICAgICBpZiAoIV8uaXNOdW1iZXIocHJlZnMuU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlKSB8fCBwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGUgPD0gMCkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2ltdWxhdG9yV2luZG93TGFzdFNjYWxlIGlzIGV4cGVjdGVkIHRvIGJlIGEgcG9zaXRpdmUgZmxvYXQgdmFsdWUuIGAgK1xuICAgICAgICAgIGAnJHtwcmVmcy5TaW11bGF0b3JXaW5kb3dMYXN0U2NhbGV9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghXy5pc1VuZGVmaW5lZChwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpKSB7XG4gICAgICAvLyBodHRwczovL3JlZ2V4MTAxLmNvbS9yLzJaWE9pai8yXG4gICAgICBjb25zdCB2ZXJpZmljYXRpb25QYXR0ZXJuID0gL3stP1xcZCsoXFwuXFxkKyk/LC0/XFxkKyhcXC5cXGQrKT99LztcbiAgICAgIGlmICghXy5pc1N0cmluZyhwcmVmcy5TaW11bGF0b3JXaW5kb3dDZW50ZXIpIHx8ICF2ZXJpZmljYXRpb25QYXR0ZXJuLnRlc3QocHJlZnMuU2ltdWxhdG9yV2luZG93Q2VudGVyKSkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2ltdWxhdG9yV2luZG93Q2VudGVyIGlzIGV4cGVjdGVkIHRvIG1hdGNoIFwie2Zsb2F0WFBvc2l0aW9uLGZsb2F0WVBvc2l0aW9ufVwiIGZvcm1hdCAod2l0aG91dCBzcGFjZXMpLiBgICtcbiAgICAgICAgICBgJyR7cHJlZnMuU2ltdWxhdG9yV2luZG93Q2VudGVyfScgaXMgYXNzaWduZWQgaW5zdGVhZC5gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIV8uaXNVbmRlZmluZWQocHJlZnMuU2ltdWxhdG9yV2luZG93T3JpZW50YXRpb24pKSB7XG4gICAgICBjb25zdCBhY2NlcHRhYmxlVmFsdWVzID0gWydQb3J0cmFpdCcsICdMYW5kc2NhcGVMZWZ0JywgJ1BvcnRyYWl0VXBzaWRlRG93bicsICdMYW5kc2NhcGVSaWdodCddO1xuICAgICAgaWYgKGFjY2VwdGFibGVWYWx1ZXMuaW5kZXhPZihwcmVmcy5TaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbikgPT09IC0xKSB7XG4gICAgICAgIGxvZy5lcnJvckFuZFRocm93KGBTaW11bGF0b3JXaW5kb3dPcmllbnRhdGlvbiBpcyBleHBlY3RlZCB0byBiZSBvbmUgb2YgJHthY2NlcHRhYmxlVmFsdWVzfS4gYCArXG4gICAgICAgICAgYCcke3ByZWZzLlNpbXVsYXRvcldpbmRvd09yaWVudGF0aW9ufScgaXMgYXNzaWduZWQgaW5zdGVhZC5gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIV8uaXNVbmRlZmluZWQocHJlZnMuU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSkpIHtcbiAgICAgIGlmICghXy5pc051bWJlcihwcmVmcy5TaW11bGF0b3JXaW5kb3dSb3RhdGlvbkFuZ2xlKSkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgU2ltdWxhdG9yV2luZG93Um90YXRpb25BbmdsZSBpcyBleHBlY3RlZCB0byBiZSBhIHZhbGlkIG51bWJlci4gYCArXG4gICAgICAgICAgYCcke3ByZWZzLlNpbXVsYXRvcldpbmRvd1JvdGF0aW9uQW5nbGV9JyBpcyBhc3NpZ25lZCBpbnN0ZWFkLmApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgdGhlIGNvbW1vbiBpT1MgU2ltdWxhdG9yIHByZWZlcmVuY2VzIGZpbGUgd2l0aCBuZXcgdmFsdWVzLlxuICAgKiBJdCBpcyBuZWNlc3NhcnkgdG8gcmVzdGFydCB0aGUgY29ycmVzcG9uZGluZyBTaW11bGF0b3IgYmVmb3JlXG4gICAqIHRoZXNlIGNoYW5nZXMgYXJlIGFwcGxpZWQuXG4gICAqXG4gICAqIEBwYXJhbSB7RGV2aWNlUHJlZmVyZW5jZXN9IGRldmljZVByZWZzIFt7fV0gLSBUaGUgbWFwcGluZywgd2hpY2ggcmVwcmVzZW50cyBuZXcgZGV2aWNlIHByZWZlcmVuY2UgdmFsdWVzXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3IgdGhlIGdpdmVuIFNpbXVsYXRvci5cbiAgICogQHBhcmFtIHtDb21tb25QcmVmZXJlbmNlc30gY29tbW9uUHJlZnMgW3t9XSAtIFRoZSBtYXBwaW5nLCB3aGljaCByZXByZXNlbnRzIG5ldyBjb21tb24gcHJlZmVyZW5jZSB2YWx1ZXNcbiAgICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBhbGwgU2ltdWxhdG9ycy5cbiAgICogQHJldHVybiB7Ym9vbGVhbn0gVHJ1ZSBpZiB0aGUgcHJlZmVyZW5jZXMgd2VyZSBzdWNjZXNzZnVsbHkgdXBkYXRlZC5cbiAgICovXG4gIGFzeW5jIHVwZGF0ZVByZWZlcmVuY2VzIChkZXZpY2VQcmVmcyA9IHt9LCBjb21tb25QcmVmcyA9IHt9KSB7XG4gICAgaWYgKCFfLmlzRW1wdHkoZGV2aWNlUHJlZnMpKSB7XG4gICAgICBsb2cuZGVidWcoYFNldHRpbmcgcHJlZmVyZW5jZXMgb2YgJHt0aGlzLnVkaWR9IFNpbXVsYXRvciB0byAke0pTT04uc3RyaW5naWZ5KGRldmljZVByZWZzKX1gKTtcbiAgICB9XG4gICAgaWYgKCFfLmlzRW1wdHkoY29tbW9uUHJlZnMpKSB7XG4gICAgICBsb2cuZGVidWcoYFNldHRpbmcgY29tbW9uIFNpbXVsYXRvciBwcmVmZXJlbmNlcyB0byAke0pTT04uc3RyaW5naWZ5KGNvbW1vblByZWZzKX1gKTtcbiAgICB9XG4gICAgY29uc3QgaG9tZUZvbGRlclBhdGggPSBwcm9jZXNzLmVudi5IT01FO1xuICAgIGlmICghaG9tZUZvbGRlclBhdGgpIHtcbiAgICAgIGxvZy53YXJuKGBDYW5ub3QgZ2V0IHRoZSBwYXRoIHRvIEhPTUUgZm9sZGVyIGZyb20gdGhlIHByb2Nlc3MgZW52aXJvbm1lbnQuIGAgK1xuICAgICAgICBgSWdub3JpbmcgU2ltdWxhdG9yIHByZWZlcmVuY2VzIHVwZGF0ZS5gKTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgdGhpcy52ZXJpZnlEZXZpY2VQcmVmZXJlbmNlcyhkZXZpY2VQcmVmcyk7XG4gICAgY29uc3QgcGxpc3RQYXRoID0gcGF0aC5yZXNvbHZlKGhvbWVGb2xkZXJQYXRoLCAnTGlicmFyeScsICdQcmVmZXJlbmNlcycsICdjb20uYXBwbGUuaXBob25lc2ltdWxhdG9yLnBsaXN0Jyk7XG4gICAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MocGxpc3RQYXRoKSkge1xuICAgICAgbG9nLndhcm4oYFNpbXVsYXRvciBwcmVmZXJlbmNlcyBmaWxlICcke3BsaXN0UGF0aH0nIGlzIG5vdCBhY2Nlc3NpYmxlLiBgICtcbiAgICAgICAgYElnbm9yaW5nIFNpbXVsYXRvciBwcmVmZXJlbmNlcyB1cGRhdGUuYCk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuICAgIGxldCBuZXdQcmVmcyA9IHt9O1xuICAgIGlmICghXy5pc0VtcHR5KGRldmljZVByZWZzKSkge1xuICAgICAgbmV3UHJlZnMuRGV2aWNlUHJlZmVyZW5jZXMgPSB7W3RoaXMudWRpZC50b1VwcGVyQ2FzZSgpXTogZGV2aWNlUHJlZnN9O1xuICAgIH1cbiAgICBuZXdQcmVmcyA9IF8ubWVyZ2UobmV3UHJlZnMsIGNvbW1vblByZWZzKTtcbiAgICByZXR1cm4gYXdhaXQgcHJlZmVyZW5jZXNQbGlzdEd1YXJkLmFjcXVpcmUoU2ltdWxhdG9yWGNvZGU5Lm5hbWUsIGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGN1cnJlbnRQbGlzdENvbnRlbnQgPSBhd2FpdCBwbGlzdC5wYXJzZVBsaXN0RmlsZShwbGlzdFBhdGgpO1xuICAgICAgICBhd2FpdCBwbGlzdC51cGRhdGVQbGlzdEZpbGUocGxpc3RQYXRoLCBfLm1lcmdlKGN1cnJlbnRQbGlzdENvbnRlbnQsIG5ld1ByZWZzKSwgdHJ1ZSk7XG4gICAgICAgIGxvZy5kZWJ1ZyhgVXBkYXRlZCAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHByZWZlcmVuY2VzIGF0ICcke3BsaXN0UGF0aH0nIHdpdGggJHtKU09OLnN0cmluZ2lmeShuZXdQcmVmcyl9YCk7XG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgfSBjYXRjaCAoZSkge1xuICAgICAgICBsb2cud2FybihgQ2Fubm90IHVwZGF0ZSAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHByZWZlcmVuY2VzIGF0ICcke3BsaXN0UGF0aH0nLiBgICtcbiAgICAgICAgICAgICAgICAgYFRyeSB0byBkZWxldGUgdGhlIGZpbGUgbWFudWFsbHkgaW4gb3JkZXIgdG8gcmVzZXQgaXQuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNodXQgZG93biB0aGUgY3VycmVudCBTaW11bGF0b3IuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgc2h1dGRvd24gKCkge1xuICAgIGNvbnN0IHtzdGF0ZX0gPSBhd2FpdCB0aGlzLnN0YXQoKTtcbiAgICBpZiAoc3RhdGUgPT09ICdTaHV0ZG93bicpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgYXdhaXQgcmV0cnlJbnRlcnZhbCg1LCA1MDAsIHNpbWN0bFNodXRkb3duLCB0aGlzLnVkaWQpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlc2V0IHRoZSBjdXJyZW50IFNpbXVsYXRvciB0byB0aGUgY2xlYW4gc3RhdGUuXG4gICAqIEBvdmVycmlkZVxuICAgKi9cbiAgYXN5bmMgY2xlYW4gKCkge1xuICAgIGxvZy5pbmZvKGBDbGVhbmluZyBzaW11bGF0b3IgJHt0aGlzLnVkaWR9YCk7XG4gICAgYXdhaXQgZXJhc2VEZXZpY2UodGhpcy51ZGlkLCAxMDAwMCk7XG4gIH1cblxuICAvKipcbiAgICogQGluaGVyaXRkb2NcbiAgICogQG92ZXJyaWRlXG4gICAqIEBwcml2YXRlXG4gICAqL1xuICBhc3luYyBfYWN0aXZhdGVXaW5kb3cgKCkge1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBmYnNpbWN0bC5mb2N1cyh0aGlzLnVkaWQpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLndhcm4oYENhbm5vdCBmb2N1cyBTaW11bGF0b3Igd2luZG93IHdpdGggZmJzaW1jdGwuIERlZmF1bHRpbmcgdG8gQXBwbGVTY3JpcHQuIGAgK1xuICAgICAgICBgT3JpZ2luYWwgZXJyb3I6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICBjb25zdCB7bmFtZSwgc2RrfSA9IGF3YWl0IHRoaXMuc3RhdCgpO1xuICAgICAgcmV0dXJuIGBcbiAgICAgICAgdGVsbCBhcHBsaWNhdGlvbiBcIlN5c3RlbSBFdmVudHNcIlxuICAgICAgICAgIHRlbGwgcHJvY2VzcyBcIlNpbXVsYXRvclwiXG4gICAgICAgICAgICBzZXQgZnJvbnRtb3N0IHRvIGZhbHNlXG4gICAgICAgICAgICBzZXQgZnJvbnRtb3N0IHRvIHRydWVcbiAgICAgICAgICAgIGNsaWNrIChtZW51IGl0ZW0gMSB3aGVyZSAoaXRzIG5hbWUgY29udGFpbnMgXCIke25hbWV9IC1cIiBhbmQgaXRzIG5hbWUgY29udGFpbnMgXCIke3Nka31cIikpIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiV2luZG93XCIgb2YgbWVudSBiYXIgMVxuICAgICAgICAgIGVuZCB0ZWxsXG4gICAgICAgIGVuZCB0ZWxsXG4gICAgICBgO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGlzQmlvbWV0cmljRW5yb2xsZWQgKCkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgc3Bhd24odGhpcy51ZGlkLCBbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLWcnLCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUlxuICAgIF0pO1xuICAgIGNvbnN0IG1hdGNoID0gKG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAoRU5ST0xMTUVOVF9OT1RJRklDQVRJT05fUkVDRUlWRVIpfVxcXFxzKyhbMDFdKWApKVxuICAgICAgLmV4ZWMoc3Rkb3V0KTtcbiAgICBpZiAoIW1hdGNoKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBwYXJzZSBiaW9tZXRyaWMgZW5yb2xsbWVudCBzdGF0ZSBmcm9tICcke3N0ZG91dH0nYCk7XG4gICAgfVxuICAgIGxvZy5pbmZvKGBDdXJyZW50IGJpb21ldHJpYyBlbnJvbGxlZCBzdGF0ZSBmb3IgJHt0aGlzLnVkaWR9IFNpbXVsYXRvcjogJHttYXRjaFsxXX1gKTtcbiAgICByZXR1cm4gbWF0Y2hbMV0gPT09ICcxJztcbiAgfVxuXG4gIC8qKlxuICAgKiBAaW5oZXJpdGRvY1xuICAgKiBAb3ZlcnJpZGVcbiAgICovXG4gIGFzeW5jIGVucm9sbEJpb21ldHJpYyAoaXNFbmFibGVkID0gdHJ1ZSkge1xuICAgIGxvZy5kZWJ1ZyhgU2V0dGluZyBiaW9tZXRyaWMgZW5yb2xsZWQgc3RhdGUgZm9yICR7dGhpcy51ZGlkfSBTaW11bGF0b3IgdG8gJyR7aXNFbmFibGVkID8gJ2VuYWJsZWQnIDogJ2Rpc2FibGVkJ30nYCk7XG4gICAgYXdhaXQgc3Bhd24odGhpcy51ZGlkLCBbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLXMnLCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUiwgaXNFbmFibGVkID8gJzEnIDogJzAnXG4gICAgXSk7XG4gICAgYXdhaXQgc3Bhd24odGhpcy51ZGlkLCBbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLXAnLCBFTlJPTExNRU5UX05PVElGSUNBVElPTl9SRUNFSVZFUlxuICAgIF0pO1xuICAgIGlmIChhd2FpdCB0aGlzLmlzQmlvbWV0cmljRW5yb2xsZWQoKSAhPT0gaXNFbmFibGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBzZXQgYmlvbWV0cmljIGVucm9sbGVkIHN0YXRlIGZvciAke3RoaXMudWRpZH0gU2ltdWxhdG9yIHRvICcke2lzRW5hYmxlZCA/ICdlbmFibGVkJyA6ICdkaXNhYmxlZCd9J2ApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kcyBhIG5vdGlmaWNhdGlvbiB0byBtYXRjaC9ub3QgbWF0Y2ggdGhlIHBhcnRpY3VsYXIgYmlvbWV0cmljLlxuICAgKiBAb3ZlcnJpZGVcbiAgICpcbiAgICogQHBhcmFtIHs/Ym9vbGVhbn0gc2hvdWxkTWF0Y2ggW3RydWVdIC0gU2V0IGl0IHRvIHRydWUgb3IgZmFsc2UgaW4gb3JkZXIgdG8gZW11bGF0ZVxuICAgKiBtYXRjaGluZy9ub3QgbWF0Y2hpbmcgdGhlIGNvcnJlc3BvbmRpbmcgYmlvbWV0cmljXG4gICAqIEBwYXJhbSB7P3N0cmluZ30gYmlvbWV0cmljTmFtZSBbdG91Y2hJZF0gLSBFaXRoZXIgdG91Y2hJZCBvciBmYWNlSWQgKGZhY2VJZCBpcyBvbmx5IGF2YWlsYWJsZSBzaW5jZSBpT1MgMTEpXG4gICAqL1xuICBhc3luYyBzZW5kQmlvbWV0cmljTWF0Y2ggKHNob3VsZE1hdGNoID0gdHJ1ZSwgYmlvbWV0cmljTmFtZSA9ICd0b3VjaElkJykge1xuICAgIGNvbnN0IGRvbWFpbkNvbXBvbmVudCA9IHRvQmlvbWV0cmljRG9tYWluQ29tcG9uZW50KGJpb21ldHJpY05hbWUpO1xuICAgIGNvbnN0IGRvbWFpbiA9IGBjb20uYXBwbGUuQmlvbWV0cmljS2l0X1NpbS4ke2RvbWFpbkNvbXBvbmVudH0uJHtzaG91bGRNYXRjaCA/ICcnIDogJ25vJ31tYXRjaGA7XG4gICAgYXdhaXQgc3Bhd24odGhpcy51ZGlkLCBbXG4gICAgICAnbm90aWZ5dXRpbCcsXG4gICAgICAnLXAnLCBkb21haW5cbiAgICBdKTtcbiAgICBsb2cuaW5mbyhgU2VudCBub3RpZmljYXRpb24gJHtkb21haW59IHRvICR7c2hvdWxkTWF0Y2ggPyAnbWF0Y2gnIDogJ25vdCBtYXRjaCd9ICR7YmlvbWV0cmljTmFtZX0gYmlvbWV0cmljIGAgK1xuICAgICAgYGZvciAke3RoaXMudWRpZH0gU2ltdWxhdG9yYCk7XG4gIH1cblxuICAvKipcbiAgICogQG92ZXJyaWRlXG4gICAqL1xuICBhc3luYyBnZXRMYXVuY2hEYWVtb25zUm9vdCAoKSB7XG4gICAgY29uc3QgZGV2Um9vdCA9IGF3YWl0IGdldERldmVsb3BlclJvb3QoKTtcbiAgICByZXR1cm4gcGF0aC5yZXNvbHZlKGRldlJvb3QsXG4gICAgICAnUGxhdGZvcm1zL2lQaG9uZU9TLnBsYXRmb3JtL0RldmVsb3Blci9MaWJyYXJ5L0NvcmVTaW11bGF0b3IvUHJvZmlsZXMvUnVudGltZXMvaU9TLnNpbXJ1bnRpbWUvQ29udGVudHMvUmVzb3VyY2VzL1J1bnRpbWVSb290L1N5c3RlbS9MaWJyYXJ5L0xhdW5jaERhZW1vbnMnKTtcbiAgfVxuXG59XG5cbmV4cG9ydCBkZWZhdWx0IFNpbXVsYXRvclhjb2RlOTtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci14Y29kZS05LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
