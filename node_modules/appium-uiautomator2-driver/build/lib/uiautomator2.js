"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _asyncbox = require("asyncbox");

var _logger = _interopRequireDefault(require("./logger"));

var _appiumUiautomator2Server = require("appium-uiautomator2-server");

var _adbkit = _interopRequireDefault(require("adbkit"));

var _utils = require("./utils");

var _appiumSupport = require("appium-support");

const REQD_PARAMS = ['adb', 'tmpDir', 'host', 'systemPort', 'devicePort', 'disableWindowAnimation'];
const SERVER_LAUNCH_RETRIES = 20;
const SERVER_INSTALL_RETRIES = 20;
const INSTRUMENTATION_TARGET = 'io.appium.uiautomator2.server.test/androidx.test.runner.AndroidJUnitRunner';
const SERVER_PACKAGE_ID = 'io.appium.uiautomator2.server';
const SERVER_TEST_PACKAGE_ID = `${SERVER_PACKAGE_ID}.test`;

class UiAutomator2Server {
  constructor(opts = {}) {
    for (let req of REQD_PARAMS) {
      if (!opts || !_appiumSupport.util.hasValue(opts[req])) {
        throw new Error(`Option '${req}' is required!`);
      }

      this[req] = opts[req];
    }

    this.jwproxy = new _appiumBaseDriver.JWProxy({
      server: this.host,
      port: this.systemPort
    });
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.client = _adbkit.default.createClient({
      port: this.adb.adbPort,
      host: this.host
    });
  }

  async installServerApk(installTimeout = SERVER_INSTALL_RETRIES * 1000) {
    const packagesInfo = [{
      appPath: _appiumUiautomator2Server.SERVER_APK_PATH,
      appId: SERVER_PACKAGE_ID
    }, {
      appPath: _appiumUiautomator2Server.TEST_APK_PATH,
      appId: SERVER_TEST_PACKAGE_ID
    }];
    let shouldUninstallServerPackages = false;
    let shouldInstallServerPackages = false;

    for (const _ref of packagesInfo) {
      const {
        appId,
        appPath
      } = _ref;

      if (appId === SERVER_TEST_PACKAGE_ID) {
        if (!(await this.adb.checkApkCert(appPath, appId))) {
          await this.adb.sign(appPath);
          shouldUninstallServerPackages = shouldUninstallServerPackages || (await this.adb.isAppInstalled(appId));
          shouldInstallServerPackages = true;
        }

        continue;
      }

      const appState = await this.adb.getApplicationInstallState(appPath, appId);

      _logger.default.debug(`${appId} installation state: ${appState}`);

      if (await this.adb.checkApkCert(appPath, appId)) {
        shouldUninstallServerPackages = shouldUninstallServerPackages || [this.adb.APP_INSTALL_STATE.OLDER_VERSION_INSTALLED, this.adb.APP_INSTALL_STATE.NEWER_VERSION_INSTALLED].includes(appState);
      } else {
        await this.adb.sign(appPath);
        shouldUninstallServerPackages = shouldUninstallServerPackages || ![this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);
      }

      shouldInstallServerPackages = shouldInstallServerPackages || shouldUninstallServerPackages || [this.adb.APP_INSTALL_STATE.NOT_INSTALLED].includes(appState);
    }

    _logger.default.info(`Server packages are ${shouldInstallServerPackages ? '' : 'not '}going to be (re)installed`);

    if (shouldInstallServerPackages && shouldUninstallServerPackages) {
      _logger.default.info('Full packages reinstall is going to be performed');
    }

    for (const _ref2 of packagesInfo) {
      const {
        appId,
        appPath
      } = _ref2;

      if (shouldUninstallServerPackages) {
        try {
          await this.adb.uninstallApk(appId);
        } catch (err) {
          _logger.default.warn(`Error uninstalling '${appId}': ${err.message}`);
        }
      }

      if (shouldInstallServerPackages) {
        await this.adb.install(appPath, {
          replace: false,
          timeout: installTimeout
        });
      }
    }

    let retries = (0, _utils.getRetries)('Server install', installTimeout, SERVER_INSTALL_RETRIES);

    _logger.default.debug(`Waiting up to ${retries * 1000}ms for instrumentation '${INSTRUMENTATION_TARGET}' to be available`);

    let output;

    try {
      await (0, _asyncbox.retryInterval)(retries, 1000, async () => {
        output = await this.adb.shell(['pm', 'list', 'instrumentation']);

        if (output.indexOf('Could not access the Package Manager') !== -1) {
          let err = new Error(`Problem running package manager: ${output}`);
          output = null;
          throw err;
        } else if (output.indexOf(INSTRUMENTATION_TARGET) === -1) {
          throw new Error('No instrumentation process found. Retrying...');
        }

        _logger.default.debug(`Instrumentation '${INSTRUMENTATION_TARGET}' available`);
      });
    } catch (err) {
      _logger.default.error(`Unable to find instrumentation target '${INSTRUMENTATION_TARGET}': ${err.message}`);

      if (output) {
        _logger.default.debug('Available targets:');

        for (let line of output.split('\n')) {
          _logger.default.debug(`    ${line.replace('instrumentation:', '')}`);
        }
      }
    }
  }

  async startSession(caps) {
    await this.killUiAutomatorOnDevice();

    if (caps.skipServerInstallation) {
      _logger.default.info(`'skipServerInstallation' is set. Attempting to use UIAutomator2 server from the device.`);
    } else {
      _logger.default.info(`Starting UIAutomator2 server ${_appiumUiautomator2Server.version}`);

      _logger.default.info(`Using UIAutomator2 server from '${_appiumUiautomator2Server.SERVER_APK_PATH}' and test from '${_appiumUiautomator2Server.TEST_APK_PATH}'`);
    }

    await this.startSessionUsingAdbKit(caps.deviceUDID);
    let retries = (0, _utils.getRetries)('Server launch', caps.uiautomator2ServerLaunchTimeout, SERVER_LAUNCH_RETRIES);

    _logger.default.info(`Waiting up to ${retries * 1000}ms for UiAutomator2 to be online...`);

    await (0, _asyncbox.retryInterval)(retries, 1000, this.jwproxy.command.bind(this.jwproxy), '/status', 'GET');
    await this.jwproxy.command('/session', 'POST', {
      desiredCapabilities: caps
    });
  }

  async startSessionUsingAdbKit(deviceUDID) {
    let cmd = 'am instrument -w';

    if (this.disableWindowAnimation) {
      cmd = `${cmd} --no-window-animation`;
    }

    cmd = `${cmd} ${INSTRUMENTATION_TARGET}`;

    _logger.default.info(`Running command: 'adb -s ${deviceUDID} shell ${cmd}'`);

    this.client.shell(deviceUDID, cmd).then(_adbkit.default.util.readAll).then(function (output) {
      for (let line of output.toString().split('\n')) {
        if (line.length) {
          _logger.default.debug(`[UIAutomator2] ${line}`);
        }
      }
    }).catch(function (err) {
      _logger.default.error(`[UIAutomator2 Error] ${err.message}`);

      _logger.default.debug(`Full error: ${err.stack}`);
    });
  }

  async deleteSession() {
    _logger.default.debug('Deleting UiAutomator2 server session');

    try {
      await this.jwproxy.command('/', 'DELETE');
    } catch (err) {
      _logger.default.warn(`Did not get confirmation UiAutomator2 deleteSession worked; ` + `Error was: ${err}`);
    }
  }

  async killUiAutomatorOnDevice() {
    try {
      const pids = (await this.adb.getPIDsByName('uiautomator')).map(p => `${p}`);

      if (!_lodash.default.isEmpty(pids)) {
        const isRoot = await this.adb.root();

        try {
          await this.adb.shell(['kill', '-9', ...pids]);
        } finally {
          if (isRoot) {
            await this.adb.unroot();
          }
        }
      }
    } catch (err) {
      _logger.default.warn(`Unable to stop uiautomator process: ${err.message}`);
    }

    try {
      await this.adb.forceStop('io.appium.uiautomator2.server');
    } catch (ignore) {
      _logger.default.info("Unable to kill the io.appium.uiautomator2.server process, assuming it is already killed");
    }
  }

}

var _default = UiAutomator2Server;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi91aWF1dG9tYXRvcjIuanMiXSwibmFtZXMiOlsiUkVRRF9QQVJBTVMiLCJTRVJWRVJfTEFVTkNIX1JFVFJJRVMiLCJTRVJWRVJfSU5TVEFMTF9SRVRSSUVTIiwiSU5TVFJVTUVOVEFUSU9OX1RBUkdFVCIsIlNFUlZFUl9QQUNLQUdFX0lEIiwiU0VSVkVSX1RFU1RfUEFDS0FHRV9JRCIsIlVpQXV0b21hdG9yMlNlcnZlciIsImNvbnN0cnVjdG9yIiwib3B0cyIsInJlcSIsInV0aWwiLCJoYXNWYWx1ZSIsIkVycm9yIiwiandwcm94eSIsIkpXUHJveHkiLCJzZXJ2ZXIiLCJob3N0IiwicG9ydCIsInN5c3RlbVBvcnQiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJjbGllbnQiLCJhZGJraXQiLCJjcmVhdGVDbGllbnQiLCJhZGIiLCJhZGJQb3J0IiwiaW5zdGFsbFNlcnZlckFwayIsImluc3RhbGxUaW1lb3V0IiwicGFja2FnZXNJbmZvIiwiYXBwUGF0aCIsImFwa1BhdGgiLCJhcHBJZCIsInRlc3RBcGtQYXRoIiwic2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMiLCJzaG91bGRJbnN0YWxsU2VydmVyUGFja2FnZXMiLCJjaGVja0Fwa0NlcnQiLCJzaWduIiwiaXNBcHBJbnN0YWxsZWQiLCJhcHBTdGF0ZSIsImdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlIiwibG9nZ2VyIiwiZGVidWciLCJBUFBfSU5TVEFMTF9TVEFURSIsIk9MREVSX1ZFUlNJT05fSU5TVEFMTEVEIiwiTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQiLCJpbmNsdWRlcyIsIk5PVF9JTlNUQUxMRUQiLCJpbmZvIiwidW5pbnN0YWxsQXBrIiwiZXJyIiwid2FybiIsIm1lc3NhZ2UiLCJpbnN0YWxsIiwicmVwbGFjZSIsInRpbWVvdXQiLCJyZXRyaWVzIiwib3V0cHV0Iiwic2hlbGwiLCJpbmRleE9mIiwiZXJyb3IiLCJsaW5lIiwic3BsaXQiLCJzdGFydFNlc3Npb24iLCJjYXBzIiwia2lsbFVpQXV0b21hdG9yT25EZXZpY2UiLCJza2lwU2VydmVySW5zdGFsbGF0aW9uIiwic2VydmVyVmVyc2lvbiIsInN0YXJ0U2Vzc2lvblVzaW5nQWRiS2l0IiwiZGV2aWNlVURJRCIsInVpYXV0b21hdG9yMlNlcnZlckxhdW5jaFRpbWVvdXQiLCJjb21tYW5kIiwiZGVzaXJlZENhcGFiaWxpdGllcyIsImNtZCIsImRpc2FibGVXaW5kb3dBbmltYXRpb24iLCJ0aGVuIiwicmVhZEFsbCIsInRvU3RyaW5nIiwibGVuZ3RoIiwiY2F0Y2giLCJzdGFjayIsImRlbGV0ZVNlc3Npb24iLCJwaWRzIiwiZ2V0UElEc0J5TmFtZSIsIm1hcCIsInAiLCJfIiwiaXNFbXB0eSIsImlzUm9vdCIsInJvb3QiLCJ1bnJvb3QiLCJmb3JjZVN0b3AiLCJpZ25vcmUiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEsV0FBVyxHQUFHLENBQUMsS0FBRCxFQUFRLFFBQVIsRUFBa0IsTUFBbEIsRUFBMEIsWUFBMUIsRUFBd0MsWUFBeEMsRUFBc0Qsd0JBQXRELENBQXBCO0FBQ0EsTUFBTUMscUJBQXFCLEdBQUcsRUFBOUI7QUFDQSxNQUFNQyxzQkFBc0IsR0FBRyxFQUEvQjtBQUNBLE1BQU1DLHNCQUFzQixHQUFHLDRFQUEvQjtBQUNBLE1BQU1DLGlCQUFpQixHQUFHLCtCQUExQjtBQUNBLE1BQU1DLHNCQUFzQixHQUFJLEdBQUVELGlCQUFrQixPQUFwRDs7QUFHQSxNQUFNRSxrQkFBTixDQUF5QjtBQUN2QkMsRUFBQUEsV0FBVyxDQUFFQyxJQUFJLEdBQUcsRUFBVCxFQUFhO0FBQ3RCLFNBQUssSUFBSUMsR0FBVCxJQUFnQlQsV0FBaEIsRUFBNkI7QUFDM0IsVUFBSSxDQUFDUSxJQUFELElBQVMsQ0FBQ0Usb0JBQUtDLFFBQUwsQ0FBY0gsSUFBSSxDQUFDQyxHQUFELENBQWxCLENBQWQsRUFBd0M7QUFDdEMsY0FBTSxJQUFJRyxL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LE1BQVQsRUFBTjtBQUNEO0FBQ0Y7QUFDRjtBQUNGLEtBWkQsQ0FZRSxPQUFPeEMsR0FBUCxFQUFZO0FBQ1pULHNCQUFPVSxJQUFQLENBQWEsdUNBQXNDRCxHQUFHLENBQUNFLE9BQVEsRUFBL0Q7QUFDRDs7QUFFRCxRQUFJO0FBQ0YsWUFBTSxLQUFLM0IsR0FBTCxDQUFTa0UsU0FBVCxDQUFtQiwrQkFBbkIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPQyxNQUFQLEVBQWU7QUFDZm5ELHNCQUFPTyxJQUFQLENBQVkseUZBQVo7QUFDRDtBQUNGOztBQWpNc0I7O2VBb01WekMsa0IiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgSldQcm94eSB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyByZXRyeUludGVydmFsIH0gZnJvbSAnYXN5bmNib3gnO1xuaW1wb3J0IGxvZ2dlciBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBTRVJWRVJfQVBLX1BBVEggYXMgYXBrUGF0aCwgVEVTVF9BUEtfUEFUSCBhcyB0ZXN0QXBrUGF0aCwgdmVyc2lvbiBhcyBzZXJ2ZXJWZXJzaW9uIH0gZnJvbSAnYXBwaXVtLXVpYXV0b21hdG9yMi1zZXJ2ZXInO1xuaW1wb3J0IGFkYmtpdCBmcm9tICdhZGJraXQnO1xuaW1wb3J0IHsgZ2V0UmV0cmllcyB9IGZyb20gJy4vdXRpbHMnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcblxuXG5jb25zdCBSRVFEX1BBUkFNUyA9IFsnYWRiJywgJ3RtcERpcicsICdob3N0JywgJ3N5c3RlbVBvcnQnLCAnZGV2aWNlUG9ydCcsICdkaXNhYmxlV2luZG93QW5pbWF0aW9uJ107XG5jb25zdCBTRVJWRVJfTEFVTkNIX1JFVFJJRVMgPSAyMDtcbmNvbnN0IFNFUlZFUl9JTlNUQUxMX1JFVFJJRVMgPSAyMDtcbmNvbnN0IElOU1RSVU1FTlRBVElPTl9UQVJHRVQgPSAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXIudGVzdC9hbmRyb2lkeC50ZXN0LnJ1bm5lci5BbmRyb2lkSlVuaXRSdW5uZXInO1xuY29uc3QgU0VSVkVSX1BBQ0tBR0VfSUQgPSAnaW8uYXBwaXVtLnVpYXV0b21hdG9yMi5zZXJ2ZXInO1xuY29uc3QgU0VSVkVSX1RFU1RfUEFDS0FHRV9JRCA9IGAke1NFUlZFUl9QQUNLQUdFX0lEfS50ZXN0YDtcblxuXG5jbGFzcyBVaUF1dG9tYXRvcjJTZXJ2ZXIge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgZm9yIChsZXQgcmVxIG9mIFJFUURfUEFSQU1TKSB7XG4gICAgICBpZiAoIW9wdHMgfHwgIXV0aWwuaGFzVmFsdWUob3B0c1tyZXFdKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYE9wdGlvbiAnJHtyZXF9JyBpcyByZXF1aXJlZCFgKTtcbiAgICAgIH1cbiAgICAgIHRoaXNbcmVxXSA9IG9wdHNbcmVxXTtcbiAgICB9XG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkoe3NlcnZlcjogdGhpcy5ob3N0LCBwb3J0OiB0aGlzLnN5c3RlbVBvcnR9KTtcbiAgICB0aGlzLnByb3h5UmVxUmVzID0gdGhpcy5qd3Byb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5qd3Byb3h5KTtcblxuICAgIHRoaXMuY2xpZW50ID0gYWRia2l0LmNyZWF0ZUNsaWVudCh7XG4gICAgICBwb3J0OiB0aGlzLmFkYi5hZGJQb3J0LFxuICAgICAgaG9zdDogdGhpcy5ob3N0XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogSW5zdGFsbHMgdGhlIGFwa3Mgb24gdG8gdGhlIGRldmljZSBvciBlbXVsYXRvci5cbiAgICpcbiAgICogQHBhcmFtIHtudW1iZXJ9IGluc3RhbGxUaW1lb3V0IC0gSW5zdGFsbGF0aW9uIHRpbWVvdXRcbiAgICovXG4gIGFzeW5jIGluc3RhbGxTZXJ2ZXJBcGsgKGluc3RhbGxUaW1lb3V0ID0gU0VSVkVSX0lOU1RBTExfUkVUUklFUyAqIDEwMDApIHtcbiAgICBjb25zdCBwYWNrYWdlc0luZm8gPSBbXG4gICAgICB7XG4gICAgICAgIGFwcFBhdGg6IGFwa1BhdGgsXG4gICAgICAgIGFwcElkOiBTRVJWRVJfUEFDS0FHRV9JRCxcbiAgICAgIH0sIHtcbiAgICAgICAgYXBwUGF0aDogdGVzdEFwa1BhdGgsXG4gICAgICAgIGFwcElkOiBTRVJWRVJfVEVTVF9QQUNLQUdFX0lELFxuICAgICAgfSxcbiAgICBdO1xuICAgIGxldCBzaG91bGRVbmluc3RhbGxTZXJ2ZXJQYWNrYWdlcyA9IGZhbHNlO1xuICAgIGxldCBzaG91bGRJbnN0YWxsU2VydmVyUGFja2FnZXMgPSBmYWxzZTtcbiAgICBmb3IgKGNvbnN0IHthcHBJZCwgYXBwUGF0aH0gb2YgcGFja2FnZXNJbmZvKSB7XG4gICAgICBpZiAoYXBwSWQgPT09IFNFUlZFUl9URVNUX1BBQ0tBR0VfSUQpIHtcbiAgICAgICAgLy8gVGhlcmUgaXMgbm8gcG9pbnQgaW4gZ2V0dGluZyB0aGUgc3RhdGUgZm9yIHRlc3Qgc2VydmVyLFxuICAgICAgICAvLyBzaW5jZSBpdCBkb2VzIG5vdCBjb250YWluIHZlcnNpb24gaW5mb1xuICAgICAgICBpZiAoIWF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcHBQYXRoLCBhcHBJZCkpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLmFkYi5zaWduKGFwcFBhdGgpO1xuICAgICAgICAgIHNob3VsZFVuaW5zdGFsbFNlcnZlclBhY2thZ2VzID0gc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXNcbiAgICAgICAgICAgIHx8IGF3YWl0IHRoaXMuYWRiLmlzQXBwSW5zdGFsbGVkKGFwcElkKTtcbiAgICAgICAgICBzaG91bGRJbnN0YWxsU2VydmVyUGFja2FnZXMgPSB0cnVlO1xuICAgICAgICB9XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBhcHBTdGF0ZSA9IGF3YWl0IHRoaXMuYWRiLmdldEFwcGxpY2F0aW9uSW5zdGFsbFN0YXRlKGFwcFBhdGgsIGFwcElkKTtcbiAgICAgIGxvZ2dlci5kZWJ1ZyhgJHthcHBJZH0gaW5zdGFsbGF0aW9uIHN0YXRlOiAke2FwcFN0YXRlfWApO1xuICAgICAgaWYgKGF3YWl0IHRoaXMuYWRiLmNoZWNrQXBrQ2VydChhcHBQYXRoLCBhcHBJZCkpIHtcbiAgICAgICAgc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMgPSBzaG91bGRVbmluc3RhbGxTZXJ2ZXJQYWNrYWdlcyB8fCBbXG4gICAgICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuT0xERVJfVkVSU0lPTl9JTlNUQUxMRUQsXG4gICAgICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTkVXRVJfVkVSU0lPTl9JTlNUQUxMRUQsXG4gICAgICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgdGhpcy5hZGIuc2lnbihhcHBQYXRoKTtcbiAgICAgICAgc2hvdWxkVW5pbnN0YWxsU2VydmVyUGFja2FnZXMgPSBzaG91bGRVbmluc3RhbGxTZXJ2ZXJQYWNrYWdlcyB8fCAhW1xuICAgICAgICAgIHRoaXMuYWRiLkFQUF9JTlNUQUxMX1NUQVRFLk5PVF9JTlNUQUxMRUQsXG4gICAgICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuICAgICAgfVxuICAgICAgc2hvdWxkSW5zdGFsbFNlcnZlclBhY2thZ2VzID0gc2hvdWxkSW5zdGFsbFNlcnZlclBhY2thZ2VzIHx8IHNob3VsZFVuaW5zdGFsbFNlcnZlclBhY2thZ2VzIHx8IFtcbiAgICAgICAgdGhpcy5hZGIuQVBQX0lOU1RBTExfU1RBVEUuTk9UX0lOU1RBTExFRCxcbiAgICAgIF0uaW5jbHVkZXMoYXBwU3RhdGUpO1xuICAgIH1cbiAgICBsb2dnZXIuaW5mbyhgU2VydmVyIHBhY2thZ2VzIGFyZSAke3Nob3VsZEluc3RhbGxTZXJ2ZXJQYWNrYWdlcyA/ICcnIDogJ25vdCAnfWdvaW5nIHRvIGJlIChyZSlpbnN0YWxsZWRgKTtcbiAgICBpZiAoc2hvdWxkSW5zdGFsbFNlcnZlclBhY2thZ2VzICYmIHNob3VsZFVuaW5zdGFsbFNlcnZlclBhY2thZ2VzKSB7XG4gICAgICBsb2dnZXIuaW5mbygnRnVsbCBwYWNrYWdlcyByZWluc3RhbGwgaXMgZ29pbmcgdG8gYmUgcGVyZm9ybWVkJyk7XG4gICAgfVxuICAgIGZvciAoY29uc3Qge2FwcElkLCBhcHBQYXRofSBvZiBwYWNrYWdlc0luZm8pIHtcbiAgICAgIGlmIChzaG91bGRVbmluc3RhbGxTZXJ2ZXJQYWNrYWdlcykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLnVuaW5zdGFsbEFwayhhcHBJZCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGxvZ2dlci53YXJuKGBFcnJvciB1bmluc3RhbGxpbmcgJyR7YXBwSWR9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgaWYgKHNob3VsZEluc3RhbGxTZXJ2ZXJQYWNrYWdlcykge1xuICAgICAgICBhd2FpdCB0aGlzLmFkYi5pbnN0YWxsKGFwcFBhdGgsIHtcbiAgICAgICAgICByZXBsYWNlOiBmYWxzZSxcbiAgICAgICAgICB0aW1lb3V0OiBpbnN0YWxsVGltZW91dCxcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIGxldCByZXRyaWVzID0gZ2V0UmV0cmllcygnU2VydmVyIGluc3RhbGwnLCBpbnN0YWxsVGltZW91dCwgU0VSVkVSX0lOU1RBTExfUkVUUklFUyk7XG5cbiAgICBsb2dnZXIuZGVidWcoYFdhaXRpbmcgdXAgdG8gJHtyZXRyaWVzICogMTAwMH1tcyBmb3IgaW5zdHJ1bWVudGF0aW9uICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JyB0byBiZSBhdmFpbGFibGVgKTtcbiAgICBsZXQgb3V0cHV0O1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDEwMDAsIGFzeW5jICgpID0+IHtcbiAgICAgICAgb3V0cHV0ID0gYXdhaXQgdGhpcy5hZGIuc2hlbGwoWydwbScsICdsaXN0JywgJ2luc3RydW1lbnRhdGlvbiddKTtcbiAgICAgICAgaWYgKG91dHB1dC5pbmRleE9mKCdDb3VsZCBub3QgYWNjZXNzIHRoZSBQYWNrYWdlIE1hbmFnZXInKSAhPT0gLTEpIHtcbiAgICAgICAgICBsZXQgZXJyID0gbmV3IEVycm9yKGBQcm9ibGVtIHJ1bm5pbmcgcGFja2FnZSBtYW5hZ2VyOiAke291dHB1dH1gKTtcbiAgICAgICAgICBvdXRwdXQgPSBudWxsOyAvLyByZW1vdmUgb3V0cHV0LCBzbyBpdCBpcyBub3QgcHJpbnRlZCBiZWxvd1xuICAgICAgICAgIHRocm93IGVycjtcbiAgICAgICAgfSBlbHNlIGlmIChvdXRwdXQuaW5kZXhPZihJTlNUUlVNRU5UQVRJT05fVEFSR0VUKSA9PT0gLTEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGluc3RydW1lbnRhdGlvbiBwcm9jZXNzIGZvdW5kLiBSZXRyeWluZy4uLicpO1xuICAgICAgICB9XG4gICAgICAgIGxvZ2dlci5kZWJ1ZyhgSW5zdHJ1bWVudGF0aW9uICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JyBhdmFpbGFibGVgKTtcbiAgICAgIH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nZ2VyLmVycm9yKGBVbmFibGUgdG8gZmluZCBpbnN0cnVtZW50YXRpb24gdGFyZ2V0ICcke0lOU1RSVU1FTlRBVElPTl9UQVJHRVR9JzogJHtlcnIubWVzc2FnZX1gKTtcbiAgICAgIGlmIChvdXRwdXQpIHtcbiAgICAgICAgbG9nZ2VyLmRlYnVnKCdBdmFpbGFibGUgdGFyZ2V0czonKTtcbiAgICAgICAgZm9yIChsZXQgbGluZSBvZiBvdXRwdXQuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgbG9nZ2VyLmRlYnVnKGAgICAgJHtsaW5lLnJlcGxhY2UoJ2luc3RydW1lbnRhdGlvbjonLCAnJyl9YCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBzdGFydFNlc3Npb24gKGNhcHMpIHtcbiAgICAvLyBraWxsIGFueSB1aWF1dG9tYXRvciBleGlzdGluZyBwcm9jZXNzZXNcbiAgICBhd2FpdCB0aGlzLmtpbGxVaUF1dG9tYXRvck9uRGV2aWNlKCk7XG5cbiAgICBpZiAoY2Fwcy5za2lwU2VydmVySW5zdGFsbGF0aW9uKSB7XG4gICAgICBsb2dnZXIuaW5mbyhgJ3NraXBTZXJ2ZXJJbnN0YWxsYXRpb24nIGlzIHNldC4gQXR0ZW1wdGluZyB0byB1c2UgVUlBdXRvbWF0b3IyIHNlcnZlciBmcm9tIHRoZSBkZXZpY2UuYCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZ2dlci5pbmZvKGBTdGFydGluZyBVSUF1dG9tYXRvcjIgc2VydmVyICR7c2VydmVyVmVyc2lvbn1gKTtcbiAgICAgIGxvZ2dlci5pbmZvKGBVc2luZyBVSUF1dG9tYXRvcjIgc2VydmVyIGZyb20gJyR7YXBrUGF0aH0nIGFuZCB0ZXN0IGZyb20gJyR7dGVzdEFwa1BhdGh9J2ApO1xuICAgIH1cblxuICAgIC8vIGxldCBjbWQgPSBbJ2FtJywgJ2luc3RydW1lbnQnLCAnLXcnLFxuICAgIC8vICAgJ2lvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyLnRlc3QvYW5kcm9pZHgudGVzdC5ydW5uZXIuQW5kcm9pZEpVbml0UnVubmVyJ107XG4gICAgLy8gdGhpcy5hZGIuc2hlbGwoY21kKTtcbiAgICAvLyB1c2luZyAzcmQgcGFydHkgbW9kdWxlIGNhbGxlZCAnYWRiS2l0JyBmb3IgdGltZSBiZWluZyBhcyB1c2luZyAnYXBwaXVtLWFkYidcbiAgICAvLyBmYWNpbmcgSWxsZWdhbFN0YXRlRXhjZXB0aW9uOiBVaUF1dG9tYXRpb24gbm90IGNvbm5lY3RlZCBleGNlcHRpb25cbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS11aWF1dG9tYXRvcjItZHJpdmVyL2lzc3Vlcy8xOVxuXG4gICAgYXdhaXQgdGhpcy5zdGFydFNlc3Npb25Vc2luZ0FkYktpdChjYXBzLmRldmljZVVESUQpO1xuXG4gICAgbGV0IHJldHJpZXMgPSBnZXRSZXRyaWVzKCdTZXJ2ZXIgbGF1bmNoJywgY2Fwcy51aWF1dG9tYXRvcjJTZXJ2ZXJMYXVuY2hUaW1lb3V0LCBTRVJWRVJfTEFVTkNIX1JFVFJJRVMpO1xuXG4gICAgbG9nZ2VyLmluZm8oYFdhaXRpbmcgdXAgdG8gJHtyZXRyaWVzICogMTAwMH1tcyBmb3IgVWlBdXRvbWF0b3IyIHRvIGJlIG9ubGluZS4uLmApO1xuICAgIC8vIHdhaXQgZm9yIFVpQXV0b21hdG9yMiB0byBiZSBvbmxpbmVcbiAgICBhd2FpdCByZXRyeUludGVydmFsKHJldHJpZXMsIDEwMDAsIHRoaXMuandwcm94eS5jb21tYW5kLmJpbmQodGhpcy5qd3Byb3h5KSwgJy9zdGF0dXMnLCAnR0VUJyk7XG4gICAgYXdhaXQgdGhpcy5qd3Byb3h5LmNvbW1hbmQoJy9zZXNzaW9uJywgJ1BPU1QnLCB7ZGVzaXJlZENhcGFiaWxpdGllczogY2Fwc30pO1xuICB9XG5cbiAgYXN5bmMgc3RhcnRTZXNzaW9uVXNpbmdBZGJLaXQgKGRldmljZVVESUQpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gICAgbGV0IGNtZCA9ICdhbSBpbnN0cnVtZW50IC13JztcbiAgICBpZiAodGhpcy5kaXNhYmxlV2luZG93QW5pbWF0aW9uKSB7XG4gICAgICBjbWQgPSBgJHtjbWR9IC0tbm8td2luZG93LWFuaW1hdGlvbmA7XG4gICAgfVxuICAgIGNtZCA9IGAke2NtZH0gJHtJTlNUUlVNRU5UQVRJT05fVEFSR0VUfWA7XG4gICAgbG9nZ2VyLmluZm8oYFJ1bm5pbmcgY29tbWFuZDogJ2FkYiAtcyAke2RldmljZVVESUR9IHNoZWxsICR7Y21kfSdgKTtcbiAgICB0aGlzLmNsaWVudC5zaGVsbChkZXZpY2VVRElELCBjbWQpXG4gICAgICAudGhlbihhZGJraXQudXRpbC5yZWFkQWxsKSAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHByb21pc2UvcHJlZmVyLWF3YWl0LXRvLXRoZW5cbiAgICAgIC50aGVuKGZ1bmN0aW9uIChvdXRwdXQpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by10aGVuXG4gICAgICAgIGZvciAobGV0IGxpbmUgb2Ygb3V0cHV0LnRvU3RyaW5nKCkuc3BsaXQoJ1xcbicpKSB7XG4gICAgICAgICAgaWYgKGxpbmUubGVuZ3RoKSB7XG4gICAgICAgICAgICBsb2dnZXIuZGVidWcoYFtVSUF1dG9tYXRvcjJdICR7bGluZX1gKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnIpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBwcm9taXNlL3ByZWZlci1hd2FpdC10by1jYWxsYmFja3NcbiAgICAgICAgbG9nZ2VyLmVycm9yKGBbVUlBdXRvbWF0b3IyIEVycm9yXSAke2Vyci5tZXNzYWdlfWApO1xuICAgICAgICBsb2dnZXIuZGVidWcoYEZ1bGwgZXJyb3I6ICR7ZXJyLnN0YWNrfWApO1xuICAgICAgfSk7XG4gIH1cblxuICBhc3luYyBkZWxldGVTZXNzaW9uICgpIHtcbiAgICBsb2dnZXIuZGVidWcoJ0RlbGV0aW5nIFVpQXV0b21hdG9yMiBzZXJ2ZXIgc2Vzc2lvbicpO1xuICAgIC8vIHJlbHkgb24gandwcm94eSdzIGludGVsbGlnZW5jZSB0byBrbm93IHdoYXQgd2UncmUgdGFsa2luZyBhYm91dCBhbmRcbiAgICAvLyBkZWxldGUgdGhlIGN1cnJlbnQgc2Vzc2lvblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmp3cHJveHkuY29tbWFuZCgnLycsICdERUxFVEUnKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBEaWQgbm90IGdldCBjb25maXJtYXRpb24gVWlBdXRvbWF0b3IyIGRlbGV0ZVNlc3Npb24gd29ya2VkOyBgICtcbiAgICAgICAgICBgRXJyb3Igd2FzOiAke2Vycn1gKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyBraWxsVWlBdXRvbWF0b3JPbkRldmljZSAoKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHBpZHMgPSAoYXdhaXQgdGhpcy5hZGIuZ2V0UElEc0J5TmFtZSgndWlhdXRvbWF0b3InKSkubWFwKChwKSA9PiBgJHtwfWApO1xuICAgICAgaWYgKCFfLmlzRW1wdHkocGlkcykpIHtcbiAgICAgICAgY29uc3QgaXNSb290ID0gYXdhaXQgdGhpcy5hZGIucm9vdCgpO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IHRoaXMuYWRiLnNoZWxsKFsna2lsbCcsICctOScsIC4uLnBpZHNdKTtcbiAgICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgICBpZiAoaXNSb290KSB7XG4gICAgICAgICAgICBhd2FpdCB0aGlzLmFkYi51bnJvb3QoKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZ2dlci53YXJuKGBVbmFibGUgdG8gc3RvcCB1aWF1dG9tYXRvciBwcm9jZXNzOiAke2Vyci5tZXNzYWdlfWApO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICBhd2FpdCB0aGlzLmFkYi5mb3JjZVN0b3AoJ2lvLmFwcGl1bS51aWF1dG9tYXRvcjIuc2VydmVyJyk7XG4gICAgfSBjYXRjaCAoaWdub3JlKSB7XG4gICAgICBsb2dnZXIuaW5mbyhcIlVuYWJsZSB0byBraWxsIHRoZSBpby5hcHBpdW0udWlhdXRvbWF0b3IyLnNlcnZlciBwcm9jZXNzLCBhc3N1bWluZyBpdCBpcyBhbHJlYWR5IGtpbGxlZFwiKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVWlBdXRvbWF0b3IyU2VydmVyO1xuIl0sImZpbGUiOiJsaWIvdWlhdXRvbWF0b3IyLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
