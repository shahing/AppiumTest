"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _lodash = _interopRequireDefault(require("lodash"));

let commands = {},
    helpers = {},
    extensions = {};
exports.helpers = helpers;
exports.commands = commands;

commands.getAlertText = async function () {
  try {
    return await this.proxyCommand('/alert/text', 'GET');
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.getText();
    }

    throw err;
  }
};

commands.setAlertText = async function (value) {
  if (_lodash.default.isString(value)) {
    value = value.split('');
  }

  try {
    return await this.proxyCommand('/alert/text', 'POST', {
      value
    });
  } catch (err) {
    if (this.isWebContext()) {
      const alert = await this.getAlert();
      return await alert.setText(value);
    }

    throw err;
  }
};

commands.postAcceptAlert = async function (opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/accept', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.ok();
  }
};

commands.postDismissAlert = async function (opts = {}) {
  try {
    let params = {};

    if (opts.buttonLabel) {
      params.name = opts.buttonLabel;
    }

    return await this.proxyCommand('/alert/dismiss', 'POST', params);
  } catch (err) {
    if (!this.isWebContext()) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }

    let alert = await this.getAlert();

    if (alert.close) {
      return await alert.close();
    }

    await alert.cancel();
  }
};

commands.getAlertButtons = async function () {
  try {
    return await this.proxyCommand('/wda/alert/buttons', 'GET');
  } catch (err) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }
};

commands.mobileHandleAlert = async function (opts = {}) {
  switch (opts.action) {
    case 'accept':
      return await this.postAcceptAlert(opts);

    case 'dismiss':
      return await this.postDismissAlert(opts);

    case 'getButtons':
      return await this.getAlertButtons();

    default:
      throw new Error(`The 'action' value should be either 'accept', 'dismiss' or 'getButtons'. ` + `'${opts.action}' is provided instead.`);
  }
};

helpers.getAlert = async function () {
  let possibleAlert = await this.findNativeElementOrElements('class name', 'XCUIElementTypeScrollView', true);

  if (possibleAlert.length !== 1) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  let possibleAlertButtons = await this.findNativeElementOrElements('class name', 'XCUIElementTypeButton', true, possibleAlert[0].ELEMENT);

  if (possibleAlertButtons.length < 1 || possibleAlertButtons.length > 2) {
    throw new _appiumBaseDriver.errors.NoAlertOpenError();
  }

  let assertButtonName = async (button, expectedName) => {
    button = button.ELEMENT ? button.ELEMENT : button;
    let name = await this.proxyCommand(`/element/${button}/attribute/name`, 'GET');

    if (name.toLowerCase() !== expectedName) {
      throw new _appiumBaseDriver.errors.NoAlertOpenError();
    }
  };

  let alert = possibleAlert[0];

  if (possibleAlertButtons.length === 1) {
    let closeButton = possibleAlertButtons[0];
    await assertButtonName(closeButton, 'close');

    alert.close = async () => {
      await this.proxyCommand(`/element/${closeButton.ELEMENT}/click`, 'POST');
    };
  } else {
    let cancelButton = possibleAlertButtons[0];
    await assertButtonName(cancelButton, 'cancel');
    let okButton = possibleAlertButtons[1];
    await assertButtonName(okButton, 'ok');

    alert.cancel = async () => {
      await this.proxyCommand(`/element/${cancelButton.ELEMENT}/click`, 'POST');
    };

    alert.ok = async () => {
      await this.proxyCommand(`/element/${okButton.ELEMENT}/click`, 'POST');
    };
  }

  alert.getText = async () => {
    let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextView', false, _appiumSupport.util.unwrapElement(alert));
    return await this.proxyCommand(`/element/${textView.ELEMENT}/attribute/value`, 'GET');
  };

  alert.setText = async value => {
    try {
      let textView = await this.findNativeElementOrElements('class name', 'XCUIElementTypeTextField', false, _appiumSupport.util.unwrapElement(alert));
      await this.proxyCommand(`/element/${textView.ELEMENT}/value `, 'POST', {
        value
      });
    } catch (err) {
      if ((0, _appiumBaseDriver.isErrorType)(err, _appiumBaseDriver.errors.NoSuchElementError)) {
        throw new Error('Tried to set text of an alert that was not a prompt');
      }

      throw err;
    }
  };

  return alert;
};

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9hbGVydC5qcyJdLCJuYW1lcyI6WyJjb21tYW5kcyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiZ2V0QWxlcnRUZXh0IiwicHJveHlDb21tYW5kIiwiZXJyIiwiaXNXZWJDb250ZXh0IiwiYWxlcnQiLCJnZXRBbGVydCIsImdldFRleHQiLCJzZXRBbGVydFRleHQiLCJ2YWx1ZSIsIl8iLCJpc1N0cmluZyIsInNwbGl0Iiwic2V0VGV4dCIsInBvc3RBY2NlcHRBbGVydCIsIm9wdHMiLCJwYXJhbXMiLCJidXR0b25MYWJlbCIsIm5hbWUiLCJlcnJvcnMiLCJOb0FsZXJ0T3BlbkVycm9yIiwiY2xvc2UiLCJvayIsInBvc3REaXNtaXNzQWxlcnQiLCJjYW5jZWwiLCJnZXRBbGVydEJ1dHRvbnMiLCJtb2JpbGVIYW5kbGVBbGVydCIsImFjdGlvbiIsIkVycm9yIiwicG9zc2libGVBbGVydCIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImxlbmd0aCIsInBvc3NpYmxlQWxlcnRCdXR0b25zIiwiRUxFTUVOVCIsImFzc2VydEJ1dHRvbk5hbWUiLCJidXR0b24iLCJleHBlY3RlZE5hbWUiLCJ0b0xvd2VyQ2FzZSIsImNsb3NlQnV0dG9uIiwiY2FuY2VsQnV0dG9uIiwib2tCdXR0b24iLCJ0ZXh0VmlldyIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiTm9TdWNoRWxlbWVudEVycm9yIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFFBQVEsR0FBRyxFQUFmO0FBQUEsSUFBbUJDLE9BQU8sR0FBRyxFQUE3QjtBQUFBLElBQWlDQyxVQUFVLEdBQUcsRUFBOUM7Ozs7QUFFQUYsUUFBUSxDQUFDRyxZQUFULEdBQXdCLGtCQUFrQjtBQUN4QyxNQUFJO0FBQ0YsV0FBTyxNQUFNLEtBQUtDLFlBQUwsQ0FBa0IsYUFBbEIsRUFBaUMsS0FBakMsQ0FBYjtBQUNELEdB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QStEQXdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjOUMsVUFBZCxFQUEwQkYsUUFBMUIsRUFBb0NDLE9BQXBDO2VBRWVDLFUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlcnJvcnMsIGlzRXJyb3JUeXBlIH0gZnJvbSAnYXBwaXVtLWJhc2UtZHJpdmVyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5sZXQgY29tbWFuZHMgPSB7fSwgaGVscGVycyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmNvbW1hbmRzLmdldEFsZXJ0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC90ZXh0JywgJ0dFVCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgY29uc3QgYWxlcnQgPSBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgICByZXR1cm4gYXdhaXQgYWxlcnQuZ2V0VGV4dCgpO1xuICAgIH1cbiAgICB0aHJvdyBlcnI7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnNldEFsZXJ0VGV4dCA9IGFzeW5jIGZ1bmN0aW9uICh2YWx1ZSkge1xuICBpZiAoXy5pc1N0cmluZyh2YWx1ZSkpIHtcbiAgICB2YWx1ZSA9IHZhbHVlLnNwbGl0KCcnKTtcbiAgfVxuICB0cnkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FsZXJ0L3RleHQnLCAnUE9TVCcsIHt2YWx1ZX0pO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBpZiAodGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgY29uc3QgYWxlcnQgPSBhd2FpdCB0aGlzLmdldEFsZXJ0KCk7XG4gICAgICByZXR1cm4gYXdhaXQgYWxlcnQuc2V0VGV4dCh2YWx1ZSk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuY29tbWFuZHMucG9zdEFjY2VwdEFsZXJ0ID0gYXN5bmMgZnVuY3Rpb24gKG9wdHMgPSB7fSkge1xuICB0cnkge1xuICAgIGxldCBwYXJhbXMgPSB7fTtcbiAgICBpZiAob3B0cy5idXR0b25MYWJlbCkge1xuICAgICAgcGFyYW1zLm5hbWUgPSBvcHRzLmJ1dHRvbkxhYmVsO1xuICAgIH1cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy9hbGVydC9hY2NlcHQnLCAnUE9TVCcsIHBhcmFtcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gICAgfVxuXG4gICAgbGV0IGFsZXJ0ID0gYXdhaXQgdGhpcy5nZXRBbGVydCgpO1xuICAgIGlmIChhbGVydC5jbG9zZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGFsZXJ0LmNsb3NlKCk7XG4gICAgfVxuICAgIGF3YWl0IGFsZXJ0Lm9rKCk7XG4gIH1cbn07XG5cbmNvbW1hbmRzLnBvc3REaXNtaXNzQWxlcnQgPSBhc3luYyBmdW5jdGlvbiAob3B0cyA9IHt9KSB7XG4gIHRyeSB7XG4gICAgbGV0IHBhcmFtcyA9IHt9O1xuICAgIGlmIChvcHRzLmJ1dHRvbkxhYmVsKSB7XG4gICAgICBwYXJhbXMubmFtZSA9IG9wdHMuYnV0dG9uTGFiZWw7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZCgnL2FsZXJ0L2Rpc21pc3MnLCAnUE9TVCcsIHBhcmFtcyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmICghdGhpcy5pc1dlYkNvbnRleHQoKSkge1xuICAgICAgdGhyb3cgbmV3IGVycm9ycy5Ob0FsZXJ0T3BlbkVycm9yKCk7XG4gICAgfVxuXG4gICAgbGV0IGFsZXJ0ID0gYXdhaXQgdGhpcy5nZXRBbGVydCgpO1xuICAgIGlmIChhbGVydC5jbG9zZSkge1xuICAgICAgcmV0dXJuIGF3YWl0IGFsZXJ0LmNsb3NlKCk7XG4gICAgfVxuICAgIGF3YWl0IGFsZXJ0LmNhbmNlbCgpO1xuICB9XG59O1xuXG5jb21tYW5kcy5nZXRBbGVydEJ1dHRvbnMgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMucHJveHlDb21tYW5kKCcvd2RhL2FsZXJ0L2J1dHRvbnMnLCAnR0VUJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBlcnJvcnMuTm9BbGVydE9wZW5FcnJvcigpO1xuICB9XG59O1xuXG5jb21tYW5kcy5tb2JpbGVIYW5kbGVBbGVydCA9IGFzeW5jIGZ1bmN0aW9uIChvcHRzID0ge30pIHtcbiAgc3dpdGNoIChvcHRzLmFjdGlvbikge1xuICAgIGNhc2UgJ2FjY2VwdCc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wb3N0QWNjZXB0QWxlcnQob3B0cyk7XG4gICAgY2FzZSAnZGlzbWlzcyc6XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5wb3N0RGlzbWlzc0FsZXJ0KG9wdHMpO1xuICAgIGNhc2UgJ2dldEJ1dHRvbnMnOlxuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0QWxlcnRCdXR0b25zKCk7XG4gICAgZGVmYXVsdDpcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVGhlICdhY3Rpb24nIHZhbHVlIHNob3VsZCBiZSBlaXRoZXIgJ2FjY2VwdCcsICdkaXNtaXNzJyBvciAnZ2V0QnV0dG9ucycuIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGAnJHtvcHRzLmFjdGlvbn0nIGlzIHByb3ZpZGVkIGluc3RlYWQuYCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZ2V0QWxlcnQgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGxldCBwb3NzaWJsZUFsZXJ0ID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlU2Nyb2xsVmlldycsIHRydWUpO1xuICBpZiAocG9zc2libGVBbGVydC5sZW5ndGggIT09IDEpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBwb3NzaWJsZUFsZXJ0QnV0dG9ucyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZUJ1dHRvbicsIHRydWUsIHBvc3NpYmxlQWxlcnRbMF0uRUxFTUVOVCk7XG4gIGlmIChwb3NzaWJsZUFsZXJ0QnV0dG9ucy5sZW5ndGggPCAxIHx8IHBvc3NpYmxlQWxlcnRCdXR0b25zLmxlbmd0aCA+IDIpIHtcbiAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgfVxuXG4gIGxldCBhc3NlcnRCdXR0b25OYW1lID0gYXN5bmMgKGJ1dHRvbiwgZXhwZWN0ZWROYW1lKSA9PiB7XG4gICAgYnV0dG9uID0gYnV0dG9uLkVMRU1FTlQgPyBidXR0b24uRUxFTUVOVCA6IGJ1dHRvbjtcbiAgICBsZXQgbmFtZSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2J1dHRvbn0vYXR0cmlidXRlL25hbWVgLCAnR0VUJyk7XG4gICAgaWYgKG5hbWUudG9Mb3dlckNhc2UoKSAhPT0gZXhwZWN0ZWROYW1lKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vQWxlcnRPcGVuRXJyb3IoKTtcbiAgICB9XG4gIH07XG5cbiAgbGV0IGFsZXJ0ID0gcG9zc2libGVBbGVydFswXTtcbiAgaWYgKHBvc3NpYmxlQWxlcnRCdXR0b25zLmxlbmd0aCA9PT0gMSkge1xuICAgIC8vIG1ha2Ugc3VyZSB0aGUgYnV0dG9uIGlzICdDbG9zZSdcbiAgICBsZXQgY2xvc2VCdXR0b24gPSBwb3NzaWJsZUFsZXJ0QnV0dG9uc1swXTtcbiAgICBhd2FpdCBhc3NlcnRCdXR0b25OYW1lKGNsb3NlQnV0dG9uLCAnY2xvc2UnKTtcblxuICAgIGFsZXJ0LmNsb3NlID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7Y2xvc2VCdXR0b24uRUxFTUVOVH0vY2xpY2tgLCAnUE9TVCcpO1xuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgLy8gZW5zdXJlIHRoZSBidXR0b25zIGFyZSAnQ2FuY2VsJyBhbmQgJ09LJ1xuICAgIGxldCBjYW5jZWxCdXR0b24gPSBwb3NzaWJsZUFsZXJ0QnV0dG9uc1swXTtcbiAgICBhd2FpdCBhc3NlcnRCdXR0b25OYW1lKGNhbmNlbEJ1dHRvbiwgJ2NhbmNlbCcpO1xuICAgIGxldCBva0J1dHRvbiA9IHBvc3NpYmxlQWxlcnRCdXR0b25zWzFdO1xuICAgIGF3YWl0IGFzc2VydEJ1dHRvbk5hbWUob2tCdXR0b24sICdvaycpO1xuXG4gICAgYWxlcnQuY2FuY2VsID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7Y2FuY2VsQnV0dG9uLkVMRU1FTlR9L2NsaWNrYCwgJ1BPU1QnKTtcbiAgICB9O1xuICAgIGFsZXJ0Lm9rID0gYXN5bmMgKCkgPT4ge1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7b2tCdXR0b24uRUxFTUVOVH0vY2xpY2tgLCAnUE9TVCcpO1xuICAgIH07XG4gIH1cblxuICBhbGVydC5nZXRUZXh0ID0gYXN5bmMgKCkgPT4ge1xuICAgIGxldCB0ZXh0VmlldyA9IGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZVRleHRWaWV3JywgZmFsc2UsIHV0aWwudW53cmFwRWxlbWVudChhbGVydCkpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5Q29tbWFuZChgL2VsZW1lbnQvJHt0ZXh0Vmlldy5FTEVNRU5UfS9hdHRyaWJ1dGUvdmFsdWVgLCAnR0VUJyk7XG4gIH07XG4gIGFsZXJ0LnNldFRleHQgPSBhc3luYyAodmFsdWUpID0+IHtcbiAgICB0cnkge1xuICAgICAgbGV0IHRleHRWaWV3ID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2NsYXNzIG5hbWUnLCAnWENVSUVsZW1lbnRUeXBlVGV4dEZpZWxkJywgZmFsc2UsIHV0aWwudW53cmFwRWxlbWVudChhbGVydCkpO1xuICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoYC9lbGVtZW50LyR7dGV4dFZpZXcuRUxFTUVOVH0vdmFsdWUgYCwgJ1BPU1QnLCB7dmFsdWV9KTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmIChpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Ob1N1Y2hFbGVtZW50RXJyb3IpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignVHJpZWQgdG8gc2V0IHRleHQgb2YgYW4gYWxlcnQgdGhhdCB3YXMgbm90IGEgcHJvbXB0Jyk7XG4gICAgICB9XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfVxuICB9O1xuXG4gIHJldHVybiBhbGVydDtcbn07XG5cblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBjb21tYW5kcywgaGVscGVycyk7XG5leHBvcnQgeyBjb21tYW5kcywgaGVscGVycyB9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2FsZXJ0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
