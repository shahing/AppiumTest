"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumRemoteDebugger = require("appium-remote-debugger");

var _appiumSupport = require("appium-support");

let extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.context);

extensions.closeAlertBeforeTest = async function () {
  return true;
};

extensions._setContext = extensions.setContext;

extensions.setContext = async function (name, callback, skipReadyCheck) {
  await this._setContext(name, callback, skipReadyCheck);

  if (name && name !== _appiumIosDriver.NATIVE_WIN && this.logs) {
    if (this.logs.safariConsole) {
      await this.remote.startConsole(this.logs.safariConsole.addLogLine.bind(this.logs.safariConsole));
    }

    if (this.logs.safariNetwork) {
      await this.remote.startNetwork(this.logs.safariNetwork.addLogLine.bind(this.logs.safariNetwork));
    }
  }
};

extensions._getLatestWebviewContextForTitle = extensions.getLatestWebviewContextForTitle;

extensions.getLatestWebviewContextForTitle = async function (regExp) {
  let currentUrl = this.getCurrentUrl();

  if (!currentUrl) {
    return await this._getLatestWebviewContextForTitle(regExp);
  }

  let contexts = await this.getContextsAndViews();
  let matchingCtx;

  for (let ctx of contexts) {
    if (ctx.view) {
      let url = ctx.view.url || '';

      if (url === this.getCurrentUrl()) {
        matchingCtx = ctx;
        break;
      }
    }
  }

  if (matchingCtx) {
    return matchingCtx.id;
  }

  return await this._getLatestWebviewContextForTitle(regExp);
};

extensions.isWebContext = function () {
  return !!this.curContext && this.curContext !== _appiumIosDriver.iosCommands.context.NATIVE_WIN;
};

extensions.isWebview = function () {
  return this.isWebContext();
};

extensions.getNewRemoteDebugger = async function () {
  const socketPath = await this.opts.device.getWebInspectorSocket();
  return new _appiumRemoteDebugger.RemoteDebugger({
    bundleId: this.opts.bundleId,
    useNewSafari: this.useNewSafari(),
    pageLoadMs: this.pageLoadMs,
    platformVersion: this.opts.platformVersion,
    socketPath,
    remoteDebugProxy: this.opts.remoteDebugProxy,
    garbageCollectOnExecute: _appiumSupport.util.hasValue(this.opts.safariGarbageCollect) ? !!this.opts.safariGarbageCollect : true
  });
};

extensions.mobileGetContexts = async function () {
  const curOpt = this.opts.fullContextList;

  try {
    this.opts.fullContextList = true;
    return await this.getContexts();
  } finally {
    this.opts.fullContextList = curOpt;
  }
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIl0sIm5hbWVzIjpbImV4dGVuc2lvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJpb3NDb21tYW5kcyIsImNvbnRleHQiLCJjbG9zZUFsZXJ0QmVmb3JlVGVzdCIsIl9zZXRDb250ZXh0Iiwic2V0Q29udGV4dCIsIm5hbWUiLCJjYWxsYmFjayIsInNraXBSZWFkeUNoZWNrIiwiTkFUSVZFX1dJTiIsImxvZ3MiLCJzYWZhcmlDb25zb2xlIiwicmVtb3RlIiwic3RhcnRDb25zb2xlIiwiYWRkTG9nTGluZSIsImJpbmQiLCJzYWZhcmlOZXR3b3JrIiwic3RhcnROZXR3b3JrIiwiX2dldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUiLCJnZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlIiwicmVnRXhwIiwiY3VycmVudFVybCIsImdldEN1cnJlbnRVcmwiLCJjb250ZXh0cyIsImdldENvbnRleHRzQW5kVmlld3MiLCJtYXRjaGluZ0N0eCIsImN0eCIsInZpZXciLCJ1cmwiLCJpZCIsImlzV2ViQ29udGV4dCIsImN1ckNvbnRleHQiLCJpc1dlYnZpZXciLCJnZXROZXdSZW1vdGVEZWJ1Z2dlciIsInNvY2tldFBhdGgiLCJvcHRzIiwiZGV2aWNlIiwiZ2V0V2ViSW5zcGVjdG9yU29ja2V0IiwiUmVtb3RlRGVidWdnZXIiLCJidW5kbGVJZCIsInVzZU5ld1NhZmFyaSIsInBhZ2VMb2FkTXMiLCJwbGF0Zm9ybVZlcnNpb24iLCJyZW1vdGVEZWJ1Z1Byb3h5IiwiZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGUiLCJ1dGlsIiwiaGFzVmFsdWUiLCJzYWZhcmlHYXJiYWdlQ29sbGVjdCIsIm1vYmlsZUdldENvbnRleHRzIiwiY3VyT3B0IiwiZnVsbENvbnRleHRMaXN0IiwiZ2V0Q29udGV4dHMiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUVBLElBQUlBLFVBQVUsR0FBRyxFQUFqQjtBQUVBQyxN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QUl4QkMsSUFBQUEsZUFBZSxFQUFFLEtBQUtQLElBQUwsQ0FBVU8sZUFKSDtBQUt4QlIsSUFBQUEsVUFMd0I7QUFNeEJTLElBQUFBLGdCQUFnQixFQUFFLEtBQUtSLElBQUwsQ0FBVVEsZ0JBTko7QUFPeEJDLElBQUFBLHVCQUF1QixFQUFFQyxvQkFBS0MsUUFBTCxDQUFjLEtBQUtYLElBQUwsQ0FBVVksb0JBQXhCLElBQ3JCLENBQUMsQ0FBQyxLQUFLWixJQUFMLENBQVVZLG9CQURTLEdBRXJCO0FBVG9CLEdBQW5CLENBQVA7QUFXRCxDQWJEOztBQThCQWpELFVBQVUsQ0FBQ2tELGlCQUFYLEdBQStCLGtCQUFrQjtBQUMvQyxRQUFNQyxNQUFNLEdBQUcsS0FBS2QsSUFBTCxDQUFVZSxlQUF6Qjs7QUFDQSxNQUFJO0FBR0YsU0FBS2YsSUFBTCxDQUFVZSxlQUFWLEdBQTRCLElBQTVCO0FBQ0EsV0FBTyxNQUFNLEtBQUtDLFdBQUwsRUFBYjtBQUNELEdBTEQsU0FLVTtBQUVSLFNBQUtoQixJQUFMLENBQVVlLGVBQVYsR0FBNEJELE1BQTVCO0FBQ0Q7QUFDRixDQVhEOztlQWNlbkQsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlvc0NvbW1hbmRzLCBOQVRJVkVfV0lOIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgUmVtb3RlRGVidWdnZXIgfSBmcm9tICdhcHBpdW0tcmVtb3RlLWRlYnVnZ2VyJztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5cbmxldCBleHRlbnNpb25zID0ge307XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMuY29udGV4dCk7XG5cbi8vIG92ZXJyaWRlLCBhcyBhcHBpdW0taW9zLWRyaXZlcidzIHZlcnNpb24gdXNlcyBVSSBBdXRvbWF0aW9uIHRvIGNsb3NlXG5leHRlbnNpb25zLmNsb3NlQWxlcnRCZWZvcmVUZXN0ID0gYXN5bmMgZnVuY3Rpb24gKCkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIHJlcXVpcmUtYXdhaXRcbiAgcmV0dXJuIHRydWU7XG59O1xuXG5leHRlbnNpb25zLl9zZXRDb250ZXh0ID0gZXh0ZW5zaW9ucy5zZXRDb250ZXh0O1xuZXh0ZW5zaW9ucy5zZXRDb250ZXh0ID0gYXN5bmMgZnVuY3Rpb24gKG5hbWUsIGNhbGxiYWNrLCBza2lwUmVhZHlDaGVjaykge1xuICBhd2FpdCB0aGlzLl9zZXRDb250ZXh0KG5hbWUsIGNhbGxiYWNrLCBza2lwUmVhZHlDaGVjayk7XG5cbiAgLy8gc3RhcnQgc2FmYXJpIGxvZ2dpbmcgaWYgdGhlIGxvZ3MgaGFuZGxlcnMgYXJlIGFjdGl2ZVxuICBpZiAobmFtZSAmJiBuYW1lICE9PSBOQVRJVkVfV0lOICYmIHRoaXMubG9ncykge1xuICAgIGlmICh0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSkge1xuICAgICAgYXdhaXQgdGhpcy5yZW1vdGUuc3RhcnRDb25zb2xlKHRoaXMubG9ncy5zYWZhcmlDb25zb2xlLmFkZExvZ0xpbmUuYmluZCh0aGlzLmxvZ3Muc2FmYXJpQ29uc29sZSkpO1xuICAgIH1cbiAgICBpZiAodGhpcy5sb2dzLnNhZmFyaU5ldHdvcmspIHtcbiAgICAgIGF3YWl0IHRoaXMucmVtb3RlLnN0YXJ0TmV0d29yayh0aGlzLmxvZ3Muc2FmYXJpTmV0d29yay5hZGRMb2dMaW5lLmJpbmQodGhpcy5sb2dzLnNhZmFyaU5ldHdvcmspKTtcbiAgICB9XG4gIH1cbn07XG5cbi8vIHRoZSBhcHBpdW0taW9zLWRyaXZlciB2ZXJzaW9uIG9mIHRoaXMgZnVuY3Rpb24gZmFpbHMgaW4gQ0ksXG4vLyBhbmQgdGhlIHdyb25nIHdlYnZpZXcgaXMgYWxtb3N0IGFsd2F5cyByZXRyaWV2ZWRcbmV4dGVuc2lvbnMuX2dldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgPSBleHRlbnNpb25zLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGU7XG5leHRlbnNpb25zLmdldExhdGVzdFdlYnZpZXdDb250ZXh0Rm9yVGl0bGUgPSBhc3luYyBmdW5jdGlvbiAocmVnRXhwKSB7XG4gIGxldCBjdXJyZW50VXJsID0gdGhpcy5nZXRDdXJyZW50VXJsKCk7XG4gIGlmICghY3VycmVudFVybCkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLl9nZXRMYXRlc3RXZWJ2aWV3Q29udGV4dEZvclRpdGxlKHJlZ0V4cCk7XG4gIH1cblxuICBsZXQgY29udGV4dHMgPSBhd2FpdCB0aGlzLmdldENvbnRleHRzQW5kVmlld3MoKTtcbiAgbGV0IG1hdGNoaW5nQ3R4O1xuICBmb3IgKGxldCBjdHggb2YgY29udGV4dHMpIHtcbiAgICBpZiAoY3R4LnZpZXcpIHtcbiAgICAgIGxldCB1cmwgPSBjdHgudmlldy51cmwgfHwgJyc7XG4gICAgICBpZiAodXJsID09PSB0aGlzLmdldEN1cnJlbnRVcmwoKSkge1xuICAgICAgICBtYXRjaGluZ0N0eCA9IGN0eDtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgfVxuICB9XG4gIGlmIChtYXRjaGluZ0N0eCkge1xuICAgIHJldHVybiBtYXRjaGluZ0N0eC5pZDtcbiAgfVxuICByZXR1cm4gYXdhaXQgdGhpcy5fZ2V0TGF0ZXN0V2Vidmlld0NvbnRleHRGb3JUaXRsZShyZWdFeHApO1xufTtcblxuZXh0ZW5zaW9ucy5pc1dlYkNvbnRleHQgPSBmdW5jdGlvbiAoKSB7XG4gIHJldHVybiAhIXRoaXMuY3VyQ29udGV4dCAmJiB0aGlzLmN1ckNvbnRleHQgIT09IGlvc0NvbW1hbmRzLmNvbnRleHQuTkFUSVZFX1dJTjtcbn07XG5cbmV4dGVuc2lvbnMuaXNXZWJ2aWV3ID0gZnVuY3Rpb24gKCkge1xuICByZXR1cm4gdGhpcy5pc1dlYkNvbnRleHQoKTtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0TmV3UmVtb3RlRGVidWdnZXIgPSBhc3luYyBmdW5jdGlvbiAoKSB7XG4gIGNvbnN0IHNvY2tldFBhdGggPSBhd2FpdCB0aGlzLm9wdHMuZGV2aWNlLmdldFdlYkluc3BlY3RvclNvY2tldCgpO1xuICByZXR1cm4gbmV3IFJlbW90ZURlYnVnZ2VyKHtcbiAgICBidW5kbGVJZDogdGhpcy5vcHRzLmJ1bmRsZUlkLFxuICAgIHVzZU5ld1NhZmFyaTogdGhpcy51c2VOZXdTYWZhcmkoKSxcbiAgICBwYWdlTG9hZE1zOiB0aGlzLnBhZ2VMb2FkTXMsXG4gICAgcGxhdGZvcm1WZXJzaW9uOiB0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uLFxuICAgIHNvY2tldFBhdGgsXG4gICAgcmVtb3RlRGVidWdQcm94eTogdGhpcy5vcHRzLnJlbW90ZURlYnVnUHJveHksXG4gICAgZ2FyYmFnZUNvbGxlY3RPbkV4ZWN1dGU6IHV0aWwuaGFzVmFsdWUodGhpcy5vcHRzLnNhZmFyaUdhcmJhZ2VDb2xsZWN0KVxuICAgICAgPyAhIXRoaXMub3B0cy5zYWZhcmlHYXJiYWdlQ29sbGVjdFxuICAgICAgOiB0cnVlLFxuICB9KTtcbn07XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQ29udGV4dFxuICpcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBpZCAtIFRoZSBpZGVudGlmaWVyIG9mIHRoZSBjb250ZXh0LiBUaGUgbmF0aXZlIGNvbnRleHRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICB3aWxsIGJlICdOQVRJVkVfQVBQJyBhbmQgdGhlIHdlYnZpZXdzIHdpbGwgYmVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAnV0VCVklFV194eHgnXG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHRpdGxlIC0gVGhlIHRpdGxlIGFzc29jaWF0ZWQgd2l0aCB0aGUgd2VidmlldyBjb250ZW50XG4gKiBAcHJvcGVydHkgez9zdHJpbmd9IHVybCAtIFRoZSB1cmwgYXNzb2NpYXRlZCB3aXRoIHRoZSB3ZWJ2aWV3IGNvbnRlbnRcbiAqL1xuXG4vKipcbiAqIEdldCB0aGUgY29udGV4dHMgYXZhaWxhYmxlLCB3aXRoIGluZm9ybWF0aW9uIGFib3V0IHRoZSB1cmwgYW5kIHRpdGxlIG9mIGVhY2hcbiAqIHdlYnZpZXdcbiAqIEByZXR1cm5zIHtBcnJheX0gTGlzdCBvZiBDb250ZXh0IG9iamVjdHNcbiAqL1xuZXh0ZW5zaW9ucy5tb2JpbGVHZXRDb250ZXh0cyA9IGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgY29uc3QgY3VyT3B0ID0gdGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdDtcbiAgdHJ5IHtcbiAgICAvLyBgYXBwaXVtLWlvcy1kcml2ZXIjZ2V0Q29udGV4dHNgIHJldHVybnMgdGhlIGZ1bGwgbGlzdCBvZiBjb250ZXh0c1xuICAgIC8vIGlmIHRoaXMgb3B0aW9uIGlzIG9uXG4gICAgdGhpcy5vcHRzLmZ1bGxDb250ZXh0TGlzdCA9IHRydWU7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0Q29udGV4dHMoKTtcbiAgfSBmaW5hbGx5IHtcbiAgICAvLyByZXNldCB0aGUgb3B0aW9uIHNvIHRoZXJlIGFyZSBubyBzaWRlIGVmZmVjdHNcbiAgICB0aGlzLm9wdHMuZnVsbENvbnRleHRMaXN0ID0gY3VyT3B0O1xuICB9XG59O1xuXG5cbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwiZmlsZSI6ImxpYi9jb21tYW5kcy9jb250ZXh0LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
