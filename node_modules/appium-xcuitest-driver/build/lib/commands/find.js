"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.helpers = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

const MAGIC_FIRST_VIS_CHILD_SEL = /\/\*\[@firstVisible\s*=\s*('|")true\1\]/;
const MAGIC_SCROLLABLE_SEL = /\/\/\*\[@scrollable\s*=\s*('|")true\1\]/;
const WDA_CLASS_CHAIN_STRATEGY = 'class chain';
let helpers = {},
    commands = {},
    extensions = {};
exports.commands = commands;
exports.helpers = helpers;

helpers.findElOrEls = async function (strategy, selector, mult, context) {
  if (this.isWebview()) {
    return await this.findWebElementOrElements(strategy, selector, mult, context);
  } else {
    return await this.findNativeElementOrElements(strategy, selector, mult, context);
  }
};

helpers.findNativeElementOrElements = async function (strategy, selector, mult, context) {
  const initSelector = selector;
  let rewroteSelector = false;

  if (strategy === '-ios predicate string') {
    strategy = 'predicate string';
  } else if (strategy === '-ios class chain') {
    strategy = WDA_CLASS_CHAIN_STRATEGY;
  }

  function stripViewFromSelector(selector) {
    const keepView = ['XCUIElementTypeScrollView', 'XCUIElementTypeCollectionView', 'XCUIElementTypeTextView', 'XCUIElementTypeWebView'].includes(selector);

    if (!keepView && selector.indexOf('View') === selector.length - 4) {
      return selector.substr(0, selector.length - 4);
    } else {
      return selector;
    }
  }

  if (strategy === 'class name') {
    if (selector.startsWith('UIA')) {
      selector = selector.substring(3);
    }

    if (!selector.startsWith('XCUIElementType')) {
      selector = stripViewFromSelector(`XCUIElementType${selector}`);
      rewroteSelector = true;
    }
  }

  if (strategy === 'xpath' && MAGIC_FIRST_VIS_CHILD_SEL.test(selector)) {
    return await this.getFirstVisibleChild(mult, context);
  } else if (strategy === 'xpath' && MAGIC_SCROLLABLE_SEL.test(selector)) {
    [strategy, selector] = rewriteMagicScrollable(mult);
  } else if (strategy === 'xpath') {
    selector = selector.replace(/(^|\/)(UIA)([^[/]+)/g, (str, g1, g2, g3) => {
      rewroteSelector = true;
      return g1 + stripViewFromSelector(`XCUIElementType${g3}`);
    });
  }

  if (rewroteSelector) {
    _logger.default.info(`Rewrote incoming selector from '${initSelector}' to ` + `'${selector}' to match XCUI type. You should consider ` + `updating your tests to use the new selectors directly`);
  }

  return await this.doNativeFind(strategy, selector, mult, context);
};

helpers.doNativeFind = async function (strategy, selector, mult, context) {
  context = _appiumSupport.util.unwrapElement(context);
  let endpoint = `/element${context ? `/${context}/element` : ''}${mult ? 's' : ''}`;
  let body = {
    using: strategy,
    value: selector
  };
  let method = 'POST';
  let els;

  try {
    await this.implicitWaitForCondition(async () => {
      try {
        els = await this.proxyCommand(endpoint, method, body);

        if (mult) {
          return els && els.length;
        } else {
          return !els.status || els.status === 0;
        }
      } catch (err) {
        els = undefined;
        return false;
      }
    });
  } catch (err) {
    if (err.message && err.message.match(/Condition unmet/)) {
      els = [];
    } else {
      throw err;
    }
  }

  if (mult) {
    return els;
  } else {
    if (!els || _lodash.default.size(els) === 0) {
      throw new _appiumBaseDriver.errors.NoSuchElementError();
    }

    return els;
  }
};

helpers.getFirstVisibleChild = async function (mult, context) {
  _logger.default.info(`Getting first visible child`);

  if (mult) {
    throw new Error("Cannot get multiple first visible children!");
  }

  if (!context) {
    throw new Error("Cannot get first visible child without a context element");
  }

  let index = 1;

  while (true) {
    const strategy = WDA_CLASS_CHAIN_STRATEGY;
    const selector = `*[${index}]`;
    const nthChild = await this.doNativeFind(strategy, selector, false, context);
    const visible = await this.getAttribute('visible', nthChild);

    if (visible === "true") {
      _logger.default.info(`Found first visible child at position ${index}`);

      return nthChild;
    }

    index++;
  }
};

function rewriteMagicScrollable(mult) {
  const types = ['ScrollView', 'Table', 'CollectionView', 'WebView'].map(t => `XCUIElementType${t}`);
  const pred = types.map(t => `type == "${t}"`).join(" OR ");
  const strategy = WDA_CLASS_CHAIN_STRATEGY;
  let selector = '**/*[`' + pred + '`]';

  if (!mult) {
    selector += '[1]';
  }

  _logger.default.info("Rewrote request for scrollable descendants to class chain " + `format with selector '${selector}'`);

  return [strategy, selector];
}

Object.assign(extensions, commands, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maW5kLmpzIl0sIm5hbWVzIjpbIk1BR0lDX0ZJUlNUX1ZJU19DSElMRF9TRUwiLCJNQUdJQ19TQ1JPTExBQkxFX1NFTCIsIldEQV9DTEFTU19DSEFJTl9TVFJBVEVHWSIsImhlbHBlcnMiLCJjb21tYW5kcyIsImV4dGVuc2lvbnMiLCJmaW5kRWxPckVscyIsInN0cmF0ZWd5Iiwic2VsZWN0b3IiLCJtdWx0IiwiY29udGV4dCIsImlzV2VidmlldyIsImZpbmRXZWJFbGVtZW50T3JFbGVtZW50cyIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsImluaXRTZWxlY3RvciIsInJld3JvdGVTZWxlY3RvciIsInN0cmlwVmlld0Zyb21TZWxlY3RvciIsImtlZXBWaWV3IiwiaW5jbHVkZXMiLCJpbmRleE9mIiwibGVuZ3RoIiwic3Vic3RyIiwic3RhcnRzV2l0aCIsInN1YnN0cmluZyIsInRlc3QiLCJnZXRGaXJzdFZpc2libGVDaGlsZCIsInJld3JpdGVNYWdpY1Njcm9sbGFibGUiLCJyZXBsYWNlIiwic3RyIiwiZzEiLCJnMiIsImczIiwibG9nIiwiaW5mbyIsImRvTmF0aXZlRmluZCIsInV0aWwiLCJ1bndyYXBFbGVtZW50IiwiZW5kcG9pbnQiLCJib2R5IiwidXNpbmciLCJ2YWx1ZSIsIm1ldGhvZCIsImVscyIsImltcGxpY2l0V2FpdEZvckNvbmRpdGlvbiIsInByb3h5Q29tbWFuZCIsInN0YXR1cyIsImVyciIsInVuZGVmaW5lZCIsIm1lc3NhZ2UiLCJtYXRjaCIsIl8iLCJzaXplIiwiZXJyb3JzIiwiTm9TdWNoRWxlbWVudEVycm9yIiwiRXJyb3IiLCJpbmRleCIsIm50aENoaWxkIiwidmlzaWJsZSIsImdldEF0dHJpYnV0ZSIsInR5cGVzIiwibWFwIiwidCIsInByZWQiLCJqb2luIiwiT2JqZWN0IiwiYXNzaWduIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUlBLE1BQU1BLHlC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RCxRQUExQixFQUFvQ0QsT0FBcEM7ZUFFZUUsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBlcnJvcnMgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcblxuLy8gd2Ugb3ZlcnJpZGUgdGhlIHhwYXRoIHNlYXJjaCBmb3IgdGhpcyBmaXJzdC12aXNpYmxlLWNoaWxkIHNlbGVjdG9yLCB3aGljaFxuLy8gbG9va3MgbGlrZSAvKltAZmlyc3RWaXNpYmxlPVwidHJ1ZVwiXVxuY29uc3QgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTCA9IC9cXC9cXCpcXFtAZmlyc3RWaXNpYmxlXFxzKj1cXHMqKCd8XCIpdHJ1ZVxcMVxcXS87XG5cbi8vIHdlIGxpa2V3aXNlIG92ZXJyaWRlIHhwYXRoIHNlYXJjaCB0byBwcm92aWRlIGEgc2hvcnRjdXQgZm9yIGZpbmRpbmcgYWxsXG4vLyBzY3JvbGxhYmxlIGVsZW1lbnRzXG5jb25zdCBNQUdJQ19TQ1JPTExBQkxFX1NFTCA9IC9cXC9cXC9cXCpcXFtAc2Nyb2xsYWJsZVxccyo9XFxzKignfFwiKXRydWVcXDFcXF0vO1xuXG5jb25zdCBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1kgPSAnY2xhc3MgY2hhaW4nO1xuXG5sZXQgaGVscGVycyA9IHt9LCBjb21tYW5kcyA9IHt9LCBleHRlbnNpb25zID0ge307XG5cbmhlbHBlcnMuZmluZEVsT3JFbHMgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGlmICh0aGlzLmlzV2VidmlldygpKSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZFdlYkVsZW1lbnRPckVsZW1lbnRzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCk7XG4gIH1cbn07XG5cbmhlbHBlcnMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzID0gYXN5bmMgZnVuY3Rpb24gKHN0cmF0ZWd5LCBzZWxlY3RvciwgbXVsdCwgY29udGV4dCkge1xuICBjb25zdCBpbml0U2VsZWN0b3IgPSBzZWxlY3RvcjtcbiAgbGV0IHJld3JvdGVTZWxlY3RvciA9IGZhbHNlO1xuICBpZiAoc3RyYXRlZ3kgPT09ICctaW9zIHByZWRpY2F0ZSBzdHJpbmcnKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAncHJlZGljYXRlIHN0cmluZydcbiAgICBzdHJhdGVneSA9ICdwcmVkaWNhdGUgc3RyaW5nJztcbiAgfSBlbHNlIGlmIChzdHJhdGVneSA9PT0gJy1pb3MgY2xhc3MgY2hhaW4nKSB7XG4gICAgLy8gV2ViRHJpdmVyQWdlbnQgdXNlcyAnY2xhc3MgY2hhaW4nXG4gICAgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gIH1cblxuICAvLyBDaGVjayBpZiB0aGUgd29yZCAnVmlldycgaXMgYXBwZW5kZWQgdG8gc2VsZWN0b3IgYW5kIGlmIGl0IGlzLCBzdHJpcCBpdCBvdXRcbiAgZnVuY3Rpb24gc3RyaXBWaWV3RnJvbVNlbGVjdG9yIChzZWxlY3Rvcikge1xuICAgIC8vIERvbid0IHN0cmlwIGl0IG91dCBpZiBpdCdzIG9uZSBvZiB0aGVzZSA0IGVsZW1lbnQgdHlwZXNcbiAgICAvLyAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9mYWNlYm9vay9XZWJEcml2ZXJBZ2VudC9ibG9iL21hc3Rlci9XZWJEcml2ZXJBZ2VudExpYi9VdGlsaXRpZXMvRkJFbGVtZW50VHlwZVRyYW5zZm9ybWVyLm0gZm9yIHJlZmVyZW5jZSlcbiAgICBjb25zdCBrZWVwVmlldyA9IFtcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVTY3JvbGxWaWV3JyxcbiAgICAgICdYQ1VJRWxlbWVudFR5cGVDb2xsZWN0aW9uVmlldycsXG4gICAgICAnWENVSUVsZW1lbnRUeXBlVGV4dFZpZXcnLFxuICAgICAgJ1hDVUlFbGVtZW50VHlwZVdlYlZpZXcnLFxuICAgIF0uaW5jbHVkZXMoc2VsZWN0b3IpO1xuXG4gICAgaWYgKCFrZWVwVmlldyAmJiBzZWxlY3Rvci5pbmRleE9mKCdWaWV3JykgPT09IHNlbGVjdG9yLmxlbmd0aCAtIDQpIHtcbiAgICAgIHJldHVybiBzZWxlY3Rvci5zdWJzdHIoMCwgc2VsZWN0b3IubGVuZ3RoIC0gNCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBzZWxlY3RvcjtcbiAgICB9XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICdjbGFzcyBuYW1lJykge1xuICAgIC8vIFhDVUlUZXN0IGNsYXNzZXMgaGF2ZSBgWENVSUVsZW1lbnRUeXBlYCBwcmVwZW5kZWRcbiAgICAvLyBmaXJzdCBjaGVjayBpZiB0aGVyZSBpcyB0aGUgb2xkIGBVSUFgIHByZWZpeFxuICAgIGlmIChzZWxlY3Rvci5zdGFydHNXaXRoKCdVSUEnKSkge1xuICAgICAgc2VsZWN0b3IgPSBzZWxlY3Rvci5zdWJzdHJpbmcoMyk7XG4gICAgfVxuICAgIC8vIG5vdyBjaGVjayBpZiB3ZSBuZWVkIHRvIGFkZCBgWENVSUVsZW1lbnRUeXBlYFxuICAgIGlmICghc2VsZWN0b3Iuc3RhcnRzV2l0aCgnWENVSUVsZW1lbnRUeXBlJykpIHtcbiAgICAgIHNlbGVjdG9yID0gc3RyaXBWaWV3RnJvbVNlbGVjdG9yKGBYQ1VJRWxlbWVudFR5cGUke3NlbGVjdG9yfWApO1xuICAgICAgcmV3cm90ZVNlbGVjdG9yID0gdHJ1ZTtcbiAgICB9XG4gIH1cblxuICBpZiAoc3RyYXRlZ3kgPT09ICd4cGF0aCcgJiYgTUFHSUNfRklSU1RfVklTX0NISUxEX1NFTC50ZXN0KHNlbGVjdG9yKSkge1xuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEZpcnN0VmlzaWJsZUNoaWxkKG11bHQsIGNvbnRleHQpO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnICYmIE1BR0lDX1NDUk9MTEFCTEVfU0VMLnRlc3Qoc2VsZWN0b3IpKSB7XG4gICAgW3N0cmF0ZWd5LCBzZWxlY3Rvcl0gPSByZXdyaXRlTWFnaWNTY3JvbGxhYmxlKG11bHQpO1xuICB9IGVsc2UgaWYgKHN0cmF0ZWd5ID09PSAneHBhdGgnKSB7XG4gICAgLy8gUmVwbGFjZSBVSUEgaWYgaXQgY29tZXMgYWZ0ZXIgYSBmb3J3YXJkIHNsYXNoIG9yIGlzIGF0IHRoZSBiZWdpbm5pbmcgb2YgdGhlIHN0cmluZ1xuICAgIHNlbGVjdG9yID0gc2VsZWN0b3IucmVwbGFjZSgvKF58XFwvKShVSUEpKFteWy9dKykvZywgKHN0ciwgZzEsIGcyLCBnMykgPT4ge1xuICAgICAgcmV3cm90ZVNlbGVjdG9yID0gdHJ1ZTtcbiAgICAgIHJldHVybiBnMSArIHN0cmlwVmlld0Zyb21TZWxlY3RvcihgWENVSUVsZW1lbnRUeXBlJHtnM31gKTtcbiAgICB9KTtcbiAgfVxuXG4gIGlmIChyZXdyb3RlU2VsZWN0b3IpIHtcbiAgICBsb2cuaW5mbyhgUmV3cm90ZSBpbmNvbWluZyBzZWxlY3RvciBmcm9tICcke2luaXRTZWxlY3Rvcn0nIHRvIGAgK1xuICAgICAgICAgICAgIGAnJHtzZWxlY3Rvcn0nIHRvIG1hdGNoIFhDVUkgdHlwZS4gWW91IHNob3VsZCBjb25zaWRlciBgICtcbiAgICAgICAgICAgICBgdXBkYXRpbmcgeW91ciB0ZXN0cyB0byB1c2UgdGhlIG5ldyBzZWxlY3RvcnMgZGlyZWN0bHlgKTtcbiAgfVxuXG4gIHJldHVybiBhd2FpdCB0aGlzLmRvTmF0aXZlRmluZChzdHJhdGVneSwgc2VsZWN0b3IsIG11bHQsIGNvbnRleHQpO1xufTtcblxuaGVscGVycy5kb05hdGl2ZUZpbmQgPSBhc3luYyBmdW5jdGlvbiAoc3RyYXRlZ3ksIHNlbGVjdG9yLCBtdWx0LCBjb250ZXh0KSB7XG4gIGNvbnRleHQgPSB1dGlsLnVud3JhcEVsZW1lbnQoY29udGV4dCk7XG5cbiAgbGV0IGVuZHBvaW50ID0gYC9lbGVtZW50JHtjb250ZXh0ID8gYC8ke2NvbnRleHR9L2VsZW1lbnRgIDogJyd9JHttdWx0ID8gJ3MnIDogJyd9YDtcblxuICBsZXQgYm9keSA9IHtcbiAgICB1c2luZzogc3RyYXRlZ3ksXG4gICAgdmFsdWU6IHNlbGVjdG9yXG4gIH07XG5cbiAgbGV0IG1ldGhvZCA9ICdQT1NUJztcblxuICBsZXQgZWxzO1xuICB0cnkge1xuICAgIGF3YWl0IHRoaXMuaW1wbGljaXRXYWl0Rm9yQ29uZGl0aW9uKGFzeW5jICgpID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGVscyA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGVuZHBvaW50LCBtZXRob2QsIGJvZHkpO1xuICAgICAgICBpZiAobXVsdCkge1xuICAgICAgICAgIC8vIHdlIHN1Y2NlZWQgaWYgd2UgZ2V0IHNvbWUgZWxlbWVudHNcbiAgICAgICAgICByZXR1cm4gZWxzICYmIGVscy5sZW5ndGg7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgLy8gd2UgbWF5IG5vdCBnZXQgYW55IHN0YXR1cywgd2hpY2ggbWVhbnMgc3VjY2Vzc1xuICAgICAgICAgIHJldHVybiAhZWxzLnN0YXR1cyB8fCBlbHMuc3RhdHVzID09PSAwO1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgZWxzID0gdW5kZWZpbmVkO1xuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIubWVzc2FnZSAmJiBlcnIubWVzc2FnZS5tYXRjaCgvQ29uZGl0aW9uIHVubWV0LykpIHtcbiAgICAgIC8vIGNvbmRpdGlvbiB3YXMgbm90IG1ldCBzZXR0aW5nIHJlcyB0byBlbXB0eSBhcnJheVxuICAgICAgZWxzID0gW107XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IGVycjtcbiAgICB9XG4gIH1cbiAgaWYgKG11bHQpIHtcbiAgICByZXR1cm4gZWxzO1xuICB9IGVsc2Uge1xuICAgIGlmICghZWxzIHx8IF8uc2l6ZShlbHMpID09PSAwKSB7XG4gICAgICB0aHJvdyBuZXcgZXJyb3JzLk5vU3VjaEVsZW1lbnRFcnJvcigpO1xuICAgIH1cbiAgICByZXR1cm4gZWxzO1xuICB9XG59O1xuXG5oZWxwZXJzLmdldEZpcnN0VmlzaWJsZUNoaWxkID0gYXN5bmMgZnVuY3Rpb24gKG11bHQsIGNvbnRleHQpIHtcbiAgbG9nLmluZm8oYEdldHRpbmcgZmlyc3QgdmlzaWJsZSBjaGlsZGApO1xuICBpZiAobXVsdCkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIkNhbm5vdCBnZXQgbXVsdGlwbGUgZmlyc3QgdmlzaWJsZSBjaGlsZHJlbiFcIik7XG4gIH1cbiAgaWYgKCFjb250ZXh0KSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiQ2Fubm90IGdldCBmaXJzdCB2aXNpYmxlIGNoaWxkIHdpdGhvdXQgYSBjb250ZXh0IGVsZW1lbnRcIik7XG4gIH1cbiAgbGV0IGluZGV4ID0gMTtcbiAgLy8gbG9vcCB0aHJvdWdoIGNoaWxkcmVuIHZpYSBjbGFzcy1jaGFpbiBmaW5kcywgdW50aWwgd2UgcnVuIG91dCBvZiBjaGlsZHJlblxuICAvLyBvciB3ZSBmaW5kIGEgdmlzaWJsZSBvbmUuIFRoaXMgbG9vcCBsb29rcyBpbmZpbml0ZSBidXQgaXRzIG5vdCwgYmVjYXVzZSBhdFxuICAvLyBzb21lIHBvaW50IHRoZSBjYWxsIHRvIGRvTmF0aXZlRmluZCB3aWxsIHRocm93IHdpdGggYW4gRWxlbWVudCBOb3QgRm91bmRcbiAgLy8gZXJyb3IsIHdoZW4gdGhlIGluZGV4IGdldHMgaGlnaGVyIHRoYW4gdGhlIG51bWJlciBvZiBjaGlsZCBlbGVtZW50cy4gVGhpc1xuICAvLyBpcyB3aGF0IHdlIHdhbnQgYmVjYXVzZSB0aGF0IGVycm9yIHdpbGwgaGFsdCB0aGUgbG9vcCBhbmQgbWFrZSBpdCBhbGwgdGhlXG4gIC8vIHdheSB0byB0aGUgY2xpZW50LlxuICB3aGlsZSAodHJ1ZSkgeyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLWNvbnN0YW50LWNvbmRpdGlvblxuICAgIGNvbnN0IHN0cmF0ZWd5ID0gV0RBX0NMQVNTX0NIQUlOX1NUUkFURUdZO1xuICAgIGNvbnN0IHNlbGVjdG9yID0gYCpbJHtpbmRleH1dYDtcbiAgICBjb25zdCBudGhDaGlsZCA9IGF3YWl0IHRoaXMuZG9OYXRpdmVGaW5kKHN0cmF0ZWd5LCBzZWxlY3RvciwgZmFsc2UsIGNvbnRleHQpO1xuICAgIGNvbnN0IHZpc2libGUgPSBhd2FpdCB0aGlzLmdldEF0dHJpYnV0ZSgndmlzaWJsZScsIG50aENoaWxkKTtcbiAgICBpZiAodmlzaWJsZSA9PT0gXCJ0cnVlXCIpIHtcbiAgICAgIGxvZy5pbmZvKGBGb3VuZCBmaXJzdCB2aXNpYmxlIGNoaWxkIGF0IHBvc2l0aW9uICR7aW5kZXh9YCk7XG4gICAgICByZXR1cm4gbnRoQ2hpbGQ7XG4gICAgfVxuICAgIGluZGV4Kys7XG4gIH1cbn07XG5cbmZ1bmN0aW9uIHJld3JpdGVNYWdpY1Njcm9sbGFibGUgKG11bHQpIHtcbiAgY29uc3QgdHlwZXMgPSBbXG4gICAgJ1Njcm9sbFZpZXcnLFxuICAgICdUYWJsZScsXG4gICAgJ0NvbGxlY3Rpb25WaWV3JyxcbiAgICAnV2ViVmlldydcbiAgXS5tYXAodCA9PiBgWENVSUVsZW1lbnRUeXBlJHt0fWApO1xuICBjb25zdCBwcmVkID0gdHlwZXMubWFwKHQgPT4gYHR5cGUgPT0gXCIke3R9XCJgKS5qb2luKFwiIE9SIFwiKTtcbiAgY29uc3Qgc3RyYXRlZ3kgPSBXREFfQ0xBU1NfQ0hBSU5fU1RSQVRFR1k7XG4gIGxldCBzZWxlY3RvciA9ICcqKi8qW2AnICsgcHJlZCArICdgXSc7XG4gIGlmICghbXVsdCkge1xuICAgIHNlbGVjdG9yICs9ICdbMV0nO1xuICB9XG4gIGxvZy5pbmZvKFwiUmV3cm90ZSByZXF1ZXN0IGZvciBzY3JvbGxhYmxlIGRlc2NlbmRhbnRzIHRvIGNsYXNzIGNoYWluIFwiICtcbiAgICAgICAgICAgYGZvcm1hdCB3aXRoIHNlbGVjdG9yICcke3NlbGVjdG9yfSdgKTtcbiAgcmV0dXJuIFtzdHJhdGVneSwgc2VsZWN0b3JdO1xufVxuXG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgY29tbWFuZHMsIGhlbHBlcnMpO1xuZXhwb3J0IHsgY29tbWFuZHMsIGhlbHBlcnN9O1xuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbmQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
