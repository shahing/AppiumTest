"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SafariNetworkLog = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _url = _interopRequireDefault(require("url"));

var _appiumSupport = require("appium-support");

var _rotatingLog = require("./rotating-log");

class SafariNetworkLog extends _rotatingLog.RotatingLog {
  constructor(showLogs) {
    super(showLogs, 'SafariNetwork');
  }

  getEntry(requestId) {
    let outputEntry;

    while (this.logs.length >= _rotatingLog.MAX_LOG_ENTRIES_COUNT) {
      const entry = this.logs.shift();

      if (entry && entry.requestId === requestId) {
        outputEntry = entry;
        this.logs.push(outputEntry);
        continue;
      }

      if (this.logIdxSinceLastRequest > 0) {
        this.logIdxSinceLastRequest--;
      }
    }

    if (!outputEntry) {
      for (let i = this.logs.length - 1; i >= 0; i--) {
        if (this.logs[i].requestId === requestId) {
          outputEntry = this.logs[i];
          this.logs.splice(i, 1);
          break;
        }
      }

      if (!outputEntry) {
        outputEntry = {
          requestId,
          logs: []
        };
      }

      this.logs.push(outputEntry);
    }

    return outputEntry;
  }

  addLogLine(method, out) {
    if (!this.isCapturing && !this.showLogs) {
      return;
    }

    if (['Network.dataReceived'].includes(method)) {
      return;
    }

    const outputEntry = this.getEntry(out.requestId);

    if (this.isCapturing) {
      outputEntry.logs = outputEntry.logs || [];
      outputEntry.logs.push(out);
    }

    if (!this.showLogs) {
      return;
    }

    if (method === 'Network.loadingFinished' || method === 'Network.loadingFailed') {
      this.printLogLine(outputEntry);
    }
  }

  getLogDetails(outputEntry) {
    const record = outputEntry.logs.reduce(function (record, entry) {
      record.requestId = entry.requestId;

      if (entry.response) {
        const url = _url.default.parse(entry.response.url);

        record.name = `${_lodash.default.last(url.pathname.split('/'))}${url.search ? `?${url.search}` : ''}` || url.host;
        record.status = entry.response.status;

        if (entry.response.timing) {
          record.time = entry.response.timing.receiveHeadersEnd || entry.response.timing.responseStart || 0;
        }

        record.source = entry.response.source;
      }

      if (entry.type) {
        record.type = entry.type;
      }

      if (entry.initiator) {
        record.initiator = entry.initiator;
      }

      if (entry.metrics) {
        record.size = entry.metrics.responseBodyBytesReceived || 0;
      }

      if (entry.errorText) {
        record.errorText = entry.errorText;
        record.cancelled = entry.canceled;
      }

      return record;
    }, {});
    return record;
  }

  printLogLine(outputEntry) {
    const {
      requestId,
      name,
      status,
      type,
      initiator = {},
      size = 0,
      time = 0,
      source,
      errorText,
      cancelled = false
    } = this.getLogDetails(outputEntry);
    this.log.debug(`Network event:`);
    this.log.debug(`  Id: ${requestId}`);
    this.log.debug(`  Name: ${name}`);
    this.log.debug(`  Status: ${status}`);
    this.log.debug(`  Type: ${type}`);
    this.log.debug(`  Initiator: ${initiator.type}`);

    for (const line of initiator.stackTrace || []) {
      const functionName = line.functionName || '(anonymous)';
      const url = !line.url || line.url === '[native code]' ? '' : `@${_lodash.default.last((_url.default.parse(line.url).pathname || '').split('/'))}:${line.lineNumber}`;
      this.log.debug(`    ${_lodash.default.padEnd(_lodash.default.truncate(functionName, {
        length: 20
      }), 21)} ${url}`);
    }

    const sizeStr = source.includes('cache') ? ` (from ${source.replace('-', ' ')})` : `${size}B`;
    this.log.debug(`  Size: ${sizeStr}`);
    this.log.debug(`  Time: ${Math.round(time)}ms`);

    if (errorText) {
      this.log.debug(`  Error: ${errorText}`);
    }

    if (_appiumSupport.util.hasValue(cancelled)) {
      this.log.debug(`  Cancelled: ${cancelled}`);
    }
  }

  async getLogs() {
    const logs = await super.getLogs();
    return logs.map(function (entry) {
      return Object.assign({}, entry, {
        level: 'INFO',
        timestamp: Date.now(),
        message: JSON.stringify(entry)
      });
    });
  }

}

exports.SafariNetworkLog = SafariNetworkLog;
var _default = SafariNetworkLog;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9kZXZpY2UtbG9nL3NhZmFyaS1uZXR3b3JrLWxvZy5qcyJdLCJuYW1lcyI6WyJTYWZhcmlOZXR3b3JrTG9nIiwiUm90YXRpbmdMb2ciLCJjb25zdHJ1Y3RvciIsInNob3dMb2dzIiwiZ2V0RW50cnkiLCJyZXF1ZXN0SWQiLCJvdXRwdXRFbnRyeSIsImxvZ3MiLCJsZW5ndGgiLCJNQVhfTE9HX0VOVFJJRVNfQ09VTlQiLCJlbnRyeSIsInNoaWZ0IiwicHVzaCIsImxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QiLCJpIiwic3BsaWNlIiwiYWRkTG9nTGluZSIsIm1ldGhvZCIsIm91dCIsImlzQ2FwdHVyaW5nIiwiaW5jbHVkZXMiLCJwcmludExvZ0xpbmUiLCJnZXRMb2dEZXRhaWxzIiwicmVjb3JkIiwicmVkdWNlIiwicmVzcG9uc2UiLCJ1cmwiLCJVUkwiLCJwYXJzZSIsIm5hbWUiLCJfIiwibGFzdCIsInBhdGhuYW1lIiwic3BsaXQiLCJzZWFyY2giLCJob3N0Iiwic3RhdHVzIiwidGltaW5nIiwidGltZSIsInJlY2VpdmVIZWFkZXJzRW5kIiwicmVzcG9uc2VTdGFydCIsInNvdXJjZSIsInR5cGUiLCJpbml0aWF0b3IiLCJtZXRyaWNzIiwic2l6ZSIsInJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQiLCJlcnJvclRleHQiLCJjYW5jZWxsZWQiLCJjYW5jZWxlZCIsImxvZyIsImRlYnVnIiwibGluZSIsInN0YWNrVHJhY2UiLCJmdW5jdGlvbk5hbWUiLCJsaW5lTnVtYmVyIiwicGFkRW5kIiwidHJ1bmNhdGUiLCJzaXplU3RyIiwicmVwbGFjZSIsIk1hdGgiLCJyb3VuZCIsInV0aWwiLCJoYXNWYWx1ZSIsImdldExvZ3MiLCJtYXAiLCJPYmplY3QiLCJhc3NpZ24iLCJsZXZlbCIsInRpbWVzdGFtcCIsIkRhdGUiLCJub3ciLCJtZXNzYWdlIiwiSlNPTiIsInN0cmluZ2lmeSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFD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QUlBLFdBQU96RCxJQUFJLENBQUMwRCxHQUFMLENBQVMsVUFBVXZELEtBQVYsRUFBaUI7QUFDL0IsYUFBT3dELE1BQU0sQ0FBQ0MsTUFBUCxDQUFjLEVBQWQsRUFBa0J6RCxLQUFsQixFQUF5QjtBQUM5QjBELFFBQUFBLEtBQUssRUFBRSxNQUR1QjtBQUU5QkMsUUFBQUEsU0FBUyxFQUFFQyxJQUFJLENBQUNDLEdBQUwsRUFGbUI7QUFHOUJDLFFBQUFBLE9BQU8sRUFBRUMsSUFBSSxDQUFDQyxTQUFMLENBQWVoRSxLQUFmO0FBSHFCLE9BQXpCLENBQVA7QUFLRCxLQU5NLENBQVA7QUFPRDs7QUF0THdDOzs7ZUEwTDVCVixnQiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgVVJMIGZyb20gJ3VybCc7XG5pbXBvcnQgeyB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHsgUm90YXRpbmdMb2csIE1BWF9MT0dfRU5UUklFU19DT1VOVCB9IGZyb20gJy4vcm90YXRpbmctbG9nJztcblxuXG5jbGFzcyBTYWZhcmlOZXR3b3JrTG9nIGV4dGVuZHMgUm90YXRpbmdMb2cge1xuICBjb25zdHJ1Y3RvciAoc2hvd0xvZ3MpIHtcbiAgICBzdXBlcihzaG93TG9ncywgJ1NhZmFyaU5ldHdvcmsnKTtcbiAgfVxuXG4gIGdldEVudHJ5IChyZXF1ZXN0SWQpIHtcbiAgICBsZXQgb3V0cHV0RW50cnk7XG4gICAgd2hpbGUgKHRoaXMubG9ncy5sZW5ndGggPj0gTUFYX0xPR19FTlRSSUVTX0NPVU5UKSB7XG4gICAgICAvLyBwdWxsIHRoZSBmaXJzdCBlbnRyeSwgd2hpY2ggaXMgdGhlIG9sZGVzdFxuICAgICAgY29uc3QgZW50cnkgPSB0aGlzLmxvZ3Muc2hpZnQoKTtcbiAgICAgIGlmIChlbnRyeSAmJiBlbnRyeS5yZXF1ZXN0SWQgPT09IHJlcXVlc3RJZCkge1xuICAgICAgICAvLyB3ZSBhcmUgYWRkaW5nIHRvIGFuIGV4aXN0aW5nIGVudHJ5LCBhbmQgaXQgd2FzIGFsbW9zdCByZW1vdmVkXG4gICAgICAgIC8vIGFkZCB0byB0aGUgZW5kIG9mIHRoZSBsaXN0IGFuZCB0cnkgYWdhaW5cbiAgICAgICAgb3V0cHV0RW50cnkgPSBlbnRyeTtcbiAgICAgICAgdGhpcy5sb2dzLnB1c2gob3V0cHV0RW50cnkpO1xuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIC8vIHdlJ3ZlIHJlbW92ZWQgYW4gZWxlbWVudCwgc28gdGhlIGNvdW50IGlzIGRvd24gb25lXG4gICAgICBpZiAodGhpcy5sb2dJZHhTaW5jZUxhc3RSZXF1ZXN0ID4gMCkge1xuICAgICAgICB0aGlzLmxvZ0lkeFNpbmNlTGFzdFJlcXVlc3QtLTtcbiAgICAgIH1cbiAgICB9XG5cblxuICAgIGlmICghb3V0cHV0RW50cnkpIHtcbiAgICAgIC8vIHdlIGRvIG5vdCB5ZXMgaGF2ZSBhbiBlbnRyeSB0byBhc3NvY2lhdGUgdGhpcyBiaXQgb2Ygb3V0cHV0IHdpdGhcbiAgICAgIC8vIG1vc3QgbGlrZWx5IHRoZSBlbnRyeSB3aWxsIGJlIGF0IHRoZSBlbmQgb2YgdGhlIGxpc3QsIHNvIHN0YXJ0IHRoZXJlXG4gICAgICBmb3IgKGxldCBpID0gdGhpcy5sb2dzLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKSB7XG4gICAgICAgIGlmICh0aGlzLmxvZ3NbaV0ucmVxdWVzdElkID09PSByZXF1ZXN0SWQpIHtcbiAgICAgICAgICAvLyBmb3VuZCBpdCFcbiAgICAgICAgICBvdXRwdXRFbnRyeSA9IHRoaXMubG9nc1tpXTtcbiAgICAgICAgICAvLyB0aGlzIGlzIG5vdyB0aGUgbW9zdCBjdXJyZW50IGVudHJ5LCBzbyByZW1vdmUgaXQgZnJvbSB0aGUgbGlzdFxuICAgICAgICAgIC8vIHRvIGJlIGFkZGVkIHRvIHRoZSBlbmQgYmVsb3dcbiAgICAgICAgICB0aGlzLmxvZ3Muc3BsaWNlKGksIDEpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIG5vdGhpbmcgaGFzIGJlZW4gZm91bmQsIHNvIGNyZWF0ZSBhIG5ldyBlbnRyeVxuICAgICAgaWYgKCFvdXRwdXRFbnRyeSkge1xuICAgICAgICBvdXRwdXRFbnRyeSA9IHtcbiAgICAgICAgICByZXF1ZXN0SWQsXG4gICAgICAgICAgbG9nczogW10sXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIGZpbmFsbHksIGFkZCB0aGUgZW50cnkgdG8gdGhlIGVuZCBvZiB0aGUgbGlzdFxuICAgICAgdGhpcy5sb2dzLnB1c2gob3V0cHV0RW50cnkpO1xuICAgIH1cblxuICAgIHJldHVybiBvdXRwdXRFbnRyeTtcbiAgfVxuXG4gIGFkZExvZ0xpbmUgKG1ldGhvZCwgb3V0KSB7XG4gICAgaWYgKCF0aGlzLmlzQ2FwdHVyaW5nICYmICF0aGlzLnNob3dMb2dzKSB7XG4gICAgICAvLyBuZWl0aGVyIGNhcHR1cmluZyBub3IgZGlzcGxheWluZywgc28gZG8gbm90aGluZ1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIGlmIChbJ05ldHdvcmsuZGF0YVJlY2VpdmVkJ10uaW5jbHVkZXMobWV0aG9kKSkge1xuICAgICAgLy8gc3RhdHVzIHVwZGF0ZSwgbm8gbmVlZCB0byBoYW5kbGVcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBldmVudHMgd2UgY2FyZSBhYm91dDpcbiAgICAvLyAgIE5ldHdvcmsucmVxdWVzdFdpbGxCZVNlbnRcbiAgICAvLyAgIE5ldHdvcmsucmVzcG9uc2VSZWNlaXZlZFxuICAgIC8vICAgTmV0d29yay5sb2FkaW5nRmluaXNoZWRcbiAgICAvLyAgIE5ldHdvcmsubG9hZGluZ0ZhaWxlZFxuXG4gICAgY29uc3Qgb3V0cHV0RW50cnkgPSB0aGlzLmdldEVudHJ5KG91dC5yZXF1ZXN0SWQpO1xuICAgIGlmICh0aGlzLmlzQ2FwdHVyaW5nKSB7XG4gICAgICAvLyBub3cgYWRkIHRoZSBvdXRwdXQgd2UganVzdCByZWNlaXZlZCB0byB0aGUgbG9ncyBmb3IgdGhpcyBwYXJ0aWN1bGFyIGVudHJ5XG4gICAgICBvdXRwdXRFbnRyeS5sb2dzID0gb3V0cHV0RW50cnkubG9ncyB8fCBbXTtcblxuICAgICAgb3V0cHV0RW50cnkubG9ncy5wdXNoKG91dCk7XG4gICAgfVxuXG4gICAgLy8gaWYgd2UgYXJlIG5vdCBkaXNwbGF5aW5nIHRoZSBsb2dzLFxuICAgIC8vIG9yIHdlIGFyZSBub3QgZmluaXNoZWQgZ2V0dGluZyBldmVudHMgZm9yIHRoaXMgbmV0d29yayBjYWxsLFxuICAgIC8vIHdlIGFyZSBkb25lXG4gICAgaWYgKCF0aGlzLnNob3dMb2dzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYgKG1ldGhvZCA9PT0gJ05ldHdvcmsubG9hZGluZ0ZpbmlzaGVkJyB8fCBtZXRob2QgPT09ICdOZXR3b3JrLmxvYWRpbmdGYWlsZWQnKSB7XG4gICAgICB0aGlzLnByaW50TG9nTGluZShvdXRwdXRFbnRyeSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0TG9nRGV0YWlscyAob3V0cHV0RW50cnkpIHtcbiAgICAvLyBleHRyYWN0IHRoZSBkYXRhXG4gICAgY29uc3QgcmVjb3JkID0gb3V0cHV0RW50cnkubG9ncy5yZWR1Y2UoZnVuY3Rpb24gKHJlY29yZCwgZW50cnkpIHtcbiAgICAgIHJlY29yZC5yZXF1ZXN0SWQgPSBlbnRyeS5yZXF1ZXN0SWQ7XG4gICAgICBpZiAoZW50cnkucmVzcG9uc2UpIHtcbiAgICAgICAgY29uc3QgdXJsID0gVVJMLnBhcnNlKGVudHJ5LnJlc3BvbnNlLnVybCk7XG4gICAgICAgIC8vIGdldCB0aGUgbGFzdCBwYXJ0IG9mIHRoZSB1cmwsIGFsb25nIHdpdGggdGhlIHF1ZXJ5IHN0cmluZywgaWYgcG9zc2libGVcbiAgICAgICAgcmVjb3JkLm5hbWUgPSBgJHtfLmxhc3QodXJsLnBhdGhuYW1lLnNwbGl0KCcvJykpfSR7dXJsLnNlYXJjaCA/IGA/JHt1cmwuc2VhcmNofWAgOiAnJ31gIHx8IHVybC5ob3N0O1xuICAgICAgICByZWNvcmQuc3RhdHVzID0gZW50cnkucmVzcG9uc2Uuc3RhdHVzO1xuICAgICAgICBpZiAoZW50cnkucmVzcG9uc2UudGltaW5nKSB7XG4gICAgICAgICAgcmVjb3JkLnRpbWUgPSBlbnRyeS5yZXNwb25zZS50aW1pbmcucmVjZWl2ZUhlYWRlcnNFbmRcbiAgICAgICAgICAgIHx8IGVudHJ5LnJlc3BvbnNlLnRpbWluZy5yZXNwb25zZVN0YXJ0XG4gICAgICAgICAgICB8fCAwO1xuICAgICAgICB9XG4gICAgICAgIHJlY29yZC5zb3VyY2UgPSBlbnRyeS5yZXNwb25zZS5zb3VyY2U7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkudHlwZSkge1xuICAgICAgICByZWNvcmQudHlwZSA9IGVudHJ5LnR5cGU7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkuaW5pdGlhdG9yKSB7XG4gICAgICAgIHJlY29yZC5pbml0aWF0b3IgPSBlbnRyeS5pbml0aWF0b3I7XG4gICAgICB9XG4gICAgICBpZiAoZW50cnkubWV0cmljcykge1xuICAgICAgICAvLyBTYWZhcmkgaGFzIGEgYG1ldHJpY3NgIG9iamVjdCBvbiBpdCdzIGBOZXR3b3JrLmxvYWRpbmdGaW5pc2hlZGAgZXZlbnRcbiAgICAgICAgcmVjb3JkLnNpemUgPSBlbnRyeS5tZXRyaWNzLnJlc3BvbnNlQm9keUJ5dGVzUmVjZWl2ZWQgfHwgMDtcbiAgICAgIH1cbiAgICAgIGlmIChlbnRyeS5lcnJvclRleHQpIHtcbiAgICAgICAgcmVjb3JkLmVycm9yVGV4dCA9IGVudHJ5LmVycm9yVGV4dDtcbiAgICAgICAgLy8gV2hlbiBhIG5ldHdvcmsgY2FsbCBpcyBjYW5jZWxsZWQsIFNhZmFyaSByZXR1cm5zIGBjYW5jZWxsZWRgIGFzIGVycm9yIHRleHRcbiAgICAgICAgLy8gYnV0IGhhcyBhIGJvb2xlYW4gYGNhbmNlbGVkYC4gTm9ybWFsaXplIHRoZSB0d28gc3BlbGxpbmdzIGluIGZhdm9yIG9mXG4gICAgICAgIC8vIHRoZSB0ZXh0LCB3aGljaCB3aWxsIGFsc28gYmUgZGlzcGxheWVkXG4gICAgICAgIHJlY29yZC5jYW5jZWxsZWQgPSBlbnRyeS5jYW5jZWxlZDtcbiAgICAgIH1cbiAgICAgIHJldHVybiByZWNvcmQ7XG4gICAgfSwge30pO1xuXG4gICAgcmV0dXJuIHJlY29yZDtcbiAgfVxuXG4gIHByaW50TG9nTGluZSAob3V0cHV0RW50cnkpIHtcbiAgICBjb25zdCB7XG4gICAgICByZXF1ZXN0SWQsXG4gICAgICBuYW1lLFxuICAgICAgc3RhdHVzLFxuICAgICAgdHlwZSxcbiAgICAgIGluaXRpYXRvciA9IHt9LFxuICAgICAgc2l6ZSA9IDAsXG4gICAgICB0aW1lID0gMCxcbiAgICAgIHNvdXJjZSxcbiAgICAgIGVycm9yVGV4dCxcbiAgICAgIGNhbmNlbGxlZCA9IGZhbHNlLFxuICAgIH0gPSB0aGlzLmdldExvZ0RldGFpbHMob3V0cHV0RW50cnkpO1xuXG4gICAgLy8gcHJpbnQgb3V0IHRoZSByZWNvcmQsIGZvcm1hdHRlZCBhcHByb3ByaWF0ZWx5XG4gICAgdGhpcy5sb2cuZGVidWcoYE5ldHdvcmsgZXZlbnQ6YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgSWQ6ICR7cmVxdWVzdElkfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIE5hbWU6ICR7bmFtZX1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBTdGF0dXM6ICR7c3RhdHVzfWApO1xuICAgIHRoaXMubG9nLmRlYnVnKGAgIFR5cGU6ICR7dHlwZX1gKTtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBJbml0aWF0b3I6ICR7aW5pdGlhdG9yLnR5cGV9YCk7XG4gICAgZm9yIChjb25zdCBsaW5lIG9mIChpbml0aWF0b3Iuc3RhY2tUcmFjZSB8fCBbXSkpIHtcbiAgICAgIGNvbnN0IGZ1bmN0aW9uTmFtZSA9IGxpbmUuZnVuY3Rpb25OYW1lIHx8ICcoYW5vbnltb3VzKSc7XG5cbiAgICAgIGNvbnN0IHVybCA9ICghbGluZS51cmwgfHwgbGluZS51cmwgPT09ICdbbmF0aXZlIGNvZGVdJylcbiAgICAgICAgPyAnJ1xuICAgICAgICA6IGBAJHtfLmxhc3QoKFVSTC5wYXJzZShsaW5lLnVybCkucGF0aG5hbWUgfHwgJycpLnNwbGl0KCcvJykpfToke2xpbmUubGluZU51bWJlcn1gO1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCAgICAke18ucGFkRW5kKF8udHJ1bmNhdGUoZnVuY3Rpb25OYW1lLCB7bGVuZ3RoOiAyMH0pLCAyMSl9ICR7dXJsfWApO1xuICAgIH1cbiAgICAvLyBnZXQgYG1lbW9yeS1jYWNoZWAgb3IgYGRpc2stY2FjaGVgLCBldGMuLCByaWdodFxuICAgIGNvbnN0IHNpemVTdHIgPSBzb3VyY2UuaW5jbHVkZXMoJ2NhY2hlJykgPyBgIChmcm9tICR7c291cmNlLnJlcGxhY2UoJy0nLCAnICcpfSlgIDogYCR7c2l6ZX1CYDtcbiAgICB0aGlzLmxvZy5kZWJ1ZyhgICBTaXplOiAke3NpemVTdHJ9YCk7XG4gICAgdGhpcy5sb2cuZGVidWcoYCAgVGltZTogJHtNYXRoLnJvdW5kKHRpbWUpfW1zYCk7XG4gICAgaWYgKGVycm9yVGV4dCkge1xuICAgICAgdGhpcy5sb2cuZGVidWcoYCAgRXJyb3I6ICR7ZXJyb3JUZXh0fWApO1xuICAgIH1cbiAgICBpZiAodXRpbC5oYXNWYWx1ZShjYW5jZWxsZWQpKSB7XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgICBDYW5jZWxsZWQ6ICR7Y2FuY2VsbGVkfWApO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGdldExvZ3MgKCkge1xuICAgIGNvbnN0IGxvZ3MgPSBhd2FpdCBzdXBlci5nZXRMb2dzKCk7XG4gICAgLy8gaW4gb3JkZXIgdG8gc2F0aXNmeSBjZXJ0YWluIGNsaWVudHMsIHdlIG5lZWQgdG8gaGF2ZSBhIGJhc2ljIHN0cnVjdHVyZVxuICAgIC8vIHRvIHRoZSByZXN1bHRzLCB3aXRoIGBsZXZlbGAsIGB0aW1lc3RhbXBgLCBhbmQgYG1lc3NhZ2VgLCB3aGljaCBpc1xuICAgIC8vIGFsbCB0aGUgaW5mb3JtYXRpb24gc3RyaW5naWZpZWRcbiAgICByZXR1cm4gbG9ncy5tYXAoZnVuY3Rpb24gKGVudHJ5KSB7XG4gICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgZW50cnksIHtcbiAgICAgICAgbGV2ZWw6ICdJTkZPJyxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICBtZXNzYWdlOiBKU09OLnN0cmluZ2lmeShlbnRyeSksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgeyBTYWZhcmlOZXR3b3JrTG9nIH07XG5leHBvcnQgZGVmYXVsdCBTYWZhcmlOZXR3b3JrTG9nO1xuIl0sImZpbGUiOiJsaWIvZGV2aWNlLWxvZy9zYWZhcmktbmV0d29yay1sb2cuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
