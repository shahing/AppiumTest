"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.updateProjectFile = updateProjectFile;
exports.resetProjectFile = resetProjectFile;
exports.checkForDependencies = checkForDependencies;
exports.setRealDeviceSecurity = setRealDeviceSecurity;
exports.fixForXcode7 = fixForXcode7;
exports.fixForXcode9 = fixForXcode9;
exports.generateXcodeConfigFile = generateXcodeConfigFile;
exports.setXctestrunFile = setXctestrunFile;
exports.killProcess = killProcess;
exports.randomInt = randomInt;
exports.getWDAUpgradeTimestamp = getWDAUpgradeTimestamp;
exports.WDA_RUNNER_BUNDLE_ID = void 0;

require("source-map-support/register");

var _appiumSupport = require("appium-support");

var _teen_process = require("teen_process");

var _path = _interopRequireDefault(require("path"));

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

const WDA_RUNNER_BUNDLE_ID = 'com.facebook.WebDriverAgentRunner';
exports.WDA_RUNNER_BUNDLE_ID = WDA_RUNNER_BUNDLE_ID;
const PROJECT_FILE = 'project.pbxproj';
const XCUICOORDINATE_FILE = 'PrivateHeaders/XCTest/XCUICoordinate.h';
const FBMACROS_FILE = 'WebDriverAgentLib/Utilities/FBMacros.h';
const XCUIAPPLICATION_FILE = 'PrivateHeaders/XCTest/XCUIApplication.h';
const FBSESSION_FILE = 'WebDriverAgentLib/Routing/FBSession.m';
const CARTHAGE_ROOT = 'Carthage';

async function replaceInFile(file, find, replace) {
  let contents = await _appiumSupport.fs.readFile(file, 'utf8');
  let newContents = contents.replace(find, replace);

  if (newContents !== contents) {
    await _appiumSupport.fs.writeFile(file, newContents, 'utf8');
  }
}

async function updateProjectFile(agentPath, newBundleId) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    await _appiumSupport.fs.copyFile(projectFilePath, `${projectFilePath}.old`);
    await replaceInFile(projectFilePath, new RegExp(WDA_RUNNER_BUNDLE_ID.replace('.', '\.'), 'g'), newBundleId);

    _logger.default.debug(`Successfully updated '${projectFilePath}' with bundle id '${newBundleId}'`);
  } catch (err) {
    _logger.default.debug(`Error updating project file: ${err.message}`);

    _logger.default.warn(`Unable to update project file '${projectFilePath}' with ` + `bundle id '${newBundleId}'. WebDriverAgent may not start`);
  }
}

async function resetProjectFile(agentPath) {
  let projectFilePath = `${agentPath}/${PROJECT_FILE}`;

  try {
    if (!(await _appiumSupport.fs.exists(`${projectFilePath}.old`))) {
      return;
    }

    await _appiumSupport.fs.mv(`${projectFilePath}.old`, projectFilePath);

    _logger.default.debug(`Successfully reset '${projectFilePath}' with bundle id '${WDA_RUNNER_BUNDLE_ID}'`);
  } catch (err) {
    _logger.default.debug(`Error resetting project file: ${err.message}`);

    _logger.default.warn(`Unable to reset project file '${projectFilePath}' with ` + `bundle id '${WDA_RUNNER_BUNDLE_ID}'. WebDriverAgent has been ` + `modified and not returned to the original state.`);
  }
}

async function checkForDependencies(bootstrapPath, useSsl = false) {
  try {
    let carthagePath = await _appiumSupport.fs.which('carthage');

    _logger.default.debug(`Carthage found: '${carthagePath}'`);
  } catch (err) {
    _logger.default.errorAndThrow('Carthage binary is not found. Install using `brew install carthage` if it is not installed ' + 'and make sure the root folder, where carthage binary is installed, is present in PATH environment variable. ' + `The current PATH value: '${process.env.PATH ? process.env.PATH : "<not defined for the Appium process>"}'`);
  }

  const carthageRoot = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  let areDependenciesUpdated = false;

  if (!(await _appiumSupport.fs.hasAccess(carthageRoot))) {
    _logger.default.debug('Running WebDriverAgent bootstrap script to install dependencies');

    try {
      let args = useSsl ? ['-d', '-D'] : ['-d'];
      await (0, _teen_process.exec)('Scripts/bootstrap.sh', args, {
        cwd: bootstrapPath
      });
      areDependenciesUpdated = true;
    } catch (err) {
      for (let std of ['stdout', 'stderr']) {
        for (let line of (err[std] || '').split('\n')) {
          if (!line.length) {
            continue;
          }

          _logger.default.error(line);
        }
      }

      await _appiumSupport.fs.rimraf(carthageRoot);
      throw err;
    }
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources`))) {
    _logger.default.debug('Creating WebDriverAgent resources directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources`);
    areDependenciesUpdated = true;
  }

  if (!(await _appiumSupport.fs.hasAccess(`${bootstrapPath}/Resources/WebDriverAgent.bundle`))) {
    _logger.default.debug('Creating WebDriverAgent resource bundle directory');

    await _appiumSupport.fs.mkdir(`${bootstrapPath}/Resources/WebDriverAgent.bundle`);
    areDependenciesUpdated = true;
  }

  return areDependenciesUpdated;
}

async function setRealDeviceSecurity(keychainPath, keychainPassword) {
  _logger.default.debug('Setting security for iOS device');

  await (0, _teen_process.exec)('security', ['-v', 'list-keychains', '-s', keychainPath]);
  await (0, _teen_process.exec)('security', ['-v', 'unlock-keychain', '-p', keychainPassword, keychainPath]);
  await (0, _teen_process.exec)('security', ['set-keychain-settings', '-t', '3600', '-l', keychainPath]);
}

async function fixXCUICoordinateFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUICOORDINATE_FILE);

  let oldDef = '- (void)pressForDuration:(double)arg1 thenDragToCoordinate:(id)arg2;';
  let newDef = '- (void)pressForDuration:(NSTimeInterval)duration thenDragToCoordinate:(XCUICoordinate *)otherCoordinate;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixFBSessionFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBSESSION_FILE);

  let oldLine = 'return [FBApplication fb_activeApplication] ?: self.testedApplication;';
  let newLine = 'FBApplication *application = [FBApplication fb_activeApplication] ?: self.testedApplication;\n' + '  return application;';

  if (!initial) {
    [oldLine, newLine] = [newLine, oldLine];
  }

  await replaceInFile(file, oldLine, newLine);
}

async function fixForXcode7(bootstrapPath, initial = true, fixXcode9 = true) {
  if (fixXcode9) {
    await fixForXcode9(bootstrapPath, !initial, false);
  }

  await fixXCUICoordinateFile(bootstrapPath, initial);
  await fixFBSessionFile(bootstrapPath, initial);
}

async function fixFBMacrosFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, FBMACROS_FILE);

  let oldDef = '#define FBStringify(class, property) ({if(NO){[class.new property];} @#property;})';
  let newDef = '#define FBStringify(class, property) ({@#property;})';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixXCUIApplicationFile(bootstrapPath, initial = true) {
  const file = _path.default.resolve(bootstrapPath, XCUIAPPLICATION_FILE);

  let oldDef = '@property(nonatomic, readonly) NSUInteger state; // @synthesize state=_state;';
  let newDef = '@property XCUIApplicationState state;';

  if (!initial) {
    [oldDef, newDef] = [newDef, oldDef];
  }

  await replaceInFile(file, oldDef, newDef);
}

async function fixForXcode9(bootstrapPath, initial = true, fixXcode7 = true) {
  if (fixXcode7) {
    await fixForXcode7(bootstrapPath, !initial, false);
  }

  await fixFBMacrosFile(bootstrapPath, initial);
  await fixXCUIApplicationFile(bootstrapPath, initial);
}

async function generateXcodeConfigFile(orgId, signingId) {
  _logger.default.debug(`Generating xcode config file for orgId '${orgId}' and signingId ` + `'${signingId}'`);

  let contents = `DEVELOPMENT_TEAM = ${orgId}
CODE_SIGN_IDENTITY = ${signingId}
`;
  let xcconfigPath = await _appiumSupport.tempDir.path('appium-temp.xcconfig');

  _logger.default.debug(`Writing xcode config file to ${xcconfigPath}`);

  await _appiumSupport.fs.writeFile(xcconfigPath, contents, "utf8");
  return xcconfigPath;
}

async function setXctestrunFile(isRealDevice, udid, platformVersion, bootstrapPath, wdaRemotePort) {
  let xctestrunDeviceFileName = `${udid}_${platformVersion}.xctestrun`;

  let xctestrunFilePath = _path.default.resolve(bootstrapPath, xctestrunDeviceFileName);

  if (!(await _appiumSupport.fs.exists(xctestrunFilePath))) {
    let xctestBaseFileName = isRealDevice ? `WebDriverAgentRunner_iphoneos${platformVersion}-arm64.xctestrun` : `WebDriverAgentRunner_iphonesimulator${platformVersion}-x86_64.xctestrun`;

    let originalXctestrunFile = _path.default.resolve(bootstrapPath, xctestBaseFileName);

    if (!(await _appiumSupport.fs.exists(originalXctestrunFile))) {
      _logger.default.errorAndThrow(`if you are using useXctestrunFile capability then you need to have ${originalXctestrunFile} file`);
    }

    await _appiumSupport.fs.copyFile(originalXctestrunFile, xctestrunFilePath);
  }

  let xctestRunContent = await _appiumSupport.plist.parsePlistFile(xctestrunFilePath);
  let updateWDAPort = {
    WebDriverAgentRunner: {
      EnvironmentVariables: {
        USE_PORT: wdaRemotePort
      }
    }
  };

  let newXctestRunContent = _lodash.default.merge(xctestRunContent, updateWDAPort);

  await _appiumSupport.plist.updatePlistFile(xctestrunFilePath, newXctestRunContent, true);
  return xctestrunFilePath;
}

async function killProcess(name, proc) {
  if (proc && proc.proc) {
    _logger.default.info(`Shutting down ${name} process (pid ${proc.proc.pid})`);

    try {
      await proc.stop('SIGTERM', 1000);
    } catch (err) {
      if (!err.message.includes(`Process didn't end after`)) {
        throw err;
      }

      _logger.default.debug(`${name} process did not end in a timely fashion: '${err.message}'. ` + `Sending 'SIGKILL'...`);

      try {
        await proc.stop('SIGKILL');
      } catch (err) {
        if (err.message.includes('not currently running')) {
          return;
        }

        throw err;
      }
    }
  }
}

function randomInt(low, high) {
  return Math.floor(Math.random() * (high - low) + low);
}

async function getWDAUpgradeTimestamp(bootstrapPath) {
  const carthageRootPath = _path.default.resolve(bootstrapPath, CARTHAGE_ROOT);

  if (await _appiumSupport.fs.exists(carthageRootPath)) {
    const {
      mtime
    } = await _appiumSupport.fs.stat(carthageRootPath);
    return mtime.getTime();
  }

  return null;
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvdXRpbHMuanMiXSwibmFtZXMiOlsiV0RBX1JVTk5FUl9CVU5ETEVfSUQiLCJQUk9KRUNUX0ZJTEUiLCJYQ1VJQ09PUkRJTkFURV9GSUxFIiwiRkJNQUNST1NfRklMRSIsIlhDVUlBUFBMSUNBVElPTl9GSUxFIiwiRkJTRVNTSU9OX0ZJTEUiLCJDQVJUSEFHRV9ST09UIiwicmVwbGFjZUluRmlsZSIsImZpbGUiLCJmaW5kIiwicmVwbGFjZSIsImNvbnRlbnRzIiwiZnMiLCJyZWFkRmlsZSIsIm5ld0NvbnRlbnRzIiwid3JpdGVGaWxlIiwidXBkYXRlUHJvamVjdEZpbGUiLCJhZ2VudFBhdGgiLCJuZXdCdW5kbGVJZCIsInByb2plY3RGaWxlUGF0aCIsImNvcHlGaWxlIiwiUmVnRXhwIiwibG9nIiwiZGVidWciLCJlcnIiLCJtZXNzYWdlIiwid2FybiIsInJlc2V0UHJvamVjdEZpbGUiLCJleGlzdHMiLCJtdiIsImNoZWNrRm9yRGVwZW5kZW5jaWVzIiwiYm9vdHN0cmFwUGF0aCIsInVzZVNzbCIsImNhcnRoYWdlUGF0aCIsIndoaWNoIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwiY2FydGhhZ2VSb290IiwicGF0aCIsInJlc29sdmUiLCJhcmVEZXBlbmRlbmNpZXNVcGRhdGVkIiwiaGFzQWNjZXNzIiwiYXJncyIsImN3ZCIsInN0ZCIsImxpbmUiLCJzcGxpdCIsImxlbmd0aCIsImVycm9yIiwicmltcmFmIiwibWtkaXIiLCJzZXRSZWFsRGV2aWNlU2VjdXJpdHkiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwiZml4WENVSUNvb3JkaW5hdGVGaWxlIiwiaW5pdGlhbCIsIm9sZERlZiIsIm5ld0RlZiIsImZpeEZCU2Vzc2lvbkZpbGUiLCJvbGRMaW5lIiwibmV3TGluZSIsImZpeEZvclhjb2RlNyIsImZpeFhjb2RlOSIsImZpeEZvclhjb2RlOSIsImZpeEZCTWFjcm9zRmlsZSIsImZpeFhDVUlBcHBsaWNhdGlvbkZpbGUiLCJmaXhYY29kZTciLCJnZW5lcmF0ZVhjb2RlQ29uZmlnRmlsZSIsIm9yZ0lkIiwic2lnbmluZ0lkIiwieGNjb25maWdQYXRoIiwidGVtcERpciIsInNldFhjdGVzdHJ1bkZpbGUiLCJpc1JlYWxEZXZpY2UiLCJ1ZGlkIiwicGxhdGZvcm1WZXJzaW9uIiwid2RhUmVtb3RlUG9ydCIsInhjdGVzdHJ1bkRldmljZUZpbGVOYW1lIiwieGN0ZXN0cnVuRmlsZVBhdGgiLCJ4Y3Rlc3RCYXNlRmlsZU5hbWUiLCJvcmlnaW5hbFhjdGVzdHJ1bkZpbGUiLCJ4Y3Rlc3RSdW5Db250ZW50IiwicGxpc3QiLCJwYXJzZVBsaXN0RmlsZSIsInVwZGF0ZVdEQVBvcnQiLCJXZWJEcml2ZXJBZ2VudFJ1bm5lciIsIkVudmlyb25tZW50VmFyaWFibGVzIiwiVVNFX1BPUlQiLCJuZXdYY3Rlc3RSdW5Db250ZW50IiwiXyIsIm1lcmdlIiwidXBkYXRlUGxpc3RGaWxlIiwia2lsbFByb2Nlc3MiLCJuYW1lIiwicHJvYyIsImluZm8iLCJwaWQiLCJzdG9wIiwiaW5jbHVkZXMiLCJyYW5kb21JbnQiLCJsb3ciLCJoaWdoIiwiTWF0aCIsImZsb29yIiwicmFuZG9tIiwiZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCIsImNhcnRoYWdlUm9vdFBhdGgiLCJtdGltZSIsInN0YXQiLCJnZXRUaW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsb0JBQW9CLEdBQUcsbUNBQTdCOztBQUNBLE1BQU1DLFlBQVksR0FBRyxpQkFBckI7QUFDQSxNQUFNQyxtQkFBbUIsR0FBRyx3Q0FBNUI7QUFDQSxNQUFNQyxhQUFhLEdBQUcsd0NBQXRCO0FBQ0EsTUFBTUMsb0JBQW9CLEdBQUcseUNBQTdCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLHVDQUF2QjtBQUNBLE1BQU1DLGFBQWEsR0FBRyxVQUF0Qjs7QUFFQSxlQUFlQyxhQUFmLENBQThCQyxJ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LGVBQWVLLHNCQUFmLENBQXVDNUUsYUFBdkMsRUFBc0Q7QUFDcEQsUUFBTTZFLGdCQUFnQixHQUFHcEUsY0FBS0MsT0FBTCxDQUFhVixhQUFiLEVBQTRCekIsYUFBNUIsQ0FBekI7O0FBQ0EsTUFBSSxNQUFNTSxrQkFBR2dCLE1BQUgsQ0FBVWdGLGdCQUFWLENBQVYsRUFBdUM7QUFDckMsVUFBTTtBQUFDQyxNQUFBQTtBQUFELFFBQVUsTUFBTWpHLGtCQUFHa0csSUFBSCxDQUFRRixnQkFBUixDQUF0QjtBQUNBLFdBQU9DLEtBQUssQ0FBQ0UsT0FBTixFQUFQO0FBQ0Q7O0FBQ0QsU0FBTyxJQUFQO0FBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgdGVtcERpciwgcGxpc3QgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGxvZyBmcm9tICcuLi9sb2dnZXInO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuY29uc3QgV0RBX1JVTk5FUl9CVU5ETEVfSUQgPSAnY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyJztcbmNvbnN0IFBST0pFQ1RfRklMRSA9ICdwcm9qZWN0LnBieHByb2onO1xuY29uc3QgWENVSUNPT1JESU5BVEVfRklMRSA9ICdQcml2YXRlSGVhZGVycy9YQ1Rlc3QvWENVSUNvb3JkaW5hdGUuaCc7XG5jb25zdCBGQk1BQ1JPU19GSUxFID0gJ1dlYkRyaXZlckFnZW50TGliL1V0aWxpdGllcy9GQk1hY3Jvcy5oJztcbmNvbnN0IFhDVUlBUFBMSUNBVElPTl9GSUxFID0gJ1ByaXZhdGVIZWFkZXJzL1hDVGVzdC9YQ1VJQXBwbGljYXRpb24uaCc7XG5jb25zdCBGQlNFU1NJT05fRklMRSA9ICdXZWJEcml2ZXJBZ2VudExpYi9Sb3V0aW5nL0ZCU2Vzc2lvbi5tJztcbmNvbnN0IENBUlRIQUdFX1JPT1QgPSAnQ2FydGhhZ2UnO1xuXG5hc3luYyBmdW5jdGlvbiByZXBsYWNlSW5GaWxlIChmaWxlLCBmaW5kLCByZXBsYWNlKSB7XG4gIGxldCBjb250ZW50cyA9IGF3YWl0IGZzLnJlYWRGaWxlKGZpbGUsICd1dGY4Jyk7XG5cbiAgbGV0IG5ld0NvbnRlbnRzID0gY29udGVudHMucmVwbGFjZShmaW5kLCByZXBsYWNlKTtcbiAgaWYgKG5ld0NvbnRlbnRzICE9PSBjb250ZW50cykge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShmaWxlLCBuZXdDb250ZW50cywgJ3V0ZjgnKTtcbiAgfVxufVxuXG4vKipcbiAqIFVwZGF0ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB3aXRoIG5ld0J1bmRsZUlkLlxuICogVGhpcyBtZXRob2QgYXNzdW1lcyBwcm9qZWN0IGZpbGUgaXMgaW4gdGhlIGNvcnJlY3Qgc3RhdGUuXG4gKiBAcGFyYW0ge3N0cmluZ30gYWdlbnRQYXRoIC0gUGF0aCB0byB0aGUgLnhjb2RlcHJvaiBkaXJlY3RvcnkuXG4gKiBAcGFyYW0ge3N0cmluZ30gbmV3QnVuZGxlSWQgdGhlIG5ldyBidW5kbGUgSUQgdXNlZCB0byB1cGRhdGUuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwZGF0ZVByb2plY3RGaWxlIChhZ2VudFBhdGgsIG5ld0J1bmRsZUlkKSB7XG4gIGxldCBwcm9qZWN0RmlsZVBhdGggPSBgJHthZ2VudFBhdGh9LyR7UFJPSkVDVF9GSUxFfWA7XG4gIHRyeSB7XG4gICAgLy8gQXNzdW1pbmcgcHJvamVjdEZpbGVQYXRoIGlzIGluIHRoZSBjb3JyZWN0IHN0YXRlLCBjcmVhdGUgLm9sZCBmcm9tIHByb2plY3RGaWxlUGF0aFxuICAgIGF3YWl0IGZzLmNvcHlGaWxlKHByb2plY3RGaWxlUGF0aCwgYCR7cHJvamVjdEZpbGVQYXRofS5vbGRgKTtcbiAgICBhd2FpdCByZXBsYWNlSW5GaWxlKHByb2plY3RGaWxlUGF0aCwgbmV3IFJlZ0V4cChXREFfUlVOTkVSX0JVTkRMRV9JRC5yZXBsYWNlKCcuJywgJ1xcLicpLCAnZycpLCBuZXdCdW5kbGVJZCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgbm8tdXNlbGVzcy1lc2NhcGVcbiAgICBsb2cuZGVidWcoYFN1Y2Nlc3NmdWxseSB1cGRhdGVkICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYnVuZGxlIGlkICcke25ld0J1bmRsZUlkfSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmRlYnVnKGBFcnJvciB1cGRhdGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byB1cGRhdGUgcHJvamVjdCBmaWxlICcke3Byb2plY3RGaWxlUGF0aH0nIHdpdGggYCArXG4gICAgICAgICAgICAgYGJ1bmRsZSBpZCAnJHtuZXdCdW5kbGVJZH0nLiBXZWJEcml2ZXJBZ2VudCBtYXkgbm90IHN0YXJ0YCk7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXNldCBXZWJEcml2ZXJBZ2VudFJ1bm5lciBwcm9qZWN0IGJ1bmRsZSBJRCB0byBjb3JyZWN0IHN0YXRlLlxuICogQHBhcmFtIHtzdHJpbmd9IGFnZW50UGF0aCAtIFBhdGggdG8gdGhlIC54Y29kZXByb2ogZGlyZWN0b3J5LlxuICovXG5hc3luYyBmdW5jdGlvbiByZXNldFByb2plY3RGaWxlIChhZ2VudFBhdGgpIHtcbiAgbGV0IHByb2plY3RGaWxlUGF0aCA9IGAke2FnZW50UGF0aH0vJHtQUk9KRUNUX0ZJTEV9YDtcbiAgdHJ5IHtcbiAgICAvLyByZXN0b3JlIHByb2plY3RGaWxlUGF0aCBmcm9tIC5vbGQgZmlsZVxuICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKGAke3Byb2plY3RGaWxlUGF0aH0ub2xkYCkpIHtcbiAgICAgIHJldHVybjsgLy8gbm8gbmVlZCB0byByZXNldFxuICAgIH1cbiAgICBhd2FpdCBmcy5tdihgJHtwcm9qZWN0RmlsZVBhdGh9Lm9sZGAsIHByb2plY3RGaWxlUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBTdWNjZXNzZnVsbHkgcmVzZXQgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBidW5kbGUgaWQgJyR7V0RBX1JVTk5FUl9CVU5ETEVfSUR9J2ApO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZGVidWcoYEVycm9yIHJlc2V0dGluZyBwcm9qZWN0IGZpbGU6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byByZXNldCBwcm9qZWN0IGZpbGUgJyR7cHJvamVjdEZpbGVQYXRofScgd2l0aCBgICtcbiAgICAgICAgICAgICBgYnVuZGxlIGlkICcke1dEQV9SVU5ORVJfQlVORExFX0lEfScuIFdlYkRyaXZlckFnZW50IGhhcyBiZWVuIGAgK1xuICAgICAgICAgICAgIGBtb2RpZmllZCBhbmQgbm90IHJldHVybmVkIHRvIHRoZSBvcmlnaW5hbCBzdGF0ZS5gKTtcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjaGVja0ZvckRlcGVuZGVuY2llcyAoYm9vdHN0cmFwUGF0aCwgdXNlU3NsID0gZmFsc2UpIHtcbiAgdHJ5IHtcbiAgICBsZXQgY2FydGhhZ2VQYXRoID0gYXdhaXQgZnMud2hpY2goJ2NhcnRoYWdlJyk7XG4gICAgbG9nLmRlYnVnKGBDYXJ0aGFnZSBmb3VuZDogJyR7Y2FydGhhZ2VQYXRofSdgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coJ0NhcnRoYWdlIGJpbmFyeSBpcyBub3QgZm91bmQuIEluc3RhbGwgdXNpbmcgYGJyZXcgaW5zdGFsbCBjYXJ0aGFnZWAgaWYgaXQgaXMgbm90IGluc3RhbGxlZCAnICtcbiAgICAgICdhbmQgbWFrZSBzdXJlIHRoZSByb290IGZvbGRlciwgd2hlcmUgY2FydGhhZ2UgYmluYXJ5IGlzIGluc3RhbGxlZCwgaXMgcHJlc2VudCBpbiBQQVRIIGVudmlyb25tZW50IHZhcmlhYmxlLiAnICtcbiAgICAgIGBUaGUgY3VycmVudCBQQVRIIHZhbHVlOiAnJHtwcm9jZXNzLmVudi5QQVRIID8gcHJvY2Vzcy5lbnYuUEFUSCA6IFwiPG5vdCBkZWZpbmVkIGZvciB0aGUgQXBwaXVtIHByb2Nlc3M+XCJ9J2ApO1xuICB9XG4gIGNvbnN0IGNhcnRoYWdlUm9vdCA9IHBhdGgucmVzb2x2ZShib290c3RyYXBQYXRoLCBDQVJUSEFHRV9ST09UKTtcbiAgbGV0IGFyZURlcGVuZGVuY2llc1VwZGF0ZWQgPSBmYWxzZTtcbiAgaWYgKCFhd2FpdCBmcy5oYXNBY2Nlc3MoY2FydGhhZ2VSb290KSkge1xuICAgIGxvZy5kZWJ1ZygnUnVubmluZyBXZWJEcml2ZXJBZ2VudCBib290c3RyYXAgc2NyaXB0IHRvIGluc3RhbGwgZGVwZW5kZW5jaWVzJyk7XG4gICAgdHJ5IHtcbiAgICAgIGxldCBhcmdzID0gdXNlU3NsID8gWyctZCcsICctRCddIDogWyctZCddO1xuICAgICAgYXdhaXQgZXhlYygnU2NyaXB0cy9ib290c3RyYXAuc2gnLCBhcmdzLCB7Y3dkOiBib290c3RyYXBQYXRofSk7XG4gICAgICBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gdHJ1ZTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIC8vIHByaW50IG91dCB0aGUgc3Rkb3V0IGFuZCBzdGRlcnIgcmVwb3J0c1xuICAgICAgZm9yIChsZXQgc3RkIG9mIFsnc3Rkb3V0JywgJ3N0ZGVyciddKSB7XG4gICAgICAgIGZvciAobGV0IGxpbmUgb2YgKGVycltzdGRdIHx8ICcnKS5zcGxpdCgnXFxuJykpIHtcbiAgICAgICAgICBpZiAoIWxpbmUubGVuZ3RoKSB7XG4gICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICB9XG4gICAgICAgICAgbG9nLmVycm9yKGxpbmUpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICAvLyByZW1vdmUgdGhlIGNhcnRoYWdlIGRpcmVjdG9yeSwgb3IgZWxzZSBzdWJzZXF1ZW50IHJ1bnMgd2lsbCBzZWUgaXQgYW5kXG4gICAgICAvLyBhc3N1bWUgdGhlIGRlcGVuZGVuY2llcyBhcmUgYWxyZWFkeSBkb3dubG9hZGVkXG4gICAgICBhd2FpdCBmcy5yaW1yYWYoY2FydGhhZ2VSb290KTtcblxuICAgICAgdGhyb3cgZXJyO1xuICAgIH1cbiAgfVxuICBpZiAoIWF3YWl0IGZzLmhhc0FjY2VzcyhgJHtib290c3RyYXBQYXRofS9SZXNvdXJjZXNgKSkge1xuICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2VzIGRpcmVjdG9yeScpO1xuICAgIGF3YWl0IGZzLm1rZGlyKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlc2ApO1xuICAgIGFyZURlcGVuZGVuY2llc1VwZGF0ZWQgPSB0cnVlO1xuICB9XG4gIGlmICghYXdhaXQgZnMuaGFzQWNjZXNzKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKSkge1xuICAgIGxvZy5kZWJ1ZygnQ3JlYXRpbmcgV2ViRHJpdmVyQWdlbnQgcmVzb3VyY2UgYnVuZGxlIGRpcmVjdG9yeScpO1xuICAgIGF3YWl0IGZzLm1rZGlyKGAke2Jvb3RzdHJhcFBhdGh9L1Jlc291cmNlcy9XZWJEcml2ZXJBZ2VudC5idW5kbGVgKTtcbiAgICBhcmVEZXBlbmRlbmNpZXNVcGRhdGVkID0gdHJ1ZTtcbiAgfVxuICByZXR1cm4gYXJlRGVwZW5kZW5jaWVzVXBkYXRlZDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc2V0UmVhbERldmljZVNlY3VyaXR5IChrZXljaGFpblBhdGgsIGtleWNoYWluUGFzc3dvcmQpIHtcbiAgbG9nLmRlYnVnKCdTZXR0aW5nIHNlY3VyaXR5IGZvciBpT1MgZGV2aWNlJyk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWyctdicsICdsaXN0LWtleWNoYWlucycsICctcycsIGtleWNoYWluUGF0aF0pO1xuICBhd2FpdCBleGVjKCdzZWN1cml0eScsIFsnLXYnLCAndW5sb2NrLWtleWNoYWluJywgJy1wJywga2V5Y2hhaW5QYXNzd29yZCwga2V5Y2hhaW5QYXRoXSk7XG4gIGF3YWl0IGV4ZWMoJ3NlY3VyaXR5JywgWydzZXQta2V5Y2hhaW4tc2V0dGluZ3MnLCAnLXQnLCAnMzYwMCcsICctbCcsIGtleWNoYWluUGF0aF0pO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhYQ1VJQ29vcmRpbmF0ZUZpbGUgKGJvb3RzdHJhcFBhdGgsIGluaXRpYWwgPSB0cnVlKSB7XG4gIC8vIHRoZSB3YXkgdGhlIHVwZGF0ZWQgWENUZXN0IGhlYWRlcnMgYXJlIGluIHRoZSBXREEgcHJvamVjdCwgYnVpbGRpbmcgaW5cbiAgLy8gWGNvZGUgOC4wIGNhdXNlcyBhIGR1cGxpY2F0ZSBkZWNsYXJhdGlvbiBvZiBtZXRob2RcbiAgLy8gc28gZml4IHRoZSBvZmZlbmRpbmcgbGluZSBpbiB0aGUgbG9jYWwgaGVhZGVyc1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIFhDVUlDT09SRElOQVRFX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnLSAodm9pZClwcmVzc0ZvckR1cmF0aW9uOihkb3VibGUpYXJnMSB0aGVuRHJhZ1RvQ29vcmRpbmF0ZTooaWQpYXJnMjsnO1xuICBsZXQgbmV3RGVmID0gJy0gKHZvaWQpcHJlc3NGb3JEdXJhdGlvbjooTlNUaW1lSW50ZXJ2YWwpZHVyYXRpb24gdGhlbkRyYWdUb0Nvb3JkaW5hdGU6KFhDVUlDb29yZGluYXRlICopb3RoZXJDb29yZGluYXRlOyc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhGQlNlc3Npb25GaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIEZCU0VTU0lPTl9GSUxFKTtcblxuICBsZXQgb2xkTGluZSA9ICdyZXR1cm4gW0ZCQXBwbGljYXRpb24gZmJfYWN0aXZlQXBwbGljYXRpb25dID86IHNlbGYudGVzdGVkQXBwbGljYXRpb247JztcbiAgbGV0IG5ld0xpbmUgPSAnRkJBcHBsaWNhdGlvbiAqYXBwbGljYXRpb24gPSBbRkJBcHBsaWNhdGlvbiBmYl9hY3RpdmVBcHBsaWNhdGlvbl0gPzogc2VsZi50ZXN0ZWRBcHBsaWNhdGlvbjtcXG4nICtcbiAgICAgICAgICAgICAgICAnICByZXR1cm4gYXBwbGljYXRpb247JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZExpbmUsIG5ld0xpbmVdID0gW25ld0xpbmUsIG9sZExpbmVdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkTGluZSwgbmV3TGluZSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZvclhjb2RlNyAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUsIGZpeFhjb2RlOSA9IHRydWUpIHtcbiAgaWYgKGZpeFhjb2RlOSkge1xuICAgIGF3YWl0IGZpeEZvclhjb2RlOShib290c3RyYXBQYXRoLCAhaW5pdGlhbCwgZmFsc2UpO1xuICB9XG4gIGF3YWl0IGZpeFhDVUlDb29yZGluYXRlRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbiAgYXdhaXQgZml4RkJTZXNzaW9uRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZml4RkJNYWNyb3NGaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIEZCTUFDUk9TX0ZJTEUpO1xuXG4gIGxldCBvbGREZWYgPSAnI2RlZmluZSBGQlN0cmluZ2lmeShjbGFzcywgcHJvcGVydHkpICh7aWYoTk8pe1tjbGFzcy5uZXcgcHJvcGVydHldO30gQCNwcm9wZXJ0eTt9KSc7XG4gIGxldCBuZXdEZWYgPSAnI2RlZmluZSBGQlN0cmluZ2lmeShjbGFzcywgcHJvcGVydHkpICh7QCNwcm9wZXJ0eTt9KSc7XG4gIGlmICghaW5pdGlhbCkge1xuICAgIFtvbGREZWYsIG5ld0RlZl0gPSBbbmV3RGVmLCBvbGREZWZdO1xuICB9XG4gIGF3YWl0IHJlcGxhY2VJbkZpbGUoZmlsZSwgb2xkRGVmLCBuZXdEZWYpO1xufVxuXG5hc3luYyBmdW5jdGlvbiBmaXhYQ1VJQXBwbGljYXRpb25GaWxlIChib290c3RyYXBQYXRoLCBpbml0aWFsID0gdHJ1ZSkge1xuICBjb25zdCBmaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIFhDVUlBUFBMSUNBVElPTl9GSUxFKTtcblxuICBsZXQgb2xkRGVmID0gJ0Bwcm9wZXJ0eShub25hdG9taWMsIHJlYWRvbmx5KSBOU1VJbnRlZ2VyIHN0YXRlOyAvLyBAc3ludGhlc2l6ZSBzdGF0ZT1fc3RhdGU7JztcbiAgbGV0IG5ld0RlZiA9ICdAcHJvcGVydHkgWENVSUFwcGxpY2F0aW9uU3RhdGUgc3RhdGU7JztcbiAgaWYgKCFpbml0aWFsKSB7XG4gICAgW29sZERlZiwgbmV3RGVmXSA9IFtuZXdEZWYsIG9sZERlZl07XG4gIH1cbiAgYXdhaXQgcmVwbGFjZUluRmlsZShmaWxlLCBvbGREZWYsIG5ld0RlZik7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGZpeEZvclhjb2RlOSAoYm9vdHN0cmFwUGF0aCwgaW5pdGlhbCA9IHRydWUsIGZpeFhjb2RlNyA9IHRydWUpIHtcbiAgaWYgKGZpeFhjb2RlNykge1xuICAgIGF3YWl0IGZpeEZvclhjb2RlNyhib290c3RyYXBQYXRoLCAhaW5pdGlhbCwgZmFsc2UpO1xuICB9XG4gIGF3YWl0IGZpeEZCTWFjcm9zRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbiAgYXdhaXQgZml4WENVSUFwcGxpY2F0aW9uRmlsZShib290c3RyYXBQYXRoLCBpbml0aWFsKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZ2VuZXJhdGVYY29kZUNvbmZpZ0ZpbGUgKG9yZ0lkLCBzaWduaW5nSWQpIHtcbiAgbG9nLmRlYnVnKGBHZW5lcmF0aW5nIHhjb2RlIGNvbmZpZyBmaWxlIGZvciBvcmdJZCAnJHtvcmdJZH0nIGFuZCBzaWduaW5nSWQgYCArXG4gICAgICAgICAgICBgJyR7c2lnbmluZ0lkfSdgKTtcbiAgbGV0IGNvbnRlbnRzID0gYERFVkVMT1BNRU5UX1RFQU0gPSAke29yZ0lkfVxuQ09ERV9TSUdOX0lERU5USVRZID0gJHtzaWduaW5nSWR9XG5gO1xuICBsZXQgeGNjb25maWdQYXRoID0gYXdhaXQgdGVtcERpci5wYXRoKCdhcHBpdW0tdGVtcC54Y2NvbmZpZycpO1xuICBsb2cuZGVidWcoYFdyaXRpbmcgeGNvZGUgY29uZmlnIGZpbGUgdG8gJHt4Y2NvbmZpZ1BhdGh9YCk7XG4gIGF3YWl0IGZzLndyaXRlRmlsZSh4Y2NvbmZpZ1BhdGgsIGNvbnRlbnRzLCBcInV0ZjhcIik7XG4gIHJldHVybiB4Y2NvbmZpZ1BhdGg7XG59XG5cbi8qKlxuICogQ3JlYXRlcyB4Y3Rlc3RydW4gZmlsZSBwZXIgZGV2aWNlICYgcGxhdGZvcm0gdmVyc2lvbi5cbiAqIFdlIGV4cGVjdHMgdG8gaGF2ZSBXZWJEcml2ZXJBZ2VudFJ1bm5lcl9pcGhvbmVvcyR7cGxhdGZvcm1WZXJzaW9ufS1hcm02NC54Y3Rlc3RydW4gZm9yIHJlYWwgZGV2aWNlXG4gKiBhbmQgV2ViRHJpdmVyQWdlbnRSdW5uZXJfaXBob25lc2ltdWxhdG9yJHtwbGF0Zm9ybVZlcnNpb259LXg4Nl82NC54Y3Rlc3RydW4gZm9yIHNpbXVsYXRvciBsb2NhdGVkIEBib290c3RyYXBQYXRoXG4gKlxuICogQHBhcmFtIHtib29sZWFufSBpc1JlYWxEZXZpY2UgLSBFcXVhbHMgdG8gdHJ1ZSBpZiB0aGUgY3VycmVudCBkZXZpY2UgaXMgYSByZWFsIGRldmljZVxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgLSBUaGUgZGV2aWNlIFVESUQuXG4gKiBAcGFyYW0ge3N0cmluZ30gcGxhdGZvcm1WZXJzaW9uIC0gVGhlIHBsYXRmb3JtIHZlcnNpb24gb2YgT1MuXG4gKiBAcGFyYW0ge3N0cmluZ30gYm9vdHN0cmFwUGF0aCAtIFRoZSBmb2xkZXIgcGF0aCBjb250YWluaW5nIHhjdGVzdHJ1biBmaWxlLlxuICogQHBhcmFtIHtzdHJpbmd9IHdkYVJlbW90ZVBvcnQgLSBUaGUgcmVtb3RlIHBvcnQgV0RBIGlzIGxpc3RlbmluZyBvbi5cbiAqIEByZXR1cm4ge3N0cmluZ30gcmV0dXJucyB4Y3Rlc3RydW5GaWxlUGF0aCBmb3IgZ2l2ZW4gZGV2aWNlXG4gKiBAdGhyb3dzIGlmIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtwbGF0Zm9ybVZlcnNpb259LWFybTY0LnhjdGVzdHJ1biBmb3IgcmVhbCBkZXZpY2VcbiAqIG9yIFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuIGZvciBzaW11bGF0b3IgaXMgbm90IGZvdW5kIEBib290c3RyYXBQYXRoLFxuICogdGhlbiBpdCB3aWxsIHRocm93IGZpbGUgbm90IGZvdW5kIGV4Y2VwdGlvblxuICovXG5hc3luYyBmdW5jdGlvbiBzZXRYY3Rlc3RydW5GaWxlIChpc1JlYWxEZXZpY2UsIHVkaWQsIHBsYXRmb3JtVmVyc2lvbiwgYm9vdHN0cmFwUGF0aCwgd2RhUmVtb3RlUG9ydCkge1xuICBsZXQgeGN0ZXN0cnVuRGV2aWNlRmlsZU5hbWUgPSBgJHt1ZGlkfV8ke3BsYXRmb3JtVmVyc2lvbn0ueGN0ZXN0cnVuYDtcbiAgbGV0IHhjdGVzdHJ1bkZpbGVQYXRoID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIHhjdGVzdHJ1bkRldmljZUZpbGVOYW1lKTtcblxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyh4Y3Rlc3RydW5GaWxlUGF0aCkpIHtcbiAgICBsZXQgeGN0ZXN0QmFzZUZpbGVOYW1lID0gaXNSZWFsRGV2aWNlID8gYFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZW9zJHtwbGF0Zm9ybVZlcnNpb259LWFybTY0LnhjdGVzdHJ1bmAgOlxuICAgICAgYFdlYkRyaXZlckFnZW50UnVubmVyX2lwaG9uZXNpbXVsYXRvciR7cGxhdGZvcm1WZXJzaW9ufS14ODZfNjQueGN0ZXN0cnVuYDtcbiAgICBsZXQgb3JpZ2luYWxYY3Rlc3RydW5GaWxlID0gcGF0aC5yZXNvbHZlKGJvb3RzdHJhcFBhdGgsIHhjdGVzdEJhc2VGaWxlTmFtZSk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMob3JpZ2luYWxYY3Rlc3RydW5GaWxlKSkge1xuICAgICAgbG9nLmVycm9yQW5kVGhyb3coYGlmIHlvdSBhcmUgdXNpbmcgdXNlWGN0ZXN0cnVuRmlsZSBjYXBhYmlsaXR5IHRoZW4geW91IG5lZWQgdG8gaGF2ZSAke29yaWdpbmFsWGN0ZXN0cnVuRmlsZX0gZmlsZWApO1xuICAgIH1cbiAgICAvLyBJZiB0aGlzIGlzIGZpcnN0IHRpbWUgcnVuIGZvciBnaXZlbiBkZXZpY2UsIHRoZW4gZmlyc3QgZ2VuZXJhdGUgeGN0ZXN0cnVuIGZpbGUgZm9yIGRldmljZS5cbiAgICAvLyBXZSBuZWVkIHRvIGhhdmUgYSB4Y3Rlc3RydW4gZmlsZSBwZXIgZGV2aWNlIGJlY2F1c2Ugd2UgY2FudCBub3QgaGF2ZSBzYW1lIHdkYSBwb3J0IGZvciBhbGwgZGV2aWNlcy5cbiAgICBhd2FpdCBmcy5jb3B5RmlsZShvcmlnaW5hbFhjdGVzdHJ1bkZpbGUsIHhjdGVzdHJ1bkZpbGVQYXRoKTtcbiAgfVxuXG4gIGxldCB4Y3Rlc3RSdW5Db250ZW50ID0gYXdhaXQgcGxpc3QucGFyc2VQbGlzdEZpbGUoeGN0ZXN0cnVuRmlsZVBhdGgpO1xuXG4gIGxldCB1cGRhdGVXREFQb3J0ID0ge1xuICAgIFdlYkRyaXZlckFnZW50UnVubmVyOiB7XG4gICAgICBFbnZpcm9ubWVudFZhcmlhYmxlczoge1xuICAgICAgICBVU0VfUE9SVDogd2RhUmVtb3RlUG9ydFxuICAgICAgfVxuICAgIH1cbiAgfTtcblxuICBsZXQgbmV3WGN0ZXN0UnVuQ29udGVudCA9IF8ubWVyZ2UoeGN0ZXN0UnVuQ29udGVudCwgdXBkYXRlV0RBUG9ydCk7XG4gIGF3YWl0IHBsaXN0LnVwZGF0ZVBsaXN0RmlsZSh4Y3Rlc3RydW5GaWxlUGF0aCwgbmV3WGN0ZXN0UnVuQ29udGVudCwgdHJ1ZSk7XG5cbiAgcmV0dXJuIHhjdGVzdHJ1bkZpbGVQYXRoO1xufVxuXG5hc3luYyBmdW5jdGlvbiBraWxsUHJvY2VzcyAobmFtZSwgcHJvYykge1xuICBpZiAocHJvYyAmJiBwcm9jLnByb2MpIHtcbiAgICBsb2cuaW5mbyhgU2h1dHRpbmcgZG93biAke25hbWV9IHByb2Nlc3MgKHBpZCAke3Byb2MucHJvYy5waWR9KWApO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBwcm9jLnN0b3AoJ1NJR1RFUk0nLCAxMDAwKTtcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGlmICghZXJyLm1lc3NhZ2UuaW5jbHVkZXMoYFByb2Nlc3MgZGlkbid0IGVuZCBhZnRlcmApKSB7XG4gICAgICAgIHRocm93IGVycjtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgJHtuYW1lfSBwcm9jZXNzIGRpZCBub3QgZW5kIGluIGEgdGltZWx5IGZhc2hpb246ICcke2Vyci5tZXNzYWdlfScuIGAgK1xuICAgICAgICAgICAgICAgIGBTZW5kaW5nICdTSUdLSUxMJy4uLmApO1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgcHJvYy5zdG9wKCdTSUdLSUxMJyk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgaWYgKGVyci5tZXNzYWdlLmluY2x1ZGVzKCdub3QgY3VycmVudGx5IHJ1bm5pbmcnKSkge1xuICAgICAgICAgIC8vIHRoZSBwcm9jZXNzIGVuZGVkIGJ1dCBmb3Igc29tZSByZWFzb24gd2Ugd2VyZSBub3QgaW5mb3JtZWRcbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgfVxuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGEgcmFuZG9tIGludGVnZXIuXG4gKlxuICogQHJldHVybiB7bnVtYmVyfSBBIHJhbmRvbSBpbnRlZ2VyIG51bWJlciBpbiByYW5nZSBbbG93LCBoaWdodCkuIGBsb3dgYCBpcyBpbmNsdXNpdmUgYW5kIGBoaWdoYCBpcyBleGNsdXNpdmUuXG4gKi9cbmZ1bmN0aW9uIHJhbmRvbUludCAobG93LCBoaWdoKSB7XG4gIHJldHVybiBNYXRoLmZsb29yKE1hdGgucmFuZG9tKCkgKiAoaGlnaCAtIGxvdykgKyBsb3cpO1xufVxuXG4vKipcbiAqIFJldHJpZXZlcyBXREEgdXBncmFkZSB0aW1lc3RhbXBcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYm9vdHN0cmFwUGF0aCBUaGUgZnVsbCBwYXRoIHRvIHRoZSBmb2xkZXIgd2hlcmUgV0RBIHNvdXJjZSBpcyBsb2NhdGVkXG4gKiBAcmV0dXJuIHs/bnVtYmVyfSBUaGUgVU5JWCB0aW1lc3RhbXAgb2YgdGhlIGNhcnRoYWdlIHJvb3QgZm9sZGVyLCB3aGVyZSBkZXBlbmRlbmNpZXMgYXJlIGRvd25sb2FkZWQuXG4gKiBUaGlzIGZvbGRlciBpcyBjcmVhdGVkIG9ubHkgb25jZSBvbiBtb2R1bGUgdXBncmFkZS9maXJzdCBpbnN0YWxsLlxuICovXG5hc3luYyBmdW5jdGlvbiBnZXRXREFVcGdyYWRlVGltZXN0YW1wIChib290c3RyYXBQYXRoKSB7XG4gIGNvbnN0IGNhcnRoYWdlUm9vdFBhdGggPSBwYXRoLnJlc29sdmUoYm9vdHN0cmFwUGF0aCwgQ0FSVEhBR0VfUk9PVCk7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoY2FydGhhZ2VSb290UGF0aCkpIHtcbiAgICBjb25zdCB7bXRpbWV9ID0gYXdhaXQgZnMuc3RhdChjYXJ0aGFnZVJvb3RQYXRoKTtcbiAgICByZXR1cm4gbXRpbWUuZ2V0VGltZSgpO1xuICB9XG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgeyB1cGRhdGVQcm9qZWN0RmlsZSwgcmVzZXRQcm9qZWN0RmlsZSwgY2hlY2tGb3JEZXBlbmRlbmNpZXMsXG4gIHNldFJlYWxEZXZpY2VTZWN1cml0eSwgZml4Rm9yWGNvZGU3LCBmaXhGb3JYY29kZTksXG4gIGdlbmVyYXRlWGNvZGVDb25maWdGaWxlLCBzZXRYY3Rlc3RydW5GaWxlLCBraWxsUHJvY2VzcywgcmFuZG9tSW50LCBXREFfUlVOTkVSX0JVTkRMRV9JRCxcbiAgZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCB9O1xuIl0sImZpbGUiOiJsaWIvd2RhL3V0aWxzLmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
