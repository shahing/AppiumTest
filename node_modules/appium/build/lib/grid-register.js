"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _requestPromise = _interopRequireDefault(require("request-promise"));

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("./logger"));

const hubUri = config => {
  const protocol = config.hubProtocol || 'http';
  return `${protocol}://${config.hubHost}:${config.hubPort}`;
};

async function registerNode(configFile, addr, port) {
  let data;

  try {
    data = await _appiumSupport.fs.readFile(configFile, 'utf-8');
  } catch (err) {
    _logger.default.error(`Unable to load node configuration file to register with grid: ${err.message}`);

    return;
  }

  if (!data) {
    _logger.default.error('No data found in the node configuration file to send to the grid');

    return;
  }

  postRequest(data, addr, port);
}

async function registerToGrid(options_post, jsonObject) {
  try {
    let response = await (0, _requestPromise.default)(options_post);

    if (response === undefined || response.statusCode !== 200) {
      throw new Error('Request failed');
    }

    let logMessage = `Appium successfully registered with the grid on ${hubUri(jsonObject.configuration)}`;

    _logger.default.debug(logMessage);
  } catch (err) {
    _logger.default.error(`Request to register with grid was unsuccessful: ${err.message}`);
  }
}

function postRequest(data, addr, port) {
  let jsonObject;

  try {
    jsonObject = JSON.parse(data);
  } catch (err) {
    _logger.default.errorAndThrow(`Syntax error in node configuration file: ${err.message}`);
  }

  if (!jsonObject.hasOwnProperty('configuration')) {
    let configuration = {};

    for (let property in jsonObject) {
      if (jsonObject.hasOwnProperty(property) && property !== 'capabilities') {
        configuration[property] = jsonObject[property];
        delete jsonObject[property];
      }
    }

    jsonObject.configuration = configuration;
  }

  if (!jsonObject.configuration.url || !jsonObject.configuration.host || !jsonObject.configuration.port) {
    jsonObject.configuration.url = `http://${addr}:${port}/wd/hub`;
    jsonObject.configuration.host = addr;
    jsonObject.configuration.port = port;
  }

  if (!jsonObject.configuration.id) {
    jsonObject.configuration.id = `http://${jsonObject.configuration.host}:${jsonObject.configuration.port}`;
  }

  data = JSON.stringify(jsonObject);
  let post_headers = {
    'Content-Type': 'application/json',
    'Content-Length': data.length
  };
  let post_options = {
    url: `${hubUri(jsonObject.configuration)}/grid/register`,
    method: 'POST',
    body: data,
    headers: post_headers,
    resolveWithFullResponse: true
  };

  if (jsonObject.configuration.register !== true) {
    _logger.default.debug(`No registration sent (${jsonObject.configuration.register} = false)`);

    return;
  }

  let registerCycleTime = jsonObject.configuration.registerCycle;

  if (registerCycleTime !== null && registerCycleTime > 0) {
    let first = true;

    _logger.default.debug(`Starting auto register thread for grid. Will try to register every ${registerCycleTime} ms.`);

    setInterval(async function () {
      if (first !== true) {
        let isRegistered = await isAlreadyRegistered(jsonObject);

        if (isRegistered !== null && isRegistered !== true) {
          await registerToGrid(post_options, jsonObject);
        }
      } else {
        first = false;
        await registerToGrid(post_options, jsonObject);
      }
    }, registerCycleTime);
  }
}

async function isAlreadyRegistered(jsonObject) {
  let id = jsonObject.configuration.id;

  try {
    let response = await (0, _requestPromise.default)({
      uri: `${hubUri(jsonObject.configuration)}/grid/api/proxy?id=${id}`,
      method: 'GET',
      timeout: 10000,
      resolveWithFullResponse: true
    });

    if (response === undefined || response.statusCode !== 200) {
      throw new Error(`Request failed`);
    }

    let responseData = JSON.parse(response.body);

    if (responseData.success !== true) {
      _logger.default.debug(`Grid registration error: ${responseData.msg}`);
    }

    return responseData.success;
  } catch (err) {
    _logger.default.debug(`Hub down or not responding: ${err.message}`);
  }
}

var _default = registerNode;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9ncmlkLXJlZ2lzdGVyLmpzIl0sIm5hbWVzIjpbImh1YlVyaSIsImNvbmZpZyIsInByb3RvY29sIiwiaHViUHJvdG9jb2wiLCJodWJIb3N0IiwiaHViUG9ydCIsInJlZ2lzdGVyTm9kZSIsImNvbmZpZ0ZpbGUiLCJhZGRyIiwicG9ydCIsImRhdGEiLCJmcyIsInJlYWRGaWxlIiwiZXJyIiwibG9nZ2VyIiwiZXJyb3IiLCJtZXNzYWdlIiwicG9zdFJlcXVlc3QiLCJyZWdpc3RlclRvR3JpZCIsIm9wdGlvbnNfcG9zdCIsImpzb25PYmplY3QiLCJyZXNwb25zZSIsInVuZGVmaW5lZCIsInN0YXR1c0NvZGUiLCJFcnJvciIsImxvZ01lc3NhZ2UiLCJjb25maWd1cmF0aW9uIiwiZGVidWciLCJKU09OIiwicGFyc2UiLCJlcnJvckFuZFRocm93IiwiaGFzT3duUHJvcGVydHkiLCJwcm9wZXJ0eSIsInVybCIsImhvc3QiLCJpZCIsInN0cmluZ2lmeSIsInBvc3RfaGVhZGVycyIsImxlbmd0aCIsInBvc3Rfb3B0aW9ucyIsIm1ldGhvZCIsImJvZHkiLCJoZWFkZXJzIiwicmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2UiLCJyZWdpc3RlciIsInJlZ2lzdGVyQ3ljbGVUaW1lIiwicmVnaXN0ZXJDeWNsZSIsImZpcnN0Iiwic2V0SW50ZXJ2YWwiLCJpc1JlZ2lzdGVyZWQiLCJpc0FscmVhZHlSZWdpc3RlcmVkIiwidXJpIiwidGltZW91dCIsInJlc3BvbnNlRGF0YSIsInN1Y2Nlc3MiLCJtc2ciXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsTUFBTSxHQUFJQyxNQUFELElBQVk7QUFDekIsUUFBTUMsUUFBUSxHQUFHRCxNQUFNLENBQUNFLFdBQVAsSUFBc0IsTUFBdkM7QUFDQSxTQUFRLEdBQUVELFFBQVMsTUFBS0QsTUFBTSxDQUFDRyxPQUFRLElBQUdILE1BQU0sQ0FBQ0ksT0FBUSxFQUF6RDtBQUNELENBSEQ7O0FB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WkMsb0JBQU9hLEtBQVAsQ0FBYywrQkFBOEJkLEdBQUcsQ0FBQ0csT0FBUSxFQUF4RDtBQUNEO0FBQ0Y7O2VBR2NWLFkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcmVxdWVzdCBmcm9tICdyZXF1ZXN0LXByb21pc2UnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nZ2VyIGZyb20gJy4vbG9nZ2VyJztcblxuY29uc3QgaHViVXJpID0gKGNvbmZpZykgPT4ge1xuICBjb25zdCBwcm90b2NvbCA9IGNvbmZpZy5odWJQcm90b2NvbCB8fCAnaHR0cCc7XG4gIHJldHVybiBgJHtwcm90b2NvbH06Ly8ke2NvbmZpZy5odWJIb3N0fToke2NvbmZpZy5odWJQb3J0fWA7XG59O1xuXG5hc3luYyBmdW5jdGlvbiByZWdpc3Rlck5vZGUgKGNvbmZpZ0ZpbGUsIGFkZHIsIHBvcnQpIHtcbiAgbGV0IGRhdGE7XG4gIHRyeSB7XG4gICAgZGF0YSA9IGF3YWl0IGZzLnJlYWRGaWxlKGNvbmZpZ0ZpbGUsICd1dGYtOCcpO1xuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2dnZXIuZXJyb3IoYFVuYWJsZSB0byBsb2FkIG5vZGUgY29uZmlndXJhdGlvbiBmaWxlIHRvIHJlZ2lzdGVyIHdpdGggZ3JpZDogJHtlcnIubWVzc2FnZX1gKTtcbiAgICByZXR1cm47XG4gIH1cblxuICAvLyBDaGVjayBwcmVzZW5jZSBvZiBkYXRhIGJlZm9yZSBwb3N0aW5nICBpdCB0byB0aGUgc2VsZW5pdW0gZ3JpZFxuICBpZiAoIWRhdGEpIHtcbiAgICBsb2dnZXIuZXJyb3IoJ05vIGRhdGEgZm91bmQgaW4gdGhlIG5vZGUgY29uZmlndXJhdGlvbiBmaWxlIHRvIHNlbmQgdG8gdGhlIGdyaWQnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgcG9zdFJlcXVlc3QoZGF0YSwgYWRkciwgcG9ydCk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyVG9HcmlkIChvcHRpb25zX3Bvc3QsIGpzb25PYmplY3QpIHtcbiAgdHJ5IHtcbiAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KG9wdGlvbnNfcG9zdCk7XG4gICAgaWYgKHJlc3BvbnNlID09PSB1bmRlZmluZWQgfHwgcmVzcG9uc2Uuc3RhdHVzQ29kZSAhPT0gMjAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1JlcXVlc3QgZmFpbGVkJyk7XG4gICAgfVxuICAgIGxldCBsb2dNZXNzYWdlID0gYEFwcGl1bSBzdWNjZXNzZnVsbHkgcmVnaXN0ZXJlZCB3aXRoIHRoZSBncmlkIG9uICR7aHViVXJpKGpzb25PYmplY3QuY29uZmlndXJhdGlvbil9YDtcbiAgICBsb2dnZXIuZGVidWcobG9nTWVzc2FnZSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZ2dlci5lcnJvcihgUmVxdWVzdCB0byByZWdpc3RlciB3aXRoIGdyaWQgd2FzIHVuc3VjY2Vzc2Z1bDogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwb3N0UmVxdWVzdCAoZGF0YSwgYWRkciwgcG9ydCkge1xuICAvLyBwYXJzZSBqc29uIHRvIGdldCBodWIgaG9zdCBhbmQgcG9ydFxuICBsZXQganNvbk9iamVjdDtcbiAgdHJ5IHtcbiAgICBqc29uT2JqZWN0ID0gSlNPTi5wYXJzZShkYXRhKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmVycm9yQW5kVGhyb3coYFN5bnRheCBlcnJvciBpbiBub2RlIGNvbmZpZ3VyYXRpb24gZmlsZTogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuXG4gIC8vIE1vdmUgU2VsZW5pdW0gMyBjb25maWd1cmF0aW9uIHByb3BlcnRpZXMgdG8gY29uZmlndXJhdGlvbiBvYmplY3RcbiAgaWYgKCFqc29uT2JqZWN0Lmhhc093blByb3BlcnR5KCdjb25maWd1cmF0aW9uJykpIHtcbiAgICBsZXQgY29uZmlndXJhdGlvbiA9IHt9O1xuICAgIGZvciAobGV0IHByb3BlcnR5IGluIGpzb25PYmplY3QpIHtcbiAgICAgIGlmIChqc29uT2JqZWN0Lmhhc093blByb3BlcnR5KHByb3BlcnR5KSAmJiBwcm9wZXJ0eSAhPT0gJ2NhcGFiaWxpdGllcycpIHtcbiAgICAgICAgY29uZmlndXJhdGlvbltwcm9wZXJ0eV0gPSBqc29uT2JqZWN0W3Byb3BlcnR5XTtcbiAgICAgICAgZGVsZXRlIGpzb25PYmplY3RbcHJvcGVydHldO1xuICAgICAgfVxuICAgIH1cbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24gPSBjb25maWd1cmF0aW9uO1xuICB9XG5cbiAgLy8gaWYgdGhlIG5vZGUgY29uZmlnIGRvZXMgbm90IGhhdmUgdGhlIGFwcGl1bS93ZWJkcml2ZXIgdXJsLCBob3N0LCBhbmQgcG9ydCxcbiAgLy8gYXV0b21hdGljYWxseSBhZGQgaXQgYmFzZWQgb24gaG93IGFwcGl1bSB3YXMgaW5pdGlhbGl6ZWRcbiAgLy8gb3RoZXJ3aXNlLCB3ZSB3aWxsIHRha2Ugd2hhdGV2ZXIgdGhlIHVzZXIgc2V0dXBcbiAgLy8gYmVjYXVzZSB3ZSB3aWxsIGFsd2F5cyBzZXQgbG9jYWxob3N0LzEyNy4wLjAuMS4gdGhpcyB3b24ndCB3b3JrIGlmIHlvdXJcbiAgLy8gbm9kZSBhbmQgZ3JpZCBhcmVuJ3QgaW4gdGhlIHNhbWUgcGxhY2VcbiAgaWYgKCFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24udXJsIHx8ICFqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaG9zdCB8fCAhanNvbk9iamVjdC5jb25maWd1cmF0aW9uLnBvcnQpIHtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24udXJsID0gYGh0dHA6Ly8ke2FkZHJ9OiR7cG9ydH0vd2QvaHViYDtcbiAgICBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24uaG9zdCA9IGFkZHI7XG4gICAganNvbk9iamVjdC5jb25maWd1cmF0aW9uLnBvcnQgPSBwb3J0O1xuICB9XG4gIC8vIGlmIHRoZSBub2RlIGNvbmZpZyBkb2VzIG5vdCBoYXZlIGlkIGF1dG9tYXRpY2FsbHkgYWRkIGl0XG4gIGlmICghanNvbk9iamVjdC5jb25maWd1cmF0aW9uLmlkKSB7XG4gICAganNvbk9iamVjdC5jb25maWd1cmF0aW9uLmlkID0gYGh0dHA6Ly8ke2pzb25PYmplY3QuY29uZmlndXJhdGlvbi5ob3N0fToke2pzb25PYmplY3QuY29uZmlndXJhdGlvbi5wb3J0fWA7XG4gIH1cblxuICAvLyByZS1zZXJpYWxpemUgdGhlIGNvbmZpZ3VyYXRpb24gd2l0aCB0aGUgYXV0byBwb3B1bGF0ZWQgZGF0YVxuICBkYXRhID0gSlNPTi5zdHJpbmdpZnkoanNvbk9iamVjdCk7XG5cbiAgLy8gcHJlcGFyZSB0aGUgaGVhZGVyXG4gIGxldCBwb3N0X2hlYWRlcnMgPSB7XG4gICAgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyxcbiAgICAnQ29udGVudC1MZW5ndGgnOiBkYXRhLmxlbmd0aFxuICB9O1xuICAvLyB0aGUgcG9zdCBvcHRpb25zXG4gIGxldCBwb3N0X29wdGlvbnMgPSB7XG4gICAgdXJsOiBgJHtodWJVcmkoanNvbk9iamVjdC5jb25maWd1cmF0aW9uKX0vZ3JpZC9yZWdpc3RlcmAsXG4gICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgYm9keTogZGF0YSxcbiAgICBoZWFkZXJzOiBwb3N0X2hlYWRlcnMsXG4gICAgcmVzb2x2ZVdpdGhGdWxsUmVzcG9uc2U6IHRydWUgLy8gcmV0dXJuIHRoZSBmdWxsIHJlc3BvbnNlLCBub3QganVzdCB0aGUgYm9keVxuICB9O1xuXG4gIGlmIChqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucmVnaXN0ZXIgIT09IHRydWUpIHtcbiAgICBsb2dnZXIuZGVidWcoYE5vIHJlZ2lzdHJhdGlvbiBzZW50ICgke2pzb25PYmplY3QuY29uZmlndXJhdGlvbi5yZWdpc3Rlcn0gPSBmYWxzZSlgKTtcbiAgICByZXR1cm47XG4gIH1cblxuICBsZXQgcmVnaXN0ZXJDeWNsZVRpbWUgPSBqc29uT2JqZWN0LmNvbmZpZ3VyYXRpb24ucmVnaXN0ZXJDeWNsZTtcbiAgaWYgKHJlZ2lzdGVyQ3ljbGVUaW1lICE9PSBudWxsICYmIHJlZ2lzdGVyQ3ljbGVUaW1lID4gMCkge1xuICAgIC8vIGluaXRpYXRlIGEgbmV3IFRocmVhZFxuICAgIGxldCBmaXJzdCA9IHRydWU7XG4gICAgbG9nZ2VyLmRlYnVnKGBTdGFydGluZyBhdXRvIHJlZ2lzdGVyIHRocmVhZCBmb3IgZ3JpZC4gV2lsbCB0cnkgdG8gcmVnaXN0ZXIgZXZlcnkgJHtyZWdpc3RlckN5Y2xlVGltZX0gbXMuYCk7XG4gICAgc2V0SW50ZXJ2YWwoYXN5bmMgZnVuY3Rpb24gKCkge1xuICAgICAgaWYgKGZpcnN0ICE9PSB0cnVlKSB7XG4gICAgICAgIGxldCBpc1JlZ2lzdGVyZWQgPSBhd2FpdCBpc0FscmVhZHlSZWdpc3RlcmVkKGpzb25PYmplY3QpO1xuICAgICAgICBpZiAoaXNSZWdpc3RlcmVkICE9PSBudWxsICYmIGlzUmVnaXN0ZXJlZCAhPT0gdHJ1ZSkge1xuICAgICAgICAgIC8vIG1ha2UgdGhlIGh0dHAgUE9TVCB0byB0aGUgZ3JpZCBmb3IgcmVnaXN0cmF0aW9uXG4gICAgICAgICAgYXdhaXQgcmVnaXN0ZXJUb0dyaWQocG9zdF9vcHRpb25zLCBqc29uT2JqZWN0KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmlyc3QgPSBmYWxzZTtcbiAgICAgICAgYXdhaXQgcmVnaXN0ZXJUb0dyaWQocG9zdF9vcHRpb25zLCBqc29uT2JqZWN0KTtcbiAgICAgIH1cbiAgICB9LCByZWdpc3RlckN5Y2xlVGltZSk7XG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gaXNBbHJlYWR5UmVnaXN0ZXJlZCAoanNvbk9iamVjdCkge1xuICAvL2NoZWNrIGlmIG5vZGUgaXMgYWxyZWFkeSByZWdpc3RlcmVkXG4gIGxldCBpZCA9IGpzb25PYmplY3QuY29uZmlndXJhdGlvbi5pZDtcbiAgdHJ5IHtcbiAgICBsZXQgcmVzcG9uc2UgPSBhd2FpdCByZXF1ZXN0KHtcbiAgICAgIHVyaTogYCR7aHViVXJpKGpzb25PYmplY3QuY29uZmlndXJhdGlvbil9L2dyaWQvYXBpL3Byb3h5P2lkPSR7aWR9YCxcbiAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICB0aW1lb3V0OiAxMDAwMCxcbiAgICAgIHJlc29sdmVXaXRoRnVsbFJlc3BvbnNlOiB0cnVlIC8vIHJldHVybiB0aGUgZnVsbCByZXNwb25zZSwgbm90IGp1c3QgdGhlIGJvZHlcbiAgICB9KTtcbiAgICBpZiAocmVzcG9uc2UgPT09IHVuZGVmaW5lZCB8fCByZXNwb25zZS5zdGF0dXNDb2RlICE9PSAyMDApIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWVzdCBmYWlsZWRgKTtcbiAgICB9XG4gICAgbGV0IHJlc3BvbnNlRGF0YSA9IEpTT04ucGFyc2UocmVzcG9uc2UuYm9keSk7XG4gICAgaWYgKHJlc3BvbnNlRGF0YS5zdWNjZXNzICE9PSB0cnVlKSB7XG4gICAgICAvLyBpZiByZWdpc3RlciBmYWlsLCBwcmludCB0aGUgZGVidWcgbXNnXG4gICAgICBsb2dnZXIuZGVidWcoYEdyaWQgcmVnaXN0cmF0aW9uIGVycm9yOiAke3Jlc3BvbnNlRGF0YS5tc2d9YCk7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZURhdGEuc3VjY2VzcztcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nZ2VyLmRlYnVnKGBIdWIgZG93biBvciBub3QgcmVzcG9uZGluZzogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxufVxuXG5cbmV4cG9ydCBkZWZhdWx0IHJlZ2lzdGVyTm9kZTtcbiJdLCJmaWxlIjoibGliL2dyaWQtcmVnaXN0ZXIuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
