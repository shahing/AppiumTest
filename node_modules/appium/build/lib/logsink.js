"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.init = init;
exports.clear = clear;
exports.default = void 0;

require("source-map-support/register");

var _npmlog = _interopRequireDefault(require("npmlog"));

var _winston = require("winston");

var _appiumSupport = require("appium-support");

var _dateformat = _interopRequireDefault(require("dateformat"));

var _lodash = _interopRequireDefault(require("lodash"));

_appiumSupport.logger.patchLogger(_npmlog.default);

global._global_npmlog = _npmlog.default;
_npmlog.default.level = "silent";
const levels = {
  debug: 4,
  info: 3,
  warn: 2,
  error: 1
};
const colors = {
  info: 'cyan',
  debug: 'grey',
  warn: 'yellow',
  error: 'red'
};
const npmToWinstonLevels = {
  silly: 'debug',
  verbose: 'debug',
  debug: 'debug',
  info: 'info',
  http: 'info',
  warn: 'warn',
  error: 'error'
};
let log = null;
let timeZone = null;

const timestampFormat = _winston.format.timestamp({
  format() {
    let date = new Date();

    if (!timeZone) {
      date = new Date(date.valueOf() + date.getTimezoneOffset() * 60000);
    }

    return (0, _dateformat.default)(date, 'yyyy-mm-dd HH:MM:ss:l');
  }

});

const colorizeFormat = _winston.format.colorize({
  colors
});

const stripColorFormat = (0, _winston.format)(function (info) {
  const code = /\u001b\[(\d+(;\d+)*)?m/g;
  info.message = info.message.replace(code, '');
  return info;
})();

function createConsoleTransport(args, logLvl) {
  return new _winston.transports.Console({
    name: 'console',
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl,
    stderrLevels: ['error'],
    format: _winston.format.combine((0, _winston.format)(function (info) {
      if (info.level === 'debug') {
        info.level = 'info';
        info.message = `[debug] ${info.message}`;
      }

      return info;
    })(), timestampFormat, colorizeFormat, _winston.format.printf(function (info) {
      return `${args.logTimestamp ? `${info.timestamp} - ` : ''}${info.message}`;
    }))
  });
}

function createFileTransport(args, logLvl) {
  return new _winston.transports.File({
    name: 'file',
    filename: args.logFile,
    maxFiles: 1,
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl,
    format: _winston.format.combine(stripColorFormat, timestampFormat, _winston.format.printf(function (info) {
      return `${info.timestamp} ${info.message}`;
    }))
  });
}

function createHttpTransport(args, logLvl) {
  let host = '127.0.0.1';
  let port = 9003;

  if (args.webhook.match(':')) {
    const hostAndPort = args.webhook.split(':');
    host = hostAndPort[0];
    port = parseInt(hostAndPort[1], 10);
  }

  return new _winston.transports.Http({
    name: 'http',
    host,
    port,
    path: '/',
    handleExceptions: true,
    exitOnError: false,
    json: false,
    level: logLvl,
    format: _winston.format.combine(stripColorFormat, _winston.format.printf(function (info) {
      return `${info.timestamp} ${info.message}`;
    }))
  });
}

async function createTransports(args) {
  let transports = [];
  let consoleLogLevel = null;
  let fileLogLevel = null;

  if (args.loglevel && args.loglevel.match(':')) {
    const lvlPair = args.loglevel.split(':');
    consoleLogLevel = lvlPair[0] || consoleLogLevel;
    fileLogLevel = lvlPair[1] || fileLogLevel;
  } else {
    consoleLogLevel = fileLogLevel = args.loglevel;
  }

  transports.push(createConsoleTransport(args, consoleLogLevel));

  if (args.logFile) {
    try {
      if (await _appiumSupport.fs.exists(args.logFile)) {
        await _appiumSupport.fs.unlink(args.logFile);
      }

      transports.push(createFileTransport(args, fileLogLevel));
    } catch (e) {
      console.log(`Tried to attach logging to file '${args.logFile}' but an error ` + `occurred: ${e.message}`);
    }
  }

  if (args.webhook) {
    try {
      transports.push(createHttpTransport(args, fileLogLevel));
    } catch (e) {
      console.log(`Tried to attach logging to Http at ${args.webhook} but ` + `an error occurred: ${e.message}`);
    }
  }

  return transports;
}

async function init(args) {
  timeZone = args.localTimezone;
  clear();
  log = (0, _winston.createLogger)({
    transports: await createTransports(args),
    levels
  });

  _npmlog.default.on('log', logObj => {
    const winstonLevel = npmToWinstonLevels[logObj.level] || 'info';
    let msg = logObj.message;

    if (logObj.prefix) {
      const prefix = `[${logObj.prefix}]`;
      msg = `${args.logNoColors ? prefix : prefix.magenta} ${msg}`;
    }

    log[winstonLevel](msg);

    if (args.logHandler && _lodash.default.isFunction(args.logHandler)) {
      args.logHandler(logObj.level, msg);
    }
  });
}

function clear() {
  if (log) {
    for (let transport of _lodash.default.keys(log.transports)) {
      log.remove(transport);
    }
  }

  _npmlog.default.removeAllListeners('log');
}

var _default = init;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9sb2dzaW5rLmpzIl0sIm5hbWVzIjpbImxvZ2dlciIsInBhdGNoTG9nZ2VyIiwibnBtbG9nIiwiZ2xvYmFsIiwiX2dsb2JhbF9ucG1sb2ciLCJsZXZlbCIsImxldmVscyIsImRlYnVnIiwiaW5mbyIsIndhcm4iLCJlcnJvciIsImNvbG9ycyIsIm5wbVRvV2luc3RvbkxldmVscyIsInNpbGx5IiwidmVyYm9zZSIsImh0dHAiLCJsb2ciLCJ0aW1lWm9uZSIsInRpbWVzdGFtcEZvcm1hdCIsImZvcm1hdCIsInRpbWVzdGFtcCIsImRhdGUiLCJEYXRlIiwidmFsdWVPZiIsImdldFRpbWV6b25lT2Zmc2V0IiwiY29sb3JpemVGb3JtYXQiLCJjb2xvcml6ZSIsInN0cmlwQ29sb3JGb3JtYXQiLCJjb2RlIiwibWVzc2FnZSIsInJlcGxhY2UiLCJjcmVhdGVDb25zb2xlVHJhbnNwb3J0IiwiYXJncyIsImxvZ0x2bCIsInRyYW5zcG9ydHMiLCJDb25zb2xlIiwibmFtZSIsImhhbmRsZUV4Y2VwdGlvbnMiLCJleGl0T25FcnJvciIsImpzb24iLCJzdGRlcnJMZXZlbHMiLCJjb21iaW5lIiwicHJpbnRmIiwibG9nVGltZXN0YW1wIiwiY3JlYXRlRmlsZVRyYW5zcG9ydCIsIkZpbGUiLCJmaWxlbmFtZSIsImxvZ0ZpbGUiLCJtYXhGaWxlcyIsImNyZWF0ZUh0dHBUcmFuc3BvcnQiLCJob3N0IiwicG9ydCIsIndlYmhvb2siLCJtYXRjaCIsImhvc3RBbmRQb3J0Iiwic3BsaXQiLCJwYXJzZUludCIsIkh0dHAiLCJwYXRoIiwiY3JlYXRlVHJhbnNwb3J0cyIsImNvbnNvbGVMb2dMZXZlbCIsImZpbGVMb2dMZXZlbCIsImxvZ2xldmVsIiwibHZsUGFpciIsInB1c2giLCJmcyIsImV4aXN0cyIsInVubGluayIsImUiLCJjb25zb2xlIiwiaW5pdCIsImxvY2FsVGltZXpvbmUiLCJjbGVhciIsIm9uIiwibG9nT2JqIiwid2luc3RvbkxldmVsIiwibXNnIiwicHJlZml4IiwibG9nTm9Db2xvcnMiLCJtYWdlbnRhIiwibG9nSGFuZGxlciIsIl8iLCJpc0Z1bmN0aW9uIiwidHJhbnNwb3J0Iiwia2V5cyIsInJlbW92ZSIsInJlbW92ZUFsbExpc3RlbmVycyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUlBQSxzQkFBT0MsV0FBUCxDQUFtQkMsZUFBbkI7O0FBQ0FDLE1BQU0sQ0FBQ0MsY0FBUCxHQUF3QkYsZUFBeEI7QUFHQUEsZ0JBQU9HLEtBQVAsR0FBZSxRQUFmO0FBQ0EsTUFBTUMsTUFBTSxHQUFHO0FBQ2JDLEVBQUFBLEtBQUssRUFBRSxDQURNO0FBRWJDLEVBQUFBLElBQUksRUFBRSxDQUZPO0FBR2JDLEVBQUFBLElBQUksRUFBRSxDQUhPO0FBSWJDLEVBQUFBLEtBQUssRUFBRTtBQUpNLENBQWY7QUFPQSxNQUFNQyxNQUFNLEdBQUc7QUFDYkgsRUFBQUEsSUFBSSxFQUFFLE1BRE87QUFFYkQsRUFBQUEsS0FBSyxFQUFFLE1BRk07QUFHYkUsRUFBQUEsSUFBSSxFQUFFLFFBSE87QUFJYkMsRUFBQUEsS0FBSyxFQUFFO0FBSk0sQ0FBZjtBQU9BLE1BQU1FLGtCQUFrQixHQUFHO0FBQ3pCQyxFQUFBQSxLQUFLLEVBQUUsT0FEa0I7QUFFekJDLEVBQUFBLE9BQU8sRUFBRSxPQUZnQjtBQUd6QlAsRUFBQUEsS0FBSyxFQUFFLE9BSGtCO0FBSXpCQyxFQUFBQSxJQUFJLEVBQUUsTUFKbUI7QUFLekJPLEVBQUFBLElBQUksRUFBRSxNQUxtQjtBQU16Qk4sRUFBQUEsSUFBSSxFQUFFLE1BTm1CO0FBT3pCQyxFQUFBQSxLQUFLLEVBQUU7QUFQa0IsQ0FBM0I7QUFVQSxJQUFJTSxHQUFHLEdBQUcsSUFBVjtBQUNBLElBQUlDLFFBQVEsR0FBRyxJQUFmOztBQUdBLE1BQU1DLGVBQWUsR0FBR0MsZ0JBQU9DLFNBQVAsQ0FBaUI7QUFDdkNELEVBQUFBLE1BQU0sR0FBSTtBQUNSLFFBQUlFLElBQUksR0FBRyxJQUFJQyxJQUFK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QUE5QjtBQUNEO0FBRUYsR0FaRDtBQWFEOztBQUVELFNBQVNKLEtBQVQsR0FBa0I7QUFDaEIsTUFBSXhELEdBQUosRUFBUztBQUNQLFNBQUssSUFBSW1FLFNBQVQsSUFBc0JGLGdCQUFFRyxJQUFGLENBQU9wRSxHQUFHLENBQUNrQixVQUFYLENBQXRCLEVBQThDO0FBQzVDbEIsTUFBQUEsR0FBRyxDQUFDcUUsTUFBSixDQUFXRixTQUFYO0FBQ0Q7QUFDRjs7QUFDRGpGLGtCQUFPb0Ysa0JBQVAsQ0FBMEIsS0FBMUI7QUFDRDs7ZUFJY2hCLEkiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbnBtbG9nIGZyb20gJ25wbWxvZyc7XG5pbXBvcnQgeyBjcmVhdGVMb2dnZXIsIGZvcm1hdCwgdHJhbnNwb3J0cyB9IGZyb20gJ3dpbnN0b24nO1xuaW1wb3J0IHsgZnMsIGxvZ2dlciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCBkYXRlZm9ybWF0IGZyb20gJ2RhdGVmb3JtYXQnO1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcblxuXG4vLyBzZXQgdXAgZGlzdHJpYnV0ZWQgbG9nZ2luZyBiZWZvcmUgZXZlcnl0aGluZyBlbHNlXG5sb2dnZXIucGF0Y2hMb2dnZXIobnBtbG9nKTtcbmdsb2JhbC5fZ2xvYmFsX25wbWxvZyA9IG5wbWxvZztcblxuLy8gbnBtbG9nIGlzIHVzZWQgb25seSBmb3IgZW1pdHRpbmcsIHdlIHVzZSB3aW5zdG9uIGZvciBvdXRwdXRcbm5wbWxvZy5sZXZlbCA9IFwic2lsZW50XCI7XG5jb25zdCBsZXZlbHMgPSB7XG4gIGRlYnVnOiA0LFxuICBpbmZvOiAzLFxuICB3YXJuOiAyLFxuICBlcnJvcjogMSxcbn07XG5cbmNvbnN0IGNvbG9ycyA9IHtcbiAgaW5mbzogJ2N5YW4nLFxuICBkZWJ1ZzogJ2dyZXknLFxuICB3YXJuOiAneWVsbG93JyxcbiAgZXJyb3I6ICdyZWQnLFxufTtcblxuY29uc3QgbnBtVG9XaW5zdG9uTGV2ZWxzID0ge1xuICBzaWxseTogJ2RlYnVnJyxcbiAgdmVyYm9zZTogJ2RlYnVnJyxcbiAgZGVidWc6ICdkZWJ1ZycsXG4gIGluZm86ICdpbmZvJyxcbiAgaHR0cDogJ2luZm8nLFxuICB3YXJuOiAnd2FybicsXG4gIGVycm9yOiAnZXJyb3InLFxufTtcblxubGV0IGxvZyA9IG51bGw7XG5sZXQgdGltZVpvbmUgPSBudWxsO1xuXG4vLyBhZGQgdGhlIHRpbWVzdGFtcCBpbiB0aGUgY29ycmVjdCBmb3JtYXQgdG8gdGhlIGxvZyBpbmZvIG9iamVjdFxuY29uc3QgdGltZXN0YW1wRm9ybWF0ID0gZm9ybWF0LnRpbWVzdGFtcCh7XG4gIGZvcm1hdCAoKSB7XG4gICAgbGV0IGRhdGUgPSBuZXcgRGF0ZSgpO1xuICAgIGlmICghdGltZVpvbmUpIHtcbiAgICAgIGRhdGUgPSBuZXcgRGF0ZShkYXRlLnZhbHVlT2YoKSArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSAqIDYwMDAwKTtcbiAgICB9XG4gICAgcmV0dXJuIGRhdGVmb3JtYXQoZGF0ZSwgJ3l5eXktbW0tZGQgSEg6TU06c3M6bCcpO1xuICB9LFxufSk7XG5cbi8vIHNldCB0aGUgY3VzdG9tIGNvbG9yc1xuY29uc3QgY29sb3JpemVGb3JtYXQgPSBmb3JtYXQuY29sb3JpemUoe1xuICBjb2xvcnMsXG59KTtcblxuLy8gU3RyaXAgdGhlIGNvbG9yIG1hcmtpbmcgd2l0aGluIG1lc3NhZ2VzXG5jb25zdCBzdHJpcENvbG9yRm9ybWF0ID0gZm9ybWF0KGZ1bmN0aW9uIChpbmZvKSB7XG4gIGNvbnN0IGNvZGUgPSAvXFx1MDAxYlxcWyhcXGQrKDtcXGQrKSopP20vZzsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBuby1jb250cm9sLXJlZ2V4XG4gIGluZm8ubWVzc2FnZSA9IGluZm8ubWVzc2FnZS5yZXBsYWNlKGNvZGUsICcnKTtcbiAgcmV0dXJuIGluZm87XG59KSgpO1xuXG5mdW5jdGlvbiBjcmVhdGVDb25zb2xlVHJhbnNwb3J0IChhcmdzLCBsb2dMdmwpIHtcbiAgcmV0dXJuIG5ldyAodHJhbnNwb3J0cy5Db25zb2xlKSh7XG4gICAgbmFtZTogJ2NvbnNvbGUnLFxuICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgZXhpdE9uRXJyb3I6IGZhbHNlLFxuICAgIGpzb246IGZhbHNlLFxuICAgIGxldmVsOiBsb2dMdmwsXG4gICAgc3RkZXJyTGV2ZWxzOiBbJ2Vycm9yJ10sXG4gICAgZm9ybWF0OiBmb3JtYXQuY29tYmluZShcbiAgICAgIGZvcm1hdChmdW5jdGlvbiAoaW5mbykge1xuICAgICAgICAvLyBwcmVwZW5kIGRlYnVnIG1hcmtlciwgYW5kIHNoaWZ0IHRvIGBpbmZvYCBsb2cgbGV2ZWxcbiAgICAgICAgaWYgKGluZm8ubGV2ZWwgPT09ICdkZWJ1ZycpIHtcbiAgICAgICAgICBpbmZvLmxldmVsID0gJ2luZm8nO1xuICAgICAgICAgIGluZm8ubWVzc2FnZSA9IGBbZGVidWddICR7aW5mby5tZXNzYWdlfWA7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIGluZm87XG4gICAgICB9KSgpLFxuICAgICAgdGltZXN0YW1wRm9ybWF0LFxuICAgICAgY29sb3JpemVGb3JtYXQsXG4gICAgICBmb3JtYXQucHJpbnRmKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIHJldHVybiBgJHthcmdzLmxvZ1RpbWVzdGFtcCA/IGAke2luZm8udGltZXN0YW1wfSAtIGAgOiAnJ30ke2luZm8ubWVzc2FnZX1gO1xuICAgICAgfSlcbiAgICApLFxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlRmlsZVRyYW5zcG9ydCAoYXJncywgbG9nTHZsKSB7XG4gIHJldHVybiBuZXcgKHRyYW5zcG9ydHMuRmlsZSkoe1xuICAgIG5hbWU6ICdmaWxlJyxcbiAgICBmaWxlbmFtZTogYXJncy5sb2dGaWxlLFxuICAgIG1heEZpbGVzOiAxLFxuICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgZXhpdE9uRXJyb3I6IGZhbHNlLFxuICAgIGpzb246IGZhbHNlLFxuICAgIGxldmVsOiBsb2dMdmwsXG4gICAgZm9ybWF0OiBmb3JtYXQuY29tYmluZShcbiAgICAgIHN0cmlwQ29sb3JGb3JtYXQsXG4gICAgICB0aW1lc3RhbXBGb3JtYXQsXG4gICAgICBmb3JtYXQucHJpbnRmKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIHJldHVybiBgJHtpbmZvLnRpbWVzdGFtcH0gJHtpbmZvLm1lc3NhZ2V9YDtcbiAgICAgIH0pXG4gICAgKVxuICB9KTtcbn1cblxuZnVuY3Rpb24gY3JlYXRlSHR0cFRyYW5zcG9ydCAoYXJncywgbG9nTHZsKSB7XG4gIGxldCBob3N0ID0gJzEyNy4wLjAuMSc7XG4gIGxldCBwb3J0ID0gOTAwMztcblxuICBpZiAoYXJncy53ZWJob29rLm1hdGNoKCc6JykpIHtcbiAgICBjb25zdCBob3N0QW5kUG9ydCA9IGFyZ3Mud2ViaG9vay5zcGxpdCgnOicpO1xuICAgIGhvc3QgPSBob3N0QW5kUG9ydFswXTtcbiAgICBwb3J0ID0gcGFyc2VJbnQoaG9zdEFuZFBvcnRbMV0sIDEwKTtcbiAgfVxuXG4gIHJldHVybiBuZXcgKHRyYW5zcG9ydHMuSHR0cCkoe1xuICAgIG5hbWU6ICdodHRwJyxcbiAgICBob3N0LFxuICAgIHBvcnQsXG4gICAgcGF0aDogJy8nLFxuICAgIGhhbmRsZUV4Y2VwdGlvbnM6IHRydWUsXG4gICAgZXhpdE9uRXJyb3I6IGZhbHNlLFxuICAgIGpzb246IGZhbHNlLFxuICAgIGxldmVsOiBsb2dMdmwsXG4gICAgZm9ybWF0OiBmb3JtYXQuY29tYmluZShcbiAgICAgIHN0cmlwQ29sb3JGb3JtYXQsXG4gICAgICBmb3JtYXQucHJpbnRmKGZ1bmN0aW9uIChpbmZvKSB7XG4gICAgICAgIHJldHVybiBgJHtpbmZvLnRpbWVzdGFtcH0gJHtpbmZvLm1lc3NhZ2V9YDtcbiAgICAgIH0pXG4gICAgKSxcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNyZWF0ZVRyYW5zcG9ydHMgKGFyZ3MpIHtcbiAgbGV0IHRyYW5zcG9ydHMgPSBbXTtcbiAgbGV0IGNvbnNvbGVMb2dMZXZlbCA9IG51bGw7XG4gIGxldCBmaWxlTG9nTGV2ZWwgPSBudWxsO1xuXG4gIGlmIChhcmdzLmxvZ2xldmVsICYmIGFyZ3MubG9nbGV2ZWwubWF0Y2goJzonKSkge1xuICAgIC8vIC0tbG9nLWxldmVsIGFyZyBjYW4gb3B0aW9uYWxseSBwcm92aWRlIGRpZmYgbG9nZ2luZyBsZXZlbHMgZm9yIGNvbnNvbGUgYW5kIGZpbGUsIHNlcGFyYXRlZCBieSBhIGNvbG9uXG4gICAgY29uc3QgbHZsUGFpciA9IGFyZ3MubG9nbGV2ZWwuc3BsaXQoJzonKTtcbiAgICBjb25zb2xlTG9nTGV2ZWwgPSBsdmxQYWlyWzBdIHx8IGNvbnNvbGVMb2dMZXZlbDtcbiAgICBmaWxlTG9nTGV2ZWwgPSBsdmxQYWlyWzFdIHx8IGZpbGVMb2dMZXZlbDtcbiAgfSBlbHNlIHtcbiAgICBjb25zb2xlTG9nTGV2ZWwgPSBmaWxlTG9nTGV2ZWwgPSBhcmdzLmxvZ2xldmVsO1xuICB9XG5cbiAgdHJhbnNwb3J0cy5wdXNoKGNyZWF0ZUNvbnNvbGVUcmFuc3BvcnQoYXJncywgY29uc29sZUxvZ0xldmVsKSk7XG5cbiAgaWYgKGFyZ3MubG9nRmlsZSkge1xuICAgIHRyeSB7XG4gICAgICAvLyBpZiB3ZSBkb24ndCBkZWxldGUgdGhlIGxvZyBmaWxlLCB3aW5zdG9uIHdpbGwgYWx3YXlzIGFwcGVuZCBhbmQgaXQgd2lsbCBncm93IGluZmluaXRlbHkgbGFyZ2U7XG4gICAgICAvLyB3aW5zdG9uIGFsbG93cyBmb3IgbGltaXRpbmcgbG9nIGZpbGUgc2l6ZSwgYnV0IGFzIG9mIDkuMi4xNCB0aGVyZSdzIGEgc2VyaW91cyBidWcgd2hlbiB1c2luZ1xuICAgICAgLy8gbWF4RmlsZXMgYW5kIG1heFNpemUgdG9nZXRoZXIuIGh0dHBzOi8vZ2l0aHViLmNvbS9mbGF0aXJvbi93aW5zdG9uL2lzc3Vlcy8zOTdcbiAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMoYXJncy5sb2dGaWxlKSkge1xuICAgICAgICBhd2FpdCBmcy51bmxpbmsoYXJncy5sb2dGaWxlKTtcbiAgICAgIH1cblxuICAgICAgdHJhbnNwb3J0cy5wdXNoKGNyZWF0ZUZpbGVUcmFuc3BvcnQoYXJncywgZmlsZUxvZ0xldmVsKSk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lIG5vLWNvbnNvbGVcbiAgICAgIGNvbnNvbGUubG9nKGBUcmllZCB0byBhdHRhY2ggbG9nZ2luZyB0byBmaWxlICcke2FyZ3MubG9nRmlsZX0nIGJ1dCBhbiBlcnJvciBgICtcbiAgICAgICAgICAgICAgICAgIGBvY2N1cnJlZDogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgaWYgKGFyZ3Mud2ViaG9vaykge1xuICAgIHRyeSB7XG4gICAgICB0cmFuc3BvcnRzLnB1c2goY3JlYXRlSHR0cFRyYW5zcG9ydChhcmdzLCBmaWxlTG9nTGV2ZWwpKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgY29uc29sZS5sb2coYFRyaWVkIHRvIGF0dGFjaCBsb2dnaW5nIHRvIEh0dHAgYXQgJHthcmdzLndlYmhvb2t9IGJ1dCBgICtcbiAgICAgICAgICAgICAgICAgIGBhbiBlcnJvciBvY2N1cnJlZDogJHtlLm1lc3NhZ2V9YCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRyYW5zcG9ydHM7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluaXQgKGFyZ3MpIHtcbiAgLy8gc2V0IGRlIGZhY3RvIHBhcmFtIHBhc3NlZCB0byB0aW1lc3RhbXAgZnVuY3Rpb25cbiAgdGltZVpvbmUgPSBhcmdzLmxvY2FsVGltZXpvbmU7XG5cbiAgLy8gY2xlYW4gdXAgaW4gY2FzZSB3ZSBoYXZlIGluaXR0ZWQgYmVmb3JlIHNpbmNlIG5wbWxvZyBpcyBhIGdsb2JhbCBvYmplY3RcbiAgY2xlYXIoKTtcblxuICBsb2cgPSBjcmVhdGVMb2dnZXIoe1xuICAgIHRyYW5zcG9ydHM6IGF3YWl0IGNyZWF0ZVRyYW5zcG9ydHMoYXJncyksXG4gICAgbGV2ZWxzLFxuICB9KTtcblxuICAvLyBDYXB0dXJlIGxvZ3MgZW1pdHRlZCB2aWEgbnBtbG9nIGFuZCBwYXNzIHRoZW0gdGhyb3VnaCB3aW5zdG9uXG4gIG5wbWxvZy5vbignbG9nJywgKGxvZ09iaikgPT4ge1xuICAgIGNvbnN0IHdpbnN0b25MZXZlbCA9IG5wbVRvV2luc3RvbkxldmVsc1tsb2dPYmoubGV2ZWxdIHx8ICdpbmZvJztcbiAgICBsZXQgbXNnID0gbG9nT2JqLm1lc3NhZ2U7XG4gICAgaWYgKGxvZ09iai5wcmVmaXgpIHtcbiAgICAgIGNvbnN0IHByZWZpeCA9IGBbJHtsb2dPYmoucHJlZml4fV1gO1xuICAgICAgbXNnID0gYCR7YXJncy5sb2dOb0NvbG9ycyA/IHByZWZpeCA6IHByZWZpeC5tYWdlbnRhfSAke21zZ31gO1xuICAgIH1cbiAgICBsb2dbd2luc3RvbkxldmVsXShtc2cpO1xuICAgIGlmIChhcmdzLmxvZ0hhbmRsZXIgJiYgXy5pc0Z1bmN0aW9uKGFyZ3MubG9nSGFuZGxlcikpIHtcbiAgICAgIGFyZ3MubG9nSGFuZGxlcihsb2dPYmoubGV2ZWwsIG1zZyk7XG4gICAgfVxuXG4gIH0pO1xufVxuXG5mdW5jdGlvbiBjbGVhciAoKSB7XG4gIGlmIChsb2cpIHtcbiAgICBmb3IgKGxldCB0cmFuc3BvcnQgb2YgXy5rZXlzKGxvZy50cmFuc3BvcnRzKSkge1xuICAgICAgbG9nLnJlbW92ZSh0cmFuc3BvcnQpO1xuICAgIH1cbiAgfVxuICBucG1sb2cucmVtb3ZlQWxsTGlzdGVuZXJzKCdsb2cnKTtcbn1cblxuXG5leHBvcnQgeyBpbml0LCBjbGVhciB9O1xuZXhwb3J0IGRlZmF1bHQgaW5pdDtcbiJdLCJmaWxlIjoibGliL2xvZ3NpbmsuanMiLCJzb3VyY2VSb290IjoiLi4vLi4ifQ==
